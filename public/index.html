<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üßü Survival Zombie - Inicio</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Courier New', monospace;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
      color: #00ff00;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .container {
      max-width: 900px;
      width: 100%;
    }
    
    h1 {
      text-align: center;
      color: #ff0000;
      text-shadow: 3px 3px #000, 0 0 20px #ff0000;
      font-size: 48px;
      margin-bottom: 10px;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    
    .subtitle {
      text-align: center;
      color: #888;
      margin-bottom: 40px;
      font-size: 14px;
    }
    
    .panel {
      background: rgba(42, 42, 60, 0.9);
      border: 2px solid #00ff00;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 30px rgba(0, 255, 0, 0.3);
      backdrop-filter: blur(10px);
      margin-bottom: 20px;
    }
    
    .panel h2 {
      color: #ffff00;
      margin-bottom: 20px;
      border-bottom: 2px solid #00ff00;
      padding-bottom: 10px;
    }
    
    input, select {
      background: #000;
      color: #00ff00;
      border: 2px solid #00ff00;
      padding: 15px;
      font-family: inherit;
      width: 100%;
      margin: 10px 0;
      font-size: 16px;
      border-radius: 5px;
      transition: all 0.3s;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #00ffff;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
    }
    
    button {
      background: linear-gradient(135deg, #00aa00 0%, #005500 100%);
      color: #fff;
      border: 2px solid #00ff00;
      padding: 15px 30px;
      font-family: inherit;
      font-size: 18px;
      cursor: pointer;
      border-radius: 5px;
      font-weight: bold;
      transition: all 0.3s;
      width: 100%;
      margin: 10px 0;
    }
    
    button:hover {
      background: linear-gradient(135deg, #00ff00 0%, #00aa00 100%);
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.6);
      transform: translateY(-2px);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button.secondary {
      background: linear-gradient(135deg, #555 0%, #333 100%);
      border-color: #888;
    }
    
    button.secondary:hover {
      background: linear-gradient(135deg, #777 0%, #555 100%);
      box-shadow: 0 0 20px rgba(136, 136, 136, 0.6);
    }
    
    .hidden {
      display: none !important;
    }
    
    .clase-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin: 20px 0;
    }
    
    .clase-card {
      background: #1a1a2e;
      border: 2px solid #333;
      padding: 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }
    
    .clase-card:hover {
      border-color: #00ff00;
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(0, 255, 0, 0.4);
    }
    
    .clase-card.selected {
      border-color: #00ffff;
      background: #2a2a4e;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
    }
    
    .clase-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    .clase-name {
      font-size: 20px;
      color: #00ff00;
      margin-bottom: 10px;
    }
    
    .clase-desc {
      font-size: 12px;
      color: #aaa;
      line-height: 1.4;
    }
    
    .clase-bonus {
      margin-top: 10px;
      font-size: 11px;
      color: #ffaa00;
    }
    
    .atributo {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 15px 0;
      padding: 10px;
      background: #1a1a2e;
      border-radius: 5px;
    }
    
    .atributo-nombre {
      flex: 1;
      font-size: 16px;
    }
    
    .atributo-control {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .atributo-control button {
      width: 40px;
      height: 40px;
      padding: 0;
      font-size: 20px;
      margin: 0;
    }
    
    .atributo-valor {
      font-size: 24px;
      min-width: 40px;
      text-align: center;
      color: #00ffff;
    }
    
    .puntos-restantes {
      text-align: center;
      font-size: 20px;
      color: #ffff00;
      margin: 20px 0;
      padding: 15px;
      background: #1a1a2e;
      border-radius: 5px;
    }
    
    .avatar-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
      margin: 20px 0;
    }
    
    .avatar-option {
      font-size: 40px;
      padding: 15px;
      background: #1a1a2e;
      border: 2px solid #333;
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
    }
    
    .avatar-option:hover {
      border-color: #00ff00;
      transform: scale(1.1);
    }
    
    .avatar-option.selected {
      border-color: #00ffff;
      background: #2a2a4e;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.6);
    }
    
    .color-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 10px;
      margin: 20px 0;
    }
    
    .color-option {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid #333;
      transition: all 0.3s;
    }
    
    .color-option:hover {
      transform: scale(1.2);
      border-color: #fff;
    }
    
    .color-option.selected {
      border-color: #fff;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
      transform: scale(1.3);
    }
    
    .personajes-lista {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .personaje-card {
      background: #1a1a2e;
      border: 2px solid #333;
      padding: 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .personaje-card:hover {
      border-color: #00ff00;
      transform: translateY(-5px);
      box-shadow: 0 5px 20px rgba(0, 255, 0, 0.4);
    }
    
    .personaje-avatar {
      font-size: 60px;
      text-align: center;
      margin-bottom: 10px;
    }
    
    .personaje-info {
      text-align: center;
    }
    
    .personaje-nombre {
      font-size: 20px;
      color: #00ff00;
      margin-bottom: 5px;
    }
    
    .personaje-clase {
      font-size: 14px;
      color: #ffaa00;
      margin-bottom: 10px;
    }
    
    .personaje-stats {
      font-size: 12px;
      color: #888;
    }
    
    .error {
      color: #ff0000;
      text-align: center;
      margin: 10px 0;
      padding: 10px;
      background: rgba(255, 0, 0, 0.1);
      border: 1px solid #ff0000;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üíª Z-SURVIVAL.exe</h1>
    <p class="subtitle">// Sistema de Supervivencia Multijugador v2.0 - Alpha Build</p>
    
    <!-- PANTALLA LOGIN/REGISTRO -->
    <div id="screenAuth" class="panel">
      <h2>üîê ACCESO</h2>
      <div id="errorAuth" class="error hidden"></div>
      
      <div style="border: 1px solid #00ff00; padding: 15px; margin: 20px 0; background: rgba(0,0,0,0.3);">
        <p style="font-size: 12px; color: #00ff00; margin-bottom: 10px;">‚ú® Caracter√≠sticas del juego:</p>
        <p style="font-size: 11px; color: #aaa; line-height: 1.6;">
          üéÆ Mundo compartido en tiempo real<br>
          üßü Sistema de supervivencia completo<br>
          ü§ù Cooperaci√≥n y comercio entre jugadores<br>
          üè† Refugio comunitario que defender<br>
          üìà Progresi√≥n con skills y niveles<br>
          üéØ Misiones, eventos y narrativa din√°mica
        </p>
      </div>
      
      <input type="text" id="username" placeholder="Usuario" maxlength="20">
      <input type="password" id="password" placeholder="Contrase√±a">
      
      <button onclick="login()">üö™ INICIAR SESI√ìN</button>
      <button onclick="register()" class="secondary">‚ûï CREAR CUENTA NUEVA</button>
      
      <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #333;">
        <p style="font-size: 11px; color: #666; margin-bottom: 10px; text-align: center;">¬øTe gusta el proyecto?</p>
        <a href="https://link.mercadopago.com.ar/donaciondelproyecto" target="_blank" style="display: block; padding: 12px 20px; background: #009ee3; color: white; text-decoration: none; border-radius: 5px; font-size: 14px; font-weight: bold; text-align: center; transition: all 0.3s;">
          üíù APOYAR CON UNA DONACI√ìN
        </a>
        <p style="font-size: 10px; color: #555; margin-top: 8px; text-align: center;">Tu apoyo ayuda a mantener el servidor online üôè</p>
      </div>
    </div>
    
    <!-- PANTALLA SELECCI√ìN DE PERSONAJE -->
    <div id="screenPersonajes" class="panel hidden">
      <h2>üë• TUS PERSONAJES</h2>
      <div id="personajesLista" class="personajes-lista"></div>
      <button onclick="mostrarCrearPersonaje()">‚ûï CREAR PERSONAJE NUEVO</button>
      <button onclick="logout()" class="secondary">CERRAR SESI√ìN</button>
      
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #333; text-align: center;">
        <a href="https://link.mercadopago.com.ar/donaciondelproyecto" target="_blank" style="display: inline-block; padding: 10px 20px; background: #009ee3; color: white; text-decoration: none; border-radius: 5px; font-size: 13px; font-weight: bold;">
          üíù Apoyar el proyecto
        </a>
      </div>
    </div>
    
    <!-- PANTALLA CREAR PERSONAJE -->
    <div id="screenCrear" class="panel hidden">
      <h2>‚≠ê CREAR PERSONAJE</h2>
      <div id="errorCrear" class="error hidden"></div>
      
      <!-- Paso 1: Nombre y Clase -->
      <div id="paso1">
        <input type="text" id="nombrePersonaje" placeholder="Nombre del personaje" maxlength="20">
        
        <h3 style="color: #ffff00; margin: 20px 0;">Elige tu clase:</h3>
        <div class="clase-grid">
          <div class="clase-card" onclick="seleccionarClase('soldado')">
            <div class="clase-icon">üéñÔ∏è</div>
            <div class="clase-name">SOLDADO</div>
            <div class="clase-desc">Veterano de combate. Experto en armas.</div>
            <div class="clase-bonus">+2 Fuerza | +2 Combate</div>
          </div>
          
          <div class="clase-card" onclick="seleccionarClase('medico')">
            <div class="clase-icon">‚öïÔ∏è</div>
            <div class="clase-name">M√âDICO</div>
            <div class="clase-desc">Salva vidas. Conoce medicina.</div>
            <div class="clase-bonus">+2 Inteligencia | +2 Medicina</div>
          </div>
          
          <div class="clase-card" onclick="seleccionarClase('ingeniero')">
            <div class="clase-icon">üîß</div>
            <div class="clase-name">INGENIERO</div>
            <div class="clase-desc">Construye y repara. Crafteo maestro.</div>
            <div class="clase-bonus">+1 Inteligencia | +3 Mec√°nica</div>
          </div>
          
          <div class="clase-card" onclick="seleccionarClase('superviviente')">
            <div class="clase-icon">üéí</div>
            <div class="clase-name">SUPERVIVIENTE</div>
            <div class="clase-desc">Adaptable. Maestro del sigilo.</div>
            <div class="clase-bonus">+1 Agilidad | +2 Supervivencia | +1 Sigilo</div>
          </div>
        </div>
        
        <button onclick="siguientePaso(2)">CONTINUAR ‚Üí</button>
        <button onclick="volverPersonajes()" class="secondary">‚Üê CANCELAR</button>
      </div>
      
      <!-- Paso 2: Atributos -->
      <div id="paso2" class="hidden">
        <h3 style="color: #ffff00; margin: 20px 0;">Distribuye tus atributos:</h3>
        <div class="puntos-restantes">Puntos restantes: <span id="puntosRestantes">10</span></div>
        
        <div class="atributo">
          <div class="atributo-nombre">üí™ FUERZA (Da√±o f√≠sico)</div>
          <div class="atributo-control">
            <button onclick="cambiarAtributo('fuerza', -1)">‚àí</button>
            <span class="atributo-valor" id="fuerza">5</span>
            <button onclick="cambiarAtributo('fuerza', 1)">+</button>
          </div>
        </div>
        
        <div class="atributo">
          <div class="atributo-nombre">üõ°Ô∏è RESISTENCIA (Salud m√°xima)</div>
          <div class="atributo-control">
            <button onclick="cambiarAtributo('resistencia', -1)">‚àí</button>
            <span class="atributo-valor" id="resistencia">5</span>
            <button onclick="cambiarAtributo('resistencia', 1)">+</button>
          </div>
        </div>
        
        <div class="atributo">
          <div class="atributo-nombre">‚ö° AGILIDAD (Evasi√≥n y sigilo)</div>
          <div class="atributo-control">
            <button onclick="cambiarAtributo('agilidad', -1)">‚àí</button>
            <span class="atributo-valor" id="agilidad">5</span>
            <button onclick="cambiarAtributo('agilidad', 1)">+</button>
          </div>
        </div>
        
        <div class="atributo">
          <div class="atributo-nombre">üß† INTELIGENCIA (Crafteo y medicina)</div>
          <div class="atributo-control">
            <button onclick="cambiarAtributo('inteligencia', -1)">‚àí</button>
            <span class="atributo-valor" id="inteligencia">5</span>
            <button onclick="cambiarAtributo('inteligencia', 1)">+</button>
          </div>
        </div>
        
        <button onclick="siguientePaso(3)">CONTINUAR ‚Üí</button>
        <button onclick="siguientePaso(1)" class="secondary">‚Üê ATR√ÅS</button>
      </div>
      
      <!-- Paso 3: Apariencia -->
      <div id="paso3" class="hidden">
        <h3 style="color: #ffff00; margin: 20px 0;">üì∏ Toma una foto para tu perfil:</h3>
        
        <div style="text-align: center; margin: 20px 0;">
          <video id="cameraPreview" autoplay playsinline style="width: 300px; height: 225px; border: 2px solid #00ff00; border-radius: 8px; display: none; background: #000;"></video>
          <canvas id="photoCanvas" style="display: none;"></canvas>
          <img id="capturedPhoto" style="width: 300px; height: 225px; border: 2px solid #00ff00; border-radius: 8px; display: none; object-fit: cover;">
          
          <div style="margin-top: 15px;">
            <button id="btnStartCamera" onclick="startCamera()" style="width: auto; padding: 10px 20px; margin: 5px;">üì∑ Iniciar C√°mara</button>
            <button id="btnTakePhoto" onclick="takePhoto()" style="width: auto; padding: 10px 20px; margin: 5px; display: none;">üì∏ Capturar Foto</button>
            <button id="btnRetakePhoto" onclick="retakePhoto()" style="width: auto; padding: 10px 20px; margin: 5px; display: none;">üîÑ Tomar Otra</button>
          </div>
        </div>
        
        <h3 style="color: #ffff00; margin: 20px 0;">O elige un avatar:</h3>
        <div class="avatar-grid">
          <div class="avatar-option" onclick="seleccionarAvatar('üë§')">üë§</div>
          <div class="avatar-option" onclick="seleccionarAvatar('üë®')">üë®</div>
          <div class="avatar-option" onclick="seleccionarAvatar('üë©')">üë©</div>
          <div class="avatar-option" onclick="seleccionarAvatar('üßî')">üßî</div>
          <div class="avatar-option" onclick="seleccionarAvatar('üë¥')">üë¥</div>
          <div class="avatar-option" onclick="seleccionarAvatar('üëµ')">üëµ</div>
          <div class="avatar-option" onclick="seleccionarAvatar('üßë')">üßë</div>
          <div class="avatar-option" onclick="seleccionarAvatar('üë®‚Äçü¶±')">üë®‚Äçü¶±</div>
          <div class="avatar-option" onclick="seleccionarAvatar('üë©‚Äçü¶±')">üë©‚Äçü¶±</div>
          <div class="avatar-option" onclick="seleccionarAvatar('üë®‚Äçü¶∞')">üë®‚Äçü¶∞</div>
          <div class="avatar-option" onclick="seleccionarAvatar('üë©‚Äçü¶∞')">üë©‚Äçü¶∞</div>
          <div class="avatar-option" onclick="seleccionarAvatar('üßë‚Äçü¶∞')">üßë‚Äçü¶∞</div>
        </div>
        
        <h3 style="color: #ffff00; margin: 20px 0;">Color de identificaci√≥n:</h3>
        <div class="color-grid">
          <div class="color-option" onclick="seleccionarColor('#00ff00')" style="background: #00ff00;"></div>
          <div class="color-option" onclick="seleccionarColor('#00ffff')" style="background: #00ffff;"></div>
          <div class="color-option" onclick="seleccionarColor('#ff00ff')" style="background: #ff00ff;"></div>
          <div class="color-option" onclick="seleccionarColor('#ffff00')" style="background: #ffff00;"></div>
          <div class="color-option" onclick="seleccionarColor('#ff8800')" style="background: #ff8800;"></div>
          <div class="color-option" onclick="seleccionarColor('#ff0000')" style="background: #ff0000;"></div>
          <div class="color-option" onclick="seleccionarColor('#8800ff')" style="background: #8800ff;"></div>
          <div class="color-option" onclick="seleccionarColor('#ffffff')" style="background: #ffffff;"></div>
        </div>
        
        <button onclick="crearPersonaje()">‚ú® CREAR Y JUGAR</button>
        <button onclick="siguientePaso(2)" class="secondary">‚Üê ATR√ÅS</button>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let selectedClase = null;
    let selectedAvatar = 'üë§';
    let selectedColor = '#00ff00';
    let atributos = { fuerza: 5, resistencia: 5, agilidad: 5, inteligencia: 5 };
    let puntosDisponibles = 10;
    let cameraStream = null;
    let capturedPhotoData = null;

    async function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      
      if (!username || !password) {
        showError('errorAuth', 'Completa todos los campos');
        return;
      }
      
      const response = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      
      const data = await response.json();
      
      if (data.success) {
        currentUser = data.user;
        mostrarPersonajes(data.personajes);
      } else {
        showError('errorAuth', data.error);
      }
    }

    async function register() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      
      if (!username || !password) {
        showError('errorAuth', 'Completa todos los campos');
        return;
      }
      
      if (password.length < 4) {
        showError('errorAuth', 'Contrase√±a muy corta (m√≠nimo 4 caracteres)');
        return;
      }
      
      const response = await fetch('/api/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      
      const data = await response.json();
      
      if (data.success) {
        showError('errorAuth', '‚úÖ Cuenta creada. Inicia sesi√≥n.');
      } else {
        showError('errorAuth', data.error);
      }
    }

    function mostrarPersonajes(personajes) {
      document.getElementById('screenAuth').classList.add('hidden');
      document.getElementById('screenPersonajes').classList.remove('hidden');
      
      const lista = document.getElementById('personajesLista');
      
      if (personajes.length === 0) {
        lista.innerHTML = '<p style="text-align: center; color: #888;">No tienes personajes. ¬°Crea uno!</p>';
      } else {
        lista.innerHTML = personajes.map(p => `
          <div class="personaje-card" onclick="seleccionarPersonaje(${p.id})">
            <div class="personaje-avatar" style="color: ${p.color}">${p.avatar}</div>
            <div class="personaje-info">
              <div class="personaje-nombre">${p.nombre}</div>
              <div class="personaje-clase">${p.clase.toUpperCase()}</div>
              <div class="personaje-stats">Nivel ${p.nivel} | ‚ù§Ô∏è ${p.salud}HP</div>
            </div>
          </div>
        `).join('');
      }
    }

    function mostrarCrearPersonaje() {
      document.getElementById('screenPersonajes').classList.add('hidden');
      document.getElementById('screenCrear').classList.remove('hidden');
      resetearCreacion();
    }

    function volverPersonajes() {
      document.getElementById('screenCrear').classList.add('hidden');
      document.getElementById('screenPersonajes').classList.remove('hidden');
    }

    function logout() {
      currentUser = null;
      document.getElementById('screenPersonajes').classList.add('hidden');
      document.getElementById('screenAuth').classList.remove('hidden');
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
    }

    function resetearCreacion() {
      selectedClase = null;
      selectedAvatar = 'üë§';
      selectedColor = '#00ff00';
      atributos = { fuerza: 5, resistencia: 5, agilidad: 5, inteligencia: 5 };
      puntosDisponibles = 10;
      siguientePaso(1);
      document.getElementById('nombrePersonaje').value = '';
      document.querySelectorAll('.clase-card').forEach(c => c.classList.remove('selected'));
      actualizarAtributos();
    }

    function siguientePaso(paso) {
      document.getElementById('paso1').classList.add('hidden');
      document.getElementById('paso2').classList.add('hidden');
      document.getElementById('paso3').classList.add('hidden');
      
      if (paso === 2 && !selectedClase) {
        showError('errorCrear', 'Selecciona una clase');
        document.getElementById('paso1').classList.remove('hidden');
        return;
      }
      
      if (paso === 2 && !document.getElementById('nombrePersonaje').value.trim()) {
        showError('errorCrear', 'Ingresa un nombre');
        document.getElementById('paso1').classList.remove('hidden');
        return;
      }
      
      if (paso === 3 && puntosDisponibles > 0) {
        showError('errorCrear', 'Distribuye todos los puntos');
        document.getElementById('paso2').classList.remove('hidden');
        return;
      }
      
      hideError('errorCrear');
      document.getElementById(`paso${paso}`).classList.remove('hidden');
    }

    function seleccionarClase(clase) {
      selectedClase = clase;
      document.querySelectorAll('.clase-card').forEach(c => c.classList.remove('selected'));
      event.currentTarget.classList.add('selected');
    }

    function cambiarAtributo(attr, delta) {
      const nuevoValor = atributos[attr] + delta;
      
      if (nuevoValor < 1 || nuevoValor > 10) return;
      if (delta > 0 && puntosDisponibles <= 0) return;
      if (delta < 0 && atributos[attr] <= 5) return; // M√≠nimo 5 (base)
      
      atributos[attr] = nuevoValor;
      puntosDisponibles -= delta;
      
      actualizarAtributos();
    }

    function actualizarAtributos() {
      document.getElementById('fuerza').textContent = atributos.fuerza;
      document.getElementById('resistencia').textContent = atributos.resistencia;
      document.getElementById('agilidad').textContent = atributos.agilidad;
      document.getElementById('inteligencia').textContent = atributos.inteligencia;
      document.getElementById('puntosRestantes').textContent = puntosDisponibles;
    }

    function seleccionarAvatar(avatar) {
      selectedAvatar = avatar;
      document.querySelectorAll('.avatar-option').forEach(a => a.classList.remove('selected'));
      event.currentTarget.classList.add('selected');
    }

    function seleccionarColor(color) {
      selectedColor = color;
      document.querySelectorAll('.color-option').forEach(c => c.classList.remove('selected'));
      event.currentTarget.classList.add('selected');
    }

    async function startCamera() {
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
        const video = document.getElementById('cameraPreview');
        video.srcObject = cameraStream;
        video.style.display = 'block';
        document.getElementById('btnStartCamera').style.display = 'none';
        document.getElementById('btnTakePhoto').style.display = 'inline-block';
        document.getElementById('capturedPhoto').style.display = 'none';
      } catch (err) {
        alert('No se pudo acceder a la c√°mara: ' + err.message);
      }
    }
    
    function takePhoto() {
      const video = document.getElementById('cameraPreview');
      const canvas = document.getElementById('photoCanvas');
      const ctx = canvas.getContext('2d');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      
      capturedPhotoData = canvas.toDataURL('image/jpeg', 0.8);
      
      const img = document.getElementById('capturedPhoto');
      img.src = capturedPhotoData;
      img.style.display = 'block';
      
      video.style.display = 'none';
      document.getElementById('btnTakePhoto').style.display = 'none';
      document.getElementById('btnRetakePhoto').style.display = 'inline-block';
      
      // Detener c√°mara
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
    }
    
    function retakePhoto() {
      capturedPhotoData = null;
      document.getElementById('capturedPhoto').style.display = 'none';
      document.getElementById('btnRetakePhoto').style.display = 'none';
      document.getElementById('btnStartCamera').style.display = 'inline-block';
    }
    
    async function crearPersonaje() {
      const nombre = document.getElementById('nombrePersonaje').value.trim();
      
      if (!nombre || !selectedClase) {
        showError('errorCrear', 'Completa todos los pasos');
        return;
      }
      
      // Detener c√°mara si est√° activa
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
      }
      
      try {
        console.log('Creando personaje:', nombre, selectedClase);
        
        const response = await fetch('/api/personaje/crear', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            usuarioId: currentUser.id,
            nombre,
            clase: selectedClase,
            fuerza: atributos.fuerza,
            resistencia: atributos.resistencia,
            agilidad: atributos.agilidad,
            inteligencia: atributos.inteligencia,
            avatar: capturedPhotoData || selectedAvatar,
            color: selectedColor
          })
        });
        
        const data = await response.json();
        console.log('Respuesta crear personaje:', data);
        
        if (data.success) {
          console.log('Personaje creado exitosamente, cargando...');
          await seleccionarPersonaje(data.personaje.id);
        } else {
          console.error('Error al crear personaje:', data.error);
          showError('errorCrear', data.error || 'Error al crear personaje');
        }
      } catch (error) {
        console.error('Error en crearPersonaje:', error);
        showError('errorCrear', 'Error de conexi√≥n. Verifica que el servidor est√© activo.');
      }
    }

    async function seleccionarPersonaje(personajeId) {
      console.log('Seleccionando personaje ID:', personajeId);
      
      try {
        const response = await fetch('/api/personaje/load', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ personajeId })
        });
        
        const data = await response.json();
        console.log('Respuesta cargar personaje:', data);
        
        if (data.success) {
          localStorage.setItem('playerId', data.player.id);
          console.log('Redirigiendo a survival.html...');
          window.location.href = '/survival.html';
        } else {
          console.error('Error al cargar personaje:', data.error);
          alert('Error al cargar personaje: ' + (data.error || 'Error desconocido'));
        }
      } catch (error) {
        console.error('Error en seleccionarPersonaje:', error);
        alert('Error de conexi√≥n al cargar personaje. Refresca la p√°gina e intenta de nuevo.');
      }
    }

    function showError(id, msg) {
      const el = document.getElementById(id);
      el.textContent = msg;
      el.classList.remove('hidden');
    }

    function hideError(id) {
      document.getElementById(id).classList.add('hidden');
    }
  </script>
</body>
</html>
