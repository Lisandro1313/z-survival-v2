<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ’» Z-SURVIVAL.exe</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      /* ğŸ¨ Sistema de jerarquÃ­a verde */
      --green-bright: #00ff00;     /* Acciones primarias, alertas crÃ­ticas */
      --green-medium: #00cc00;     /* Info importante, elementos activos */
      --green-dim: #006600;        /* Elementos pasivos, decorativos */
      --green-dark: #004400;       /* Backgrounds, menos prominente */
      
      /* Espaciado consistente */
      --spacing-xs: 5px;
      --spacing-sm: 10px;
      --spacing-md: 15px;
      --spacing-lg: 20px;
      --spacing-xl: 30px;
    }
    
    body {
      font-family: 'Courier New', monospace;
      background: #1a1a1a;
      color: var(--green-medium);
      padding: var(--spacing-sm);
    }
    
    #game {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    h1 {
      text-align: center;
      color: #ff0000;
      text-shadow: 2px 2px #000;
      margin-bottom: 10px;
    }

    /* SISTEMA DE PESTAÃ‘AS */
    .tabs-container {
      background: #2a2a2a;
      border: 2px solid var(--green-dim);
      border-radius: 5px;
      margin-top: var(--spacing-md);
    }

    .tabs-header {
      display: flex;
      background: #1a1a1a;
      border-bottom: 2px solid var(--green-dim);
      overflow-x: auto;
      flex-wrap: wrap;
    }

    .tab-button {
      background: #2a2a2a;
      color: var(--green-medium);
      border: none;
      padding: var(--spacing-md) var(--spacing-lg);
      cursor: pointer;
      font-family: inherit;
      font-size: 14px;
      border-right: 1px solid var(--green-dark);
      transition: all 0.3s;
      position: relative;
      white-space: nowrap;
    }

    .tab-button:hover {
      background: #3a3a3a;
      color: var(--green-bright);
    }

    .tab-button.active {
      background: var(--green-bright);
      color: #000;
      font-weight: bold;
      box-shadow: 0 2px 10px rgba(0, 255, 0, 0.3);
    }

    .tab-badge {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #ff0000;
      color: #fff;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.8; }
    }
    
    @keyframes flashGreen {
      0% { box-shadow: 0 0 0 rgba(0, 255, 0, 0); }
      50% { box-shadow: 0 0 20px rgba(0, 255, 0, 0.8); }
      100% { box-shadow: 0 0 0 rgba(0, 255, 0, 0); }
    }
    
    @keyframes flashRed {
      0% { box-shadow: 0 0 0 rgba(255, 0, 0, 0); }
      50% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.8); }
      100% { box-shadow: 0 0 0 rgba(255, 0, 0, 0); }
    }
    
    .flash-success {
      animation: flashGreen 0.5s ease-out;
    }
    
    .flash-danger {
      animation: flashRed 0.5s ease-out;
    }
    
    #actionFeedback {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 255, 0, 0.95);
      color: #000;
      padding: 20px 40px;
      border-radius: 10px;
      font-size: 24px;
      font-weight: bold;
      z-index: 10000;
      display: none;
      box-shadow: 0 0 30px rgba(0, 255, 0, 0.8);
    }
    
    /* ğŸ’¥ Sistema de feedback de consecuencias */
    #consequenceFeedback {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 9999;
      max-width: 300px;
      pointer-events: none;
    }
    
    .consequence-popup {
      background: rgba(0, 0, 0, 0.95);
      border: 2px solid var(--green-bright);
      padding: 12px 18px;
      margin-bottom: 8px;
      border-radius: 5px;
      font-size: 14px;
      font-weight: bold;
      animation: popupSlide 0.4s ease-out, popupFade 3s ease-in;
      box-shadow: 0 4px 15px rgba(0, 255, 0, 0.4);
    }
    
    .consequence-popup.positive {
      border-color: var(--green-bright);
      color: var(--green-bright);
    }
    
    .consequence-popup.negative {
      border-color: #ff0000;
      color: #ff0000;
    }
    
    .consequence-popup.warning {
      border-color: #ffff00;
      color: #ffff00;
    }
    
    .consequence-popup.neutral {
      border-color: #00ffff;
      color: #00ffff;
    }
    
    @keyframes popupSlide {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes popupFade {
      0%, 70% { opacity: 1; }
      100% { opacity: 0; }
    }
    
    /* Tabs de crafteo */
    .craft-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
    }
    
    .craft-tab {
      padding: 8px 15px;
      background: #1a1a1a;
      border: 1px solid #444;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.3s;
    }
    
    .craft-tab:hover {
      background: #2a2a2a;
      border-color: #00ff00;
    }
    
    .craft-tab.active {
      background: #00ff00;
      color: #000;
      border-color: #00ff00;
      font-weight: bold;
    }
    
    .craft-section {
      display: none;
    }
    
    .craft-section.active {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 5px;
    }
    
    /* Refugio visual */
    #refugioVisual {
      text-align: center;
      font-size: 48px;
      margin: 10px 0;
      line-height: 1.2;
    }
    
    /* BotÃ³n de sonido */
    #soundToggle {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #1a1a1a;
      border: 2px solid #00ff00;
      color: #00ff00;
      padding: 10px 15px;
      cursor: pointer;
      font-size: 20px;
      z-index: 1000;
      border-radius: 5px;
      transition: all 0.3s;
    }
    
    #soundToggle:hover {
      background: #00ff00;
      color: #000;
    }

    .tab-content {
      display: none;
      padding: var(--spacing-lg);
      animation: fadeIn 0.3s;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .container {
      display: grid;
      grid-template-columns: 1fr 2fr 1fr;
      gap: var(--spacing-md);
      margin-top: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }

    @media (max-width: 1024px) {
      .container {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
      
      .tab-button {
        padding: 12px 15px;
        font-size: 12px;
      }
    }
    
    .panel {
      background: #2a2a2a;
      border: 2px solid var(--green-dim);
      padding: var(--spacing-md);
      border-radius: 5px;
      transition: all 0.3s;
    }
    
    /* ğŸŒŸ Panel protagonista (destacado) */
    .panel.featured {
      border: 3px solid var(--green-bright);
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
      background: #2a3a2a;
      transform: scale(1.02);
    }
    
    .panel.featured h2 {
      color: var(--green-bright);
      font-size: 18px;
    }
    
    .panel h2 {
      color: #ffff00;
      margin-bottom: var(--spacing-sm);
      border-bottom: 1px solid var(--green-dim);
      padding-bottom: var(--spacing-xs);
      font-size: 16px;
    }
    
    .stat {
      margin: 8px 0;
      font-size: 14px;
    }
    
    .stat-bar {
      background: #000;
      height: 15px;
      border: 1px solid var(--green-dim);
      margin-top: var(--spacing-xs);
      position: relative;
      border-radius: 3px;
      overflow: hidden;
    }
    
    .stat-fill {
      height: 100%;
      transition: width 0.3s;
    }
    
    .stat-fill.salud { background: #ff0000; }
    .stat-fill.hambre { background: #ff8800; }
    .stat-fill.moral { background: #00ffff; }
    
    button {
      background: var(--green-dark);
      color: var(--green-medium);
      border: 2px solid var(--green-dim);
      padding: var(--spacing-sm) var(--spacing-md);
      margin: var(--spacing-xs) 2px;
      cursor: pointer;
      font-family: inherit;
      border-radius: 3px;
      transition: all 0.2s;
    }
    
    button:hover {
      background: var(--green-dim);
      color: var(--green-bright);
      border-color: var(--green-medium);
      transform: translateY(-1px);
    }
    
    /* BotÃ³n de acciÃ³n primaria */
    button.primary {
      background: var(--green-dim);
      color: var(--green-bright);
      border-color: var(--green-bright);
      font-weight: bold;
    }
    
    button.primary:hover {
      background: var(--green-bright);
      color: #000;
      box-shadow: 0 4px 15px rgba(0, 255, 0, 0.4);
    }
    
    button:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .location {
      padding: var(--spacing-sm);
      margin: var(--spacing-sm) 0;
      background: #1a1a1a;
      border-left: 3px solid var(--green-dim);
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 3px;
    }
    
    .location:hover {
      background: #2a2a2a;
      border-left-color: var(--green-medium);
      transform: translateX(5px);
    }
    
    .location.current {
      border-left-color: var(--green-bright);
      background: #2a3a2a;
      box-shadow: 0 0 10px rgba(0, 255, 0, 0.2);
    }
    
    .location.danger {
      border-left-color: #ff0000;
    }
    
    .npc {
      padding: var(--spacing-sm);
      margin: var(--spacing-sm) 0;
      background: #1a1a1a;
      border: 1px solid var(--green-dim);
      border-radius: 3px;
      transition: all 0.2s;
    }
    
    .npc:hover {
      border-color: var(--green-medium);
      background: #2a2a2a;
    }
    
    .npc.dead {
      opacity: 0.5;
      border-color: #666;
    }
    
    .npc-name {
      color: #ffff00;
      font-weight: bold;
    }
    
    .log {
      background: #000;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      border: 1px solid #00ff00;
      margin-top: 10px;
      font-size: 12px;
    }
    
    .log-entry {
      margin: 3px 0;
    }
    
    .log-combat { color: #ff0000; }
    .log-success { color: #00ff00; }
    .log-warning { color: #ffff00; }
    .log-death { color: #ff00ff; }
    
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.3; }
    }
    
    #login {
      max-width: 400px;
      margin: 100px auto;
      padding: 30px;
      background: #2a2a2a;
      border: 2px solid #00ff00;
      border-radius: 5px;
      text-align: center;
    }
    
    input {
      background: #000;
      color: #00ff00;
      border: 2px solid #00ff00;
      padding: 10px;
      font-family: inherit;
      width: 100%;
      margin: 10px 0;
      font-size: 16px;
    }
    
    .zombie-count {
      color: #ff0000;
      font-weight: bold;
    }

    .online-player {
      padding: 8px;
      margin: 5px 0;
      background: #1a3a1a;
      border-left: 3px solid #00ff00;
      font-size: 12px;
      border-radius: 3px;
    }

    .online-player-name {
      color: #00ff00;
      font-weight: bold;
    }

    .online-player-info {
      color: #888;
      font-size: 11px;
      margin-top: 3px;
    }

    .online-count {
      display: inline-block;
      background: #00ff00;
      color: #000;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: bold;
      margin-left: 5px;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #2a2a2a;
      border: 2px solid #00ff00;
      padding: 15px 20px;
      border-radius: 5px;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
      max-width: 300px;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .notification.success { border-color: #00ff00; }
    .notification.warning { border-color: #ffff00; }
    .notification.danger { border-color: #ff0000; }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .connection-status {
      position: fixed;
      bottom: 10px;
      right: 10px;
      padding: 5px 10px;
      background: #2a2a2a;
      border: 2px solid #00ff00;
      border-radius: 5px;
      font-size: 11px;
      z-index: 999;
    }

    .connection-status.connected { border-color: #00ff00; color: #00ff00; }
    .connection-status.disconnected { border-color: #ff0000; color: #ff0000; }
    
    /* Chat y Social mejorado */
    .chat-section { display: none; }
    .chat-section.active { display: block; }
    
    .dm-message {
      padding: 8px;
      margin: 5px 0;
      border-radius: 5px;
      font-size: 11px;
    }
    
    .dm-sent {
      background: #1a2a1a;
      border-left: 3px solid #00ff00;
      text-align: right;
    }
    
    .dm-received {
      background: #2a1a1a;
      border-left: 3px solid #ff8800;
    }
    
    .player-card-inspect {
      background: #1a2a1a;
      border: 2px solid #00ff00;
      padding: 10px;
      margin: 5px 0;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }
    
    .player-card-inspect:hover {
      background: #2a3a2a;
      border-color: #00ffff;
      transform: translateX(5px);
    }
    
    .player-card-inspect .rank-badge {
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 24px;
    }
    
    .title-badge {
      display: inline-block;
      padding: 2px 6px;
      background: linear-gradient(135deg, #1a1a3a, #3a1a3a);
      border: 1px solid #8888ff;
      border-radius: 3px;
      font-size: 9px;
      color: #aaaaff;
      margin-left: 5px;
      font-weight: bold;
    }
    
    .leaderboard-entry {
      background: #1a1a2a;
      border-left: 3px solid #888;
      padding: 10px;
      margin: 5px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s;
    }
    
    .leaderboard-entry:hover {
      background: #2a2a3a;
      transform: translateX(5px);
    }
    
    .leaderboard-entry.rank-1 { 
      border-left-color: #ffd700; 
      background: linear-gradient(90deg, #2a2a1a, #1a1a1a);
    }
    .leaderboard-entry.rank-2 { 
      border-left-color: #c0c0c0; 
      background: linear-gradient(90deg, #2a2a2a, #1a1a1a);
    }
    .leaderboard-entry.rank-3 { 
      border-left-color: #cd7f32; 
      background: linear-gradient(90deg, #2a1a1a, #1a1a1a);
    }
    
    .profile-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #0a0a0a;
      border: 3px solid #00ff00;
      padding: 20px;
      z-index: 9999;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 0 50px rgba(0, 255, 0, 0.5);
      border-radius: 5px;
    }
    
    .profile-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 9998;
      backdrop-filter: blur(3px);
    }
    
    .stat-comparison {
      display: flex;
      justify-content: space-between;
      padding: 5px;
      margin: 3px 0;
      background: #1a1a1a;
      font-size: 11px;
    }
    
    .stat-better { color: #ff8888; }
    .stat-worse { color: #88ff88; }
    
    /* ğŸŒŸ Estilos para historia destacada */
    #featuredStory:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0, 255, 0, 0.4) !important;
      background: linear-gradient(135deg, #1a3a1a, #3a1a1a);
    }
  </style>
</head>
<body>
  <!-- Indicador de estado de conexiÃ³n -->
  <div id="connectionStatus" class="connection-status connected">
    ğŸŸ¢ Conectado
  </div>
  
  <!-- Sistema de feedback de consecuencias -->
  <div id="consequenceFeedback"></div>

  <div id="game">
    <!-- Pantalla de login -->
    <div id="login">
      <h1 style="color: #ff0000; font-size: 32px; margin-bottom: 10px;">ğŸ’» Z-SURVIVAL.exe</h1>
      <p style="color: #00ff00; font-size: 14px; margin-bottom: 5px;">// Sistema de Supervivencia Multijugador v2.0</p>
      <p style="margin: 20px 0; color: #ff6666; font-style: italic;">El mundo estÃ¡ infectado. Los zombies dominan.<br>Â¿PodrÃ¡s sobrevivir?</p>
      
      <div style="border: 1px solid #00ff00; padding: 15px; margin: 20px 0; background: #1a1a1a;">
        <p style="font-size: 12px; color: #00ff00; margin-bottom: 10px;">âœ¨ CaracterÃ­sticas:</p>
        <p style="font-size: 11px; color: #aaa; text-align: left; line-height: 1.6;">
          ğŸ® Mundo compartido en tiempo real<br>
          ğŸ§Ÿ Sistema de supervivencia completo<br>
          ğŸ¤ CooperaciÃ³n y comercio entre jugadores<br>
          ğŸ  Refugio comunitario que defender<br>
          ğŸ“ˆ ProgresiÃ³n con skills y niveles<br>
          ğŸ¯ Misiones, eventos y narrativa dinÃ¡mica
        </p>
      </div>
      
      <input type="text" id="playerName" placeholder="Ingresa tu nombre de superviviente" maxlength="20" style="margin: 20px 0;">
      <button onclick="createPlayer()" style="width: 100%; padding: 15px; font-size: 18px; background: #006600; border: 2px solid #00ff00; color: #00ff00; cursor: pointer; font-weight: bold;">ğŸšª ENTRAR AL APOCALIPSIS</button>
      
      <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #333;">
        <p style="font-size: 11px; color: #666; margin-bottom: 10px;">Â¿Te gusta el proyecto?</p>
        <a href="https://link.mercadopago.com.ar/donaciondelproyecto" target="_blank" style="display: inline-block; padding: 8px 15px; background: #009ee3; color: white; text-decoration: none; border-radius: 3px; font-size: 12px; font-weight: bold;">ğŸ’ APOYAR CON UNA DONACIÃ“N</a>
        <p style="font-size: 10px; color: #555; margin-top: 8px;">Tu apoyo ayuda a mantener el servidor online ğŸ™</p>
      </div>
    </div>

    <!-- Pantalla de juego (oculta inicialmente) -->
    <div id="gameScreen" style="display:none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h1 style="margin: 0;">ğŸ’» Z-SURVIVAL.exe <span style="font-size: 14px; color: #888; font-weight: normal;">// alpha build</span></h1>
        <a href="https://link.mercadopago.com.ar/donaciondelproyecto" target="_blank" style="padding: 6px 12px; background: #009ee3; color: white; text-decoration: none; border-radius: 3px; font-size: 11px; font-weight: bold;">ğŸ’ Donar</a>
      </div>
      
      <!-- ğŸŒŸ HISTORIA DESTACADA DEL DÃA -->
      <div id="featuredStory" style="background: linear-gradient(135deg, #1a2a1a, #2a1a1a); border: 2px solid var(--green-bright); padding: 12px 18px; margin-bottom: 15px; border-radius: 5px; cursor: pointer; transition: all 0.3s; box-shadow: 0 0 15px rgba(0, 255, 0, 0.2);" onclick="handleFeaturedStoryClick()">
        <div style="display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 24px;">ğŸ“°</span>
          <div style="flex: 1;">
            <div style="font-size: 10px; color: var(--green-dim); text-transform: uppercase; letter-spacing: 1px;">HOY EN EL MUNDO</div>
            <div id="featuredStoryText" style="color: var(--green-bright); font-weight: bold; margin-top: 3px; font-size: 13px;">Cargando acontecimientos...</div>
          </div>
          <span style="color: var(--green-medium); font-size: 20px;">â†’</span>
        </div>
      </div>
      
      <!-- SISTEMA DE PESTAÃ‘AS -->
      <div class="tabs-container">
        <div class="tabs-header">
          <button class="tab-button active" onclick="switchTab('main')">
            ğŸ® JUEGO
          </button>
          <button class="tab-button" onclick="switchTab('missions')" id="tab-btn-missions">
            ğŸ“– MISIONES
            <span class="tab-badge" id="badge-missions" style="display: none;">!</span>
          </button>
          <button class="tab-button" onclick="switchTab('events')" id="tab-btn-events">
            ğŸ“œ EVENTOS
            <span class="tab-badge" id="badge-events" style="display: none;">!</span>
          </button>
          <button class="tab-button" onclick="switchTab('social')" id="tab-btn-social">
            ğŸ‘¥ SOCIAL
            <span class="tab-badge" id="badge-social" style="display: none;">!</span>
          </button>
          <button class="tab-button" onclick="switchTab('mundo')" id="tab-btn-mundo">
            ğŸŒ MUNDO
            <span class="tab-badge" id="badge-mundo" style="display: none;">!</span>
          </button>
          <button class="tab-button" onclick="switchTab('progression')">
            ğŸ“Š PROGRESIÃ“N
          </button>
          <button class="tab-button" onclick="switchTab('advanced')">
            âš¡ AVANZADO
          </button>
        </div>

        <!-- PESTAÃ‘A 1: JUEGO PRINCIPAL -->
        <div id="tab-main" class="tab-content active">
          <div class="container">
            <!-- Panel izquierdo: Stats del jugador -->
            <div class="panel">
              <h2>ğŸ‘¤ TU PERSONAJE</h2>
              <div id="playerStats"></div>
              
              <h2 style="margin-top: 20px;">ğŸ’ INVENTARIO</h2>
              <div id="inventory"></div>
              
              <h2 style="margin-top: 20px;">ğŸ  REFUGIO</h2>
              <div style="margin-bottom: 10px;">
                <strong id="defensas" style="color: #00aaff;">ğŸ›¡ï¸ Defensas: 0</strong>
              </div>
              <div id="refugioRecursos" style="font-size: 12px; margin-bottom: 10px;"></div>
              <button onclick="showDonateMenu()" style="width: 100%; padding: 8px; font-size: 11px; background: #006600; border: 1px solid #00ff00; cursor: pointer;">
                ğŸ’ DONAR AL REFUGIO
              </button>

              <div id="hordeWarning" style="display: none; background: #ff0000; padding: 10px; margin-top: 15px; animation: blink 1s infinite;">
                ğŸš¨ HORDA ACERCÃNDOSE
              </div>
            </div>
            
            <!-- Panel central: Mundo y acciones -->
            <div class="panel featured">
              <h2 id="locationName">ğŸ“ UbicaciÃ³n</h2>
              <p id="locationDesc" style="margin: 10px 0; color: #ccc;"></p>
              
              <div id="locationActions"></div>
              
              <h2 style="margin-top: 20px;">ï¿½ LOG PERSONAL</h2>
              <div class="log" id="log"></div>
              
              <h2 style="margin-top: 15px;">ğŸŒ LOG DEL MUNDO</h2>
              <div class="log" id="worldLog" style="max-height: 120px;"></div>
              
              <h2 style="margin-top: 20px;">ğŸ—ºï¸ MOVERTE A:</h2>
              <div id="locations"></div>
              
              <h2 style="margin-top: 20px;">ğŸ”¨ CRAFTEAR</h2>
              <div class="craft-tabs">
                <button class="craft-tab active" onclick="switchCraftTab('basic')">BÃSICO</button>
                <button class="craft-tab" onclick="switchCraftTab('advanced')">AVANZADO</button>
                <button class="craft-tab" onclick="switchCraftTab('epic')">LEGENDARIO</button>
              </div>
              
              <div id="craft-basic" class="craft-section active" style="font-size: 11px;">
                <button onclick="craft('vendaje')" style="background: #003300; border: 1px solid #006600;">ğŸ’Š Vendaje<br><small>(2 mat)</small></button>
                <button onclick="craft('molotov')" style="background: #330000; border: 1px solid #660000;">ğŸ”¥ Molotov<br><small>(3 mat, 1 com)</small></button>
                <button onclick="craft('barricada')" style="background: #003333; border: 1px solid #006666;">ğŸš§ Barricada<br><small>(5 mat)</small></button>
                <button onclick="craft('trampa')" style="background: #333300; border: 1px solid #666600;">ğŸª¤ Trampa<br><small>(4 mat, 1 arm)</small></button>
              </div>
              
              <div id="craft-advanced" class="craft-section" style="font-size: 11px;">
                <button onclick="craft('antibiotico')" style="background: #1a4a1a; border: 2px solid #00ff00;">ğŸ’‰ AntibiÃ³tico<br><small>(2 med, 1 mat)</small></button>
                <button onclick="craft('machete')" style="background: #4a1a1a; border: 2px solid #ff6600;">ğŸ”ª Machete<br><small>(6 mat, 1 arm)</small></button>
                <button onclick="craft('pistola_mejorada')" style="background: #3a0a0a; border: 2px solid #ff0000;">ğŸ”« Pistola+<br><small>(3 arm, 5 mat)</small></button>
                <button onclick="craft('armadura_ligera')" style="background: #1a3a4a; border: 2px solid #0088ff;">ğŸ¦º Armadura<br><small>(8 mat, 2 com)</small></button>
                <button onclick="craft('botiquin')" style="background: #2a1a3a; border: 2px solid #aa00ff;">âš•ï¸ BotiquÃ­n<br><small>(3 med, 2 mat)</small></button>
                <button onclick="craft('radio')" style="background: #2a2a4a; border: 2px solid #4488ff;">ğŸ“» Radio<br><small>(15 mat, 1 arm)</small></button>
              </div>
              
              <div id="craft-epic" class="craft-section" style="font-size: 11px;">
                <button onclick="craft('explosivo')" style="background: #4a1a2a; border: 3px solid #ff0000;">ğŸ’£ Explosivo<br><small>(10 mat, 2 arm, 3 com)</small></button>
                <button onclick="craft('generador')" style="background: #3a3a1a; border: 2px solid #ffff00;">âš¡ Generador<br><small>(20 mat, 3 arm)</small></button>
              </div>
            </div>
            
            <!-- Panel derecho: Info rÃ¡pida -->
            <div class="panel">
              <h2>ğŸ›¡ï¸ DEFENSAS REFUGIO</h2>
              <div id="defensas" style="font-size: 20px; color: #00ffff; margin: 10px 0;"></div>

              <h2>ğŸŒ™ CICLO DÃA/NOCHE</h2>
              <div id="timeDisplay" style="font-size: 18px; text-align: center; margin: 10px 0;">
                â˜€ï¸ DÃ­a 1 - 08:00
              </div>

              <h2 style="margin-top: 15px;">ğŸ—ºï¸ LOCACIÃ“N ACTUAL</h2>
              <div id="locationInfo" style="font-size: 12px; line-height: 1.6;">
                <div id="locationZombies">ğŸ§Ÿ Zombies: 0</div>
                <div id="locationRuido">ğŸ”Š Ruido: 0</div>
                <div id="locationDefensas">ğŸ›¡ï¸ Defensas: 0</div>
              </div>

              <h2 style="margin-top: 15px;">ğŸ“‹ ACCIONES RÃPIDAS</h2>
              <div style="display: grid; gap: 5px; font-size: 11px;">
                <button onclick="quickAction('scavenge')" style="padding: 8px; background: #00aa00; border: 2px solid #00ff00;">
                  ğŸ” Buscar Recursos<br><small style="opacity: 0.8;">+XP +Items</small>
                </button>
                <button onclick="quickAction('attack')" style="padding: 8px; background: #aa0000; border: 2px solid #ff0000;">
                  âš”ï¸ Atacar Zombies<br><small style="opacity: 0.8;">Alto riesgo</small>
                </button>
                <button onclick="quickAction('rest')" style="padding: 8px; background: #004444; border: 1px solid #008888;">
                  ğŸ˜´ Descansar<br><small style="opacity: 0.8;">+10 salud -5 hambre</small>
                </button>
                <button onclick="quickAction('eat')" style="padding: 8px; background: #443300; border: 1px solid #886600;">
                  ğŸ– Comer<br><small style="opacity: 0.8;">+40 hambre +5 salud</small>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- PESTAÃ‘A MISIONES NARRATIVAS -->
        <div id="tab-missions" class="tab-content">
          <div class="container">
            <!-- Panel principal: MisiÃ³n en curso o lista de misiones -->
            <div class="panel" style="grid-column: 1 / -1;">
              <div id="narrativeMissionActive" style="display: none;">
                <!-- MISIÃ“N EN CURSO -->
                <h2 id="narrativeMissionTitle" style="margin-bottom: 15px;">ğŸ“– MisiÃ³n en Curso</h2>
                
                <!-- Texto narrativo -->
                <div id="narrativeStoryText" style="
                  background: linear-gradient(135deg, #1a1a2a 0%, #2a1a1a 100%);
                  border: 2px solid #ffaa00;
                  border-radius: 8px;
                  padding: 20px;
                  margin-bottom: 20px;
                  font-size: 14px;
                  line-height: 1.6;
                  color: #ffffff;
                  text-align: left;
                  min-height: 100px;
                ">
                  Cargando...
                </div>

                <!-- Timer y modo -->
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                  <div id="narrativeTimer" style="
                    background: #ff4444;
                    color: white;
                    padding: 10px 20px;
                    border-radius: 5px;
                    font-weight: bold;
                    font-size: 18px;
                  ">
                    â±ï¸ 20s
                  </div>
                  <div id="narrativeMode" style="
                    background: #4444ff;
                    color: white;
                    padding: 10px 20px;
                    border-radius: 5px;
                    font-weight: bold;
                  ">
                    ğŸ‘¤ SOLO
                  </div>
                </div>

                <!-- VotaciÃ³n grupal (si aplica) -->
                <div id="narrativeVoting" style="display: none; margin-bottom: 15px;">
                  <div style="background: #2a2a4a; padding: 15px; border-radius: 5px;">
                    <h3 style="color: #ffaa00; margin-bottom: 10px;">ğŸ—³ï¸ VOTACIÃ“N EN CURSO</h3>
                    <div id="voteCount" style="font-size: 14px; color: #ccc;">
                      Votos: 0 / 0
                    </div>
                  </div>
                </div>

                <!-- Opciones de elecciÃ³n -->
                <div id="narrativeChoices" style="
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 15px;
                  margin-bottom: 20px;
                ">
                  <!-- Se llenarÃ¡n dinÃ¡micamente -->
                </div>

                <!-- BotÃ³n abandonar -->
                <button onclick="abandonNarrativeMission()" style="
                  background: #666;
                  color: white;
                  border: none;
                  padding: 8px 15px;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 12px;
                ">
                  âŒ Abandonar MisiÃ³n
                </button>
              </div>

              <div id="narrativeMissionList">
                <!-- LISTA DE MISIONES DISPONIBLES -->
                <h2>ğŸ“– MISIONES NARRATIVAS DISPONIBLES</h2>
                <p style="font-size: 12px; color: #888; margin-bottom: 20px;">
                  Misiones interactivas con historia, decisiones y consecuencias reales.
                </p>
                
                <button onclick="loadNarrativeMissions()" style="padding: 8px 15px; margin-bottom: 15px;">
                  ğŸ”„ Actualizar Misiones
                </button>

                <div id="narrativeMissionCards" style="
                  display: grid;
                  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                  gap: 15px;
                ">
                  <p style="text-align: center; color: #888;">Cargando misiones...</p>
                </div>
              </div>
            </div>

            <!-- Panel de info/historial -->
            <div class="panel" style="grid-column: 1 / -1;">
              <h2>ğŸ“Š ESTADÃSTICAS DE MISIONES</h2>
              <div id="narrativeMissionStats" style="font-size: 12px;">
                <p style="color: #888;">Completa misiones para ver tus estadÃ­sticas.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- PESTAÃ‘A 2: EVENTOS & MISIONES -->
        <div id="tab-events" class="tab-content">
          <div class="container">
            <div class="panel featured">
              <h2>ğŸ“œ MISIONES ACTIVAS <span id="missionCount" style="font-size: 12px; color: #ffaa00;"></span></h2>
              <div id="missionsPanel" style="font-size: 11px; max-height: 300px; overflow-y: auto;">
                <em style="color: #888;">Sin misiones disponibles</em>
              </div>
              
              <h2 style="margin-top: 20px;">ğŸ“œ LOG PERSONAL</h2>
              <div class="log" id="log2" style="max-height: 200px;"></div>
            </div>

            <div class="panel">
              <h2>ğŸ“‹ QUESTS</h2>
              <div id="quests" style="margin: 10px 0; font-size: 13px;"></div>

              <h2 style="margin-top: 20px;">ğŸ¤ QUEST COOPERATIVA</h2>
              <div id="questCooperativa" style="min-height: 80px; font-size: 12px; background: #1a3a3a; padding: 10px; border-radius: 5px;">
                <em style="color: #888;">Sin quest activa</em>
              </div>
              
              <h2 style="margin-top: 20px;">ğŸ’¬ DIÃLOGOS ACTIVOS</h2>
              <div id="interactiveDialogue" style="min-height: 120px; font-size: 12px; background: #1a2a3a; padding: 10px; border-radius: 5px;">
                <em style="color: #888;">Sin conversaciones activas</em>
              </div>
            </div>

            <div class="panel">
              <h2>ğŸ­ EVENTO ESPECIAL</h2>
              <div id="specialEvent" style="min-height: 100px; font-size: 12px;">
                <em style="color: #888;">Sin eventos</em>
              </div>

              <h2 style="margin-top: 20px;">ğŸ‘¥ NPCs EN REFUGIO</h2>
              <div id="npcs"></div>

              <h2 style="margin-top: 20px;">ğŸ§‘â€ğŸ¤â€ğŸ§‘ JUGADORES AQUÃ</h2>
              <div id="playersHere" style="font-size: 12px; min-height: 40px;">
                <em style="color: #888;">Solo tÃº</em>
              </div>
            </div>
          </div>
        </div>

        <!-- PESTAÃ‘A 3: SOCIAL -->
        <div id="tab-social" class="tab-content">
          <div class="container">
            <div class="panel">
              <h2>ğŸŒ JUGADORES ONLINE <span id="onlineCount" class="online-count">0</span></h2>
              <div id="onlinePlayers" style="font-size: 12px; max-height: 400px; overflow-y: auto;">
                <em style="color: #888;">Cargando...</em>
              </div>
            </div>

            <div class="panel">
              <h2>ğŸ‘¥ MI GRUPO <span id="groupMemberCount" style="font-size: 12px; color: #00ff00;"></span></h2>
              <div id="groupPanel" style="font-size: 12px;">
                <button onclick="createGroup()" style="width: 100%; padding: 10px; margin: 5px 0;">â• Crear Grupo</button>
              </div>
            </div>

            <div class="panel">
              <h2>ğŸ’¬ CHAT & MENSAJES</h2>
              <div class="craft-tabs" style="margin-bottom: 5px;">
                <button class="craft-tab active" onclick="switchChatTab('global')">ğŸŒ GLOBAL</button>
                <button class="craft-tab" onclick="switchChatTab('dms')" id="dmTabBtn">
                  ğŸ’Œ PRIVADOS
                  <span id="dmBadge" style="display: none; position: absolute; top: -5px; right: -5px; background: #ff0000; color: #fff; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; line-height: 16px;">0</span>
                </button>
              </div>
              
              <!-- Chat Global -->
              <div id="chat-global" class="chat-section active">
                <div class="log" id="chatLog" style="max-height: 300px; background: #1a1a2e;"></div>
                <div style="display: flex; gap: 5px; margin-top: 10px;">
                  <input type="text" id="chatInput" placeholder="Mensaje global..." maxlength="100" style="flex: 1; padding: 10px; font-size: 12px;" onkeypress="if(event.key==='Enter') sendChat()">
                  <button onclick="sendChat()" style="padding: 10px 15px;">ğŸ“¤</button>
                </div>
                <div style="margin-top: 5px; font-size: 10px; color: #888;">
                  Comandos: /help /stats /online /loc /skills
                </div>
              </div>
              
              <!-- Mensajes Privados -->
              <div id="chat-dms" class="chat-section">
                <div style="margin-bottom: 10px;">
                  <label style="font-size: 11px; color: #888;">Enviar a:</label>
                  <select id="dmTargetSelect" style="width: 100%; padding: 5px; background: #1a1a1a; border: 1px solid #333; color: #fff; margin: 5px 0;">
                    <option value="">Selecciona jugador...</option>
                  </select>
                </div>
                <div id="dmLog" style="height: 250px; overflow-y: auto; border: 1px solid #333; padding: 10px; background: #0a0a0a; margin-bottom: 10px;"></div>
                <div style="display: flex; gap: 5px;">
                  <input type="text" id="dmInput" placeholder="Mensaje privado..." maxlength="100" style="flex: 1; padding: 10px; background: #1a1a1a; border: 1px solid #333; color: #fff; font-size: 12px;" onkeypress="if(event.key==='Enter') sendDM()">
                  <button onclick="sendDM()" style="padding: 10px 15px;">ğŸ“¨</button>
                </div>
              </div>
            </div>
          </div>

          <div class="container" style="margin-top: 15px;">
            <div class="panel" style="grid-column: span 3;">
              <h2>ğŸ’± COMERCIO ENTRE JUGADORES</h2>
              <div id="tradePanel" style="font-size: 12px;">
                <div style="margin: 10px 0;">
                  <p style="color: #888; margin-bottom: 10px;">Selecciona un jugador y crea una oferta de intercambio</p>
                  <select id="tradeTargetSelect" style="width: 100%; padding: 8px; background: #000; color: #00ff00; border: 1px solid #00ff00; margin-bottom: 10px;">
                    <option>Cargando jugadores...</option>
                  </select>
                  <button onclick="openTradeDialog()" style="width: 100%; padding: 10px;">ğŸ¤ Crear Oferta de Intercambio</button>
                </div>
                <h3 style="margin-top: 15px;">Ofertas Recibidas:</h3>
                <div id="tradeOffers" style="max-height: 200px; overflow-y: auto;">
                  <em style="color: #888;">Sin ofertas pendientes</em>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- PESTAÃ‘A 4: MUNDO VIVO -->
        <div id="tab-mundo" class="tab-content">
          <div class="container">
            <!-- Misiones DinÃ¡micas -->
            <div class="panel" style="grid-column: 1 / -1;">
              <h2>âš¡ MISIONES DINÃMICAS <span id="questCountBadge" style="font-size: 12px; color: #00ff00;"></span></h2>
              <p style="font-size: 11px; color: #888; margin-bottom: 10px;">
                Misiones generadas por los dramas y eventos del mundo. Â¡IntervÃ©n en las historias de los NPCs!
              </p>
              <button onclick="refreshQuests()" style="padding: 8px 15px; margin-bottom: 10px;">ğŸ”„ Refrescar</button>
              <div id="questsList" style="max-height: 400px; overflow-y: auto;">
                <p style="text-align: center; color: #888; padding: 20px;">
                  â³ Cargando misiones...
                </p>
              </div>
            </div>

            <!-- Feed de Noticias del Mundo -->
            <div class="panel" style="grid-column: 1 / -1;">
              <h2>ğŸ“° FEED DEL MUNDO</h2>
              <p style="font-size: 11px; color: #888; margin-bottom: 10px;">
                Lee lo que estÃ¡ pasando en el mundo. Los NPCs viven sus propias vidas...
              </p>
              <button onclick="refreshWorldEvents()" style="padding: 8px 15px; margin-bottom: 10px;">ğŸ”„ Refrescar</button>
              <div id="worldEventsFeed" style="max-height: 500px; overflow-y: auto; font-size: 11px;">
                <p style="text-align: center; color: #888; padding: 20px;">
                  â³ Cargando eventos del mundo...
                </p>
              </div>
            </div>

            <!-- Relaciones Intensas -->
            <div class="panel">
              <h2>ğŸ’• RELACIONES DRAMÃTICAS</h2>
              <p style="font-size: 11px; color: #888; margin-bottom: 10px;">
                NPCs con relaciones intensas: amores, odios, rivalidades...
              </p>
              <div id="intenseRelationships" style="max-height: 300px; overflow-y: auto; font-size: 11px;">
                <p style="color: #888;">Sin relaciones dramÃ¡ticas...</p>
              </div>
            </div>

            <!-- EstadÃ­sticas del Mundo -->
            <div class="panel">
              <h2>ğŸŒ ESTADO DEL MUNDO</h2>
              <div id="worldStats" style="font-size: 11px;">
                <p style="color: #888;">Cargando...</p>
              </div>
            </div>

            <!-- Acciones AutÃ³nomas de NPCs (IA) -->
            <div class="panel" style="grid-column: 1 / -1;">
              <h2>ğŸ¤– ACCIONES AUTÃ“NOMAS DE NPCs</h2>
              <p style="font-size: 11px; color: #888; margin-bottom: 10px;">
                Los NPCs toman decisiones por sÃ­ mismos basadas en su personalidad, relaciones y memoria...
              </p>
              <div id="npcActionsLog" style="max-height: 350px; overflow-y: auto; font-size: 11px;">
                <p style="text-align: center; color: #888;">Sin acciones registradas...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- PESTAÃ‘A 5: PROGRESIÃ“N -->
        <div id="tab-progression" class="tab-content">
          <div class="container">
            <div class="panel">
              <h2>ğŸ† LOGROS <span id="achievementCount" style="font-size: 12px; color: #ffaa00;"></span></h2>
              <div id="achievements" style="font-size: 11px; max-height: 400px; overflow-y: auto;">
                <em style="color: #888;">Sin logros desbloqueados</em>
              </div>
            </div>

            <div class="panel">
              <h2>ğŸ“Š TUS ESTADÃSTICAS</h2>
              <div id="playerStats2" style="font-size: 12px; line-height: 1.8;">
                <div>ğŸ§Ÿ Zombies: 0</div>
                <div>ğŸ”¨ Crafteos: 0</div>
                <div>ğŸ—ºï¸ Locaciones: 1</div>
                <div>ğŸ“¦ Recursos: 0</div>
              </div>

              <h2 style="margin-top: 20px;">ğŸ“ˆ TUS SKILLS</h2>
              <div id="skills" style="font-size: 12px;"></div>
            </div>

            <div class="panel">
              <h2>ğŸ—ï¸ MEJORAS REFUGIO</h2>
              <div id="refugioUpgrades" style="font-size: 11px;">
                <button onclick="upgradeRefugio('torre_vigilancia')" style="width: 100%; margin: 4px 0; padding: 8px; font-size: 11px;">ğŸ—¼ Torre (30 mat, 5 arm)</button>
                <button onclick="upgradeRefugio('enfermeria')" style="width: 100%; margin: 4px 0; padding: 8px; font-size: 11px;">âš•ï¸ EnfermerÃ­a (25 mat, 10 med)</button>
                <button onclick="upgradeRefugio('taller')" style="width: 100%; margin: 4px 0; padding: 8px; font-size: 11px;">ğŸ”§ Taller (35 mat, 3 arm)</button>
                <button onclick="upgradeRefugio('huerto')" style="width: 100%; margin: 4px 0; padding: 8px; font-size: 11px;">ğŸŒ± Huerto (20 mat, 5 com)</button>
                <button onclick="upgradeRefugio('armeria')" style="width: 100%; margin: 4px 0; padding: 8px; font-size: 11px;">ğŸ¯ ArmerÃ­a (40 mat, 15 arm)</button>
              </div>

              <h2 style="margin-top: 20px;">â° TIEMPO</h2>
              <div id="worldTime" style="font-size: 18px; color: #ffff00;"></div>
            </div>
          </div>
          
          <!-- LEADERBOARD -->
          <div class="container" style="margin-top: 15px;">
            <div class="panel" style="grid-column: span 3;">
              <h2>ğŸ† TABLA DE LÃDERES</h2>
              <div class="craft-tabs" style="margin-bottom: 10px;">
                <button class="craft-tab active" onclick="switchLeaderboard('zombies')">ğŸ§Ÿ ZOMBIES</button>
                <button class="craft-tab" onclick="switchLeaderboard('nivel')">ğŸ“Š NIVEL</button>
                <button class="craft-tab" onclick="switchLeaderboard('dias')">ğŸ“… DÃAS</button>
                <button class="craft-tab" onclick="switchLeaderboard('prestigio')">ğŸ‘‘ PRESTIGIO</button>
              </div>
              <div id="leaderboardContent" style="font-size: 11px; max-height: 350px; overflow-y: auto;">
                <em style="color: #888;">Cargando rankings...</em>
              </div>
            </div>
          </div>
        </div>

        <!-- PESTAÃ‘A 5: AVANZADO -->
        <div id="tab-advanced" class="tab-content">
          <div class="container">
            <div class="panel">
              <h2>ğŸ¾ TU MASCOTA</h2>
              <div id="petPanel" style="font-size: 11px;">
                <p style="color: #888;">No tienes mascota</p>
                <button onclick="adoptPet('perro')" style="width: 100%; padding: 8px; margin: 3px 0; font-size: 11px;">ğŸ• Adoptar Perro</button>
                <button onclick="adoptPet('lobo')" style="width: 100%; padding: 8px; margin: 3px 0; font-size: 11px;">ğŸº Adoptar Lobo</button>
                <button onclick="adoptPet('cuervo')" style="width: 100%; padding: 8px; margin: 3px 0; font-size: 11px;">ğŸ¦… Adoptar Cuervo</button>
              </div>

              <h2 style="margin-top: 20px;">âš¡ HABILIDADES ESPECIALES</h2>
              <div id="abilitiesPanel" style="font-size: 11px;">
                <em style="color: #888;">Desbloquea habilidades con tu clase</em>
              </div>
            </div>

            <div class="panel">
              <h2>âš”ï¸ TU FACCIÃ“N <span id="factionRank" style="font-size: 12px; color: #ff8800;"></span></h2>
              <div id="factionPanel" style="font-size: 11px;">
                <p style="color: #888; margin-bottom: 10px;">Ãšnete a una facciÃ³n para desbloquear recompensas</p>
                <button onclick="joinFaction('refugio')" style="width: 100%; padding: 8px; margin: 3px 0; font-size: 10px;">ğŸ  Los Refugiados</button>
                <button onclick="joinFaction('nomadas')" style="width: 100%; padding: 8px; margin: 3px 0; font-size: 10px;">ğŸš¶ NÃ³madas</button>
                <button onclick="joinFaction('cientificos')" style="width: 100%; padding: 8px; margin: 3px 0; font-size: 10px;">ğŸ”¬ Los CientÃ­ficos</button>
                <button onclick="joinFaction('saqueadores')" style="width: 100%; padding: 8px; margin: 3px 0; font-size: 10px;">ğŸ’€ Saqueadores</button>
              </div>
            </div>

            <div class="panel">
              <h2>ğŸš— TU VEHÃCULO</h2>
              <div id="vehiclePanel" style="font-size: 11px;">
                <p style="color: #888; margin-bottom: 10px;">Construye un vehÃ­culo para moverte mÃ¡s rÃ¡pido y con mÃ¡s seguridad</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                  <button onclick="craftVehicle('bicicleta')" style="padding: 8px; font-size: 10px;">ğŸš² Bicicleta<br><small>(10 mat, 5 arm)</small></button>
                  <button onclick="craftVehicle('moto')" style="padding: 8px; font-size: 10px;">ğŸï¸ Moto<br><small>(30 mat, 20 arm)</small></button>
                  <button onclick="craftVehicle('auto')" style="padding: 8px; font-size: 10px;">ğŸš— Auto<br><small>(50 mat, 30 arm)</small></button>
                  <button onclick="craftVehicle('blindado')" style="padding: 8px; font-size: 10px;">ğŸš Blindado<br><small>(100 mat, 60 arm)</small></button>
                </div>
              </div>
            </div>
          </div>

          <div class="container" style="margin-top: 15px;">
            <div class="panel" style="grid-column: span 3;">
              <h2>âš”ï¸ ARENA PvP <span id="pvpQueue" style="font-size: 12px; color: #ff0000;"></span></h2>
              <div id="pvpPanel" style="font-size: 12px;">
                <p style="color: #888; margin-bottom: 10px;">EnfrÃ©ntate a otros jugadores en combate directo. Requisitos: 50+ salud</p>
                <button onclick="enterPvPArena()" style="padding: 15px; font-size: 14px; width: 200px;">ğŸ›¡ï¸ Entrar a la Arena</button>
                <div id="pvpMatch" style="margin-top: 15px; display: none; background: #3a1a1a; padding: 15px; border-radius: 5px;">
                  <h3 id="pvpMatchTitle">COMBATE EN CURSO</h3>
                  <div style="display: flex; justify-content: space-between; margin: 15px 0;">
                    <div style="flex: 1;">
                      <h4 id="pvpPlayer1">Jugador 1</h4>
                      <div class="stat-bar" style="width: 150px;">
                        <div id="pvpPlayer1HP" class="stat-fill salud" style="width: 100%;"></div>
                      </div>
                    </div>
                    <div style="align-self: center; font-size: 24px;">âš”ï¸</div>
                    <div style="flex: 1; text-align: right;">
                      <h4 id="pvpPlayer2">Jugador 2</h4>
                      <div class="stat-bar" style="width: 150px; float: right;">
                        <div id="pvpPlayer2HP" class="stat-fill salud" style="width: 100%;"></div>
                      </div>
                    </div>
                  </div>
                  <button id="pvpAttackBtn" onclick="attackInPvP()" style="width: 100%; padding: 12px; font-size: 16px; background: #880000;">âš”ï¸ ATACAR</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
  
  <!-- Modal de perfil de jugador -->
  <div id="profileBackdrop" class="profile-backdrop" style="display: none;" onclick="closeProfile()"></div>
  <div id="profileModal" class="profile-modal" style="display: none;">
    <div style="text-align: right; margin-bottom: 10px;">
      <button onclick="closeProfile()" style="padding: 5px 10px; background: #aa0000;">âœ– Cerrar</button>
    </div>
    <div id="profileContent"></div>
  </div>
  
  <button id="soundToggle" onclick="toggleSound()" title="Activar/Desactivar sonidos">ğŸ”‡</button>

  <script>
    let ws = null;
    let player = null;
    let world = null;
    let worldLogMessages = []; // Log de eventos del mundo
    let pingInterval = null;
    let reconnectTimeout = null;
    let activeDialogue = null; // DiÃ¡logo activo con NPC
    let dialogueHistory = []; // Historial de conversaciÃ³n
    let soundEnabled = false; // Sonido desactivado por defecto
    let audioContext = null;
    let directMessages = {}; // Almacenar DMs por jugador {playerId: [{from, to, message, timestamp}]}
    let unreadDMs = 0; // Contador de DMs no leÃ­dos
    let currentDMTarget = null; // Jugador actual en vista de DM
    let allPlayers = {}; // CachÃ© de todos los jugadores online
    let currentLeaderboard = 'zombies'; // Leaderboard actual
    let pendingActions = new Set(); // Prevenir acciones duplicadas
    let renderCache = {}; // CachÃ© de renders para evitar actualizaciones innecesarias
    let tabsLoaded = { game: true }; // Tabs ya cargados (game se carga al inicio)

    // Helper para hash simple de objetos
    function simpleHash(obj) {
      return JSON.stringify(obj);
    }

    // Render con cachÃ© - solo actualiza si cambiÃ³ el contenido
    function cachedRender(key, renderFn, dependencies) {
      const hash = simpleHash(dependencies);
      if (renderCache[key] !== hash) {
        renderFn();
        renderCache[key] = hash;
      }
    }

    // Helper para fetch con manejo de errores robusto
    async function safeFetch(url, options = {}) {
      try {
        const response = await fetch(url, options);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.success && data.error) {
          log(`âŒ ${data.error}`, 'warning');
          playSound('error');
          return { success: false, error: data.error };
        }
        
        return data;
      } catch (error) {
        console.error('Error en fetch:', error);
        log(`âŒ Error de conexiÃ³n: ${error.message}`, 'warning');
        playSound('error');
        return { success: false, error: error.message };
      }
    }

    // Al cargar, verificar si hay un personaje seleccionado
    window.addEventListener('DOMContentLoaded', () => {
      const playerId = localStorage.getItem('playerId');
      
      if (!playerId) {
        // Sin personaje, redirigir al login
        window.location.href = '/index.html';
        return;
      }
      
      // Tenemos playerId, ocultar login y mostrar juego
      player = { id: playerId };
      document.getElementById('login').style.display = 'none';
      document.getElementById('gameScreen').style.display = 'block';
      connectWebSocket();
    });

    function log(message, type = '') {
      // Determinar Ã­cono segÃºn tipo
      let icon = 'â„¹ï¸';
      if (type === 'success') icon = 'âœ…';
      else if (type === 'warning') icon = 'âš ï¸';
      else if (type === 'combat') icon = 'âš”ï¸';
      else if (type === 'death') icon = 'ğŸ’€';
      
      // Reproducir sonido
      if (type === 'success') playSound('success');
      else if (type === 'warning') playSound('warning');
      else if (type === 'combat') playSound('combat');
      else if (type === 'death') playSound('death');
      
      // Log principal
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `${icon} [${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
      
      // Limitar a 50 entradas
      while (logDiv.children.length > 50) {
        logDiv.removeChild(logDiv.firstChild);
      }
      
      // TambiÃ©n agregar al log de eventos
      const logDiv2 = document.getElementById('log2');
      if (logDiv2) {
        const entry2 = document.createElement('div');
        entry2.className = `log-entry log-${type}`;
        entry2.textContent = `${icon} [${new Date().toLocaleTimeString()}] ${message}`;
        logDiv2.appendChild(entry2);
        logDiv2.scrollTop = logDiv2.scrollHeight;
        
        while (logDiv2.children.length > 50) {
          logDiv2.removeChild(logDiv2.firstChild);
        }
      }
    }
    
    function worldLog(message, category = '') {
      // Ãconos por categorÃ­a
      const icons = {
        player: 'ğŸ§',
        zombie: 'ğŸ§Ÿ',
        npc: 'ğŸ‘¤',
        event: 'ğŸ­',
        horde: 'ğŸš¨',
        trade: 'ğŸ’±',
        faction: 'âš”ï¸',
        pet: 'ğŸ¾',
        vehicle: 'ğŸš—',
        pvp: 'âš”ï¸',
        special: 'â­'
      };
      const icon = icons[category] || 'ğŸŒ';
      
      const logDiv = document.getElementById('worldLog');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${category}`;
      entry.textContent = `${icon} [${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
      
      // Mantener solo Ãºltimos 20 mensajes
      while (logDiv.children.length > 20) {
        logDiv.removeChild(logDiv.firstChild);
      }
    }

    // ====================================
    // SISTEMA DE SONIDO
    // ====================================
    function toggleSound() {
      soundEnabled = !soundEnabled;
      const btn = document.getElementById('soundToggle');
      btn.textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
      btn.title = soundEnabled ? 'Desactivar sonidos' : 'Activar sonidos';
      
      if (soundEnabled && !audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      
      if (soundEnabled) {
        playSound('success');
      }
    }
    
    // Sistema de audio para sonidos reales
    const audioFiles = {};
    let audioVolume = 0.85;

    function loadAudioFile(name, path) {
      const audio = new Audio(path);
      audio.volume = audioVolume;
      audioFiles[name] = audio;
    }

    // Cargar archivos de sonido
    loadAudioFile('npc_saludo', '/sounds/SaludoinicialNpcMale.m4a');
    loadAudioFile('npc_charla', '/sounds/CharlamediaNpcMale.m4a');
    loadAudioFile('npc_despedida', '/sounds/DespedidaNpcMale.m4a');
    loadAudioFile('ataque_melee', '/sounds/AtacoMele.m4a');
    loadAudioFile('recibo_dano', '/sounds/ReciboDaÃ±o.m4a');

    function playSound(type) {
      if (!soundEnabled) return;
      
      // Intentar reproducir archivo de audio real primero
      if (audioFiles[type]) {
        const audio = audioFiles[type].cloneNode();
        audio.volume = audioVolume;
        audio.play().catch(err => console.log('Error reproduciendo sonido:', err));
        return;
      }

      // Fallback a tonos sintetizados
      if (!audioContext) return;
      
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      // Diferentes tonos segÃºn tipo
      switch(type) {
        case 'success':
          oscillator.frequency.value = 800;
          oscillator.type = 'sine';
          gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
          break;
        case 'error':
          oscillator.frequency.value = 200;
          oscillator.type = 'sawtooth';
          gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
          break;
        case 'warning':
          oscillator.frequency.value = 400;
          oscillator.type = 'triangle';
          gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
          break;
        case 'combat':
          oscillator.frequency.value = 150;
          oscillator.type = 'square';
          gainNode.gain.setValueAtTime(0.12, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
          break;
        case 'levelup':
          // Sonido ascendente Ã©pico
          oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
          oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.3);
          oscillator.type = 'sine';
          gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
          oscillator.stop(audioContext.currentTime + 0.3);
          return;
        case 'loot':
          // Sonido de pickup
          oscillator.frequency.value = 1000;
          oscillator.type = 'sine';
          gainNode.gain.setValueAtTime(0.08, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.08);
          oscillator.stop(audioContext.currentTime + 0.08);
          return;
        case 'craft':
          // Sonido de martillo
          oscillator.frequency.value = 300;
          oscillator.type = 'square';
          gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
          oscillator.stop(audioContext.currentTime + 0.05);
          return;
        case 'move':
          // Sonido sutil de paso
          oscillator.frequency.value = 250;
          oscillator.type = 'sine';
          gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.06);
          oscillator.stop(audioContext.currentTime + 0.06);
          return;
        case 'notification':
          // Ping suave
          oscillator.frequency.value = 600;
          oscillator.type = 'sine';
          gainNode.gain.setValueAtTime(0.08, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.12);
          oscillator.stop(audioContext.currentTime + 0.12);
          return;
        case 'death':
          // Sonido grave de muerte
          oscillator.frequency.setValueAtTime(300, audioContext.currentTime);
          oscillator.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime + 0.4);
          oscillator.type = 'sawtooth';
          gainNode.gain.setValueAtTime(0.18, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
          oscillator.stop(audioContext.currentTime + 0.4);
          return;
        case 'achievement':
          // Fanfarria corta
          oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
          oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.08);
          oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.16);
          oscillator.type = 'sine';
          gainNode.gain.setValueAtTime(0.12, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.25);
          oscillator.stop(audioContext.currentTime + 0.25);
          return;
        case 'click':
          // Click UI
          oscillator.frequency.value = 500;
          oscillator.type = 'sine';
          gainNode.gain.setValueAtTime(0.06, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.03);
          oscillator.stop(audioContext.currentTime + 0.03);
          return;
      }
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.2);
    }
    
    // ====================================
    // TABS DE CRAFTEO
    // ====================================
    function switchCraftTab(tabName) {
      // Desactivar todos los tabs
      document.querySelectorAll('.craft-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.craft-section').forEach(section => section.classList.remove('active'));
      
      // Activar el seleccionado
      event.target.classList.add('active');
      document.getElementById(`craft-${tabName}`).classList.add('active');
      
      playSound('success');
    }
    
    // ====================================
    // REFUGIO VISUAL DINÃMICO
    // ====================================
    function renderRefugioVisual() {
      if (!world || !world.locations || !world.locations.refugio) return;
      
      const refugio = world.locations.refugio;
      const defensas = refugio.defensas || 0;
      const mejoras = refugio.mejoras || {};
      
      let visual = 'ğŸ˜ï¸'; // Base: edificio bÃ¡sico
      
      // AÃ±adir elementos segÃºn mejoras
      if (mejoras.torre_vigilancia && mejoras.torre_vigilancia.nivel > 0) {
        visual = 'ğŸ¯' + visual; // Torre
      }
      if (mejoras.enfermeria && mejoras.enfermeria.nivel > 0) {
        visual += 'âš•ï¸'; // Cruz mÃ©dica
      }
      if (mejoras.taller && mejoras.taller.nivel > 0) {
        visual += 'ğŸ”§'; // Herramientas
      }
      if (mejoras.armeria && mejoras.armeria.nivel > 0) {
        visual += 'ğŸ›¡ï¸'; // Escudo
      }
      if (mejoras.huerto && mejoras.huerto.nivel > 0) {
        visual += 'ğŸŒ¿'; // Planta
      }
      
      // Estado segÃºn defensas
      let estadoText = '';
      let color = '#00ff00';
      if (defensas < 20) {
        estadoText = 'âš ï¸ VULNERABLE';
        color = '#ff0000';
      } else if (defensas < 50) {
        estadoText = 'âš™ï¸ FORTIFICADO';
        color = '#ffaa00';
      } else if (defensas < 100) {
        estadoText = 'ğŸ›¡ï¸ PROTEGIDO';
        color = '#00ff00';
      } else {
        estadoText = 'ğŸ¯ FORTALEZA';
        color = '#00ffff';
      }
      
      const html = `
        <div style="text-align: center;">
          <div style="font-size: 48px; margin: 10px 0;">${visual}</div>
          <div style="font-size: 12px; color: ${color}; font-weight: bold;">${estadoText}</div>
        </div>
      `;
      
      document.getElementById('refugioVisual').innerHTML = html;
    }
    
    // ====================================
    // SISTEMA DE PESTAÃ‘AS
    // ====================================
    function switchTab(tabName) {
      // Ocultar todos los contenidos
      const contents = document.querySelectorAll('.tab-content');
      contents.forEach(content => content.classList.remove('active'));
      
      // Desactivar todos los botones
      const buttons = document.querySelectorAll('.tab-button');
      buttons.forEach(btn => btn.classList.remove('active'));
      
      // Activar la pestaÃ±a seleccionada
      document.getElementById(`tab-${tabName}`).classList.add('active');
      document.querySelector(`button[onclick="switchTab('${tabName}')"]`).classList.add('active');
      
      // Sonido de click
      playSound('click');
      
      // Limpiar badge cuando se abre la pestaÃ±a
      if (tabName === 'events') {
        hideBadge('events');
      } else if (tabName === 'social') {
        hideBadge('social');
      } else if (tabName === 'missions') {
        hideBadge('missions');
        loadNarrativeMissions(); // Cargar misiones narrativas
      } else if (tabName === 'mundo') {
        hideBadge('mundo');
        refreshQuests(); // Refrescar misiones al abrir tab
      }
      
      // Lazy loading: cargar contenido solo la primera vez
      if (!tabsLoaded[tabName]) {
        tabsLoaded[tabName] = true;
        switch(tabName) {
          case 'missions':
            loadNarrativeMissions();
            break;
          case 'crafting':
            renderCrafting();
            break;
          case 'quests':
            renderQuests();
            break;
          case 'social':
            renderOnlinePlayers([]);
            renderChat();
            break;
          case 'mundo':
            refreshWorldEvents();
            loadIntenseRelationships();
            loadWorldStats();
            break;
          case 'progression':
            loadDefaultLeaderboard();
            renderAchievements();
            break;
          case 'events':
            renderWorldEvents();
            renderNarrativeHistory();
            break;
        }
      } else if (tabName === 'progression') {
        // Siempre actualizar leaderboard al abrir
        loadDefaultLeaderboard();
      } else if (tabName === 'mundo') {
        // Siempre refrescar datos del mundo al abrir
        refreshWorldEvents();
      }
    }

    function showBadge(tab) {
      const badge = document.getElementById(`badge-${tab}`);
      if (badge) {
        badge.style.display = 'flex';
      }
    }

    function hideBadge(tab) {
      const badge = document.getElementById(`badge-${tab}`);
      if (badge) {
        badge.style.display = 'none';
      }
    }

    // Acciones rÃ¡pidas desde la pestaÃ±a principal
    function quickAction(action) {
      switch(action) {
        case 'scavenge':
          showActionFeedback('ğŸ” Buscando recursos...');
          scavenge();
          break;
        case 'attack':
          showActionFeedback('âš”ï¸ Iniciando combate...', 'danger');
          startCombat();
          break;
        case 'rest':
          rest();
          break;
        case 'eat':
          eat();
          break;
      }
    }
    
    function showActionFeedback(text, type = 'success') {
      let feedbackEl = document.getElementById('actionFeedback');
      if (!feedbackEl) {
        feedbackEl = document.createElement('div');
        feedbackEl.id = 'actionFeedback';
        document.body.appendChild(feedbackEl);
      }
      
      feedbackEl.textContent = text;
      feedbackEl.style.background = type === 'danger' ? 'rgba(255, 0, 0, 0.95)' : 'rgba(0, 255, 0, 0.95)';
      feedbackEl.style.color = type === 'danger' ? '#fff' : '#000';
      feedbackEl.style.display = 'block';
      
      setTimeout(() => {
        feedbackEl.style.display = 'none';
      }, 800);
    }

    function rest() {
      if (!player) return;
      
      const oldSalud = player.salud;
      const oldHambre = player.hambre;
      
      player.salud = Math.min(100, player.salud + 10);
      player.hambre = Math.max(0, player.hambre - 5);
      
      // Mostrar consecuencias
      if (player.salud > oldSalud) showStatChange('salud', player.salud - oldSalud);
      if (player.hambre < oldHambre) showStatChange('hambre', player.hambre - oldHambre);
      
      showActionFeedback('ğŸ’¤ Descansando...', 'success');
      renderGame();
    }

    // ====================================
    // SISTEMA DE DONACIÃ“N AL REFUGIO
    // ====================================
    function showDonateMenu() {
      const items = Object.entries(player.inventario)
        .filter(([item, cant]) => cant > 0)
        .map(([item, cant]) => `<option value="${item}">${item} (tienes: ${cant})</option>`)
        .join('');
      
      if (!items) {
        showNotification('No tienes nada que donar', 'warning');
        return;
      }
      
      const item = prompt(`Â¿QuÃ© quieres donar al refugio?\n\nOpciones: ${Object.keys(player.inventario).filter(k => player.inventario[k] > 0).join(', ')}`);
      
      if (!item || !player.inventario[item]) {
        return;
      }
      
      const cantidad = parseInt(prompt(`Â¿CuÃ¡nto ${item} quieres donar? (tienes: ${player.inventario[item]})`));
      
      if (!cantidad || cantidad <= 0 || cantidad > player.inventario[item]) {
        showNotification('Cantidad invÃ¡lida', 'warning');
        return;
      }
      
      donateToRefugio(item, cantidad);
    }

    function donateToRefugio(item, cantidad) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No conectado al servidor', 'warning');
        return;
      }
      
      ws.send(JSON.stringify({
        type: 'donate',
        item,
        cantidad
      }));
    }

    // ====================================
    // SISTEMA DE MUNDO VIVO
    // ====================================
    
    function refreshWorldEvents() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No conectado al servidor', 'warning');
        return;
      }
      
      ws.send(JSON.stringify({
        type: 'getWorldEvents',
        limit: 50
      }));
    }

    function loadIntenseRelationships() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      
      ws.send(JSON.stringify({
        type: 'getIntenseRelationships',
        minIntensity: 5
      }));
    }

    function loadWorldStats() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      
      ws.send(JSON.stringify({
        type: 'getWorldState'
      }));
    }

    function renderWorldEvents(events) {
      const feed = document.getElementById('worldEventsFeed');
      if (!feed || !events || events.length === 0) {
        feed.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">No hay eventos recientes...</p>';
        return;
      }

      // Agrupar eventos por tipo para mejor visualizaciÃ³n
      const groupedEvents = {
        romance: [],
        conflicto: [],
        drama: [],
        actividad: [],
        otros: []
      };

      events.forEach(event => {
        const tipo = event.tipo;
        if (tipo.includes('romance') || tipo.includes('coqueteo') || tipo.includes('amor') || tipo.includes('tension')) {
          groupedEvents.romance.push(event);
        } else if (tipo.includes('pelea') || tipo.includes('conflicto') || tipo.includes('enemigo') || tipo.includes('rival')) {
          groupedEvents.conflicto.push(event);
        } else if (tipo.includes('drama') || tipo.includes('chisme') || tipo.includes('celos') || tipo.includes('triangulo')) {
          groupedEvents.drama.push(event);
        } else if (tipo.includes('colaboracion') || tipo.includes('charla') || tipo.includes('ayuda') || tipo.includes('amistad')) {
          groupedEvents.actividad.push(event);
        } else {
          groupedEvents.otros.push(event);
        }
      });

      let html = '';

      // Mostrar todos los eventos en orden cronolÃ³gico
      events.forEach(event => {
        const timeAgo = getTimeAgo(event.timestamp);
        const icon = getEventIcon(event.tipo);
        const color = getEventColor(event.tipo);
        
        html += `
          <div style="background: #1a1a1a; border-left: 3px solid ${color}; padding: 10px; margin: 8px 0; border-radius: 3px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
              <span style="color: ${color};">${icon} ${event.tipo.toUpperCase()}</span>
              <span style="color: #666; font-size: 10px;">${timeAgo}</span>
            </div>
            <p style="margin: 0; color: #ddd; line-height: 1.4;">
              ${event.descripcion}
            </p>
          </div>
        `;
      });

      feed.innerHTML = html;
    }

    function renderIntenseRelationships(relationships) {
      const container = document.getElementById('intenseRelationships');
      if (!container) return;

      if (!relationships || relationships.length === 0) {
        container.innerHTML = '<p style="color: #888;">Sin relaciones dramÃ¡ticas...</p>';
        return;
      }

      let html = '';

      relationships.forEach(rel => {
        const estadoIcon = getRelationshipIcon(rel.estado);
        const color = getRelationshipColor(rel.estado);
        
        html += `
          <div style="background: #1a2a1a; border: 1px solid ${color}; padding: 8px; margin: 5px 0; border-radius: 3px;">
            <div style="color: ${color}; font-weight: bold; margin-bottom: 3px;">
              ${estadoIcon} ${rel.npc_a_id} â†” ${rel.npc_b_id}
            </div>
            <div style="font-size: 10px; color: #aaa;">
              Estado: <span style="color: ${color};">${rel.estado}</span> | 
              Intensidad: ${'ğŸ”¥'.repeat(Math.min(rel.intensidad, 10))}
            </div>
            <div style="font-size: 9px; color: #888; margin-top: 3px;">
              Amistad: ${rel.amistad} | AtracciÃ³n: ${rel.atraccion} | 
              Rivalidad: ${rel.rivalidad} | Celos: ${rel.celos}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function renderWorldStats(stats) {
      const container = document.getElementById('worldStats');
      if (!container || !stats) return;

      const narrativeStats = stats.narrativeStats || {};
      const aiStats = stats.aiStats || {};
      
      const html = `
        <div style="background: #1a1a2a; padding: 10px; border-radius: 3px; margin: 5px 0;">
          <div style="margin: 5px 0;">â±ï¸ <strong>Tick:</strong> #${stats.tick || 0}</div>
          <div style="margin: 5px 0;">ğŸ‘¥ <strong>NPCs Activos:</strong> ${stats.npcCount || 0}</div>
          <div style="margin: 5px 0;">âš¡ <strong>Eventos Activos:</strong> ${stats.activeEvents || 0}</div>
        </div>
        
        <div style="background: #2a1a1a; padding: 10px; border-radius: 3px; margin: 10px 0;">
          <div style="font-weight: bold; margin-bottom: 5px; color: #ff88aa;">ğŸ“Š EstadÃ­sticas Narrativas</div>
          <div style="margin: 3px 0;">ğŸ’• Romances: ${narrativeStats.romances || 0}</div>
          <div style="margin: 3px 0;">âš”ï¸ Conflictos: ${narrativeStats.conflictos || 0}</div>
          <div style="margin: 3px 0;">ğŸ­ Dramas: ${narrativeStats.dramas || 0}</div>
          <div style="margin: 3px 0;">ğŸ¤ Actividades: ${narrativeStats.actividades || 0}</div>
        </div>
        
        <div style="background: #1a2a1a; padding: 10px; border-radius: 3px; margin: 10px 0;">
          <div style="font-weight: bold; margin-bottom: 5px; color: #44ff88;">ğŸ¤– Sistema de IA</div>
          <div style="margin: 3px 0;">ğŸ§  NPCs con memoria: ${aiStats.npcsWithMemories || 0}</div>
          <div style="margin: 3px 0;">ğŸ’­ Recuerdos totales: ${aiStats.totalMemories || 0}</div>
          <div style="margin: 3px 0;">ğŸ¯ Objetivos activos: ${aiStats.activeGoals || 0}</div>
        </div>
      `;

      container.innerHTML = html;
    }

    // Helpers para iconos y colores
    function getEventIcon(tipo) {
      if (tipo.includes('romance') || tipo.includes('amor')) return 'ğŸ’•';
      if (tipo.includes('pelea') || tipo.includes('conflicto')) return 'âš”ï¸';
      if (tipo.includes('drama') || tipo.includes('chisme')) return 'ğŸ­';
      if (tipo.includes('amistad') || tipo.includes('ayuda')) return 'ğŸ¤';
      if (tipo.includes('coqueteo')) return 'ğŸ˜Š';
      if (tipo.includes('tension')) return 'ğŸ”¥';
      if (tipo.includes('celos')) return 'ğŸ˜’';
      return 'ğŸ“°';
    }

    function getEventColor(tipo) {
      if (tipo.includes('romance') || tipo.includes('amor')) return '#ff88aa';
      if (tipo.includes('pelea') || tipo.includes('conflicto')) return '#ff4444';
      if (tipo.includes('drama') || tipo.includes('chisme')) return '#ff8800';
      if (tipo.includes('amistad') || tipo.includes('ayuda')) return '#44ff44';
      if (tipo.includes('coqueteo')) return '#ffaa88';
      if (tipo.includes('tension')) return '#ffaa00';
      if (tipo.includes('celos')) return '#aa00aa';
      return '#888888';
    }

    function getRelationshipIcon(estado) {
      switch(estado) {
        case 'amantes': return 'ğŸ’‘';
        case 'tension_sexual': return 'ğŸ”¥';
        case 'enemigos': return 'âš”ï¸';
        case 'rivales': return 'ğŸ¥Š';
        case 'amigos': return 'ğŸ¤';
        case 'celoso': return 'ğŸ˜’';
        case 'complejo': return 'ğŸ­';
        default: return 'ğŸ‘¥';
      }
    }

    function getRelationshipColor(estado) {
      switch(estado) {
        case 'amantes': return '#ff4488';
        case 'tension_sexual': return '#ff8800';
        case 'enemigos': return '#ff0000';
        case 'rivales': return '#ffaa00';
        case 'amigos': return '#44ff44';
        case 'celoso': return '#aa00aa';
        case 'complejo': return '#8888ff';
        default: return '#888888';
      }
    }

    function getTimeAgo(timestamp) {
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      if (seconds < 60) return `hace ${seconds}s`;
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `hace ${minutes}m`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `hace ${hours}h`;
      const days = Math.floor(hours / 24);
      return `hace ${days}d`;
    }

    // Renderizar acciones autÃ³nomas de NPCs
    function renderNpcActions(actions) {
      const container = document.getElementById('npcActionsLog');
      
      if (!actions || actions.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #888;">Sin acciones registradas...</p>';
        return;
      }

      const actionsHTML = actions.map(action => {
        const icon = getActionIcon(action.action);
        const color = getActionColor(action.action);
        
        return `
          <div style="
            background: rgba(0,0,0,0.4);
            border-left: 3px solid ${color};
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
          ">
            <div style="color: ${color}; font-weight: bold; margin-bottom: 4px;">
              ${icon} ${action.action.toUpperCase().replace('_', ' ')}
            </div>
            <div style="color: #ccc;">
              ${action.description}
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = actionsHTML;
    }

    function getActionIcon(actionType) {
      const icons = {
        'move': 'ğŸš¶',
        'interact': 'ğŸ’¬',
        'seek_romance': 'ğŸ’•',
        'avoid_enemy': 'ğŸƒ',
        'seek_friend': 'ğŸ¤',
        'confront': 'âš”ï¸',
        'rest': 'ğŸ˜´'
      };
      return icons[actionType] || 'ğŸ¯';
    }

    function getActionColor(actionType) {
      const colors = {
        'move': '#4488ff',
        'interact': '#44ff44',
        'seek_romance': '#ff4488',
        'avoid_enemy': '#ffaa00',
        'seek_friend': '#44ff88',
        'confront': '#ff4444',
        'rest': '#8888ff'
      };
      return colors[actionType] || '#888888';
    }

    // ====================================
    // SISTEMA DE MISIONES DINÃMICAS
    // ====================================
    
    function refreshQuests() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: 'getActiveQuests' }));
    }
    
    function renderQuests(quests) {
      const list = document.getElementById('questsList');
      const badge = document.getElementById('questCountBadge');
      
      if (!quests || quests.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">No hay misiones disponibles.</p>';
        badge.textContent = '';
        return;
      }
      
      badge.textContent = `(${quests.length})`;
      
      const questsHTML = quests.map(quest => {
        const timeLeft = quest.expiresAt - Date.now();
        const minutesLeft = Math.floor(timeLeft / 60000);
        const isExpiringSoon = minutesLeft < 3;
        
        const typeIcons = {
          'romance': 'ğŸ’•',
          'matchmaker': 'ğŸ’˜',
          'mediation': 'ğŸ•Šï¸',
          'rivalry': 'âš”ï¸',
          'jealousy': 'ğŸ˜’',
          'investigation': 'ğŸ”'
        };
        
        const typeColors = {
          'romance': '#ff4488',
          'matchmaker': '#ff88cc',
          'mediation': '#44ff44',
          'rivalry': '#ffaa00',
          'jealousy': '#aa00aa',
          'investigation': '#4488ff'
        };
        
        const icon = typeIcons[quest.type] || 'âš¡';
        const color = typeColors[quest.type] || '#888';
        const isAccepted = quest.estado === 'aceptada';
        
        return `
          <div class="quest-card" style="
            background: linear-gradient(135deg, rgba(0,0,0,0.8) 0%, rgba(30,30,30,0.9) 100%);
            border: 2px solid ${color};
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            ${isExpiringSoon ? 'animation: pulse 1s infinite;' : ''}
          ">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
              <h3 style="margin: 0; color: ${color}; font-size: 14px;">
                ${icon} ${quest.title}
              </h3>
              <span style="
                background: ${isExpiringSoon ? '#ff0000' : '#333'};
                color: white;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 10px;
                font-weight: bold;
              ">
                â±ï¸ ${minutesLeft}m
              </span>
            </div>
            
            <p style="font-size: 11px; color: #ccc; margin: 10px 0; line-height: 1.4;">
              ${quest.description}
            </p>
            
            <div style="margin: 10px 0;">
              <strong style="color: ${color}; font-size: 11px;">OBJETIVOS:</strong>
              <ul style="margin: 5px 0; padding-left: 20px; font-size: 10px; color: #aaa;">
                ${quest.objectives.map(obj => `<li>${obj}</li>`).join('')}
              </ul>
            </div>
            
            <div style="margin: 10px 0;">
              <strong style="color: #ffaa00; font-size: 11px;">RECOMPENSAS:</strong>
              <div style="font-size: 10px; color: #ffcc00; margin-top: 5px;">
                ${quest.rewards.xp ? `â­ +${quest.rewards.xp} XP` : ''}
                ${quest.rewards.reputacion ? `ğŸ“Š +${quest.rewards.reputacion} Rep` : ''}
                ${quest.rewards.oro ? `ğŸ’° +${quest.rewards.oro} Oro` : ''}
              </div>
            </div>
            
            <div style="margin: 10px 0; font-size: 10px; color: #888;">
              NPCs: ${quest.npcsInvolved.map(npc => `<span style="color: #fff;">${npc.nombre}</span>`).join(', ')}
            </div>
            
            ${isAccepted ? `
              <button onclick="completeQuest('${quest.id}', true)" style="
                background: #44ff44;
                color: #000;
                border: none;
                padding: 8px 15px;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
                margin-right: 5px;
              ">âœ… COMPLETAR</button>
              <button onclick="completeQuest('${quest.id}', false)" style="
                background: #ff4444;
                color: #fff;
                border: none;
                padding: 8px 15px;
                border-radius: 4px;
                cursor: pointer;
              ">âŒ FALLAR</button>
            ` : `
              <button onclick="acceptQuest('${quest.id}')" style="
                background: ${color};
                color: #fff;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
                width: 100%;
              ">ğŸ¯ ACEPTAR MISIÃ“N</button>
            `}
          </div>
        `;
      }).join('');
      
      list.innerHTML = questsHTML;
    }
    
    function acceptQuest(questId) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No hay conexiÃ³n con el servidor', 'warning');
        return;
      }
      
      ws.send(JSON.stringify({
        type: 'acceptQuest',
        questId
      }));
    }
    
    function completeQuest(questId, success) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No hay conexiÃ³n con el servidor', 'warning');
        return;
      }
      
      const confirmMsg = success 
        ? 'Â¿Completaste los objetivos de la misiÃ³n?' 
        : 'Â¿Quieres marcar la misiÃ³n como fallida?';
      
      if (confirm(confirmMsg)) {
        ws.send(JSON.stringify({
          type: 'completeQuest',
          questId,
          success
        }));
      }
    }

    // ====================================
    // FIN SISTEMA DE MISIONES DINÃMICAS
    // ====================================

    // ====================================
    // SISTEMA DE MISIONES NARRATIVAS
    // ====================================

    let currentNarrativeMission = null;
    let narrativeTimer = null;
    let narrativeTimeLeft = 0;

    // Cargar misiones disponibles
    function loadNarrativeMissions() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No hay conexiÃ³n con el servidor', 'warning');
        return;
      }

      ws.send(JSON.stringify({ type: 'getNarrativeMissions' }));
    }

    // Renderizar lista de misiones
    function renderNarrativeMissions(missions) {
      const container = document.getElementById('narrativeMissionCards');
      
      if (!missions || missions.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #888;">No hay misiones disponibles para tu nivel.</p>';
        return;
      }

      const missionsHTML = missions.map(mission => {
        return `
          <div class="mission-card" style="
            background: linear-gradient(135deg, #1a1a2a 0%, #2a1a2a 100%);
            border: 2px solid #ffaa00;
            border-radius: 8px;
            padding: 15px;
          ">
            <h3 style="color: #ffaa00; margin-bottom: 10px;">${mission.title}</h3>
            <p style="font-size: 11px; color: #ccc; margin-bottom: 10px; line-height: 1.4;">
              ${mission.description}
            </p>
            
            <div style="font-size: 10px; color: #888; margin: 5px 0;">
              ğŸ“Š Nivel mÃ­nimo: ${mission.minLevel}
            </div>
            <div style="font-size: 10px; color: #888; margin: 5px 0;">
              ğŸ‘¥ MÃ¡ximo jugadores: ${mission.maxPartySize}
            </div>
            <div style="font-size: 10px; color: #888; margin: 5px 0;">
              â±ï¸ DuraciÃ³n estimada: ${mission.estimatedTime}
            </div>

            <div style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 4px;">
              <div style="font-weight: bold; color: #ffaa00; margin-bottom: 5px;">ğŸ Recompensas</div>
              <div style="font-size: 10px; color: #ffcc00;">
                ğŸ‘¤ Solo: ${mission.rewards.solo.xp} XP + ${Object.entries(mission.rewards.solo.items).map(([k,v]) => `${v} ${k}`).join(', ')}
              </div>
              <div style="font-size: 10px; color: #88ff88;">
                ğŸ‘¥ Grupo: ${mission.rewards.group.xp} XP + ${Object.entries(mission.rewards.group.items).map(([k,v]) => `${v} ${k}`).join(', ')}
              </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 15px;">
              <button onclick="startNarrativeMission('${mission.id}', false)" style="
                flex: 1;
                background: #4444ff;
                color: white;
                border: none;
                padding: 10px;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
              ">
                ğŸ‘¤ INICIAR SOLO
              </button>
              <button onclick="startNarrativeMission('${mission.id}', true)" style="
                flex: 1;
                background: #44ff44;
                color: #000;
                border: none;
                padding: 10px;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
              ">
                ğŸ‘¥ INICIAR EN GRUPO
              </button>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = missionsHTML;
    }

    // Iniciar misiÃ³n narrativa
    function startNarrativeMission(templateId, isGroup) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No hay conexiÃ³n con el servidor', 'warning');
        return;
      }

      // Si es grupo, obtener miembros del partido
      let partyMembers = [player.id];
      
      if (isGroup) {
        // TODO: Implementar selector de grupo
        // Por ahora, solo jugador
        if (!confirm('Â¿Iniciar misiÃ³n en modo GRUPO? (Actualmente solo tÃº)')) {
          return;
        }
      }

      ws.send(JSON.stringify({
        type: 'startNarrativeMission',
        templateId,
        isGroup,
        partyMembers
      }));
    }

    // Mostrar misiÃ³n en curso
    function showNarrativeMission(mission) {
      currentNarrativeMission = mission;

      // Ocultar lista, mostrar misiÃ³n activa
      document.getElementById('narrativeMissionList').style.display = 'none';
      document.getElementById('narrativeMissionActive').style.display = 'block';

      // TÃ­tulo
      document.getElementById('narrativeMissionTitle').textContent = `ğŸ“– ${mission.title}`;

      // Modo
      const modeDiv = document.getElementById('narrativeMode');
      if (mission.isGroup) {
        modeDiv.innerHTML = `ğŸ‘¥ GRUPO (${mission.partyMembers.length})`;
        modeDiv.style.background = '#44ff44';
        modeDiv.style.color = '#000';
      } else {
        modeDiv.innerHTML = 'ğŸ‘¤ SOLO';
        modeDiv.style.background = '#4444ff';
      }

      // Mostrar paso actual
      if (mission.currentStep) {
        showNarrativeStep(mission.currentStep);
      }
    }

    // Mostrar paso narrativo
    function showNarrativeStep(step) {
      // Texto narrativo
      document.getElementById('narrativeStoryText').innerHTML = step.text;

      // Timer
      narrativeTimeLeft = step.timer || 30;
      updateNarrativeTimer();
      
      // Reiniciar timer
      if (narrativeTimer) clearInterval(narrativeTimer);
      narrativeTimer = setInterval(() => {
        narrativeTimeLeft--;
        updateNarrativeTimer();
        
        if (narrativeTimeLeft <= 0) {
          clearInterval(narrativeTimer);
          // Auto-seleccionar opciÃ³n aleatoria
          autoSelectNarrativeChoice();
        }
      }, 1000);

      // Estilo del timer segÃºn urgencia
      const timerDiv = document.getElementById('narrativeTimer');
      if (step.critical) {
        timerDiv.style.background = '#ff0000';
        timerDiv.style.animation = 'pulse 0.5s infinite';
      } else if (step.danger) {
        timerDiv.style.background = '#ff6600';
      } else {
        timerDiv.style.background = '#ff4444';
        timerDiv.style.animation = 'none';
      }

      // VotaciÃ³n (si es grupo)
      if (currentNarrativeMission.isGroup) {
        document.getElementById('narrativeVoting').style.display = 'block';
        document.getElementById('voteCount').textContent = `Votos: 0 / ${currentNarrativeMission.partyMembers.length}`;
      } else {
        document.getElementById('narrativeVoting').style.display = 'none';
      }

      // Opciones
      renderNarrativeChoices(step.choices);
    }

    // Actualizar timer
    function updateNarrativeTimer() {
      document.getElementById('narrativeTimer').textContent = `â±ï¸ ${narrativeTimeLeft}s`;
    }

    // Renderizar opciones
    function renderNarrativeChoices(choices) {
      const container = document.getElementById('narrativeChoices');
      
      const choicesHTML = choices.map(choice => {
        return `
          <button onclick="makeNarrativeChoice('${choice.id}')" class="narrative-choice-btn" style="
            background: linear-gradient(135deg, #2a2a4a 0%, #3a2a4a 100%);
            border: 2px solid #ffaa00;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            text-align: left;
            color: white;
            font-size: 13px;
            transition: all 0.3s;
          " onmouseover="this.style.borderColor='#ffff00'; this.style.transform='scale(1.05)'" onmouseout="this.style.borderColor='#ffaa00'; this.style.transform='scale(1)'">
            ${choice.text}
          </button>
        `;
      }).join('');

      container.innerHTML = choicesHTML;
    }

    // Hacer elecciÃ³n
    function makeNarrativeChoice(choiceId) {
      if (!currentNarrativeMission) return;

      // Detener timer
      if (narrativeTimer) {
        clearInterval(narrativeTimer);
        narrativeTimer = null;
      }

      // Enviar elecciÃ³n
      if (currentNarrativeMission.isGroup) {
        // Votar
        ws.send(JSON.stringify({
          type: 'narrativeVote',
          missionId: currentNarrativeMission.id,
          choiceId
        }));

        log('âœ… Voto registrado. Esperando a los demÃ¡s...', 'info');
      } else {
        // ElecciÃ³n directa
        ws.send(JSON.stringify({
          type: 'narrativeChoice',
          missionId: currentNarrativeMission.id,
          choiceId
        }));
      }

      // Deshabilitar botones
      document.querySelectorAll('.narrative-choice-btn').forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
      });
    }

    // Auto-seleccionar si se acaba el tiempo
    function autoSelectNarrativeChoice() {
      if (!currentNarrativeMission) return;
      
      const step = currentNarrativeMission.currentStep;
      if (step && step.choices && step.choices.length > 0) {
        // Elegir la Ãºltima opciÃ³n (generalmente la mÃ¡s segura/cobarde)
        const lastChoice = step.choices[step.choices.length - 1];
        log('â° Â¡Tiempo agotado! ElecciÃ³n automÃ¡tica...', 'warning');
        makeNarrativeChoice(lastChoice.id);
      }
    }

    // Abandonar misiÃ³n
    function abandonNarrativeMission() {
      if (!confirm('Â¿Seguro que quieres abandonar la misiÃ³n?')) return;

      currentNarrativeMission = null;
      if (narrativeTimer) {
        clearInterval(narrativeTimer);
        narrativeTimer = null;
      }

      document.getElementById('narrativeMissionActive').style.display = 'none';
      document.getElementById('narrativeMissionList').style.display = 'block';

      log('MisiÃ³n abandonada', 'warning');
    }

    // Mostrar completado
    function showNarrativeMissionCompleted(rewards, summary) {
      if (narrativeTimer) {
        clearInterval(narrativeTimer);
        narrativeTimer = null;
      }

      playSound('achievement');

      let summaryHTML = `
        <div style="
          background: linear-gradient(135deg, #1a4a1a 0%, #2a5a2a 100%);
          border: 3px solid #44ff44;
          border-radius: 12px;
          padding: 25px;
          text-align: center;
        ">
          <h2 style="color: #44ff44; font-size: 24px; margin-bottom: 15px;">
            âœ… Â¡MISIÃ“N COMPLETADA!
          </h2>
          
          <div style="font-size: 18px; margin: 10px 0;">
            ${summary.title}
          </div>
          
          <div style="display: flex; justify-content: center; gap: 30px; margin: 20px 0; font-size: 14px;">
            <div>â±ï¸ ${summary.duration}</div>
            <div>${summary.mode === 'Grupo' ? 'ğŸ‘¥' : 'ğŸ‘¤'} ${summary.mode}</div>
            <div>ğŸ§Ÿ ${summary.kills} Kills</div>
          </div>

          <div style="
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
          ">
            <div style="font-size: 16px; color: #ffaa00; margin-bottom: 10px;">ğŸ RECOMPENSAS</div>
            <div style="font-size: 14px;">
              â­ +${rewards.xp} XP<br>
              â¤ï¸ ${rewards.health > 0 ? '+' : ''}${rewards.health} Salud<br>
              ğŸ’ ${Object.entries(rewards.items).map(([k,v]) => `${v} ${k}`).join(', ')}
            </div>
          </div>

          <button onclick="closeNarrativeMissionComplete()" style="
            background: #44ff44;
            color: #000;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            margin-top: 15px;
          ">
            âœ… CONTINUAR
          </button>
        </div>
      `;

      document.getElementById('narrativeStoryText').innerHTML = summaryHTML;
      document.getElementById('narrativeChoices').innerHTML = '';
      document.getElementById('narrativeTimer').style.display = 'none';
    }

    function closeNarrativeMissionComplete() {
      currentNarrativeMission = null;
      document.getElementById('narrativeMissionActive').style.display = 'none';
      document.getElementById('narrativeMissionList').style.display = 'block';
      document.getElementById('narrativeTimer').style.display = 'block';
      
      loadNarrativeMissions();
      renderGame();
    }

    // ====================================
    // FIN SISTEMA DE MISIONES NARRATIVAS
    // ====================================

    // ====================================
    // FIN SISTEMA DE MUNDO VIVO
    // ====================================

    function rest() {
      if (!player) return;
      
      player.salud = Math.min(100, player.salud + 10);
      player.hambre = Math.max(0, player.hambre - 5);
      
      log('ğŸ˜´ Descansaste un momento. +10 salud', 'success');
      renderGame();
    }

    function eat() {
      if (!player || !player.inventario.comida || player.inventario.comida <= 0) {
        showNotification('No tienes comida', 'warning');
        return;
      }
      
      player.inventario.comida--;
      player.hambre = Math.min(100, player.hambre + 40);
      player.salud = Math.min(100, player.salud + 5);
      
      log('ğŸ– Comiste. +40 hambre, +5 salud', 'success');
      renderGame();
    }

    async function createPlayer() {
      const nombre = document.getElementById('playerName').value.trim();
      
      if (!nombre || nombre.length < 3) {
        alert('Nombre muy corto');
        return;
      }
      
      const data = await safeFetch('/api/player/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nombre })
      });
      
      if (data.success) {
        player = data.player;
        document.getElementById('login').style.display = 'none';
        document.getElementById('gameScreen').style.display = 'block';
        connectWebSocket();
      }
    }

    function connectWebSocket() {
      // Limpiar intervalo anterior si existe
      if (pingInterval) clearInterval(pingInterval);
      if (reconnectTimeout) clearTimeout(reconnectTimeout);
      
      // Exponential backoff para reconexiÃ³n
      if (!window.reconnectAttempts) window.reconnectAttempts = 0;
      if (!window.maxReconnectAttempts) window.maxReconnectAttempts = 5;
      
      // Detectar si usar ws:// o wss:// segÃºn el protocolo de la pÃ¡gina
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}`);
      
      ws.onopen = () => {
        log('âœ… Conectado al servidor', 'success');
        playSound('success');
        window.reconnectAttempts = 0; // Reset contador
        
        ws.send(JSON.stringify({ type: 'login', playerId: player.id }));
        
        // Solicitar estado completo del mundo
        ws.send(JSON.stringify({ type: 'getWorld' }));
        
        // Actualizar indicador de conexiÃ³n
        const statusEl = document.getElementById('connectionStatus');
        if (statusEl) {
          statusEl.className = 'connection-status connected';
          statusEl.innerHTML = 'ğŸŸ¢ Conectado';
        }
        
        // Mostrar mensaje de bienvenida con comandos
        setTimeout(() => {
          addSystemMessage('Â¡Bienvenido! Escribe /help en el chat para ver comandos disponibles.\nAtajos de teclado: S=Buscar, C=Combate, T=Comerciar, H=Hablar');
        }, 1000);
        
        // Iniciar ping cada 30 segundos para mantener conexiÃ³n activa
        pingInterval = setInterval(() => {
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'ping' }));
          }
        }, 30000);
      };
      
      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        handleMessage(msg);
      };
      
      ws.onclose = () => {
        log('Desconectado del servidor', 'warning');
        if (pingInterval) clearInterval(pingInterval);
        
        // Actualizar indicador de conexiÃ³n
        const statusEl = document.getElementById('connectionStatus');
        if (statusEl) {
          statusEl.className = 'connection-status disconnected pulse';
          statusEl.innerHTML = 'ğŸ”´ Desconectado';
        }
        
        // Intentar reconectar con exponential backoff
        if (window.reconnectAttempts < window.maxReconnectAttempts) {
          window.reconnectAttempts++;
          const delay = Math.min(1000 * Math.pow(2, window.reconnectAttempts - 1), 16000);
          log(`Reconectando en ${delay/1000}s... (intento ${window.reconnectAttempts}/${window.maxReconnectAttempts})`, 'warning');
          
          reconnectTimeout = setTimeout(() => {
            connectWebSocket();
          }, delay);
        } else {
          log('âŒ No se pudo reconectar. Recarga la pÃ¡gina.', 'warning');
          if (statusEl) statusEl.innerHTML = 'ğŸ”´ Sin conexiÃ³n';
        }
      };
      
      ws.onerror = (error) => {
        log('Error de conexiÃ³n', 'warning');
      };
    }

    // ====================================
    // WEBSOCKET HANDLERS (Organizado por tipo)
    // ====================================
    const messageHandlers = {
      'world:state': (msg) => {
        world = msg.world;
        console.log('ğŸ“¦ Mundo recibido:', world);
        if (world.players && world.players[player.id]) {
          player = world.players[player.id];
        }
        renderGame();
      },
      
      'moved': (msg) => {
        log(`Te moviste a: ${msg.location.nombre}`, 'success');
        player.locacion = msg.location.id;
        playSound('move');
        renderGame();
      },
      
      'scavenge:result': (msg) => {
        const items = Object.entries(msg.found).map(([k,v]) => `${k}:${v}`).join(', ');
        log(`Encontraste: ${items || 'nada'}`, 'success');
        if (msg.inventario) player.inventario = msg.inventario;
        if (items) playSound('loot');
        renderGame();
      },
      
      'combat': (msg) => {
        log(msg.message, 'combat');
        player.salud = msg.salud;
        renderGame();
      },
      
      'combat:result': (msg) => {
        // Reproducir sonido si viene en el mensaje
        if (msg.playSound) playSound(msg.playSound);
        
        let combatMsg = `âš”ï¸ Eliminaste ${msg.killed} zombies`;
        if (msg.critico) combatMsg += ' Â¡CRÃTICO!';
        if (msg.falloSigilo) combatMsg = 'ğŸš« Fallo de sigilo! Te detectaron y te hirieron.';
        const lootItems = Object.entries(msg.loot || {});
        if (lootItems.length > 0) {
          combatMsg += ' | Loot: ' + lootItems.map(([k,v]) => `${k}:${v}`).join(', ');
        }
        log(`${combatMsg}. Quedan: ${msg.remaining}`, 'combat');
        player.inventario = msg.inventario;
        renderGame();
      },
      
      'craft:success': (msg) => {
        log(`ğŸ”¨ Crafteaste: ${msg.item}`, 'success');
        if (msg.defensas && world.locations?.refugio) {
          world.locations.refugio.defensas = msg.defensas;
        }
        if (msg.inventario) player.inventario = msg.inventario;
        playSound('craft');
        renderGame();
      },
      
      'level:up': (msg) => {
        player.nivel = msg.nivel;
        player.xpParaSiguienteNivel = msg.xpMax;
        player.xp = 0;
        playSound('levelup');
        showNotification(`ğŸ‰ Â¡NIVEL ${msg.nivel}!`, 'success');
        renderGame();
      },
      
      'xp:gained': (msg) => {
        log(`+${msg.amount} XP (${msg.xp}/${msg.xpMax})`, 'success');
        player.xp = msg.xp;
        player.xpParaSiguienteNivel = msg.xpMax;
        renderGame();
      },
      
      'world:event': (msg) => {
        worldLog(msg.message, msg.category);
        const eventsTab = document.getElementById('tab-events');
        if (eventsTab && !eventsTab.classList.contains('active')) {
          showBadge('events');
        }
      },
      
      'player:joined': (msg) => {
        worldLog(`ğŸ‘¤ ${msg.nombre} se uniÃ³`, 'success');
        // Solicitar lista actualizada de jugadores
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'getPlayers' }));
        }
        renderGame();
      },
      
      'player:left': (msg) => {
        worldLog(`ğŸ‘¤ ${msg.nombre} se desconectÃ³`, 'warning');
      },
      
      'players:list': (msg) => {
        renderOnlinePlayers(msg.players);
        updateTradePlayerSelect(msg.players);
      },
      
      'chat:message': (msg) => {
        addChatMessage(msg);
        if (msg.playerId !== player.id) {
          const socialTab = document.getElementById('tab-social');
          if (socialTab && !socialTab.classList.contains('active')) {
            showBadge('social');
          }
        }
      },
      
      'achievement:unlocked': (msg) => {
        handleAchievementUnlocked(msg.achievement);
        if (!player.achievements) player.achievements = {};
        player.achievements[msg.achievement.id] = { desbloqueado: true, fecha: Date.now() };
        playSound('achievement');
        renderAchievements();
      },
      
      'mission:completed': (msg) => {
        showNotification(`âœ… MisiÃ³n: ${msg.mission?.descripcion}`, 'success');
        if (msg.inventario) player.inventario = msg.inventario;
        if (world.activeMissions) {
          const mission = world.activeMissions.find(m => m.id === msg.mission?.id);
          if (mission && !mission.completedBy.includes(player.id)) {
            mission.completedBy.push(player.id);
          }
        }
        renderGame();
      },
      
      'dm:received': (msg) => {
        // Agregar a log local
        if (!directMessages[msg.from]) directMessages[msg.from] = [];
        directMessages[msg.from].push({
          from: msg.from,
          to: player.id,
          message: msg.message,
          timestamp: Date.now(),
          sent: false
        });
        
        // Incrementar contador de no leÃ­dos
        unreadDMs++;
        updateDMBadge();
        
        // NotificaciÃ³n
        playSound('warning');
        log(`ğŸ’Œ Mensaje privado de ${msg.fromName || allPlayers[msg.from] || 'Desconocido'}`, 'warning');
        
        // Si estÃ¡ viendo DMs de ese jugador, actualizar
        if (currentDMTarget === msg.from) {
          renderDMs();
          unreadDMs--;
          updateDMBadge();
        }
        
        // Badge en tab social
        const socialTab = document.getElementById('tab-social');
        if (socialTab && !socialTab.classList.contains('active')) {
          showBadge('social');
        }
      },
      
      'dm:sent': (msg) => {
        playSound('success');
      },
      
      'trade:offer_received': (msg) => {
        log(`ğŸ“¦ ${msg.fromName} te ofrece: ${msg.offer.item} x${msg.offer.cantidad} por ${msg.offer.request.item} x${msg.offer.request.cantidad}`, 'warning');
        showNotification(`ğŸ“¦ Oferta de comercio de ${msg.fromName}`, 'warning');
        playSound('notification');
      },
      
      'trade:success': (msg) => {
        log(msg.message, 'success');
        if (msg.inventario) player.inventario = msg.inventario;
        renderGame();
      },
      
      'donate:success': (msg) => {
        log(`ğŸ’ Donaste ${msg.cantidad} ${msg.item} al refugio (+${msg.xpGain} XP)`, 'success');
        player.inventario = msg.inventario;
        player.xp += msg.xpGain;
        playSound('success');
        showNotification(`Â¡Gracias por tu donaciÃ³n! +${msg.xpGain} XP`, 'success');
        renderGame();
      },
      
      'refugio:recursos': (msg) => {
        if (world.locations && world.locations.refugio) {
          world.locations.refugio.recursos = msg.recursos;
          renderRefugioRecursos();
        }
      },
      
      // ===== MUNDO VIVO =====
      'world:events': (msg) => {
        renderWorldEvents(msg.events);
        // Badge si hay nuevos eventos y no estÃ¡ en el tab
        const mundoTab = document.getElementById('tab-mundo');
        if (mundoTab && !mundoTab.classList.contains('active') && msg.events && msg.events.length > 0) {
          showBadge('mundo');
        }
      },
      
      'world:relationships': (msg) => {
        renderIntenseRelationships(msg.relationships);
      },
      
      'world:fullState': (msg) => {
        renderWorldStats(msg.state);
        
        // Renderizar acciones de NPCs si hay
        if (msg.state.recentNpcActions) {
          renderNpcActions(msg.state.recentNpcActions);
        }
      },
      
      'quests:list': (msg) => {
        renderQuests(msg.quests);
      },
      
      'quest:accepted': (msg) => {
        log(`âœ… MisiÃ³n aceptada: ${msg.quest.title}`, 'success');
        playSound('achievement');
        refreshQuests();
      },
      
      'quest:completed': (msg) => {
        log(msg.result.message, 'success');
        if (msg.result.rewards) {
          const r = msg.result.rewards;
          const rewards = [];
          if (r.xp) rewards.push(`+${r.xp} XP`);
          if (r.reputacion) rewards.push(`+${r.reputacion} ReputaciÃ³n`);
          if (r.oro) rewards.push(`+${r.oro} Oro`);
          log(`ğŸ Recompensas: ${rewards.join(', ')}`, 'success');
        }
        player = { ...player, ...msg.player };
        playSound('achievement');
        renderGame();
        refreshQuests();
      },
      
      // ===== MISIONES NARRATIVAS =====
      'narrative:missions': (msg) => {
        renderNarrativeMissions(msg.missions);
      },
      
      'narrative:started': (msg) => {
        log(`ğŸ“– MisiÃ³n iniciada: ${msg.mission.title}`, 'success');
        showNarrativeMission(msg.mission);
        playSound('achievement');
      },
      
      'narrative:nextStep': (msg) => {
        if (msg.effects) {
          // Mostrar efectos brevemente
          if (msg.effects.damage) {
            log(`ğŸ’” Recibiste daÃ±o: ${msg.effects.damage}`, 'combat');
          }
          if (msg.effects.loot) {
            log(`ğŸ’ Conseguiste items`, 'success');
          }
        }
        
        // Mostrar siguiente paso
        setTimeout(() => {
          showNarrativeStep(msg.step);
        }, 500);
      },
      
      'narrative:completed': (msg) => {
        log(`âœ… Â¡MisiÃ³n completada!`, 'success');
        showNarrativeMissionCompleted(msg.rewards, msg.summary);
      },
      
      'narrative:voted': (msg) => {
        document.getElementById('voteCount').textContent = `Votos: ${msg.votesCount} / ${msg.totalMembers}`;
        log(`âœ… Voto registrado (${msg.votesCount}/${msg.totalMembers})`, 'info');
      },
      
      'narrative:active': (msg) => {
        if (msg.mission) {
          showNarrativeMission(msg.mission);
        }
      },
      
      'error': (msg) => {
        log(`ERROR: ${msg.error}`, 'warning');
      }
    };

    function handleMessage(msg) {
      const handler = messageHandlers[msg.type];
      if (handler) {
        handler(msg);
      } else {
        // Fallback para mensajes no migrados aÃºn
        handleMessageLegacy(msg);
      }
    }

    function handleMessageLegacy(msg) {
      switch(msg.type) {
        case 'world:state':
          world = msg.world;
          console.log('ğŸ“¦ Mundo recibido:', world);
          if (world.players && world.players[player.id]) {
            player = world.players[player.id];
          }
          renderGame();
          break;
        
        case 'mission:completed':
          log(`âœ… MisiÃ³n completada! Recompensa: ${Object.entries(msg.recompensa).map(([k,v]) => `${k}:${v}`).join(', ')}`, 'success');
          if (msg.inventario) {
            player.inventario = msg.inventario;
          }
          // Actualizar el mundo local para reflejar la misiÃ³n completada
          if (world.activeMissions) {
            const mission = world.activeMissions.find(m => m.id === msg.mission.id);
            if (mission && !mission.completedBy.includes(player.id)) {
              mission.completedBy.push(player.id);
            }
          }
          renderGame();
          break;
          
        case 'moved':
          log(`Te moviste a: ${msg.location.nombre}`, 'success');
          player.locacion = msg.location.id;
          playSound('move');
          renderGame();
          break;
          
        case 'scavenge:result':
          const items = Object.entries(msg.found).map(([k,v]) => `${k}:${v}`).join(', ');
          log(`Encontraste: ${items || 'nada'}`, 'success');
          
          // Mostrar pop-ups de consecuencias
          for (const [item, cantidad] of Object.entries(msg.found)) {
            if (cantidad > 0) {
              showStatChange(item, cantidad);
            }
          }
          
          if (msg.inventario) {
            player.inventario = msg.inventario;
          }
          if (items) playSound('loot');
          renderGame();
          break;
          
        case 'combat':
          log(msg.message, 'combat');
          const oldHealth = player.salud;
          player.salud = msg.salud;
          
          // Mostrar cambio de salud
          if (player.salud !== oldHealth) {
            showStatChange('salud', player.salud - oldHealth);
          }
          
          renderGame();
          break;
          
        case 'give:success':
          log(`Le diste ${msg.cantidad} ${msg.item} a ${msg.npc}`, 'success');
          if (msg.inventario) {
            player.inventario = msg.inventario;
          }
          world.npcs[msg.npcState.id] = msg.npcState;
          renderGame();
          break;
          
        case 'dialogue':
          // Reproducir sonido de saludo inicial o de charla
          if (msg.playSound) {
            playSound(msg.playSound);
          }
          
          log(`${msg.npc}: "${msg.text}"`, '');
          
          // Actualizar panel de diÃ¡logo interactivo
          activeDialogue = {
            npcId: msg.npcId,
            npcName: msg.npc,
            text: msg.text,
            options: msg.options || []
          };
          
          dialogueHistory.push({
            speaker: msg.npc,
            text: msg.text,
            timestamp: Date.now()
          });
          
          renderInteractiveDialogue();
          showBadge('events');
          break;
          
        case 'npc:died':
          log(`ğŸ’€ ${msg.nombre} ha muerto`, 'death');
          if (world.npcs[msg.npcId]) {
            world.npcs[msg.npcId].vivo = false;
          }
          renderGame();
          break;
          
        case 'npc:updated':
          world.npcs[msg.npcId] = msg.npc;
          renderGame();
          break;
          
        case 'horde:warning':
          log(msg.message, 'warning');
          document.getElementById('hordeWarning').style.display = 'block';
          break;
          
        case 'horde:attacked':
          log(msg.message, 'combat');
          document.getElementById('hordeWarning').style.display = 'none';
          renderGame();
          break;
          
        case 'horde:npc_killed':
          log(`ğŸ’€ ${msg.npcNombre} muriÃ³ en el ataque de la horda`, 'death');
          break;
          
        case 'quest:new':
          log(`ğŸ“‹ Nueva quest: ${msg.quest.descripcion}`, 'success');
          if (!world.activeQuests) world.activeQuests = [];
          world.activeQuests.push(msg.quest);
          renderGame();
          break;
          
        case 'craft:success':
          log(`ğŸ”¨ Crafteaste: ${msg.item}`, 'success');
          if (msg.defensas) {
            log(`ğŸ›¡ï¸ Defensas del refugio: ${msg.defensas}`, 'success');
            if (world.locations && world.locations.refugio) {
              world.locations.refugio.defensas = msg.defensas;
            }
          }
          if (msg.inventario) {
            player.inventario = msg.inventario;
          }
          playSound('craft');
          renderGame();
          break;
          
        case 'combat:result':
          let combatMsg = `âš”ï¸ Eliminaste ${msg.killed} zombies`;
          if (msg.critico) combatMsg += ' Â¡CRÃTICO!';
          if (msg.falloSigilo) combatMsg = 'ğŸš« Fallo de sigilo! Te detectaron y te hirieron.';
          
          const lootItems = Object.entries(msg.loot || {});
          if (lootItems.length > 0) {
            combatMsg += ' | Loot: ' + lootItems.map(([k,v]) => `${k}:${v}`).join(', ');
          }
          
          log(`${combatMsg}. Quedan: ${msg.remaining}`, 'combat');
          player.inventario = msg.inventario;
          renderGame();
          break;
          
        case 'shoot:result':
          log(`ğŸ”« Mataste ${msg.killed} zombies. Quedan: ${msg.remaining}`, 'combat');
          log(msg.warning, 'warning');
          renderGame();
          break;
          
        case 'event:special':
          log(`ğŸ­ EVENTO: ${msg.event.nombre}`, 'success');
          world.activeEvents = [msg.event];
          renderGame();
          break;
          
        case 'event:resolved':
          log(msg.resultado, 'success');
          player.inventario = msg.inventario;
          world.activeEvents = [];
          renderGame();
          break;
          
        case 'event:expired':
          log('El evento expirÃ³', 'warning');
          world.activeEvents = [];
          renderGame();
          break;
          
        case 'world:event':
          worldLog(msg.message, msg.category);
          
          // Mostrar badge en pestaÃ±a de eventos si no estÃ¡ activa
          const eventsTab = document.getElementById('tab-events');
          if (eventsTab && !eventsTab.classList.contains('active')) {
            showBadge('events');
          }
          break;
          
        case 'player:joined':
          worldLog(`ğŸ‘¤ ${msg.nombre} se uniÃ³`, 'success');
          renderGame();
          break;
          
        case 'player:left':
          worldLog(`ğŸ‘¤ ${msg.nombre} se desconectÃ³`, 'warning');
          break;

        case 'players:list':
          renderOnlinePlayers(msg.players);
          break;
          
        case 'player:moved':
          renderGame();
          break;
          
        case 'trade:success':
          log(msg.message, 'success');
          player.inventario = msg.inventario;
          renderGame();
          break;
          
        case 'xp:gained':
          log(`+${msg.amount} XP (${msg.xp}/${msg.xpMax})`, 'success');
          player.xp = msg.xp;
          player.xpParaSiguienteNivel = msg.xpMax;
          renderGame();
          break;
          
        case 'level:up':
          log(`â­ Â¡SUBISTE A NIVEL ${msg.nivel}!`, 'success');
          player.nivel = msg.nivel;
          player.xpParaSiguienteNivel = msg.xpMax;
          player.xp = 0;
          playSound('levelup');
          showNotification(`ğŸ‰ Â¡NIVEL ${msg.nivel}!`, 'success');
          renderGame();
          break;
          
        case 'refugio:recursos':
          if (world.locations && world.locations.refugio) {
            world.locations.refugio.recursos = msg.recursos;
          }
          renderGame();
          break;
          
        case 'quest:cooperativa':
          renderQuestCooperativa(msg.quest);
          worldLog(`ğŸ¤ QUEST COOPERATIVA: ${msg.quest.nombre}`, 'special');
          break;
          
        case 'quest:votes_update':
          updateVotosQuest(msg.votos);
          break;
          
        case 'quest:resultado':
          worldLog(`âœ… Quest resuelta: ${msg.opcionGanadora}`, 'success');
          document.getElementById('questCooperativa').innerHTML = '<em style="color: #888;">Sin quest activa</em>';
          break;
          
        case 'quest:voted':
          log(msg.message, 'success');
          break;
          
        case 'error':
          log(`ERROR: ${msg.error}`, 'warning');
          break;
          
        case 'chat:message':
          addChatMessage(msg);
          
          // Mostrar badge en pestaÃ±a social si no estÃ¡ activa y no es tu mensaje
          if (msg.playerId !== player.id) {
            const socialTab = document.getElementById('tab-social');
            if (socialTab && !socialTab.classList.contains('active')) {
              showBadge('social');
            }
          }
          break;
          
        case 'chat:system':
          addSystemMessage(msg.mensaje);
          break;
        
        // ====================================
        // MENSAJES PRIVADOS
        // ====================================
        case 'dm:received':
          // Agregar a log local
          if (!directMessages[msg.from]) directMessages[msg.from] = [];
          directMessages[msg.from].push({
            from: msg.from,
            to: player.id,
            message: msg.message,
            timestamp: Date.now(),
            sent: false
          });
          
          // Incrementar contador de no leÃ­dos
          unreadDMs++;
          updateDMBadge();
          
          // NotificaciÃ³n
          playSound('warning');
          log(`ğŸ’Œ Mensaje privado de ${allPlayers[msg.from] || 'Desconocido'}`, 'warning');
          
          // Si estÃ¡ viendo DMs de ese jugador, actualizar
          if (currentDMTarget === msg.from) {
            renderDMs();
            unreadDMs--;
            updateDMBadge();
          }
          
          // Badge en tab social
          const socialTab = document.getElementById('tab-social');
          if (socialTab && !socialTab.classList.contains('active')) {
            showBadge('social');
          }
          break;
        
        case 'dm:sent':
          playSound('success');
          break;
          
        case 'achievement:unlocked':
          handleAchievementUnlocked(msg.achievement);
          if (!player.achievements) player.achievements = {};
          player.achievements[msg.achievement.id] = { desbloqueado: true, fecha: Date.now() };
          playSound('achievement');
          renderAchievements();
          break;
          
        case 'players:list':
          renderOnlinePlayers(msg.players);
          updateTradePlayerSelect(msg.players);
          break;
          
        case 'mission:completed':
          showNotification(`âœ… MisiÃ³n completada: ${msg.mission.descripcion}`, 'success');
          player.inventario = msg.inventario;
          renderGame();
          break;
          
        case 'pet:updated':
          player.mascota = msg.mascota;
          player.inventario = msg.inventario;
          renderPet();
          break;
        
        case 'pet:adopted':
          player.mascota = msg.mascota;
          showNotification(`ğŸ¾ Adoptaste ${msg.mascota.nombre}!`, 'success');
          renderPet();
          break;
        
        case 'faction:joined':
          player.faccion = msg.faccion;
          player.factionRep = msg.reputation;
          showNotification(`âš”ï¸ Te uniste a ${msg.faccion.nombre}!`, 'success');
          renderFaction();
          break;
        
        case 'faction:reputation':
          player.factionRep = msg.reputation;
          renderFaction();
          break;
        
        case 'vehicle:created':
          player.vehiculo = msg.vehiculo;
          player.inventario = msg.inventario;
          showNotification(`ğŸš— Construiste ${msg.vehiculo.nombre}!`, 'success');
          renderVehicle();
          break;
          
        case 'ability:result':
          if (msg.success) {
            showNotification(`âš¡ ${msg.ability.nombre} activada!`, 'success');
            renderGame();
          } else {
            showNotification(msg.error, 'warning');
          }
          break;
          
        case 'reputation:updated':
          showNotification(`ReputaciÃ³n con NPC: ${msg.level.nombre}`, 'info');
          break;
          
        case 'pvp:match:start':
          currentPvPMatch = msg.matchId;
          document.getElementById('pvpMatch').style.display = 'block';
          document.getElementById('pvpPlayer1').textContent = msg.player1.nombre;
          document.getElementById('pvpPlayer2').textContent = msg.player2.nombre;
          document.getElementById('pvpPlayer1HP').style.width = '100%';
          document.getElementById('pvpPlayer2HP').style.width = '100%';
          showNotification(`âš”ï¸ Combate PvP iniciado!`, 'info');
          break;
          
        case 'pvp:attack':
          const isP1 = msg.attacker === player.nombre;
          const targetHP = msg.defenderSalud;
          const maxHP = 100;
          const hpPercent = (targetHP / maxHP) * 100;
          
          if (isP1) {
            document.getElementById('pvpPlayer2HP').style.width = hpPercent + '%';
          } else {
            document.getElementById('pvpPlayer1HP').style.width = hpPercent + '%';
          }
          
          log(`âš”ï¸ ${msg.attacker} atacÃ³ a ${msg.defender} por ${msg.damage} de daÃ±o`, 'combat');
          break;
          
        case 'pvp:match:end':
          const won = msg.winner === player.nombre;
          showNotification(won ? 'ğŸ† Â¡VICTORIA!' : 'ğŸ’€ Derrota', won ? 'success' : 'warning');
          document.getElementById('pvpMatch').style.display = 'none';
          currentPvPMatch = null;
          renderGame();
          break;
        
        // ====================================
        // EVENTOS NARRATIVOS
        // ====================================
        case 'narrative:event':
          world.activeNarrativeEvent = msg.event;
          log(`ğŸ“– ${msg.event.nombre} (Parte ${msg.event.parte})`, 'warning');
          playSound('notification');
          showBadge('events'); // Notificar en tab EVENTOS
          renderGame();
          break;
        
        case 'narrative:completed':
          log(msg.resultado, 'success');
          player.inventario = msg.inventario;
          if (msg.defensas) {
            world.locations.refugio.defensas = msg.defensas;
          }
          renderGame();
          break;
        
        case 'narrative:failed':
          log(msg.message, 'warning');
          playSound('error');
          break;
      }
    }

    function addChatMessage(msg) {
      const chatLog = document.getElementById('chatLog');
      const entry = document.createElement('div');
      entry.style.cssText = 'margin: 5px 0; padding: 5px; background: #2a2a2a; border-radius: 3px;';
      
      const time = new Date(msg.timestamp).toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
      const isMe = msg.playerId === player.id;
      const nameColor = isMe ? '#00ff00' : msg.color || '#00ffff';
      
      entry.innerHTML = `
        <div style="font-size: 10px; color: #888;">${time}</div>
        <div><span style="color: ${nameColor}; font-weight: bold;">${msg.avatar} ${msg.nombre}:</span> ${msg.mensaje}</div>
      `;
      
      chatLog.appendChild(entry);
      chatLog.scrollTop = chatLog.scrollHeight;
      
      // Mantener solo Ãºltimos 30 mensajes
      while (chatLog.children.length > 30) {
        chatLog.removeChild(chatLog.firstChild);
      }
    }

    function addSystemMessage(mensaje) {
      const chatLog = document.getElementById('chatLog');
      const entry = document.createElement('div');
      entry.style.cssText = 'margin: 5px 0; padding: 8px; background: #1a3a1a; border-left: 3px solid #00ff00; border-radius: 3px; white-space: pre-line;';
      
      entry.innerHTML = `<span style="color: #00ff00; font-weight: bold;">ğŸ–¥ï¸ SISTEMA:</span> ${mensaje}`;
      
      chatLog.appendChild(entry);
      chatLog.scrollTop = chatLog.scrollHeight;
      
      // Mantener solo Ãºltimos 30 mensajes
      while (chatLog.children.length > 30) {
        chatLog.removeChild(chatLog.firstChild);
      }
    }

    function sendChat() {
      const input = document.getElementById('chatInput');
      const mensaje = input.value.trim();
      
      if (!mensaje) return;
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No conectado al servidor', 'warning');
        return;
      }
      
      ws.send(JSON.stringify({
        type: 'chat',
        mensaje: mensaje
      }));
      
      input.value = '';
    }
    
    // ====================================
    // MENSAJES PRIVADOS (DMs)
    // ====================================
    function sendDM() {
      const input = document.getElementById('dmInput');
      const targetSelect = document.getElementById('dmTargetSelect');
      const mensaje = input.value.trim();
      const targetId = targetSelect.value;
      
      if (!mensaje || !targetId) {
        showActionFeedback('Selecciona un jugador y escribe un mensaje', 'danger');
        return;
      }
      
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No conectado al servidor', 'warning');
        return;
      }
      
      ws.send(JSON.stringify({
        type: 'dm',
        targetId,
        mensaje
      }));
      
      // Agregar a log local
      if (!directMessages[targetId]) directMessages[targetId] = [];
      directMessages[targetId].push({
        from: player.id,
        to: targetId,
        message: mensaje,
        timestamp: Date.now(),
        sent: true
      });
      
      currentDMTarget = targetId;
      renderDMs();
      input.value = '';
      playSound('success');
    }
    
    function renderDMs() {
      const dmLog = document.getElementById('dmLog');
      if (!currentDMTarget || !directMessages[currentDMTarget]) {
        dmLog.innerHTML = '<em style="color: #888;">No hay mensajes con este jugador</em>';
        return;
      }
      
      const messages = directMessages[currentDMTarget];
      const html = messages.map(dm => {
        const isSent = dm.from === player.id;
        const time = new Date(dm.timestamp).toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
        const senderName = isSent ? 'TÃº' : (allPlayers[dm.from] || 'Desconocido');
        
        return `
          <div class="dm-message ${isSent ? 'dm-sent' : 'dm-received'}">
            <div style="font-weight: bold; color: ${isSent ? '#00ff00' : '#ff8800'}; margin-bottom: 3px;">
              ${senderName} <span style="font-size: 9px; color: #888; font-weight: normal;">${time}</span>
            </div>
            <div>${dm.message}</div>
          </div>
        `;
      }).join('');
      
      dmLog.innerHTML = html;
      dmLog.scrollTop = dmLog.scrollHeight;
    }
    
    function switchChatTab(tab) {
      // Cambiar tabs
      document.querySelectorAll('.craft-tab').forEach(t => {
        if (t.onclick && t.onclick.toString().includes('switchChatTab')) {
          t.classList.remove('active');
        }
      });
      
      event.target.classList.add('active');
      
      // Cambiar secciones
      document.getElementById('chat-global').classList.remove('active');
      document.getElementById('chat-dms').classList.remove('active');
      
      if (tab === 'global') {
        document.getElementById('chat-global').classList.add('active');
      } else if (tab === 'dms') {
        document.getElementById('chat-dms').classList.add('active');
        unreadDMs = 0;
        updateDMBadge();
      }
      
      playSound('success');
    }
    
    function updateDMBadge() {
      const badge = document.getElementById('dmBadge');
      if (unreadDMs > 0) {
        badge.style.display = 'block';
        badge.textContent = unreadDMs;
      } else {
        badge.style.display = 'none';
      }
    }
    
    // ====================================
    // INSPECCIONAR JUGADOR
    // ====================================
    function inspectPlayer(playerId) {
      // Pedir datos completos del jugador al servidor
      fetch(`/api/player/${playerId}`)
        .then(r => r.json())
        .then(data => {
          if (data.error) {
            showActionFeedback(data.error, 'danger');
            return;
          }
          showPlayerProfile(data.player);
        })
        .catch(err => {
          console.error('Error al inspeccionar:', err);
          showActionFeedback('Error al cargar perfil', 'danger');
        });
      
      playSound('success');
    }
    
    function showPlayerProfile(target) {
      const modal = document.getElementById('profileModal');
      const backdrop = document.getElementById('profileBackdrop');
      const content = document.getElementById('profileContent');
      
      // Calcular tÃ­tulo/rango
      let rankBadge = '';
      let titleBadge = '';
      
      const stats = target.stats || {};
      const zombies = stats.zombies_matados || 0;
      const dias = stats.dias_sobrevividos || 0;
      
      if (zombies > 100) rankBadge = 'ğŸ’€';
      else if (zombies > 50) rankBadge = 'âš”ï¸';
      else if (zombies > 20) rankBadge = 'ğŸ”ª';
      
      if (dias > 30) titleBadge = '<span class="title-badge">ğŸ† VETERANO</span>';
      else if (dias > 15) titleBadge = '<span class="title-badge">â­ SUPERVIVIENTE</span>';
      else if (dias > 7) titleBadge = '<span class="title-badge">ğŸ–ï¸ RESISTENTE</span>';
      
      // Calcular "prestigio" (score combinado)
      const prestigio = (zombies * 10) + (dias * 100) + (target.nivel * 50) + (stats.items_crafteados || 0);
      
      // ComparaciÃ³n con tus stats
      const myZombies = player.stats?.zombies_matados || 0;
      const myNivel = player.nivel || 1;
      const myDias = player.stats?.dias_sobrevividos || 0;
      
      const html = `
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 48px; margin: 10px 0;">${rankBadge || 'ğŸ‘¤'}</div>
          <h2 style="color: #00ff00; margin: 5px 0;">${target.nombre}</h2>
          ${titleBadge}
          <div style="font-size: 12px; color: #888; margin-top: 5px;">Prestigio: ${prestigio.toLocaleString()}</div>
        </div>
        
        <div style="border-top: 2px solid #00ff00; padding-top: 15px; margin-top: 15px;">
          <h3 style="margin-bottom: 10px;">ğŸ“Š ESTADÃSTICAS</h3>
          
          <div class="stat-comparison">
            <span>Nivel:</span>
            <span class="${target.nivel > myNivel ? 'stat-better' : target.nivel < myNivel ? 'stat-worse' : ''}">${target.nivel}</span>
          </div>
          
          <div class="stat-comparison">
            <span>ğŸ§Ÿ Zombies eliminados:</span>
            <span class="${zombies > myZombies ? 'stat-better' : zombies < myZombies ? 'stat-worse' : ''}">${zombies}</span>
          </div>
          
          <div class="stat-comparison">
            <span>ğŸ“… DÃ­as sobrevividos:</span>
            <span class="${dias > myDias ? 'stat-better' : dias < myDias ? 'stat-worse' : ''}">${dias}</span>
          </div>
          
          <div class="stat-comparison">
            <span>ğŸ”¨ Items crafteados:</span>
            <span>${stats.items_crafteados || 0}</span>
          </div>
          
          <div class="stat-comparison">
            <span>ğŸ—ºï¸ Locaciones visitadas:</span>
            <span>${stats.locaciones_visitadas || 1}</span>
          </div>
        </div>
        
        <div style="border-top: 2px solid #00ff00; padding-top: 15px; margin-top: 15px;">
          <h3 style="margin-bottom: 10px;">ğŸ’ INVENTARIO</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; font-size: 11px;">
            <div>ğŸ– Comida: ${target.inventario?.comida || 0}</div>
            <div>ğŸ’Š Medicinas: ${target.inventario?.medicinas || 0}</div>
            <div>ğŸ”© Materiales: ${target.inventario?.materiales || 0}</div>
            <div>ğŸ”« Armas: ${target.inventario?.armas || 0}</div>
          </div>
        </div>
        
        ${target.mascota ? `
        <div style="border-top: 2px solid #00ff00; padding-top: 15px; margin-top: 15px;">
          <h3 style="margin-bottom: 10px;">ğŸ¾ MASCOTA</h3>
          <div style="text-align: center;">
            <div style="font-size: 32px;">${target.mascota.icono || 'ğŸ•'}</div>
            <div style="color: #00ff00;">${target.mascota.nombre}</div>
            <div style="font-size: 11px; color: #888;">Nivel ${target.mascota.nivel || 1}</div>
          </div>
        </div>
        ` : ''}
        
        <div style="margin-top: 20px; display: flex; gap: 10px;">
          <button onclick="sendDMTo('${target.id}', '${target.nombre}')" style="flex: 1; padding: 10px;">ğŸ’Œ Mensaje Privado</button>
          <button onclick="closeProfile()" style="padding: 10px;">Cerrar</button>
        </div>
      `;
      
      content.innerHTML = html;
      modal.style.display = 'block';
      backdrop.style.display = 'block';
    }
    
    function closeProfile() {
      document.getElementById('profileModal').style.display = 'none';
      document.getElementById('profileBackdrop').style.display = 'none';
    }
    
    function sendDMTo(playerId, playerName) {
      closeProfile();
      switchTab('social');
      switchChatTab('dms');
      
      // Seleccionar jugador en el dropdown
      const select = document.getElementById('dmTargetSelect');
      select.value = playerId;
      currentDMTarget = playerId;
      renderDMs();
      
      // Focus en input
      document.getElementById('dmInput').focus();
    }
    
    // ====================================
    // LEADERBOARD
    // ====================================
    function switchLeaderboard(category) {
      currentLeaderboard = category;
      
      // Cambiar tabs
      document.querySelectorAll('.craft-tab').forEach(t => {
        if (t.onclick && t.onclick.toString().includes('switchLeaderboard')) {
          t.classList.remove('active');
        }
      });
      
      event.target.classList.add('active');
      
      // Pedir datos al servidor
      fetch(`/api/leaderboard/${category}`)
        .then(r => r.json())
        .then(data => {
          renderLeaderboard(data.rankings, category);
        })
        .catch(err => {
          console.error('Error al cargar leaderboard:', err);
          document.getElementById('leaderboardContent').innerHTML = '<em style="color: #ff8888;">Error al cargar rankings</em>';
        });
      
      playSound('success');
    }
    
    function renderLeaderboard(rankings, category) {
      const container = document.getElementById('leaderboardContent');
      
      if (!rankings || rankings.length === 0) {
        container.innerHTML = '<em style="color: #888;">No hay datos disponibles</em>';
        return;
      }
      
      let categoryLabel = '';
      let valueKey = '';
      
      switch(category) {
        case 'zombies':
          categoryLabel = 'ğŸ§Ÿ Zombies';
          valueKey = 'zombies_matados';
          break;
        case 'nivel':
          categoryLabel = 'ğŸ“Š Nivel';
          valueKey = 'nivel';
          break;
        case 'dias':
          categoryLabel = 'ğŸ“… DÃ­as';
          valueKey = 'dias_sobrevividos';
          break;
        case 'prestigio':
          categoryLabel = 'ğŸ‘‘ Prestigio';
          valueKey = 'prestigio';
          break;
      }
      
      const html = rankings.map((entry, idx) => {
        const rank = idx + 1;
        const rankClass = rank <= 3 ? `rank-${rank}` : '';
        const isMe = entry.playerId === player.id;
        const rankEmoji = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : `#${rank}`;
        
        return `
          <div class="leaderboard-entry ${rankClass}" style="${isMe ? 'border: 2px solid #00ffff;' : ''}">
            <div>
              <span style="font-weight: bold; font-size: 14px; margin-right: 10px;">${rankEmoji}</span>
              <span style="color: ${isMe ? '#00ffff' : '#00ff00'}; font-weight: ${isMe ? 'bold' : 'normal'};">
                ${entry.nombre}${isMe ? ' (TÃš)' : ''}
              </span>
            </div>
            <div style="font-weight: bold; color: ${rank === 1 ? '#ffd700' : rank === 2 ? '#c0c0c0' : rank === 3 ? '#cd7f32' : '#fff'};">
              ${entry[valueKey]?.toLocaleString() || 0}
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = html;
    }
    
    // Cargar leaderboard por defecto al abrir tab
    function loadDefaultLeaderboard() {
      if (currentLeaderboard) {
        fetch(`/api/leaderboard/${currentLeaderboard}`)
          .then(r => r.json())
          .then(data => {
            renderLeaderboard(data.rankings, currentLeaderboard);
          })
          .catch(err => console.error('Error al cargar leaderboard:', err));
      }
    }
    
    // Enviar con Enter
    document.addEventListener('DOMContentLoaded', () => {
      const chatInput = document.getElementById('chatInput');
      if (chatInput) {
        chatInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            sendChat();
          }
        });
      }
    });

    function renderGame() {
      if (!player || !world) {
        console.warn('âš ï¸ No se puede renderizar: player o world es null', {player, world});
        return;
      }
      
      console.log('ğŸ¨ Renderizando juego...', {player: player.nombre, locacion: player.locacion});
      
      // Renders crÃ­ticos (siempre se ejecutan)
      renderPlayerStats();
      renderLocation();
      renderWorldTime();
      
      // Renders con cachÃ© (solo si cambiÃ³ el contenido)
      cachedRender('inventory', renderInventory, player.inventario);
      cachedRender('skills', renderSkills, player.skills);
      cachedRender('npcs', renderNPCs, world.npcs);
      cachedRender('quests', renderQuests, world.quests);
      cachedRender('defensas', renderDefensas, player.defensas);
      cachedRender('refugio', renderRefugioRecursos, world.refugio);
      
      // Renders condicionales
      renderLocations();
      renderSpecialEvent();
      renderNarrativeEvent();
      renderPlayersHere();
      renderInteractiveDialogue();
      renderMissions();
      renderPet();
      renderAbilities();
      renderFaction();
      renderVehicle();
      renderAchievements();
      renderTimeOfDay();
      renderRefugioVisual();
    }

    function renderPlayerStats() {
      // Determinar colores segÃºn estado crÃ­tico
      const saludColor = player.salud < 30 ? '#ff0000' : player.salud < 50 ? '#ffaa00' : '#00ff00';
      const hambreColor = player.hambre < 30 ? '#ff0000' : player.hambre < 50 ? '#ffaa00' : '#88ff88';
      
      const html = `
        <div style="text-align: center; font-size: 60px; margin-bottom: 10px; color: ${player.color || '#00ff00'};">
          ${player.avatar || 'ğŸ‘¤'}
        </div>
        <div class="stat" style="color: #888;">
          <strong style="color: #00ff00;">Nombre:</strong> ${player.nombre}
        </div>
        <div class="stat" style="color: #ffaa00;">
          <strong>Clase:</strong> ${(player.clase || 'superviviente').toUpperCase()}
        </div>
        <div class="stat" style="color: #888;">
          â­ Nivel: ${player.nivel || 1} | XP: ${player.xp || 0}/${player.xpParaSiguienteNivel || 100}
          <div class="stat-bar">
            <div class="stat-fill" style="width: ${((player.xp || 0)/(player.xpParaSiguienteNivel || 100)*100)}%; background: #ffaa00;"></div>
          </div>
        </div>
        <div class="stat" style="color: #666;">
          ğŸ’ª Fuerza: ${player.fuerza || 5} | ğŸ›¡ï¸ Resistencia: ${player.resistencia || 5}
        </div>
        <div class="stat" style="color: #666;">
          âš¡ Agilidad: ${player.agilidad || 5} | ğŸ§  Inteligencia: ${player.inteligencia || 5}
        </div>
        <div class="stat">
          <strong style="color: ${saludColor};">â¤ï¸ Salud: ${player.salud}/100</strong>
          ${player.salud < 30 ? ' <span style="color: #ff0000; font-weight: bold;">âš ï¸ CRÃTICO</span>' : ''}
          <div class="stat-bar">
            <div class="stat-fill salud" style="width: ${player.salud}%; background: ${saludColor};"></div>
          </div>
        </div>
        <div class="stat">
          <strong style="color: ${hambreColor};">ğŸ– Hambre: ${player.hambre}/100</strong>
          ${player.hambre < 30 ? ' <span style="color: #ff0000; font-weight: bold;">âš ï¸ HAMBRIENTO</span>' : ''}
          <div class="stat-bar">
            <div class="stat-fill hambre" style="width: ${player.hambre}%; background: ${hambreColor};"></div>
          </div>
        </div>
      `;
      document.getElementById('playerStats').innerHTML = html;
    }

    function renderInventory() {
      const html = Object.entries(player.inventario)
        .map(([item, cant]) => `<div>${item}: ${cant}</div>`)
        .join('');
      document.getElementById('inventory').innerHTML = html || '<em>VacÃ­o</em>';
    }

    function renderLocation() {
      const loc = world.locations[player.locacion];
      document.getElementById('locationName').textContent = `ğŸ“ ${loc.nombre}`;
      document.getElementById('locationDesc').textContent = loc.descripcion;
      
      let actionsHtml = '';
      
      if (loc.tipo === 'loot') {
        actionsHtml += `
          <button onclick="scavenge()" style="width: 100%; padding: 15px; font-size: 16px; margin: 10px 0; background: #00aa00; cursor: pointer; border: 2px solid #00ff00;">
            ğŸ” BUSCAR RECURSOS (+XP)
          </button>
          ${loc.zombies > 0 ? `
            <div style="background: #2a1a1a; padding: 10px; margin: 10px 0; border: 2px solid #ff0000;">
              <div style="margin-bottom: 5px; font-weight: bold; color: #ff8888;">âš ï¸ ${loc.zombies} zombies aquÃ­</div>
              ${player.inventario.armas > 0 ? `
                <button onclick="attack('shoot')" style="width: 100%; padding: 10px; margin: 3px 0; background: #660000; border: 1px solid #ff0000;">
                  ğŸ”« DISPARAR (armas: ${player.inventario.armas}) - Alto daÃ±o, mucho ruido
                </button>
              ` : ''}
              <button onclick="attack('melee')" style="width: 100%; padding: 10px; margin: 3px 0; background: #664400; border: 1px solid #ffaa00;">
                ğŸ¥Š MELEE - DaÃ±o medio, poco ruido
              </button>
              <button onclick="attack('stealth')" style="width: 100%; padding: 10px; margin: 3px 0; background: #004466; border: 1px solid #00aaff;">
                ğŸ§‘â€ğŸ¦¡ SIGILO - Kill silencioso o fallas (skill)
              </button>
            </div>
          ` : ''}
          ${loc.nivelRuido > 30 ? `<span style="color: #ff8800;"> ğŸ”Š RUIDOSO (${loc.nivelRuido})</span>` : ''}
        `;
      } else if (loc.id === 'refugio') {
        actionsHtml += `<p style="color: #00ff00; padding: 10px; background: #1a3a1a;">âœ… EstÃ¡s a salvo aquÃ­</p>`;
      }
      
      document.getElementById('locationActions').innerHTML = actionsHtml;
      
      // Actualizar info de locaciÃ³n en panel derecho
      renderLocationInfo();
    }

    function renderLocationInfo() {
      if (!world || !world.locations || !player) return;
      
      const loc = world.locations[player.locacion];
      if (!loc) return;
      
      const html = `
        <div>ğŸ§Ÿ Zombies: ${loc.zombies || 0}</div>
        <div>ğŸ”Š Ruido: ${loc.nivelRuido || 0}</div>
        <div>ğŸ›¡ï¸ Defensas: ${loc.defensas || 0}</div>
      `;
      
      const locationInfoEl = document.getElementById('locationInfo');
      if (locationInfoEl) {
        locationInfoEl.innerHTML = html;
      }
    }

    function renderSkills() {
      if (!player.skills) return;
      const html = Object.entries(player.skills)
        .map(([skill, nivel]) => {
          const barWidth = (nivel / 10) * 100;
          return `
            <div style="margin: 5px 0;">
              <strong>${skill}:</strong> ${nivel.toFixed(1)}/10
              <div class="stat-bar">
                <div class="stat-fill" style="width: ${barWidth}%; background: #00ffff;"></div>
              </div>
            </div>
          `;
        }).join('');
      document.getElementById('skills').innerHTML = html;
    }

    function renderDefensas() {
      const refugio = world.locations.refugio;
      if (refugio) {
        document.getElementById('defensas').textContent = `ğŸ›¡ï¸ ${refugio.defensas || 0}`;
      }
    }

    function renderQuests() {
      if (!world.activeQuests || world.activeQuests.length === 0) {
        document.getElementById('quests').innerHTML = '<em>Sin quests activas</em>';
        return;
      }
      
      const html = world.activeQuests.map(q => `
        <div style="background: #1a1a1a; padding: 5px; margin: 5px 0; border-left: 2px solid #ffff00;">
          ${q.descripcion}
        </div>
      `).join('');
      document.getElementById('quests').innerHTML = html;
    }

    function craft(item) {
      ws.send(JSON.stringify({ type: 'craft', item }));
    }

    function attack(tipo) {
      let confirmMsg = '';
      if (tipo === 'shoot') confirmMsg = 'Â¿Disparar? AtraerÃ¡ mÃ¡s zombies por el ruido.';
      else if (tipo === 'melee') confirmMsg = 'Â¿Ataque cuerpo a cuerpo? Es arriesgado.';
      else if (tipo === 'stealth') confirmMsg = 'Â¿Intento sigiloso? Puede fallar y te lastimarÃ¡n.';
      
      if (confirm(confirmMsg)) {
        ws.send(JSON.stringify({ type: 'attack', attackType: tipo }));
      }
    }
    
    function craft(item) {
      ws.send(JSON.stringify({ type: 'craft', item }));
    }

    function renderLocations() {
      const current = world.locations[player.locacion];
      const html = current.conectado_a.map(locId => {
        const loc = world.locations[locId];
        const isDanger = loc.zombies > 2;
        return `
          <div class="location ${isDanger ? 'danger' : ''}" onclick="moveTo('${locId}')">
            <strong>${loc.nombre}</strong>
            ${loc.zombies > 0 ? `<span class="zombie-count">(ğŸ§Ÿ ${loc.zombies})</span>` : ''}
          </div>
        `;
      }).join('');
      document.getElementById('locations').innerHTML = html;
    }

    function renderNPCs() {
      const html = Object.values(world.npcs)
        .filter(npc => npc.locacion === 'refugio')
        .map(npc => `
          <div class="npc ${!npc.vivo ? 'dead' : ''}">
            <div class="npc-name">${npc.nombre} ${!npc.vivo ? 'ğŸ’€' : ''}</div>
            ${npc.vivo ? `
              <div style="font-size: 11px; margin: 5px 0;">
                â¤ï¸ ${npc.salud} | ğŸ– ${npc.hambre} | ğŸ˜Š ${npc.moral}
              </div>
              <button onclick="talkTo('${npc.id}')">ğŸ’¬</button>
              <button onclick="giveItem('${npc.id}', 'comida')">ğŸ–</button>
              <button onclick="giveItem('${npc.id}', 'medicinas')">ğŸ’Š</button>
            ` : '<em>Muerto</em>'}
          </div>
        `).join('');
      document.getElementById('npcs').innerHTML = html;
    }

    function renderWorldTime() {
      document.getElementById('worldTime').textContent = `DÃ­a ${Math.floor(world.simulationTime / 144)}, ${(world.simulationTime % 144) * 10} min`;
    }

    function moveTo(locId) {
      ws.send(JSON.stringify({ type: 'move', targetId: locId }));
    }

    function scavenge() {
      ws.send(JSON.stringify({ type: 'scavenge' }));
    }

    function talkTo(npcId) {
      ws.send(JSON.stringify({ type: 'talk', npcId }));
    }

    function giveItem(npcId, item) {
      ws.send(JSON.stringify({ type: 'give', npcId, item, cantidad: 1 }));
    }
    
    function renderInteractiveDialogue() {
      const container = document.getElementById('interactiveDialogue');
      if (!container) return;
      
      if (!activeDialogue && dialogueHistory.length === 0) {
        container.innerHTML = '<em style="color: #888;">Sin conversaciones activas</em>';
        return;
      }
      
      let html = '<div style="max-height: 250px; overflow-y: auto; margin-bottom: 10px;">';
      
      // Mostrar historial de conversaciÃ³n
      dialogueHistory.slice(-5).forEach(entry => {
        const time = new Date(entry.timestamp).toLocaleTimeString();
        html += `
          <div style="margin: 5px 0; padding: 8px; background: #1a2a2a; border-left: 3px solid #00ffff; border-radius: 3px;">
            <strong style="color: #00ffff;">${entry.speaker}</strong> <span style="color: #666; font-size: 9px;">${time}</span>
            <div style="color: #ccc; margin-top: 3px; font-size: 12px;">${entry.text}</div>
          </div>
        `;
      });
      
      html += '</div>';
      
      // Mostrar opciones de respuesta si hay diÃ¡logo activo
      if (activeDialogue) {
        html += '<div style="background: #2a3a2a; padding: 10px; border-radius: 5px;">';
        html += `<strong style="color: #ffaa00;">Responder a ${activeDialogue.npcName}:</strong>`;
        
        if (activeDialogue.options && activeDialogue.options.length > 0) {
          html += '<div style="margin-top: 8px;">';
          activeDialogue.options.forEach((option, idx) => {
            html += `
              <button onclick="respondToDialogue(${idx})" style="display: block; width: 100%; margin: 5px 0; padding: 8px; font-size: 11px; text-align: left; background: #3a4a3a; border: 1px solid #00ff00;">
                ${option.texto}
              </button>
            `;
          });
          html += '</div>';
        } else {
          html += '<button onclick="clearDialogue()" style="width: 100%; margin-top: 8px; padding: 8px;">Continuar</button>';
        }
        
        html += '</div>';
      } else if (dialogueHistory.length > 0) {
        html += '<button onclick="clearDialogue()" style="width: 100%; padding: 8px;">ğŸ—‘ï¸ Limpiar historial</button>';
      }
      
      container.innerHTML = html;
    }
    
    function respondToDialogue(optionIndex) {
      if (!activeDialogue) return;
      
      const option = activeDialogue.options[optionIndex];
      
      // Agregar respuesta del jugador al historial
      dialogueHistory.push({
        speaker: player.nombre,
        text: option.texto,
        timestamp: Date.now()
      });
      
      // Enviar respuesta al servidor
      ws.send(JSON.stringify({
        type: 'dialogue:respond',
        npcId: activeDialogue.npcId,
        optionIndex
      }));
      
      // Limpiar diÃ¡logo activo
      activeDialogue = null;
      renderInteractiveDialogue();
    }
    
    function clearDialogue() {
      activeDialogue = null;
      dialogueHistory = [];
      renderInteractiveDialogue();
    }
    
    function renderSpecialEvent() {
      if (!world.activeEvents || world.activeEvents.length === 0) {
        document.getElementById('specialEvent').innerHTML = '<em style="color: #888;">Sin eventos</em>';
        return;
      }
      
      const evento = world.activeEvents[0];
      const html = `
        <div style="background: #3a2a1a; padding: 10px; border: 2px solid #ff8800; border-radius: 5px;">
          <strong style="color: #ffaa00;">${evento.nombre}</strong>
          <p style="margin: 8px 0; font-size: 11px; color: #ddd;">${evento.descripcion}</p>
          ${evento.opciones.map((op, idx) => {
            const costoStr = Object.entries(op.costo).map(([k,v]) => `${k}:${v}`).join(', ');
            return `<button onclick="respondEvent('${evento.id}', ${idx})" style="display: block; width: 100%; margin: 5px 0; padding: 5px; font-size: 11px;">
              ${op.texto} ${costoStr ? `(Costo: ${costoStr})` : ''}
            </button>`;
          }).join('')}
          <div style="margin-top: 8px; font-size: 10px; color: #ff5555;">
            Expira en ${evento.expiresIn - (world.simulationTime - evento.timestamp)} ticks
          </div>
        </div>
      `;
      document.getElementById('specialEvent').innerHTML = html;
    }
    
    function respondEvent(eventId, opcionIndex) {
      ws.send(JSON.stringify({ type: 'event:respond', eventId, opcionIndex }));
    }
    
    // ====================================
    // RENDERIZAR EVENTO NARRATIVO
    // ====================================
    function renderNarrativeEvent() {
      const container = document.getElementById('specialEvent');
      if (!world.activeNarrativeEvent) {
        return; // No sobrescribir si hay eventos regulares
      }
      
      const evento = world.activeNarrativeEvent;
      const html = `
        <div style="background: #1a1a2a; padding: 15px; border: 3px solid #8800ff; border-radius: 8px; box-shadow: 0 0 20px rgba(136, 0, 255, 0.5);">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <div style="font-size: 32px;">ğŸ“–</div>
            <div>
              <strong style="color: #aa88ff; font-size: 14px;">${evento.nombre}</strong>
              <div style="font-size: 9px; color: #888;">Parte ${evento.parte} - Historia Encadenada</div>
            </div>
          </div>
          <p style="margin: 10px 0; font-size: 12px; color: #ccc; line-height: 1.4;">
            ${evento.descripcion}
          </p>
          <div style="margin-top: 15px;">
            ${evento.opciones.map((op, idx) => {
              let costoStr = '';
              let riesgoStr = '';
              let recompensaStr = '';
              
              if (op.costo && Object.keys(op.costo).length > 0) {
                costoStr = '<br><small style="color: #ff8888;">ğŸ’° ' + Object.entries(op.costo).map(([k,v]) => `${k}:${v}`).join(', ') + '</small>';
              }
              
              if (op.riesgo && op.riesgo > 0) {
                riesgoStr = `<br><small style="color: #ffaa00;">âš ï¸ Riesgo: ${(op.riesgo * 100).toFixed(0)}%</small>`;
              }
              
              if (op.recompensa && Object.keys(op.recompensa).length > 0) {
                const recompensaTexto = Object.entries(op.recompensa)
                  .map(([k,v]) => {
                    if (k === 'moral') return `moral ${v > 0 ? '+' : ''}${v}`;
                    if (k === 'defensas') return `defensas +${v}`;
                    if (k === 'npc_nuevo') return `NPC: ${v}`;
                    return `${k}:${v}`;
                  })
                  .join(', ');
                recompensaStr = `<br><small style="color: #88ff88;">âœ“ ${recompensaTexto}</small>`;
              }
              
              return `
                <button onclick="respondNarrativeEvent(${idx})" 
                        style="display: block; width: 100%; margin: 8px 0; padding: 12px; font-size: 12px; 
                               background: #2a1a3a; border: 2px solid #aa88ff; color: #fff; cursor: pointer;
                               transition: all 0.3s; text-align: left;">
                  <strong>${idx + 1}. ${op.texto}</strong>
                  ${costoStr}${riesgoStr}${recompensaStr}
                </button>
              `;
            }).join('')}
          </div>
        </div>
      `;
      container.innerHTML = html;
    }
    
    function respondNarrativeEvent(opcionIndex) {
      playSound('success');
      ws.send(JSON.stringify({ type: 'narrative:respond', opcionIndex }));
    }
    
    function renderDefensas() {
      if (world.locations && world.locations.refugio) {
        document.getElementById('defensas').textContent = `ğŸ›¡ï¸ ${world.locations.refugio.defensas}`;
      }
    }
    
    function renderQuests() {
      if (!world.activeQuests || world.activeQuests.length === 0) {
        document.getElementById('quests').innerHTML = '<em style="color: #888;">Sin quests</em>';
        return;
      }
      
      const html = world.activeQuests.map(q => `
        <div style="margin: 5px 0; padding: 5px; background: #1a2a1a; border-left: 3px solid #00ff00;">
          ${q.descripcion}
        </div>
      `).join('');
      document.getElementById('quests').innerHTML = html;
    }
    
    function renderSkills() {
      const html = Object.entries(player.skills || {}).map(([skill, val]) => `
        <div style="margin: 3px 0;">
          ${skill}: ${val.toFixed(1)}/10
        </div>
      `).join('');
      document.getElementById('skills').innerHTML = html;
    }
    
    function renderPlayersHere() {
      if (!world || !world.players) {
        document.getElementById('playersHere').innerHTML = '<em style="color: #888;">Solo tÃº</em>';
        return;
      }
      
      const playersInLocation = Object.values(world.players)
        .filter(p => p.locacion === player.locacion && p.id !== player.id);
      
      if (playersInLocation.length === 0) {
        document.getElementById('playersHere').innerHTML = '<em style="color: #888;">Solo tÃº</em>';
        return;
      }
      
      const html = playersInLocation.map(p => `
        <div style="margin: 5px 0; padding: 5px; background: #1a3a1a; border-left: 2px solid #00ff00;">
          <strong>${p.nombre}</strong>
          <div style="font-size: 10px; color: #aaa;">
            â¤ï¸ ${p.salud} | ğŸ’ ${Object.values(p.inventario || {}).reduce((a,b) => a+b, 0)} items
          </div>
        </div>
      `).join('');
      
      document.getElementById('playersHere').innerHTML = html;
    }
    
    function renderRefugioRecursos() {
      if (!world || !world.locations || !world.locations.refugio) return;
      
      const refugio = world.locations.refugio;
      const recursos = refugio.recursos || {};
      
      // Actualizar defensas
      const defensasEl = document.getElementById('defensas');
      if (defensasEl) {
        defensasEl.textContent = `ğŸ›¡ï¸ Defensas: ${refugio.defensas || 0}`;
      }
      
      // Actualizar recursos
      const html = Object.entries(recursos).map(([item, cant]) => {
        let color = '#00ff00';
        if (cant < 5) color = '#ff0000';
        else if (cant < 10) color = '#ffaa00';
        
        return `<div style="margin: 3px 0; color: ${color};">${item}: ${cant}</div>`;
      }).join('');
      
      const refugioEl = document.getElementById('refugioRecursos');
      if (refugioEl) {
        refugioEl.innerHTML = html || '<em style="color: #888;">Sin recursos</em>';
      }
    }

    function renderOnlinePlayers(players) {
      const onlineCount = document.getElementById('onlineCount');
      const onlinePlayers = document.getElementById('onlinePlayers');
      
      if (!players || players.length === 0) {
        onlineCount.textContent = '0';
        onlinePlayers.innerHTML = '<em style="color: #888;">Sin jugadores conectados</em>';
        // Limpiar select de DMs
        document.getElementById('dmTargetSelect').innerHTML = '<option value="">Sin jugadores online</option>';
        return;
      }
      
      onlineCount.textContent = players.length;
      
      // Actualizar cachÃ© de jugadores
      players.forEach(p => {
        allPlayers[p.id] = p.nombre;
      });
      
      // Actualizar select de DMs
      const dmSelect = document.getElementById('dmTargetSelect');
      dmSelect.innerHTML = '<option value="">Selecciona jugador...</option>' + 
        players
          .filter(p => p.id !== player.id)
          .map(p => `<option value="${p.id}">${p.nombre}</option>`)
          .join('');
      
      const html = players.map(p => {
        const isMe = p.id === player.id;
        const locationName = world.locations && world.locations[p.locacion] 
          ? world.locations[p.locacion].nombre 
          : p.locacion;
        
        const stats = p.stats || {};
        const zombies = stats.zombies_matados || 0;
        let rankBadge = '';
        if (zombies > 100) rankBadge = 'ğŸ’€';
        else if (zombies > 50) rankBadge = 'âš”ï¸';
        else if (zombies > 20) rankBadge = 'ğŸ”ª';
        
        return `
          <div class="player-card-inspect" onclick="${isMe ? '' : `inspectPlayer('${p.id}')`}" style="${isMe ? 'background: #2a4a2a; border-left-color: #ffff00; cursor: default;' : ''}">
            ${rankBadge ? `<div class="rank-badge">${rankBadge}</div>` : ''}
            <div style="font-weight: bold; color: ${isMe ? '#ffff00' : '#00ff00'}; font-size: 14px;">
              ${isMe ? 'â­ ' : ''}${p.nombre}${isMe ? ' (TÃº)' : ''}
            </div>
            <div style="font-size: 11px; color: #888; margin-top: 5px;">
              ğŸ“ ${locationName} | Nv.${p.nivel || 1} | â¤ï¸ ${p.salud || 100}
            </div>
            ${!isMe ? '<div style="font-size: 10px; color: #00ff00; margin-top: 5px;">ğŸ‘ï¸ Click para inspeccionar</div>' : ''}
          </div>
        `;
      }).join('');
      
      onlinePlayers.innerHTML = html;
    }

    function renderQuestCooperativa(quest) {
      const html = `
        <div style="background: #2a4a2a; padding: 10px; border-radius: 5px; border: 2px solid #ffff00;">
          <strong style="color: #ffff00; font-size: 14px;">${quest.nombre}</strong>
          <p style="margin: 10px 0; color: #ccc;">${quest.descripcion}</p>
          <div style="margin-top: 10px;">
            ${quest.opciones.map(opt => `
              <button onclick="votarQuest('${opt}')" style="width: 100%; padding: 8px; margin: 3px 0;">
                ${opt} <span id="votos-${opt.replace(/\s/g, '')}" style="color: #ffaa00;"></span>
              </button>
            `).join('')}
          </div>
        </div>
      `;
      document.getElementById('questCooperativa').innerHTML = html;
    }

    function updateVotosQuest(votos) {
      Object.keys(votos).forEach(opcion => {
        const el = document.getElementById(`votos-${opcion.replace(/\s/g, '')}`);
        if (el) {
          el.textContent = `(${votos[opcion].length} votos)`;
        }
      });
    }

    function votarQuest(opcion) {
      ws.send(JSON.stringify({
        type: 'quest:vote',
        opcion: opcion
      }));
    }

    // Sistema de notificaciones
    function showNotification(message, type = 'success') {
      const notif = document.createElement('div');
      notif.className = `notification ${type}`;
      notif.textContent = message;
      document.body.appendChild(notif);
      
      setTimeout(() => {
        notif.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => notif.remove(), 300);
      }, 3000);
    }
    
    // ğŸ’¥ Sistema de feedback de consecuencias
    function showConsequence(text, type = 'neutral') {
      const container = document.getElementById('consequenceFeedback');
      if (!container) return;
      
      const popup = document.createElement('div');
      popup.className = `consequence-popup ${type}`;
      popup.textContent = text;
      
      container.appendChild(popup);
      
      // Auto-remover despuÃ©s de 3 segundos
      setTimeout(() => {
        popup.remove();
      }, 3000);
    }
    
    // Helper para mostrar cambios de stats
    function showStatChange(stat, amount) {
      let icon = '';
      let type = 'neutral';
      
      switch(stat) {
        case 'salud':
        case 'health':
          icon = 'â¤ï¸';
          type = amount > 0 ? 'positive' : 'negative';
          break;
        case 'hambre':
        case 'hunger':
          icon = 'ğŸ–';
          type = amount < 0 ? 'positive' : 'negative'; // Menos hambre es bueno
          break;
        case 'energia':
        case 'energy':
          icon = 'âš¡';
          type = amount > 0 ? 'positive' : 'negative';
          break;
        case 'moral':
        case 'morale':
          icon = 'ğŸ˜Š';
          type = amount > 0 ? 'positive' : 'negative';
          break;
        case 'comida':
        case 'food':
          icon = 'ğŸ¥«';
          type = amount > 0 ? 'positive' : 'negative';
          break;
        case 'agua':
        case 'water':
          icon = 'ğŸ’§';
          type = amount > 0 ? 'positive' : 'negative';
          break;
        case 'materiales':
        case 'materials':
          icon = 'ğŸ”§';
          type = amount > 0 ? 'positive' : 'negative';
          break;
        case 'medicina':
        case 'medicine':
          icon = 'ğŸ’Š';
          type = amount > 0 ? 'positive' : 'negative';
          break;
        case 'armas':
        case 'weapons':
          icon = 'ğŸ”«';
          type = amount > 0 ? 'positive' : 'negative';
          break;
        default:
          icon = 'ğŸ“Š';
      }
      
      const sign = amount > 0 ? '+' : '';
      showConsequence(`${icon} ${sign}${amount} ${stat}`, type);
    }

    // Mejorar handleMessage para incluir notificaciones
    const originalHandleMessage = handleMessage;
    handleMessage = function(msg) {
      // Notificaciones especiales
      if (msg.type === 'player:joined' && msg.playerId !== player.id) {
        showNotification(`${msg.nombre} se uniÃ³ al juego`, 'success');
      }
      if (msg.type === 'level:up') {
        showNotification(`Â¡NIVEL ${msg.nivel}!`, 'success');
      }
      if (msg.type === 'horde:warning') {
        showNotification('âš ï¸ HORDA ACERCÃNDOSE', 'danger');
      }
      
      // Llamar a la funciÃ³n original
      originalHandleMessage(msg);
    };

    // Atajos de teclado
    document.addEventListener('keydown', (e) => {
      // Si estÃ¡ escribiendo en el chat, ignorar
      if (document.activeElement.id === 'chatInput' || 
          document.activeElement.id === 'playerName') {
        return;
      }
      
      // S = Scavenge
      if (e.key === 's' || e.key === 'S') {
        scavenge();
      }
      // C = Combat
      if (e.key === 'c' || e.key === 'C') {
        combat();
      }
      // T = Trade
      if (e.key === 't' || e.key === 'T') {
        tradeWithNPC('comerciante');
      }
      // H = Hablar con Dr. GÃ³mez
      if (e.key === 'h' || e.key === 'H') {
        talkToNPC('dr_gomez');
      }
    });

    // Auto-guardar el estado periÃ³dicamente
    setInterval(() => {
      if (player && player.id) {
        // El servidor ya guarda automÃ¡ticamente, solo actualizar UI
        if (world && world.locations) {
          renderGame();
        }
      }
    }, 10000); // Cada 10 segundos

    // ====================================
    // NUEVAS FUNCIONES - SISTEMAS AVANZADOS
    // ====================================

    // Crear grupo
    async function createGroup() {
      const groupName = prompt('Nombre del grupo:');
      if (!groupName) return;
      
      const data = await safeFetch('/api/group/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id, groupName })
      });
      
      if (data.success) {
        showNotification('Grupo creado!', 'success');
        renderGroupPanel(data.group);
      }
    }

    // Invitar a jugador al grupo
    async function inviteToGroup(targetId) {
      const response = await fetch('/api/group/invite', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id, targetId })
      });
      
      const data = await response.json();
      if (data.success) {
        showNotification('Jugador invitado!', 'success');
        renderGroupPanel(data.group);
      } else {
        showNotification(data.error, 'warning');
      }
    }

    // Salir del grupo
    async function leaveGroup() {
      if (!confirm('Â¿Salir del grupo?')) return;
      
      const response = await fetch('/api/group/leave', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id })
      });
      
      const data = await response.json();
      if (data.success) {
        showNotification('Saliste del grupo', 'success');
        document.getElementById('groupPanel').innerHTML = '<button onclick="createGroup()" style="width: 100%; padding: 10px; margin: 5px 0;">â• Crear Grupo</button>';
      }
    }

    // Mejorar refugio
    async function upgradeRefugio(upgradeType) {
      const response = await fetch('/api/refugio/upgrade', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id, upgradeType })
      });
      
      const data = await response.json();
      if (data.success) {
        showNotification(`${upgradeType} mejorado!`, 'success');
        player.inventario = data.inventario;
        renderGame();
      } else {
        showNotification(data.error, 'warning');
      }
    }

    // Abrir diÃ¡logo de comercio
    function openTradeDialog() {
      const targetId = document.getElementById('tradeTargetSelect').value;
      if (!targetId || targetId === 'none') {
        showNotification('Selecciona un jugador', 'warning');
        return;
      }
      
      // Crear diÃ¡logo simple para definir la oferta
      const offering = prompt('Â¿QuÃ© ofreces? (formato: comida:5,materiales:3)');
      const requesting = prompt('Â¿QuÃ© solicitas? (formato: medicinas:2,armas:1)');
      
      if (!offering || !requesting) return;
      
      const parseItems = (str) => {
        const items = {};
        str.split(',').forEach(pair => {
          const [item, amount] = pair.trim().split(':');
          items[item] = parseInt(amount);
        });
        return items;
      };
      
      createTradeOffer(targetId, parseItems(offering), parseItems(requesting));
    }

    // Crear oferta de comercio
    async function createTradeOffer(targetId, offering, requesting) {
      const response = await fetch('/api/trade/offer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id, targetId, offering, requesting })
      });
      
      const data = await response.json();
      if (data.success) {
        showNotification('Oferta enviada!', 'success');
      } else {
        showNotification(data.error, 'warning');
      }
    }

    // Responder a oferta de comercio
    async function respondToTrade(offerId, accept) {
      const response = await fetch('/api/trade/respond', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id, offerId, accept })
      });
      
      const data = await response.json();
      showNotification(data.message || data.error, data.success ? 'success' : 'warning');
      if (data.success) renderGame();
    }

    // Renderizar panel de grupo
    function renderGroupPanel(group) {
      if (!group) {
        document.getElementById('groupPanel').innerHTML = '<button onclick="createGroup()" style="width: 100%; padding: 10px; margin: 5px 0;">â• Crear Grupo</button>';
        document.getElementById('groupMemberCount').textContent = '';
        return;
      }
      
      const membersHTML = group.members.map(mid => {
        const member = world.players && world.players[mid];
        return member ? `<div style="margin: 5px 0;">${member.nombre} ${member.id === player.id ? '(TÃº)' : ''}</div>` : '';
      }).join('');
      
      document.getElementById('groupPanel').innerHTML = `
        <div style="padding: 10px; background: #1a3a1a; border-radius: 5px;">
          <strong style="color: #ffff00;">${group.name}</strong>
          <div style="margin-top: 10px;">${membersHTML}</div>
          <button onclick="leaveGroup()" style="width: 100%; margin-top: 10px; padding: 8px; background: #4a1a1a;">ğŸšª Salir del Grupo</button>
        </div>
      `;
      
      document.getElementById('groupMemberCount').textContent = `(${group.members.length}/4)`;
    }

    // Renderizar logros
    function renderAchievements() {
      if (!player.achievements || Object.keys(player.achievements).length === 0) {
        document.getElementById('achievements').innerHTML = '<em style="color: #888;">Sin logros desbloqueados</em>';
        document.getElementById('achievementCount').textContent = '';
        return;
      }
      
      const achieved = Object.keys(player.achievements);
      const html = achieved.map(id => {
        const achievement = world.achievements && world.achievements[id];
        if (!achievement) return '';
        return `
          <div style="margin: 5px 0; padding: 5px; background: #2a3a1a; border-left: 3px solid #ffaa00; border-radius: 3px;">
            <strong>${achievement.icono} ${achievement.nombre}</strong>
            <div style="font-size: 10px; color: #888; margin-top: 2px;">${achievement.descripcion}</div>
          </div>
        `;
      }).join('');
      
      document.getElementById('achievements').innerHTML = html;
      document.getElementById('achievementCount').textContent = `(${achieved.length}/${Object.keys(world.achievements || {}).length})`;
    }

    // Renderizar tiempo dÃ­a/noche
    function renderTimeOfDay() {
      if (!world.timeOfDay && world.timeOfDay !== 0) return;
      
      const hour = world.timeOfDay;
      const day = world.dayCount || 1;
      const timeStr = `${String(hour).padStart(2, '0')}:00`;
      
      let icon = 'â˜€ï¸';
      let color = '#ffff00';
      if (hour >= 20 || hour <= 6) {
        icon = 'ğŸŒ™';
        color = '#4444ff';
      } else if (hour >= 18 || hour <= 8) {
        icon = 'ğŸŒ…';
        color = '#ffaa00';
      }
      
      document.getElementById('timeDisplay').innerHTML = `<span style="color: ${color};">${icon} DÃ­a ${day} - ${timeStr}</span>`;
    }

    // Renderizar estadÃ­sticas del jugador
    function renderPlayerStats2() {
      if (!player.stats) return;
      
      const html = `
        <div>ğŸ§Ÿ Zombies: ${player.stats.zombies_matados || 0}</div>
        <div>ğŸ”¨ Crafteos: ${player.stats.items_crafteados || 0}</div>
        <div>ğŸ—ºï¸ Locaciones: ${player.stats.locaciones_visitadas || 1}</div>
        <div>ğŸ“¦ Recursos: ${player.stats.recursos_totales || 0}</div>
        <div>ğŸ¤ Comercios: ${player.stats.comercios_completados || 0}</div>
        <div>ğŸ’ª Tanques: ${player.stats.tanques_matados || 0}</div>
      `;
      
      document.getElementById('playerStats2').innerHTML = html;
    }

    // Actualizar selector de jugadores para comercio
    function updateTradePlayerSelect(players) {
      const select = document.getElementById('tradeTargetSelect');
      if (!select) return;
      
      const options = players
        .filter(p => p.id !== player.id)
        .map(p => `<option value="${p.id}">${p.nombre} (Nv.${p.nivel})</option>`)
        .join('');
      
      select.innerHTML = options || '<option value="none">Sin jugadores disponibles</option>';
    }

    // Extender renderGame para incluir nuevos sistemas
    const originalRenderGame = renderGame;
    renderGame = function() {
      originalRenderGame();
      renderAchievements();
      renderTimeOfDay();
      renderPlayerStats2();
    };

    // Handler para logros desbloqueados
    function handleAchievementUnlocked(achievement) {
      showNotification(`ğŸ† Logro desbloqueado: ${achievement.nombre}!`, 'success');
      log(`ğŸ† Desbloqueaste: ${achievement.nombre} - ${achievement.descripcion}`, 'success');
    }

    // ====================================
    // FUNCIONES PARA NUEVOS SISTEMAS
    // ====================================

    // MISIONES
    function renderMissions() {
      if (!world.activeMissions || world.activeMissions.length === 0) {
        document.getElementById('missionsPanel').innerHTML = '<em style="color: #888;">Sin misiones disponibles</em>';
        document.getElementById('missionCount').textContent = '';
        return;
      }

      const availableMissions = world.activeMissions.filter(m => !m.completedBy.includes(player.id));
      
      const html = availableMissions.map(mission => {
        return `
          <div style="margin: 8px 0; padding: 8px; background: #2a2a1a; border-left: 3px solid #ffaa00; border-radius: 3px;">
            <strong style="color: #ffaa00;">${mission.descripcion}</strong>
            <div style="font-size: 10px; color: #aaa; margin: 4px 0;">Tipo: ${mission.tipo} | Cantidad: ${mission.cantidad}</div>
            <div style="font-size: 10px; color: #0f0;">Recompensa: ${Object.entries(mission.recompensa).map(([k,v]) => `${k}:${v}`).join(', ')}</div>
            <button onclick="completeMission('${mission.id}')" style="width: 100%; margin-top: 5px; padding: 5px; font-size: 10px;">âœ… Completar</button>
          </div>
        `;
      }).join('');

      document.getElementById('missionsPanel').innerHTML = html || '<em style="color: #888;">Todas completadas</em>';
      document.getElementById('missionCount').textContent = `(${availableMissions.length})`;
    }

    async function completeMission(missionId) {
      // Prevenir clicks mÃºltiples
      if (pendingActions.has(`mission-${missionId}`)) return;
      pendingActions.add(`mission-${missionId}`);
      
      const data = await safeFetch('/api/mission/complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id, missionId })
      });
      
      pendingActions.delete(`mission-${missionId}`);
      if (data.success) {
        showNotification('âœ… MisiÃ³n completada!', 'success');
        renderGame();
      } else {
        showNotification(data.error, 'warning');
      }
    }

    // MASCOTAS
    function renderPet() {
      if (!player.mascota) {
        document.getElementById('petPanel').innerHTML = `
          <p style="color: #888; margin-bottom: 10px;">No tienes mascota</p>
          <button onclick="adoptPet('perro')" style="width: 100%; padding: 8px; margin: 3px 0; font-size: 11px;">ğŸ• Adoptar Perro</button>
          <button onclick="adoptPet('lobo')" style="width: 100%; padding: 8px; margin: 3px 0; font-size: 11px;">ğŸº Adoptar Lobo</button>
          <button onclick="adoptPet('cuervo')" style="width: 100%; padding: 8px; margin: 3px 0; font-size: 11px;">ğŸ¦… Adoptar Cuervo</button>
        `;
        return;
      }

      const pet = player.mascota;
      document.getElementById('petPanel').innerHTML = `
        <div style="padding: 10px; background: #1a2a2a; border-radius: 5px;">
          <strong style="color: #00ffff; font-size: 14px;">${pet.nombre} Nv.${pet.nivel}</strong>
          <div style="margin: 8px 0;">
            <div style="font-size: 10px;">Hambre:</div>
            <div class="stat-bar" style="height: 10px; width: 100%;">
              <div class="stat-fill hambre" style="width: ${pet.hambre}%;"></div>
            </div>
          </div>
          <div style="margin: 8px 0;">
            <div style="font-size: 10px;">Moral:</div>
            <div class="stat-bar" style="height: 10px; width: 100%;">
              <div class="stat-fill moral" style="width: ${pet.moral}%;"></div>
            </div>
          </div>
          <div style="font-size: 10px; color: #888; margin: 5px 0;">${pet.habilidad}</div>
          <button onclick="feedPet('comida')" style="width: 100%; padding: 6px; margin: 3px 0; font-size: 10px;">ğŸ– Alimentar (comida)</button>
          <button onclick="feedPet('carne')" style="width: 100%; padding: 6px; margin: 3px 0; font-size: 10px;">ğŸ¥© Alimentar (carne)</button>
        </div>
      `;
    }

    async function adoptPet(petType) {
      if (pendingActions.has('adoptPet')) return;
      pendingActions.add('adoptPet');
      
      const data = await safeFetch('/api/pet/adopt', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id, petType })
      });
      
      pendingActions.delete('adoptPet');
      
      if (data.success) {
        player.mascota = data.mascota;
        showNotification(`ğŸ¾ Adoptaste ${data.mascota.nombre}!`, 'success');
        renderPet();
      }
    }

    async function feedPet(item) {
      if (pendingActions.has('feedPet')) return;
      pendingActions.add('feedPet');
      
      const data = await safeFetch('/api/pet/feed', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id, item })
      });
      
      pendingActions.delete('feedPet');
      
      if (data.success) {
        player.mascota = data.mascota;
        player.inventario = data.inventario;
        showNotification('ğŸ– Mascota alimentada!', 'success');
        renderGame();
      }
    }

    // HABILIDADES ESPECIALES
    function renderAbilities() {
      if (!player.clase) {
        document.getElementById('abilitiesPanel').innerHTML = '<em style="color: #888;">Necesitas una clase</em>';
        return;
      }

      const classAbilities = {
        'soldado': ['curacion_rapida', 'rafaga_mortal'],
        'explorador': ['sigilo_perfecto', 'visiÃ³n_extendida'],
        'ingeniero': ['crafteo_instantaneo', 'reparacion_rapida'],
        'medico': ['curacion_rapida', 'inmunidad_temporal'],
        'lider': ['escudo_grupal', 'moral_boost']
      };

      const abilities = classAbilities[player.clase] || [];
      
      const html = abilities.map(abilityId => {
        const ability = world.specialAbilities && world.specialAbilities[abilityId];
        if (!ability) return '';
        
        const onCooldown = player.abilityCooldowns && player.abilityCooldowns[abilityId] && Date.now() < player.abilityCooldowns[abilityId];
        const cooldownText = onCooldown ? ` (${Math.ceil((player.abilityCooldowns[abilityId] - Date.now()) / 1000)}s)` : '';
        
        return `
          <button onclick="useAbility('${abilityId}')" ${onCooldown ? 'disabled' : ''} style="width: 100%; padding: 8px; margin: 3px 0; font-size: 10px;">
            âš¡ ${ability.nombre}${cooldownText}
          </button>
        `;
      }).join('');

      document.getElementById('abilitiesPanel').innerHTML = html || '<em style="color: #888;">Sin habilidades disponibles</em>';
    }

    async function useAbility(abilityId) {
      if (pendingActions.has(`ability-${abilityId}`)) return;
      pendingActions.add(`ability-${abilityId}`);
      
      const data = await safeFetch('/api/ability/use', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id, abilityId })
      });
      
      pendingActions.delete(`ability-${abilityId}`);
      
      if (data.success) {
        showNotification(`âš¡ Usaste: ${data.ability.nombre}!`, 'success');
        renderGame();
      }
    }

    // FACCIONES
    function renderFaction() {
      if (!player.faccion) {
        document.getElementById('factionPanel').innerHTML = `
          <p style="color: #888; margin-bottom: 10px;">Ãšnete a una facciÃ³n para desbloquear recompensas</p>
          <button onclick="joinFaction('refugio')" style="width: 100%; padding: 8px; margin: 3px 0; font-size: 10px;">ğŸ  Los Refugiados</button>
          <button onclick="joinFaction('nomadas')" style="width: 100%; padding: 8px; margin: 3px 0; font-size: 10px;">ğŸš¶ NÃ³madas</button>
          <button onclick="joinFaction('cientificos')" style="width: 100%; padding: 8px; margin: 3px 0; font-size: 10px;">ğŸ”¬ Los CientÃ­ficos</button>
          <button onclick="joinFaction('saqueadores')" style="width: 100%; padding: 8px; margin: 3px 0; font-size: 10px;">ğŸ’€ Saqueadores</button>
        `;
        document.getElementById('factionRank').textContent = '';
        return;
      }

      const faction = world.factions && world.factions.find(f => f.id === player.faccion);
      if (!faction) return;

      document.getElementById('factionPanel').innerHTML = `
        <div style="padding: 10px; background: #2a1a1a; border-radius: 5px;">
          <strong style="color: #ff8800; font-size: 14px;">${faction.nombre}</strong>
          <div style="font-size: 10px; color: #aaa; margin: 5px 0;">${faction.descripcion}</div>
          <div style="margin: 8px 0; font-size: 11px;">Puntos: ${player.faccionPuntos || 0}</div>
        </div>
      `;
      
      document.getElementById('factionRank').textContent = `Rango ${player.faccionRango || 1}`;
    }

    async function joinFaction(factionId) {
      const response = await fetch('/api/faction/join', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id, factionId })
      });
      
      const data = await response.json();
      if (data.success) {
        player.faccion = factionId;
        showNotification(`âš”ï¸ Te uniste a: ${data.faction.nombre}!`, 'success');
        renderFaction();
      } else {
        showNotification(data.error, 'warning');
      }
    }

    // VEHÃCULOS
    function renderVehicle() {
      if (!player.vehiculo) return;

      const vehicle = player.vehiculo;
      document.getElementById('vehiclePanel').innerHTML = `
        <div style="padding: 10px; background: #1a1a2a; border-radius: 5px;">
          <strong style="color: #00ff00; font-size: 14px;">${vehicle.nombre}</strong>
          <div style="margin: 8px 0;">
            <div style="font-size: 10px;">Combustible:</div>
            <div class="stat-bar" style="height: 10px; width: 100%;">
              <div class="stat-fill hambre" style="width: ${vehicle.combustible}%;"></div>
            </div>
          </div>
          <div style="margin: 8px 0;">
            <div style="font-size: 10px;">Durabilidad:</div>
            <div class="stat-bar" style="height: 10px; width: 100%;">
              <div class="stat-fill salud" style="width: ${vehicle.durabilidad}%;"></div>
            </div>
          </div>
          <div style="font-size: 10px; color: #888; margin: 5px 0;">Velocidad: +${vehicle.velocidad} | ProtecciÃ³n: ${vehicle.proteccion}%</div>
        </div>
      `;
    }

    async function craftVehicle(vehicleType) {
      const response = await fetch('/api/vehicle/craft', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id, vehicleType })
      });
      
      const data = await response.json();
      if (data.success) {
        player.vehiculo = data.vehiculo;
        player.inventario = data.inventario;
        showNotification(`ğŸš— Construiste: ${data.vehiculo.nombre}!`, 'success');
        renderGame();
      } else {
        showNotification(data.error, 'warning');
      }
    }

    // PVP ARENA
    let currentPvPMatch = null;

    async function enterPvPArena() {
      if (player.salud < 50) {
        showNotification('Necesitas al menos 50 de salud', 'warning');
        return;
      }

      const response = await fetch('/api/pvp/enter', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id })
      });
      
      const data = await response.json();
      if (data.success) {
        showNotification(`âš”ï¸ En cola PvP (PosiciÃ³n: ${data.queuePosition})`, 'success');
        document.getElementById('pvpQueue').textContent = `Cola: ${data.queuePosition}`;
      } else {
        showNotification(data.error, 'warning');
      }
    }

    async function attackInPvP() {
      if (!currentPvPMatch) return;

      const response = await fetch('/api/pvp/attack', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id, matchId: currentPvPMatch })
      });
      
      const data = await response.json();
      if (data.success) {
        if (data.victory) {
          showNotification('ğŸ† Â¡VICTORIA! +100 XP', 'success');
          document.getElementById('pvpMatch').style.display = 'none';
          currentPvPMatch = null;
        }
      } else {
        showNotification(data.error, 'warning');
      }
    }

    // Actualizar funciÃ³n renderGame para incluir nuevos sistemas
    const _originalRenderGame = renderGame;
    renderGame = function() {
      _originalRenderGame();
      renderMissions();
      renderPet();
      renderAbilities();
      renderFaction();
      renderVehicle();
      updateFeaturedStory();
    };
    
    // ğŸŒŸ SISTEMA DE HISTORIA DESTACADA
    let featuredStoryData = {
      text: 'El refugio se mantiene en calma...',
      target: null,
      type: 'neutral'
    };
    
    function updateFeaturedStory() {
      if (!world || !player) return;
      
      const stories = [];
      
      // Verificar eventos especiales activos
      if (world.evento_especial) {
        stories.push({
          text: `âš ï¸ ${world.evento_especial.descripcion}`,
          target: 'events',
          type: 'danger',
          priority: 100
        });
      }
      
      // Relaciones dramÃ¡ticas entre NPCs
      const npcs = Object.values(world.npcs || {});
      for (const npc of npcs) {
        if (npc.relaciones) {
          const relations = Object.values(npc.relaciones);
          const romance = relations.find(r => r.estado === 'amantes');
          const rivalry = relations.find(r => r.estado === 'enemigos' || r.estado === 'rivales');
          
          if (romance) {
            stories.push({
              text: `ğŸ’• Una relaciÃ³n romÃ¡ntica estÃ¡ floreciendo en el refugio`,
              target: 'mundo',
              type: 'positive',
              priority: 80
            });
            break;
          }
          
          if (rivalry) {
            stories.push({
              text: `âš”ï¸ TensiÃ³n creciente entre sobrevivientes del refugio`,
              target: 'mundo',
              type: 'warning',
              priority: 85
            });
            break;
          }
        }
      }
      
      // Misiones narrativas disponibles
      if (player.misionesNarrativasDisponibles && player.misionesNarrativasDisponibles.length > 0) {
        stories.push({
          text: `ğŸ“– Nueva misiÃ³n narrativa disponible`,
          target: 'missions',
          type: 'highlight',
          priority: 70
        });
      }
      
      // Recursos del refugio crÃ­ticos
      if (world.refugio) {
        const lowResources = Object.entries(world.refugio).filter(([k, v]) => v < 10 && k !== 'poblacion');
        if (lowResources.length > 0) {
          const resource = lowResources[0][0];
          stories.push({
            text: `ğŸ  Refugio necesita urgente: ${resource}`,
            target: 'main',
            type: 'warning',
            priority: 90
          });
        }
      }
      
      // Jugadores en lÃ­nea
      const onlinePlayers = world.onlinePlayers || 0;
      if (onlinePlayers > 3) {
        stories.push({
          text: `ğŸ‘¥ ${onlinePlayers} supervivientes conectados ahora mismo`,
          target: 'social',
          type: 'highlight',
          priority: 60
        });
      }
      
      // Estado del jugador crÃ­tico
      if (player.salud < 30) {
        stories.push({
          text: `ğŸ’” Tu salud estÃ¡ crÃ­tica. Descansa pronto`,
          target: 'main',
          type: 'danger',
          priority: 95
        });
      }
      
      // Seleccionar historia de mayor prioridad
      if (stories.length > 0) {
        stories.sort((a, b) => b.priority - a.priority);
        featuredStoryData = stories[0];
      } else {
        featuredStoryData = {
          text: 'Todo tranquilo en el apocalipsis... por ahora',
          target: null,
          type: 'neutral',
          priority: 0
        };
      }
      
      // Actualizar UI
      const textEl = document.getElementById('featuredStoryText');
      const containerEl = document.getElementById('featuredStory');
      if (textEl) {
        textEl.textContent = featuredStoryData.text;
      }
      
      // Actualizar color del borde segÃºn tipo
      if (containerEl) {
        let borderColor = 'var(--green-bright)';
        switch(featuredStoryData.type) {
          case 'danger':
            borderColor = '#ff0000';
            break;
          case 'warning':
            borderColor = '#ffff00';
            break;
          case 'positive':
            borderColor = '#00ffff';
            break;
          case 'highlight':
            borderColor = 'var(--green-bright)';
            break;
        }
        containerEl.style.borderColor = borderColor;
        containerEl.style.boxShadow = `0 0 15px ${borderColor}40`;
      }
    }
    
    function handleFeaturedStoryClick() {
      if (featuredStoryData.target) {
        switchTab(featuredStoryData.target);
        showConsequence('ğŸ“Œ Navegando a ' + featuredStoryData.target.toUpperCase(), 'neutral');
      }
    }

    console.log('ğŸ§Ÿ Survival Zombie MVP cargado. Usa teclas rÃ¡pidas: S=Scavenge, C=Combat, T=Trade, H=Hablar');
  </script>
</body>
</html>
