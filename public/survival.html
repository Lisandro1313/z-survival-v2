<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üíª Z-SURVIVAL.exe</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      /* üé® PALETA SEM√ÅNTICA */
      --green-safe: #00ff00;       /* Acciones seguras, success */
      --green-medium: #00cc00;     /* Info importante, activos */
      --green-dim: #006600;        /* Pasivo, menos prominente */
      --green-dark: #004400;       /* Backgrounds oscuros */
      
      --red-danger: #ff0000;       /* Peligro, ataques, cr√≠tico */
      --red-dark: #cc0000;         /* Peligro secundario */
      
      --orange-warn: #ff8800;      /* Advertencias, atenci√≥n */
      --yellow-caution: #ffff00;   /* Precauci√≥n leve */
      
      --blue-info: #00bbff;        /* Info, NPCs, mercader */
      --blue-dark: #0088cc;        /* Info secundaria */
      
      --gray-bg: #1a1a1a;          /* Background principal */
      --gray-card: #2a2a2a;        /* Background cards */
      --gray-border: #333333;      /* Bordes suaves */
      --gray-text: #888888;        /* Texto secundario */
      
      /* üìê SISTEMA DE TARJETAS */
      --card-padding: 16px;
      --card-padding-sm: 12px;
      --card-radius: 8px;
      --card-radius-sm: 5px;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      --card-shadow-hover: 0 6px 20px rgba(0, 255, 0, 0.2);
      
      /* üìè SPACING CONSISTENTE */
      --space-xs: 8px;
      --space-sm: 12px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 32px;
      
      /* üìù TIPOGRAF√çA */
      --font-size-base: 16px;
      --font-size-sm: 14px;
      --font-size-xs: 12px;
      --font-size-lg: 18px;
      --font-size-xl: 24px;
      --line-height: 1.4;
      
      /* üèóÔ∏è LAYOUT DIMENSIONS */
      --sidebar-left-width: 220px;
      --sidebar-right-width: 300px;
      --header-height: 70px;
      --gap-main: 12px;
      
      /* ‚è±Ô∏è TRANSICIONES */
      --transition-fast: 0.15s ease;
      --transition-normal: 0.3s ease;
      --transition-slow: 0.5s ease;
    }
    
    body {
      font-family: 'Courier New', monospace;
      background: var(--gray-bg);
      color: var(--green-medium);
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      font-size: var(--font-size-base);
      line-height: var(--line-height);
    }
    
    #game {
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    /* üéÆ PANTALLA DE JUEGO */
    #gameScreen {
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    /* üî¥ BARRA SUPERIOR PERSISTENTE */
    #persistent-header {
      height: var(--header-height);
      background: var(--gray-bg);
      border-bottom: 2px solid var(--green-dim);
      padding: 0 var(--space-lg);
      display: none; /* Oculto por defecto, visible en gameScreen */
      align-items: center;
      gap: var(--space-lg);
      font-size: var(--font-size-sm);
      font-weight: bold;
      flex-shrink: 0;
      z-index: 100;
    }
    
    #persistent-header.active {
      display: flex;
    }
    
    .header-stat {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      padding: var(--space-xs) var(--space-sm);
      background: var(--gray-card);
      border-radius: var(--card-radius-sm);
      border: 1px solid var(--gray-border);
      transition: var(--transition-fast);
    }
    
    .header-stat:hover {
      border-color: var(--green-dim);
      transform: translateY(-1px);
    }
    
    .header-stat.critical {
      border-color: var(--red-danger);
      animation: pulse 1s infinite;
    }
    
    .header-divider {
      width: 1px;
      height: 40px;
      background: var(--gray-border);
    }
    
    /* üèóÔ∏è LAYOUT PRINCIPAL 3 COLUMNAS */
    #main-layout {
      display: grid;
      grid-template-columns: var(--sidebar-left-width) 1fr var(--sidebar-right-width);
      gap: var(--gap-main);
      padding: var(--gap-main);
      height: calc(100vh - var(--header-height));
      flex: 1;
    }
    
    /* üë§ SIDEBAR IZQUIERDA - PERSONAJE */
    #left-sidebar {
      background: var(--gray-card);
      border: 2px solid var(--green-dim);
      border-radius: var(--card-radius);
      padding: var(--card-padding);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
    }
    
    #left-sidebar::-webkit-scrollbar {
      width: 8px;
    }
    
    #left-sidebar::-webkit-scrollbar-track {
      background: var(--gray-bg);
    }
    
    #left-sidebar::-webkit-scrollbar-thumb {
      background: var(--green-dim);
      border-radius: 4px;
    }
    
    .player-avatar-section {
      text-align: center;
      padding: var(--space-md);
      background: var(--gray-bg);
      border-radius: var(--card-radius-sm);
      border: 1px solid var(--gray-border);
    }
    
    .player-avatar {
      font-size: 64px;
      margin-bottom: var(--space-sm);
      display: block;
      background: linear-gradient(135deg, #1a3a1a 0%, #0d1f0d 100%);
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin-left: auto;
      margin-right: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 3px solid var(--green-safe);
      box-shadow: 0 4px 10px rgba(0, 255, 0, 0.2);
    }
    
    .player-name-display {
      font-size: var(--font-size-lg);
      font-weight: bold;
      color: var(--green-safe);
      margin-bottom: var(--space-xs);
    }
    
    .player-level {
      font-size: var(--font-size-sm);
      color: var(--gray-text);
    }
    
    .stat-bar-container {
      margin: var(--space-sm) 0;
    }
    
    .stat-bar-label {
      display: flex;
      justify-content: space-between;
      font-size: var(--font-size-xs);
      margin-bottom: 4px;
    }
    
    .stat-bar {
      height: 12px;
      background: var(--gray-bg);
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid var(--gray-border);
    }
    
    .stat-bar-fill {
      height: 100%;
      transition: width 0.3s ease, background-color 0.3s ease;
      border-radius: 6px;
    }
    
    .stat-bar-fill.hp {
      background: linear-gradient(90deg, var(--red-danger), var(--green-safe));
    }
    
    .stat-bar-fill.hunger {
      background: linear-gradient(90deg, var(--orange-warn), var(--green-medium));
    }
    
    .stat-bar-fill.stamina {
      background: linear-gradient(90deg, var(--yellow-caution), var(--blue-info));
    }
    
    .sidebar-section {
      padding: var(--space-sm);
      background: var(--gray-bg);
      border-radius: var(--card-radius-sm);
      border: 1px solid var(--gray-border);
    }
    
    .sidebar-section h3 {
      font-size: var(--font-size-sm);
      color: var(--green-medium);
      margin-bottom: var(--space-sm);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .collapsible-section {
      cursor: pointer;
      user-select: none;
    }
    
    .collapsible-section:hover h3 {
      color: var(--green-safe);
    }
    
    .section-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .section-content.expanded {
      max-height: 500px;
    }
    
    .quick-action-btn {
      width: 100%;
      padding: var(--space-sm);
      margin: var(--space-xs) 0;
      background: var(--gray-card);
      border: 1px solid var(--green-dim);
      color: var(--green-medium);
      font-family: inherit;
      font-size: var(--font-size-sm);
      cursor: pointer;
      border-radius: var(--card-radius-sm);
      transition: var(--transition-fast);
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }
    
    .quick-action-btn:hover {
      background: var(--green-dim);
      color: var(--green-safe);
      transform: translateX(2px);
      box-shadow: var(--card-shadow-hover);
    }
    
    .quick-action-btn:active {
      transform: scale(0.98);
    }
    
    /* üì± CONTENIDO CENTRAL */
    #central-content {
      display: flex;
      flex-direction: column;
      background: var(--gray-card);
      border: 2px solid var(--green-dim);
      border-radius: var(--card-radius);
      overflow-y: auto;
      overflow-x: hidden;
    }
    
    #central-content::-webkit-scrollbar {
      width: 12px;
    }
    
    #central-content::-webkit-scrollbar-track {
      background: var(--gray-bg);
      border-radius: 6px;
    }
    
    #central-content::-webkit-scrollbar-thumb {
      background: var(--green-dim);
      border-radius: 6px;
    }
    
    #central-content::-webkit-scrollbar-thumb:hover {
      background: var(--green-medium);
    }
    
    /* üìú SIDEBAR DERECHA - LOGS PERSISTENTES */
    #right-sidebar-logs {
      background: var(--gray-card);
      border: 2px solid var(--green-dim);
      border-radius: var(--card-radius);
      padding: var(--card-padding);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .logs-header {
      font-size: var(--font-size-lg);
      font-weight: bold;
      color: var(--green-safe);
      margin-bottom: var(--space-md);
      padding-bottom: var(--space-sm);
      border-bottom: 2px solid var(--gray-border);
    }
    
    .log-section {
      flex: 1;
      overflow-y: auto;
      margin-bottom: var(--space-md);
      padding: var(--space-sm);
      background: var(--gray-bg);
      border-radius: var(--card-radius-sm);
      border: 1px solid var(--gray-border);
    }
    
    .log-section h4 {
      font-size: var(--font-size-sm);
      color: var(--green-medium);
      margin-bottom: var(--space-sm);
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      position: sticky;
      top: 0;
      background: var(--gray-bg);
      padding: var(--space-xs) 0;
      z-index: 1;
    }
    
    .log-section::-webkit-scrollbar {
      width: 6px;
    }
    
    .log-section::-webkit-scrollbar-track {
      background: var(--gray-bg);
    }
    
    .log-section::-webkit-scrollbar-thumb {
      background: var(--green-dim);
      border-radius: 3px;
    }
    
    .log-entry {
      font-size: var(--font-size-xs);
      line-height: 1.6;
      margin: var(--space-xs) 0;
      padding: var(--space-xs) var(--space-sm);
      border-left: 2px solid transparent;
      border-radius: 3px;
      transition: var(--transition-fast);
    }
    
    .log-entry:hover {
      background: rgba(0, 255, 0, 0.05);
      border-left-color: var(--green-dim);
    }
    
    .log-entry.combat {
      color: var(--red-danger);
      border-left-color: var(--red-dark);
    }
    
    .log-entry.social {
      color: var(--blue-info);
      border-left-color: var(--blue-dark);
    }
    
    .log-entry.system {
      color: var(--gray-text);
    }
    
    .log-entry .timestamp {
      color: var(--gray-text);
      font-size: 10px;
      margin-right: var(--space-xs);
    }
    
    .log-filters {
      display: flex;
      gap: var(--space-sm);
      padding: var(--space-sm);
      background: var(--gray-bg);
      border-radius: var(--card-radius-sm);
      border: 1px solid var(--gray-border);
      flex-wrap: wrap;
    }
    
    .log-filter-label {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: var(--font-size-xs);
      color: var(--gray-text);
      cursor: pointer;
      user-select: none;
    }
    
    .log-filter-label:hover {
      color: var(--green-medium);
    }
    
    .log-filter-label input[type="checkbox"] {
      cursor: pointer;
    }
    
    h1 {
      text-align: center;
      color: #ff0000;
      text-shadow: 2px 2px #000;
      margin-bottom: 10px;
    }

    /* SISTEMA DE PESTA√ëAS */
    .tabs-container {
      background: #2a2a2a;
      border: 2px solid var(--green-dim);
      border-radius: 5px;
      margin-top: var(--spacing-md);
    }

    .tabs-header {
      display: flex;
      background: #1a1a1a;
      border-bottom: 2px solid var(--green-dim);
      overflow-x: auto;
      flex-wrap: wrap;
    }

    .tab-button {
      background: #2a2a2a;
      color: var(--green-medium);
      border: none;
      padding: var(--spacing-md) var(--spacing-lg);
      cursor: pointer;
      font-family: inherit;
      font-size: 14px;
      border-right: 1px solid var(--green-dark);
      transition: all 0.3s;
      position: relative;
      white-space: nowrap;
    }

    .tab-button:hover {
      background: #3a3a3a;
      color: var(--green-bright);
    }
    
    /* CARTAS DE ACCI√ìN PRINCIPAL */
    .action-card {
      transition: all 0.2s ease;
    }
    
    .action-card:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
    }
    
    .action-card:active {
      transform: scale(0.95);
    }

    .tab-button.active {
      background: var(--green-bright);
      color: #000;
      font-weight: bold;
      box-shadow: 0 2px 10px rgba(0, 255, 0, 0.3);
    }

    .tab-badge {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #ff0000;
      color: #fff;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.8; }
    }
    
    @keyframes flashGreen {
      0% { box-shadow: 0 0 0 rgba(0, 255, 0, 0); }
      50% { box-shadow: 0 0 20px rgba(0, 255, 0, 0.8); }
      100% { box-shadow: 0 0 0 rgba(0, 255, 0, 0); }
    }
    
    /* üó∫Ô∏è ANIMACIONES PARA MAPA 2D */
    @keyframes npcWalk {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-2px); }
    }
    
    @keyframes zombieShake {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(-2deg); }
      75% { transform: rotate(2deg); }
    }
    
    @keyframes resourceGlow {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.5); }
    }
    
    #world-map-2d span[title]:hover {
      filter: brightness(1.3);
      text-shadow: 0 0 8px currentColor;
    }
    
    @keyframes flashRed {
      0% { box-shadow: 0 0 0 rgba(255, 0, 0, 0); }
      50% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.8); }
      100% { box-shadow: 0 0 0 rgba(255, 0, 0, 0); }
    }
    
    .flash-success {
      animation: flashGreen 0.5s ease-out;
    }
    
    .flash-danger {
      animation: flashRed 0.5s ease-out;
    }
    
    #actionFeedback {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 255, 0, 0.95);
      color: #000;
      padding: 20px 40px;
      border-radius: 10px;
      font-size: 24px;
      font-weight: bold;
      z-index: 10000;
      display: none;
      box-shadow: 0 0 30px rgba(0, 255, 0, 0.8);
    }
    
    /* üí• Sistema de feedback de consecuencias */
    #consequenceFeedback {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 9999;
      max-width: 300px;
      pointer-events: none;
    }
    
    .consequence-popup {
      background: rgba(0, 0, 0, 0.95);
      border: 2px solid var(--green-bright);
      padding: 12px 18px;
      margin-bottom: 8px;
      border-radius: 5px;
      font-size: 14px;
      font-weight: bold;
      animation: popupSlide 0.4s ease-out, popupFade 3s ease-in;
      box-shadow: 0 4px 15px rgba(0, 255, 0, 0.4);
    }
    
    .consequence-popup.positive {
      border-color: var(--green-bright);
      color: var(--green-bright);
    }
    
    .consequence-popup.negative {
      border-color: #ff0000;
      color: #ff0000;
    }
    
    .consequence-popup.warning {
      border-color: #ffff00;
      color: #ffff00;
    }
    
    .consequence-popup.neutral {
      border-color: #00ffff;
      color: #00ffff;
    }
    
    @keyframes popupSlide {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes popupFade {
      0%, 70% { opacity: 1; }
      100% { opacity: 0; }
    }
    
    /* üé≤ ANIMACIONES DE CASINO */
    @keyframes diceRoll {
      0% { transform: rotate(0deg) translateY(0); }
      25% { transform: rotate(90deg) translateY(-20px); }
      50% { transform: rotate(180deg) translateY(0); }
      75% { transform: rotate(270deg) translateY(-20px); }
      100% { transform: rotate(360deg) translateY(0); }
    }
    
    @keyframes cardFlip {
      0% { transform: rotateY(0deg); }
      50% { transform: rotateY(90deg); }
      100% { transform: rotateY(180deg); }
    }
    
    @keyframes rouletteSpin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(1440deg); }
    }
    
    @keyframes chipFall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 0; }
      100% { transform: translateY(0) rotate(360deg); opacity: 1; }
    }
    
    @keyframes slotSpin {
      0% { transform: translateY(0); }
      100% { transform: translateY(-300px); }
    }
    
    .dice-animated {
      animation: diceRoll 0.8s ease-out;
      font-size: 64px;
      display: inline-block;
    }
    
    .card-flip {
      animation: cardFlip 0.6s ease-in-out;
    }
    
    .roulette-spin {
      animation: rouletteSpin 3s cubic-bezier(0.17, 0.67, 0.12, 0.99);
    }
    
    .chip-fall {
      animation: chipFall 0.5s ease-out;
    }
    
    #gameModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 10000;
      overflow-y: auto;
    }
    
    #gameModal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .game-table {
      background: linear-gradient(135deg, #0a2a0a, #1a3a1a);
      border: 3px solid #ff8800;
      border-radius: 20px;
      padding: 30px;
      max-width: 900px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 0 50px rgba(255, 136, 0, 0.5);
    }
    
    .player-seat {
      background: #1a1a2a;
      border: 2px solid #444;
      border-radius: 10px;
      padding: 15px;
      margin: 10px;
      min-width: 150px;
      text-align: center;
      transition: all 0.3s;
    }
    
    .player-seat.active {
      border-color: #00ff00;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
    }
    
    .player-seat.winner {
      border-color: #ffd700;
      background: #2a2a1a;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
    }
    
    .game-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    
    .game-btn {
      padding: 15px 30px;
      font-size: 16px;
      font-weight: bold;
      border: 2px solid;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Courier New', monospace;
    }
    
    .game-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px currentColor;
    }
    
    .game-btn.primary {
      background: #ff8800;
      border-color: #ff8800;
      color: #000;
    }
    
    .game-btn.secondary {
      background: transparent;
      border-color: #00ff00;
      color: #00ff00;
    }
    
    .game-btn.danger {
      background: transparent;
      border-color: #ff0000;
      color: #ff0000;
    }
    
    .game-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Tabs de crafteo */
    .craft-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
    }
    
    .craft-tab {
      padding: 8px 15px;
      background: #1a1a1a;
      border: 1px solid #444;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.3s;
    }
    
    .craft-tab:hover {
      background: #2a2a2a;
      border-color: #00ff00;
    }
    
    .craft-tab.active {
      background: #00ff00;
      color: #000;
      border-color: #00ff00;
      font-weight: bold;
    }
    
    .craft-section {
      display: none;
    }
    
    .craft-section.active {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 5px;
    }
    
    /* Refugio visual */
    #refugioVisual {
      text-align: center;
      font-size: 48px;
      margin: 10px 0;
      line-height: 1.2;
    }
    
    /* Bot√≥n de sonido */
    #soundToggle {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #1a1a1a;
      border: 2px solid #00ff00;
      color: #00ff00;
      padding: 10px 15px;
      cursor: pointer;
      font-size: 20px;
      z-index: 1000;
      border-radius: 5px;
      transition: all 0.3s;
    }
    
    #soundToggle:hover {
      background: #00ff00;
      color: #000;
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.3s;
    }

    .tab-content.active {
      display: block;
    }
    
    .tab-content h2,
    .tab-content h3 {
      margin: 0 0 var(--space-sm) 0;
      font-size: var(--font-size-md);
      font-weight: bold;
    }
    
    .tab-content h2 {
      font-size: var(--font-size-lg);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .container {
      display: grid;
      grid-template-columns: 1fr 2fr 1fr;
      gap: var(--spacing-md);
      margin-top: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }

    @media (max-width: 1024px) {
      .container {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
      
      .tab-button {
        padding: 12px 15px;
        font-size: 12px;
      }
    }
    
    .panel {
      background: #2a2a2a;
      border: 2px solid var(--green-dim);
      padding: var(--spacing-md);
      border-radius: 5px;
      transition: all 0.3s;
    }
    
    /* üåü Panel protagonista (destacado) */
    .panel.featured {
      border: 3px solid var(--green-bright);
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
      background: #2a3a2a;
      transform: scale(1.02);
    }
    
    .panel.featured h2 {
      color: var(--green-bright);
      font-size: 18px;
    }
    
    .panel h2 {
      color: #ffff00;
      margin-bottom: var(--spacing-sm);
      border-bottom: 1px solid var(--green-dim);
      padding-bottom: var(--spacing-xs);
      font-size: 16px;
    }
    
    .stat {
      margin: 8px 0;
      font-size: 14px;
    }
    
    .stat-bar {
      background: #000;
      height: 15px;
      border: 1px solid var(--green-dim);
      margin-top: var(--spacing-xs);
      position: relative;
      border-radius: 3px;
      overflow: hidden;
    }
    
    .stat-fill {
      height: 100%;
      transition: width 0.3s;
    }
    
    .stat-fill.salud { background: #ff0000; }
    .stat-fill.hambre { background: #ff8800; }
    .stat-fill.moral { background: #00ffff; }
    
    button {
      background: var(--green-dark);
      color: var(--green-medium);
      border: 2px solid var(--green-dim);
      padding: var(--spacing-sm) var(--spacing-md);
      margin: var(--spacing-xs) 2px;
      cursor: pointer;
      font-family: inherit;
      border-radius: 3px;
      transition: all 0.2s;
    }
    
    button:hover {
      background: var(--green-dim);
      color: var(--green-bright);
      border-color: var(--green-medium);
      transform: translateY(-1px);
    }
    
    /* Bot√≥n de acci√≥n primaria */
    button.primary {
      background: var(--green-dim);
      color: var(--green-bright);
      border-color: var(--green-bright);
      font-weight: bold;
    }
    
    button.primary:hover {
      background: var(--green-bright);
      color: #000;
      box-shadow: 0 4px 15px rgba(0, 255, 0, 0.4);
    }
    
    button:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .location {
      padding: var(--spacing-sm);
      margin: var(--spacing-sm) 0;
      background: #1a1a1a;
      border-left: 3px solid var(--green-dim);
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 3px;
    }
    
    .location:hover {
      background: #2a2a2a;
      border-left-color: var(--green-medium);
      transform: translateX(5px);
    }
    
    .location.current {
      border-left-color: var(--green-bright);
      background: #2a3a2a;
      box-shadow: 0 0 10px rgba(0, 255, 0, 0.2);
    }
    
    .location.danger {
      border-left-color: #ff0000;
    }
    
    .npc {
      padding: var(--spacing-sm);
      margin: var(--spacing-sm) 0;
      background: #1a1a1a;
      border: 1px solid var(--green-dim);
      border-radius: 3px;
      transition: all 0.2s;
    }
    
    .npc:hover {
      border-color: var(--green-medium);
      background: #2a2a2a;
    }
    
    .npc.dead {
      opacity: 0.5;
      border-color: #666;
    }
    
    .npc-name {
      color: #ffff00;
      font-weight: bold;
    }
    
    .log {
      background: #000;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      border: 1px solid #00ff00;
      margin-top: 10px;
      font-size: 12px;
    }
    
    .log-entry {
      margin: 3px 0;
    }
    
    .log-combat { color: #ff0000; }
    .log-success { color: #00ff00; }
    .log-warning { color: #ffff00; }
    .log-death { color: #ff00ff; }
    
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.3; }
    }
    
    #login {
      max-width: 400px;
      margin: 100px auto;
      padding: 30px;
      background: #2a2a2a;
      border: 2px solid #00ff00;
      border-radius: 5px;
      text-align: center;
    }
    
    input {
      background: #000;
      color: #00ff00;
      border: 2px solid #00ff00;
      padding: 10px;
      font-family: inherit;
      width: 100%;
      margin: 10px 0;
      font-size: 16px;
    }
    
    .zombie-count {
      color: #ff0000;
      font-weight: bold;
    }

    .online-player {
      padding: 8px;
      margin: 5px 0;
      background: #1a3a1a;
      border-left: 3px solid #00ff00;
      font-size: 12px;
      border-radius: 3px;
    }

    .online-player-name {
      color: #00ff00;
      font-weight: bold;
    }

    .online-player-info {
      color: #888;
      font-size: 11px;
      margin-top: 3px;
    }

    .online-count {
      display: inline-block;
      background: #00ff00;
      color: #000;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: bold;
      margin-left: 5px;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #2a2a2a;
      border: 2px solid #00ff00;
      padding: 15px 20px;
      border-radius: 5px;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
      max-width: 300px;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .notification.success { border-color: #00ff00; }
    .notification.warning { border-color: #ffff00; }
    .notification.danger { border-color: #ff0000; }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .connection-status {
      position: fixed;
      bottom: 10px;
      right: 10px;
      padding: 5px 10px;
      background: #2a2a2a;
      border: 2px solid #00ff00;
      border-radius: 5px;
      font-size: 11px;
      z-index: 999;
    }

    .connection-status.connected { border-color: #00ff00; color: #00ff00; }
    .connection-status.disconnected { border-color: #ff0000; color: #ff0000; }
    
    /* Chat y Social mejorado */
    .chat-section { display: none; }
    .chat-section.active { display: block; }
    
    .dm-message {
      padding: 8px;
      margin: 5px 0;
      border-radius: 5px;
      font-size: 11px;
    }
    
    .dm-sent {
      background: #1a2a1a;
      border-left: 3px solid #00ff00;
      text-align: right;
    }
    
    .dm-received {
      background: #2a1a1a;
      border-left: 3px solid #ff8800;
    }
    
    .player-card-inspect {
      background: #1a2a1a;
      border: 2px solid #00ff00;
      padding: 10px;
      margin: 5px 0;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }
    
    .player-card-inspect:hover {
      background: #2a3a2a;
      border-color: #00ffff;
      transform: translateX(5px);
    }
    
    .player-card-inspect .rank-badge {
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 24px;
    }
    
    .title-badge {
      display: inline-block;
      padding: 2px 6px;
      background: linear-gradient(135deg, #1a1a3a, #3a1a3a);
      border: 1px solid #8888ff;
      border-radius: 3px;
      font-size: 9px;
      color: #aaaaff;
      margin-left: 5px;
      font-weight: bold;
    }
    
    .leaderboard-entry {
      background: #1a1a2a;
      border-left: 3px solid #888;
      padding: 10px;
      margin: 5px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s;
    }
    
    .leaderboard-entry:hover {
      background: #2a2a3a;
      transform: translateX(5px);
    }
    
    .leaderboard-entry.rank-1 { 
      border-left-color: #ffd700; 
      background: linear-gradient(90deg, #2a2a1a, #1a1a1a);
    }
    .leaderboard-entry.rank-2 { 
      border-left-color: #c0c0c0; 
      background: linear-gradient(90deg, #2a2a2a, #1a1a1a);
    }
    .leaderboard-entry.rank-3 { 
      border-left-color: #cd7f32; 
      background: linear-gradient(90deg, #2a1a1a, #1a1a1a);
    }
    
    .profile-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #0a0a0a;
      border: 3px solid #00ff00;
      padding: 20px;
      z-index: 9999;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 0 50px rgba(0, 255, 0, 0.5);
      border-radius: 5px;
    }
    
    .profile-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 9998;
      backdrop-filter: blur(3px);
    }
    
    .stat-comparison {
      display: flex;
      justify-content: space-between;
      padding: 5px;
      margin: 3px 0;
      background: #1a1a1a;
      font-size: 11px;
    }
    
    .stat-better { color: #ff8888; }
    .stat-worse { color: #88ff88; }
    
    /* üåü Estilos para historia destacada */
    #featuredStory:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0, 255, 0, 0.4) !important;
      background: linear-gradient(135deg, #1a3a1a, #3a1a1a);
    }
    
    /* ‚ö° Animaciones para feed de actividad EN VIVO */
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    .activity-item {
      padding: 8px 12px;
      margin: 5px 0;
      border-radius: 5px;
      border-left: 3px solid;
      animation: slideIn 0.3s ease-out;
      transition: all 0.2s;
      font-size: 12px;
      cursor: pointer;
    }
    
    .activity-item:hover {
      background: rgba(255,255,255,0.05);
      transform: translateX(5px);
    }
    
    .activity-fogata { border-left-color: #ff8800; background: rgba(255,136,0,0.1); }
    .activity-game { border-left-color: #4488ff; background: rgba(68,136,255,0.1); }
    .activity-chat { border-left-color: #00ff88; background: rgba(0,255,136,0.1); }
    .activity-npc { border-left-color: #ff44ff; background: rgba(255,68,255,0.1); }
    .activity-system { border-left-color: #888888; background: rgba(136,136,136,0.1); }
  </style>
</head>
<body>
  <!-- Indicador de estado de conexi√≥n -->
  <div id="connectionStatus" class="connection-status connected">
    üü¢ Conectado
  </div>
  
  <!-- Sistema de feedback de consecuencias -->
  <div id="consequenceFeedback"></div>

  <div id="game">
    <!-- Pantalla de login -->
    <div id="login">
      <h1 style="color: #ff0000; font-size: 32px; margin-bottom: 10px;">üíª Z-SURVIVAL.exe</h1>
      <p style="color: #00ff00; font-size: 14px; margin-bottom: 5px;">// Sistema de Supervivencia Multijugador v2.0</p>
      <p style="margin: 20px 0; color: #ff6666; font-style: italic;">El mundo est√° infectado. Los zombies dominan.<br>¬øPodr√°s sobrevivir?</p>
      
      <div style="border: 1px solid #00ff00; padding: 15px; margin: 20px 0; background: #1a1a1a;">
        <p style="font-size: 12px; color: #00ff00; margin-bottom: 10px;">‚ú® Caracter√≠sticas:</p>
        <p style="font-size: 11px; color: #aaa; text-align: left; line-height: 1.6;">
          üéÆ Mundo compartido en tiempo real<br>
          üßü Sistema de supervivencia completo<br>
          ü§ù Cooperaci√≥n y comercio entre jugadores<br>
          üè† Refugio comunitario que defender<br>
          üìà Progresi√≥n con skills y niveles<br>
          üéØ Misiones, eventos y narrativa din√°mica
        </p>
      </div>
      
      <input type="text" id="playerName" placeholder="Ingresa tu nombre de superviviente" maxlength="20" style="margin: 20px 0;">
      <button onclick="createPlayer()" style="width: 100%; padding: 15px; font-size: 18px; background: #006600; border: 2px solid #00ff00; color: #00ff00; cursor: pointer; font-weight: bold;">üö™ ENTRAR AL APOCALIPSIS</button>
      
      <button onclick="resetPlayerData()" style="width: 100%; padding: 8px; margin-top: 10px; font-size: 12px; background: #440000; border: 1px solid #660000; color: #ff6666; cursor: pointer;">üîÑ Limpiar datos y crear nueva cuenta</button>
      
      <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #333;">
        <p style="font-size: 11px; color: #666; margin-bottom: 10px;">¬øTe gusta el proyecto?</p>
        <a href="https://link.mercadopago.com.ar/donaciondelproyecto" target="_blank" style="display: inline-block; padding: 8px 15px; background: #009ee3; color: white; text-decoration: none; border-radius: 3px; font-size: 12px; font-weight: bold;">üíù APOYAR CON UNA DONACI√ìN</a>
        <p style="font-size: 10px; color: #555; margin-top: 8px;">Tu apoyo ayuda a mantener el servidor online üôè</p>
      </div>
    </div>

    <!-- Pantalla de juego (oculta inicialmente) -->
    <div id="gameScreen" style="display:none;">
      
      <!-- üî¥ BARRA SUPERIOR PERSISTENTE -->
      <div id="persistent-header">
        <div style="display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 20px;">üíª</span>
          <div>
            <div style="font-size: 18px; font-weight: bold; color: var(--red-danger);">Z-SURVIVAL.exe</div>
            <div style="font-size: 10px; color: var(--gray-text);">// alpha build</div>
          </div>
        </div>
        
        <div class="header-divider"></div>
        
        <div class="header-stat" id="header-hp">
          <span>üíö</span>
          <span id="header-hp-text">HP: --/--</span>
        </div>
        
        <div class="header-stat" id="header-hunger">
          <span>üçñ</span>
          <span id="header-hunger-text">Hambre: --</span>
        </div>
        
        <div class="header-stat" id="header-stamina">
          <span>‚ö°</span>
          <span id="header-stamina-text">Stamina: --</span>
        </div>
        
        <div class="header-divider"></div>
        
        <div class="header-stat" id="header-location">
          <span>üìç</span>
          <span id="header-location-text">Ubicaci√≥n: --</span>
        </div>
        
        <div class="header-stat" id="header-threats">
          <span>üßü</span>
          <span id="header-threats-text">x0</span>
        </div>
        
        <div class="header-divider"></div>
        
        <div class="header-stat" id="header-time">
          <span>üåô</span>
          <span id="header-time-text">--:--</span>
        </div>
        
        <div style="margin-left: auto;">
          <a href="https://link.mercadopago.com.ar/donaciondelproyecto" target="_blank" style="padding: 6px 12px; background: #009ee3; color: white; text-decoration: none; border-radius: 3px; font-size: 11px; font-weight: bold;">üíù Donar</a>
        </div>
      </div>
      
      <!-- üèóÔ∏è LAYOUT PRINCIPAL 3 COLUMNAS -->
      <div id="main-layout">
        
        <!-- üë§ SIDEBAR IZQUIERDA - PERSONAJE -->
        <div id="left-sidebar">
          
          <!-- Avatar y Stats -->
          <div class="player-avatar-section">
            <span class="player-avatar" id="player-avatar-icon">üßî</span>
            <div class="player-name-display" id="player-name-main">Jugador</div>
            <div class="player-level" id="player-level-display">Nivel 1</div>
            
            <!-- Barra HP -->
            <div class="stat-bar-container">
              <div class="stat-bar-label">
                <span>üíö HP</span>
                <span id="hp-value">100/100</span>
              </div>
              <div class="stat-bar">
                <div class="stat-bar-fill hp" id="hp-bar" style="width: 100%"></div>
              </div>
            </div>
            
            <!-- Barra Hambre -->
            <div class="stat-bar-container">
              <div class="stat-bar-label">
                <span>üçñ Hambre</span>
                <span id="hunger-value">100/100</span>
              </div>
              <div class="stat-bar">
                <div class="stat-bar-fill hunger" id="hunger-bar" style="width: 100%"></div>
              </div>
            </div>
            
            <!-- Barra Stamina -->
            <div class="stat-bar-container">
              <div class="stat-bar-label">
                <span>‚ö° Stamina</span>
                <span id="stamina-value">100/100</span>
              </div>
              <div class="stat-bar">
                <div class="stat-bar-fill stamina" id="stamina-bar" style="width: 100%"></div>
              </div>
            </div>
          </div>
          
          <!-- Acciones R√°pidas -->
          <div class="sidebar-section">
            <h3>‚ö° ACCIONES R√ÅPIDAS</h3>
            <button class="quick-action-btn" onclick="quickAction('buscar')">
              <span>üîç</span>
              <span>Buscar Recursos</span>
            </button>
            <button class="quick-action-btn" onclick="quickAction('atacar')">
              <span>‚öîÔ∏è</span>
              <span>Atacar Zombie</span>
            </button>
            <button class="quick-action-btn" onclick="quickAction('comer')">
              <span>üçñ</span>
              <span>Comer</span>
            </button>
            <button class="quick-action-btn" onclick="quickAction('dormir')">
              <span>üò¥</span>
              <span>Descansar</span>
            </button>
            <button class="quick-action-btn" onclick="quickAction('craftear')">
              <span>üî®</span>
              <span>Craftear</span>
            </button>
            <button class="quick-action-btn" onclick="quickAction('socializar')">
              <span>üí¨</span>
              <span>Socializar</span>
            </button>
            <button class="quick-action-btn" onclick="quickAction('viajar')">
              <span>üó∫Ô∏è</span>
              <span>Viajar</span>
            </button>
          </div>
          
          <!-- Debug / Admin Tools -->
          <div class="sidebar-section" style="padding: 8px;">
            <button class="quick-action-btn" onclick="requestMetrics()" 
                    style="background: linear-gradient(135deg, #1a1a2e, #2d2d3a); border: 1px solid #444; font-size: 11px; padding: 6px;">
              <span>üìä</span>
              <span>M√©tricas Server</span>
            </button>
          </div>
          
          <!-- Inventario Compacto (Colapsable) -->
          <div class="sidebar-section collapsible-section" onclick="toggleSection('quick-inventory')">
            <h3>üéí INVENTARIO ‚ñº</h3>
            <div class="section-content expanded" id="quick-inventory">
              <div style="font-size: 12px; line-height: 2;" id="quick-inventory-content">
                <div>üçñ Comida: <span id="quick-food">0</span></div>
                <div>üíä Medicinas: <span id="quick-meds">0</span></div>
                <div>üî© Materiales: <span id="quick-mats">0</span></div>
                <div>üî´ Armas: <span id="quick-weapons">0</span></div>
              </div>
            </div>
          </div>
          
          <!-- Info Refugio Compacta (Colapsable) -->
          <div class="sidebar-section collapsible-section" onclick="toggleSection('quick-refugio')">
            <h3>üè† REFUGIO ‚ñº</h3>
            <div class="section-content expanded" id="quick-refugio">
              <div style="font-size: 12px; line-height: 2;">
                <div>üõ°Ô∏è Defensa: <span id="quick-defense">0</span></div>
                <div>üë• NPCs: <span id="quick-npcs">0</span></div>
                <div>üìç <span id="quick-sublocation">Plaza</span></div>
              </div>
            </div>
          </div>
          
        </div>
        
        <!-- üì± CONTENIDO CENTRAL -->
        <div id="central-content">
          
          <!-- üåü HISTORIA DESTACADA DEL D√çA -->
          <div id="featuredStory" style="background: linear-gradient(135deg, #1a2a1a, #2a1a1a); border-bottom: 2px solid var(--green-bright); padding: 12px 18px; cursor: pointer; transition: all 0.3s; box-shadow: 0 0 15px rgba(0, 255, 0, 0.2);" onclick="handleFeaturedStoryClick()">
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 24px;">üì∞</span>
              <div style="flex: 1;">
                <div style="font-size: 10px; color: var(--green-dim); text-transform: uppercase; letter-spacing: 1px;">HOY EN EL MUNDO</div>
                <div id="featuredStoryText" style="color: var(--green-bright); font-weight: bold; margin-top: 3px; font-size: 13px;">Cargando acontecimientos...</div>
              </div>
              <span style="color: var(--green-medium); font-size: 20px;">‚Üí</span>
            </div>
          </div>
          
          <!-- SISTEMA DE PESTA√ëAS -->
          <div class="tabs-container" style="border: none; margin: 0; flex: 1; display: flex; flex-direction: column;">
            <div class="tabs-header">
              <button class="tab-button active" onclick="switchTab('main')">
                üè† PRINCIPAL
              </button>
              <button class="tab-button" onclick="switchTab('combate')">
                ‚öîÔ∏è COMBATE
              </button>
              <button class="tab-button" onclick="switchTab('refugio')">
                üèòÔ∏è REFUGIO
              </button>
              <button class="tab-button" onclick="switchTab('mundo')" id="tab-btn-mundo">
                üåç MUNDO
                <span class="tab-badge" id="badge-mundo" style="display: none;">!</span>
              </button>
              <button class="tab-button" onclick="switchTab('social')" id="tab-btn-social">
                üí¨ SOCIAL
                <span class="tab-badge" id="badge-social" style="display: none;">!</span>
              </button>
              <button class="tab-button" onclick="switchTab('missions')" id="tab-btn-missions">
                üìú MISIONES
                <span class="tab-badge" id="badge-missions" style="display: none;">!</span>
              </button>
              <button class="tab-button" onclick="switchTab('progression')">
                üìä PROGRESI√ìN
              </button>
            </div>

        <!-- PESTA√ëA 1: JUEGO PRINCIPAL -->
        <div id="tab-main" class="tab-content active">
          <div style="padding: var(--space-md);">
            
            <!-- TU UBICACI√ìN ACTUAL -->
            <div class="card" style="margin-bottom: var(--space-md); background: linear-gradient(135deg, #1a3a1a 0%, #0d1f0d 100%); border: 2px solid var(--green-safe);">
              <h2 id="locationName" style="color: var(--green-safe); margin-bottom: var(--space-sm); font-size: 20px; text-align: center;"></h2>
              <p id="locationDesc" style="color: var(--gray-text); font-size: 14px; line-height: 1.5; margin-bottom: var(--space-md); text-align: center;"></p>
              <div id="locationActions" style="display: flex; gap: var(--space-xs); flex-wrap: wrap; justify-content: center;"></div>
            </div>
            
            <!-- ACCIONES PRINCIPALES (DESTACADAS) -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-md); margin-bottom: var(--space-md);">
              
              <!-- MOVERSE -->
              <div class="card action-card" style="background: #0a2a3a; border: 2px solid #00aaff; cursor: pointer;" onclick="toggleSection('moveSection')">
                <div style="text-align: center;">
                  <div style="font-size: 48px; margin-bottom: var(--space-sm);">üö∂</div>
                  <h3 style="color: #00aaff; font-size: 16px; margin: 0;">MOVERSE</h3>
                  <p style="color: var(--gray-text); font-size: 11px; margin-top: 4px;">Click para ver zonas</p>
                </div>
              </div>
              
              <!-- ATACAR ZOMBIES -->
              <div class="card action-card" style="background: #3a0a0a; border: 2px solid #ff0000; cursor: pointer;" onclick="iniciarCombate()">
                <div style="text-align: center;">
                  <div style="font-size: 48px; margin-bottom: var(--space-sm);">‚öîÔ∏è</div>
                  <h3 style="color: #ff0000; font-size: 16px; margin: 0;">ATACAR</h3>
                  <p style="color: var(--gray-text); font-size: 11px; margin-top: 4px;" id="zombieCount">0 zombies aqu√≠</p>
                </div>
              </div>
              
              <!-- BUSCAR RECURSOS -->
              <div class="card action-card" style="background: #1a3a0a; border: 2px solid #00ff00; cursor: pointer;" onclick="scavenge()">
                <div style="text-align: center;">
                  <div style="font-size: 48px; margin-bottom: var(--space-sm);">üîç</div>
                  <h3 style="color: #00ff00; font-size: 16px; margin: 0;">BUSCAR</h3>
                  <p style="color: var(--gray-text); font-size: 11px; margin-top: 4px;">Recolectar recursos</p>
                </div>
              </div>
            </div>
            
            <!-- SECCI√ìN DE MOVIMIENTO (SIEMPRE VISIBLE DESPU√âS DE EXPANDIR) -->
            <div id="moveSection" style="display: none; margin-bottom: var(--space-md);">
              <div class="card" style="background: #0a2a3a; border: 2px solid #00aaff;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-sm);">
                  <h3 style="color: #00aaff; font-size: 18px; margin: 0;">üó∫Ô∏è ¬øA D√ìNDE QUER√âS IR?</h3>
                  <button onclick="toggleSection('moveSection')" style="background: transparent; border: 1px solid #00aaff; color: #00aaff; padding: 4px 12px; cursor: pointer; border-radius: 3px;">‚úï Cerrar</button>
                </div>
                <div id="locations" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: var(--space-sm);"></div>
              </div>
            </div>
            
            <!-- NPCs EN ESTA ZONA -->
            <div class="card" style="margin-bottom: var(--space-md);">
              <h3 style="color: var(--blue-info); margin-bottom: var(--space-sm); font-size: 16px;">üë• GENTE AQU√ç:</h3>
              <div id="npcsHere" style="font-size: 13px; color: var(--gray-text);">
                <div style="opacity: 0.5; font-style: italic;">No hay nadie aqu√≠</div>
              </div>
            </div>
            
            <!-- MAPA VISUAL (OPCIONAL - COLAPSABLE) -->
            <details class="card" style="margin-bottom: var(--space-md);">
              <summary style="cursor: pointer; padding: var(--space-sm); font-size: 14px; color: var(--green-safe); font-weight: bold;">
                üó∫Ô∏è Ver Mapa Completo (opcional)
              </summary>
              <div id="world-map-2d" style="
                font-family: 'Courier New', monospace;
                font-size: 10px;
                line-height: 1.3;
                background: var(--gray-bg);
                padding: var(--space-sm);
                border-radius: 4px;
                overflow-x: auto;
                white-space: pre;
                color: var(--green-medium);
                max-height: 300px;
                overflow-y: auto;
                margin-top: var(--space-sm);
              ">
                <div style="text-align: center; color: var(--gray-text);">Cargando mapa...</div>
              </div>
              <div style="display: flex; gap: var(--space-xs); flex-wrap: wrap; margin-top: var(--space-xs); font-size: 9px; color: var(--gray-text); justify-content: center;">
                <span>üìç=T√∫</span>
                <span>üë§=NPCs</span>
                <span>üßü=Zombies</span>
                <span>üì¶=Recursos</span>
              </div>
            </details>
            
            <!-- Sistema de crafteo -->
            <div class="card">
              <h3 style="color: var(--orange-warn); margin-bottom: var(--space-sm); font-size: 16px;">üî® CRAFTEAR ITEMS</h3>
              
              <div class="craft-tabs" style="display: flex; gap: var(--space-xs); margin-bottom: var(--space-md);">
                <button class="craft-tab active" onclick="switchCraftTab('basic')">B√ÅSICO</button>
                <button class="craft-tab" onclick="switchCraftTab('advanced')">AVANZADO</button>
                <button class="craft-tab" onclick="switchCraftTab('epic')">LEGENDARIO</button>
              </div>
              
              <div id="craft-basic" class="craft-section active" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: var(--space-xs); font-size: 11px;">
                <button onclick="craft('vendaje')" style="padding: 12px; background: #003300; border: 2px solid #006600; color: #00ff00;">
                  üíä<br>Vendaje<br><small style="opacity: 0.7;">(2 mat)</small>
                </button>
                <button onclick="craft('molotov')" style="padding: 12px; background: #330000; border: 2px solid #660000; color: #ff6600;">
                  üî•<br>Molotov<br><small style="opacity: 0.7;">(3 mat, 1 com)</small>
                </button>
                <button onclick="craft('barricada')" style="padding: 12px; background: #003333; border: 2px solid #006666; color: #00ffff;">
                  üöß<br>Barricada<br><small style="opacity: 0.7;">(5 mat)</small>
                </button>
                <button onclick="craft('trampa')" style="padding: 12px; background: #333300; border: 2px solid #666600; color: #ffff00;">
                  ü™§<br>Trampa<br><small style="opacity: 0.7;">(4 mat, 1 arm)</small>
                </button>
              </div>
              
              <div id="craft-advanced" class="craft-section" style="display: none; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: var(--space-xs); font-size: 11px;">
                <button onclick="craft('antibiotico')" style="padding: 12px; background: #1a4a1a; border: 2px solid #00ff00; color: #00ff00;">
                  üíâ<br>Antibi√≥tico<br><small style="opacity: 0.7;">(2 med, 1 mat)</small>
                </button>
                <button onclick="craft('machete')" style="padding: 12px; background: #4a1a1a; border: 2px solid #ff6600; color: #ff6600;">
                  üî™<br>Machete<br><small style="opacity: 0.7;">(6 mat, 1 arm)</small>
                </button>
                <button onclick="craft('pistola_mejorada')" style="padding: 12px; background: #3a0a0a; border: 2px solid #ff0000; color: #ff0000;">
                  üî´<br>Pistola+<br><small style="opacity: 0.7;">(3 arm, 5 mat)</small>
                </button>
                <button onclick="craft('armadura_ligera')" style="padding: 12px; background: #1a3a4a; border: 2px solid #0088ff; color: #0088ff;">
                  ü¶∫<br>Armadura<br><small style="opacity: 0.7;">(8 mat, 2 com)</small>
                </button>
                <button onclick="craft('botiquin')" style="padding: 12px; background: #2a1a3a; border: 2px solid #aa00ff; color: #aa00ff;">
                  ‚öïÔ∏è<br>Botiqu√≠n<br><small style="opacity: 0.7;">(3 med, 2 mat)</small>
                </button>
                <button onclick="craft('radio')" style="padding: 12px; background: #2a2a4a; border: 2px solid #4488ff; color: #4488ff;">
                  üìª<br>Radio<br><small style="opacity: 0.7;">(15 mat, 1 arm)</small>
                </button>
              </div>
              
              <div id="craft-epic" class="craft-section" style="display: none; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: var(--space-xs); font-size: 11px;">
                <button onclick="craft('explosivo')" style="padding: 12px; background: #4a1a2a; border: 3px solid #ff0000; color: #ff0000;">
                  üí£<br>Explosivo<br><small style="opacity: 0.7;">(10 mat, 2 arm, 3 com)</small>
                </button>
                <button onclick="craft('generador')" style="padding: 12px; background: #3a3a1a; border: 2px solid #ffff00; color: #ffff00;">
                  ‚ö°<br>Generador<br><small style="opacity: 0.7;">(20 mat, 3 arm)</small>
                </button>
              </div>
            </div>
            
          </div>
        </div>

        <!-- PESTA√ëA 2: COMBATE -->
        <div id="tab-combate" class="tab-content">
          <div class="container">
            <div class="panel featured" style="grid-column: 1 / -1; max-width: 1000px; margin: 0 auto;">
              <h2>‚öîÔ∏è SISTEMA DE COMBATE</h2>
              
              <!-- Estado de combate -->
              <div id="combatStatus" style="background: var(--gray-card); padding: 20px; border-radius: var(--card-radius); border: 2px solid var(--red-danger); margin: 20px 0;">
                <div id="combatActive" style="display: none;">
                  <!-- Combate activo por turnos -->
                  <h3 style="color: var(--red-danger); margin-top: 0;">üßü EN COMBATE</h3>
                  <div id="combatInfo" style="margin: 15px 0;"></div>
                  <div id="combatActions" style="display: flex; gap: 10px; margin-top: 20px;"></div>
                </div>
                
                <div id="combatIdle">
                  <p style="text-align: center; color: var(--green-medium); margin: 20px 0;">
                    ‚úÖ No est√°s en combate.<br>
                    <small>Busca zombies en ubicaciones peligrosas para iniciar combate.</small>
                  </p>
                </div>
              </div>
              
              <!-- Enemigos disponibles -->
              <div id="enemiesInLocation" style="margin-top: 20px;">
                <h3>üßü Enemigos en ubicaci√≥n actual</h3>
                <div id="enemyList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;"></div>
              </div>
              
              <!-- Equipo de combate -->
              <div style="margin-top: 30px;">
                <h3>üéí TU EQUIPO DE COMBATE</h3>
                <div id="combatEquipment" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 15px;"></div>
              </div>
              
            </div>
          </div>
        </div>

        <!-- PESTA√ëA 3: REFUGIO -->
        <div id="tab-refugio" class="tab-content">
          <div class="container">
            <div class="panel featured" style="grid-column: 1 / -1; max-width: 1000px; margin: 0 auto;">
              <h2>üèòÔ∏è GESTI√ìN DEL REFUGIO</h2>
              
              <!-- Estado del refugio -->
              <div style="background: var(--gray-card); padding: 20px; border-radius: var(--card-radius); border: 2px solid var(--blue-info); margin: 20px 0;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                  <div>
                    <h3 style="margin-top: 0; color: var(--blue-info);">üõ°Ô∏è Defensas</h3>
                    <div id="refugioDefensas" style="font-size: 24px; font-weight: bold;">0</div>
                  </div>
                  <div>
                    <h3 style="margin-top: 0; color: var(--green-safe);">üë• Supervivientes</h3>
                    <div id="refugioNPCs" style="font-size: 24px; font-weight: bold;">0</div>
                  </div>
                  <div>
                    <h3 style="margin-top: 0; color: var(--orange-warn);">üì¶ Recursos</h3>
                    <div id="refugioRecursosTotal" style="font-size: 24px; font-weight: bold;">0</div>
                  </div>
                </div>
              </div>
              
              <!-- Construcci√≥n y mejoras -->
              <div style="margin-top: 30px;">
                <h3>üî® CONSTRUIR Y MEJORAR</h3>
                <div id="refugioConstruccion" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                  <button onclick="craft('barricada')" style="padding: 20px; background: #003333; border: 2px solid #006666; color: #00ffff; cursor: pointer;">
                    üöß Construir Barricada<br>
                    <small style="opacity: 0.7;">+5 defensas (5 mat)</small>
                  </button>
                  <button onclick="craft('trampa')" style="padding: 20px; background: #333300; border: 2px solid #666600; color: #ffff00; cursor: pointer;">
                    ü™§ Instalar Trampa<br>
                    <small style="opacity: 0.7;">Da√±o autom√°tico (4 mat, 1 arm)</small>
                  </button>
                  <button onclick="craft('generador')" style="padding: 20px; background: #3a3a1a; border: 2px solid #ffff00; color: #ffff00; cursor: pointer;">
                    ‚ö° Instalar Generador<br>
                    <small style="opacity: 0.7;">Electricidad (20 mat, 3 arm)</small>
                  </button>
                </div>
              </div>
              
              <!-- NPCs del refugio -->
              <div style="margin-top: 30px;">
                <h3>üë• SUPERVIVIENTES EN EL REFUGIO</h3>
                <div id="refugioNPCList" style="margin-top: 15px;"></div>
              </div>
              
              <!-- Donar recursos -->
              <div style="margin-top: 30px;">
                <h3>üíù CONTRIBUIR AL REFUGIO</h3>
                <button onclick="showDonateMenu()" style="width: 100%; padding: 15px; font-size: 14px; background: #006600; border: 2px solid #00ff00; color: #00ff00; cursor: pointer; font-weight: bold;">
                  üíù DONAR RECURSOS AL REFUGIO COMPARTIDO
                </button>
              </div>
              
            </div>
          </div>
        </div>

        <!-- PESTA√ëA MISIONES NARRATIVAS -->
        <!-- PESTA√ëA MISIONES NARRATIVAS -->
        <div id="tab-missions" class="tab-content">
          <div style="grid-column: 1 / -1; max-width: 1000px; margin: 0 auto; padding: var(--space-lg);">
            
            <!-- Misi√≥n Activa -->
            <div id="narrativeMissionActive" class="card" style="display: none; margin-bottom: var(--space-lg);">
              <h3 id="narrativeMissionTitle" style="color: var(--orange-warn); margin-bottom: var(--space-md);">üìñ Misi√≥n en Curso</h3>
              
              <!-- Texto narrativo -->
              <div id="narrativeStoryText" style="
                background: linear-gradient(135deg, var(--gray-darker) 0%, var(--gray-card) 100%);
                border: 2px solid var(--orange-warn);
                border-radius: 8px;
                padding: var(--space-lg);
                margin-bottom: var(--space-md);
                font-size: 14px;
                line-height: 1.6;
                color: #ffffff;
                min-height: 100px;
              ">
                Cargando...
              </div>

              <!-- Timer & Modo -->
              <div style="display: flex; gap: var(--space-md); margin-bottom: var(--space-md);">
                <div id="narrativeTimer" style="
                  background: var(--red-danger);
                  color: white;
                  padding: 12px 24px;
                  border-radius: 4px;
                  font-weight: bold;
                  font-size: 18px;
                ">
                  ‚è±Ô∏è 20s
                </div>
                <div id="narrativeMode" style="
                  background: var(--blue-info);
                  color: white;
                  padding: 12px 24px;
                  border-radius: 4px;
                  font-weight: bold;
                ">
                  üë§ SOLO
                </div>
              </div>

              <!-- Votaci√≥n Grupal -->
              <div id="narrativeVoting" style="display: none; margin-bottom: var(--space-md);">
                <div style="background: var(--gray-darker); padding: var(--space-md); border-radius: 4px;">
                  <h4 style="color: var(--yellow-legend); margin-bottom: var(--space-sm);">üó≥Ô∏è VOTACI√ìN EN CURSO</h4>
                  <div id="voteCount" style="font-size: 14px; color: var(--gray-text);">
                    Votos: 0 / 0
                  </div>
                </div>
              </div>

              <!-- Opciones -->
              <div id="narrativeChoices" style="
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: var(--space-md);
                margin-bottom: var(--space-md);
              ">
                <!-- Din√°mico -->
              </div>

              <!-- Abandonar -->
              <button onclick="abandonNarrativeMission()" style="
                background: var(--gray-border);
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                font-size: 12px;
              ">
                ‚ùå Abandonar Misi√≥n
              </button>
            </div>

            <!-- Lista de Misiones -->
            <div id="narrativeMissionList" class="card" style="margin-bottom: var(--space-lg);">
              <h3 style="color: var(--blue-info); margin-bottom: var(--space-sm);">üìñ MISIONES NARRATIVAS</h3>
              <p style="font-size: 13px; color: var(--gray-text); margin-bottom: var(--space-md);">
                Misiones interactivas con historia, decisiones y consecuencias reales
              </p>
              
              <button onclick="loadNarrativeMissions()" style="padding: 10px 20px; margin-bottom: var(--space-md);">
                üîÑ Actualizar
              </button>

              <div id="narrativeMissionCards" style="
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: var(--space-md);
              ">
                <p style="text-align: center; color: var(--gray-text); padding: var(--space-lg);">Cargando misiones...</p>
              </div>
            </div>

            <!-- Estad√≠sticas -->
            <div class="card">
              <h3 style="color: var(--green-safe); margin-bottom: var(--space-sm);">üìä ESTAD√çSTICAS</h3>
              <div id="narrativeMissionStats" style="font-size: 13px; line-height: 1.8;">
                <p style="color: var(--gray-text);">Completa misiones para ver estad√≠sticas</p>
              </div>
            </div>

          </div>
        </div>

        <!-- PESTA√ëA 3: SOCIAL -->
        <!-- PESTA√ëA SOCIAL -->
        <div id="tab-social" class="tab-content">
          <div style="grid-column: 1 / -1; max-width: 1200px; margin: 0 auto; padding: var(--space-lg);">
            
            <!-- Fogata del Refugio -->
            <div class="card" style="margin-bottom: var(--space-lg);">
              <h3 style="color: var(--orange-warn); margin-bottom: var(--space-sm);">üî• FOGATA DEL REFUGIO</h3>
              <p style="color: var(--gray-text); font-size: 13px; margin-bottom: var(--space-md);">
                Comparte historias y consejos con otros supervivientes (solo en Refugio Central)
              </p>
              
              <div id="fogataAccess">
                <div id="fogataLocked" style="display: none; text-align: center; padding: 30px; color: var(--orange-warn);">
                  üîí Debes estar en el <strong>Refugio Central</strong>
                </div>
                
                <div id="fogataUnlocked">
                  <!-- Crear post -->
                  <div style="background: var(--gray-darker); padding: var(--space-md); border-radius: 8px; margin-bottom: var(--space-md);">
                    <input type="text" id="postTitle" placeholder="T√≠tulo..." maxlength="60" 
                           style="width: 100%; padding: 10px; margin-bottom: 8px; background: var(--gray-bg); border: 1px solid var(--gray-border); color: #fff; font-size: 13px;">
                    <textarea id="postContent" placeholder="Contenido..." maxlength="300" rows="3" 
                              style="width: 100%; padding: 10px; margin-bottom: 8px; background: var(--gray-bg); border: 1px solid var(--gray-border); color: #fff; font-size: 13px; resize: vertical;"></textarea>
                    <div style="display: flex; gap: var(--space-sm);">
                      <select id="postCategory" style="flex: 1; padding: 10px; background: var(--gray-bg); border: 1px solid var(--gray-border); color: #fff; font-size: 12px;">
                        <option value="historia">üìñ Historia</option>
                        <option value="consejo">üí° Consejo</option>
                        <option value="pregunta">‚ùì Pregunta</option>
                        <option value="busco_grupo">üë• Busco Grupo</option>
                        <option value="comercio">üí∞ Comercio</option>
                        <option value="general">üí¨ General</option>
                      </select>
                      <button onclick="createPost()" style="padding: 10px 24px; background: var(--orange-warn); color: #000; font-weight: bold; border: none;">üî• Publicar</button>
                    </div>
                  </div>

                  <!-- Filtros -->
                  <div style="display: flex; gap: var(--space-xs); margin-bottom: var(--space-md); flex-wrap: wrap;">
                    <button onclick="changeSortBy('recent')" id="sort-recent" style="padding: 8px 16px; background: var(--orange-warn); color: #000; border: none; font-size: 12px; font-weight: bold;">
                      üïí Recientes
                    </button>
                    <button onclick="changeSortBy('likes')" id="sort-likes" style="padding: 8px 16px; background: var(--gray-card); color: var(--gray-text); border: 1px solid var(--gray-border); font-size: 12px;">
                      ‚ù§Ô∏è M√°s gustados
                    </button>
                    <button onclick="changeSortBy('comments')" id="sort-comments" style="padding: 8px 16px; background: var(--gray-card); color: var(--gray-text); border: 1px solid var(--gray-border); font-size: 12px;">
                      üí¨ Comentados
                    </button>
                  </div>

                  <!-- Feed -->
                  <div id="fogataFeed" style="max-height: 400px; overflow-y: auto; padding: var(--space-sm);">
                    <div style="text-align: center; padding: var(--space-lg); color: var(--gray-text);">üìú Cargando posts...</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Chat & Jugadores -->
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-lg); margin-bottom: var(--space-lg);">
              
              <!-- Chat -->
              <div class="card">
                <h3 style="color: var(--blue-info); margin-bottom: var(--space-sm);">üí¨ CHAT</h3>
                <div class="craft-tabs" style="margin-bottom: var(--space-sm);">
                  <button class="craft-tab active" onclick="switchChatTab('global')">üåê GLOBAL</button>
                  <button class="craft-tab" onclick="switchChatTab('group')">üë• GRUPO</button>
                </div>
                
                <div id="chat-global" class="chat-section active">
                  <div class="log" id="chatLog" style="max-height: 300px; background: var(--gray-bg); padding: var(--space-sm); border-radius: 4px; overflow-y: auto;"></div>
                  <div style="display: flex; gap: var(--space-xs); margin-top: var(--space-sm);">
                    <input type="text" id="chatInput" placeholder="Mensaje..." maxlength="100" 
                           style="flex: 1; padding: 10px; background: var(--gray-bg); border: 1px solid var(--gray-border); color: #fff; font-size: 13px;" 
                           onkeypress="if(event.key==='Enter') sendChat()">
                    <button onclick="sendChat()" style="padding: 10px 16px;">üì§</button>
                  </div>
                </div>
                
                <div id="chat-group" class="chat-section" style="display: none;">
                  <div id="groupChatPanel">
                    <div id="noGroupMessage" style="text-align: center; padding: 40px; color: var(--gray-text);">
                      <div style="font-size: 48px; margin-bottom: var(--space-sm);">üë•</div>
                      <p>No est√°s en ning√∫n grupo</p>
                      <button onclick="createGroup()" style="margin-top: var(--space-md); padding: 10px 20px;">‚ûï Crear Grupo</button>
                    </div>
                    <div id="hasGroupMessage" style="display: none;">
                      <div id="groupChatLog" style="max-height: 300px; overflow-y: auto; background: var(--gray-bg); padding: var(--space-sm); border-radius: 4px; margin-bottom: var(--space-sm);"></div>
                      <div style="display: flex; gap: var(--space-xs);">
                        <input type="text" id="groupChatInput" placeholder="Mensaje al grupo..." maxlength="100" 
                               style="flex: 1; padding: 10px; background: var(--gray-bg); border: 1px solid var(--gray-border); color: #fff; font-size: 13px;" 
                               onkeypress="if(event.key==='Enter') sendGroupChat()">
                        <button onclick="sendGroupChat()" style="padding: 10px 16px;">üì§</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Jugadores Online -->
              <div class="card">
                <h3 style="color: var(--green-safe); margin-bottom: var(--space-sm);">
                  üåç ONLINE <span id="onlineCount" class="online-count">0</span>
                </h3>
                <div id="onlinePlayers" style="font-size: 12px; max-height: 350px; overflow-y: auto;">
                  <em style="color: var(--gray-text);">Cargando...</em>
                </div>
              </div>
            </div>

            <!-- Juegos & Comercio -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg);">
              
              <!-- Juegos -->
              <div class="card">
                <h3 style="color: var(--purple-rare); margin-bottom: var(--space-sm);">üé≤ JUEGOS DE MESA</h3>
                <p style="color: var(--gray-text); font-size: 12px; margin-bottom: var(--space-md);">
                  Juega y apuesta recursos (solo en Refugio)
                </p>
                
                <div id="gamesAccess">
                  <div id="gamesLocked" style="display: none; text-align: center; padding: var(--space-lg); color: var(--orange-warn);">
                    üîí Debes estar en el <strong>Refugio</strong>
                  </div>
                  
                  <div id="gamesUnlocked">
                    <div id="availableGames" style="display: grid; gap: var(--space-sm); grid-template-columns: repeat(2, 1fr); margin-bottom: var(--space-md);">
                      <!-- Din√°mico por ubicaci√≥n -->
                    </div>
                    
                    <div>
                      <h4 style="font-size: 13px; margin-bottom: var(--space-xs);">üéÆ Partidas Activas</h4>
                      <div id="activeGames" style="font-size: 11px; max-height: 150px; overflow-y: auto;">
                        <em style="color: var(--gray-text);">Sin partidas activas</em>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Comercio -->
              <div class="card">
                <h3 style="color: var(--yellow-legend); margin-bottom: var(--space-sm);">üí± COMERCIO</h3>
                <p style="color: var(--gray-text); font-size: 12px; margin-bottom: var(--space-md);">
                  Intercambia recursos con otros jugadores
                </p>
                
                <div id="tradePanel">
                  <select id="tradeTargetSelect" style="width: 100%; padding: 10px; background: var(--gray-bg); border: 1px solid var(--gray-border); color: #fff; margin-bottom: var(--space-sm); font-size: 13px;">
                    <option>Selecciona jugador...</option>
                  </select>
                  <button onclick="openTradeDialog()" style="width: 100%; padding: 10px; margin-bottom: var(--space-md);">ü§ù Crear Oferta</button>
                  
                  <h4 style="font-size: 13px; margin-bottom: var(--space-xs);">Ofertas Recibidas:</h4>
                  <div id="tradeOffers" style="max-height: 150px; overflow-y: auto; font-size: 12px;">
                    <em style="color: var(--gray-text);">Sin ofertas pendientes</em>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- PESTA√ëA MUNDO VIVO -->
        <div id="tab-mundo" class="tab-content">
          <div style="grid-column: 1 / -1; max-width: 1200px; margin: 0 auto; padding: var(--space-lg);">
            
            <!-- Actividad en Vivo -->
            <div class="card" style="margin-bottom: var(--space-lg); background: linear-gradient(135deg, var(--gray-darker) 0%, var(--gray-card) 100%); border: 2px solid var(--red-danger);">
              <h3 style="color: var(--red-danger); margin-bottom: var(--space-sm);">
                üî¥ ACTIVIDAD EN VIVO <span style="animation: pulse 2s infinite; display: inline-block;">‚ö´</span>
              </h3>
              <p style="color: var(--gray-text); font-size: 13px; margin-bottom: var(--space-md);">
                ¬øQu√© est√° pasando AHORA? Actividad social, juegos, conversaciones...
              </p>
              <div id="liveActivityFeed" style="max-height: 300px; overflow-y: auto; font-size: 12px; background: rgba(0,0,0,0.3); padding: var(--space-md); border-radius: 4px;">
                <p style="text-align: center; color: var(--gray-text); padding: var(--space-lg); font-style: italic;">üí≠ Esperando actividad...</p>
              </div>
            </div>

            <!-- FASE 11: EVENTOS GLOBALES -->
            <div class="card" style="margin-bottom: var(--space-lg); background: linear-gradient(135deg, rgba(0,100,200,0.1) 0%, rgba(0,50,100,0.2) 100%); border: 3px solid #00aaff;">
              <h3 style="color: #00aaff; margin-bottom: var(--space-sm);">
                üåç EVENTOS GLOBALES <span style="font-size: 12px; color: var(--orange-warn);">(NUEVO)</span>
              </h3>
              <p style="color: var(--gray-text); font-size: 13px; margin-bottom: var(--space-md);">
                Eventos que afectan a todos los jugadores simult√°neamente: Hordas, Airdrops, Comerciantes, Clima
              </p>
              <button onclick="requestActiveEvents()" style="padding: 8px 16px; margin-bottom: var(--space-sm);">üîÑ Actualizar</button>
              <div id="globalEventsContainer" style="max-height: 500px; overflow-y: auto; font-size: 12px;">
                <p style="text-align: center; color: var(--gray-text); padding: var(--space-lg); font-style: italic;">‚è≥ Cargando eventos globales...</p>
              </div>
            </div>

            <!-- FASE 12: SISTEMA DE CONSTRUCCI√ìN -->
            <div class="card" style="margin-bottom: var(--space-lg); background: linear-gradient(135deg, rgba(200,100,0,0.1) 0%, rgba(100,50,0,0.2) 100%); border: 3px solid var(--orange-warn);">
              <h3 style="color: var(--orange-warn); margin-bottom: var(--space-sm);">
                üèóÔ∏è CONSTRUCCI√ìN COOPERATIVA <span style="font-size: 12px; color: #44ff44;">(FASE 12)</span>
              </h3>
              <p style="color: var(--gray-text); font-size: 13px; margin-bottom: var(--space-md);">
                Construye estructuras junto a otros supervivientes para mejorar el refugio y obtener beneficios permanentes
              </p>
              <button onclick="requestConstructionData()" style="padding: 8px 16px; margin-bottom: var(--space-sm);">üîÑ Actualizar</button>

              <!-- Grid de 3 columnas: Estructuras | Proyectos | Beneficios -->
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--space-lg);">
                
                <!-- Estructuras Disponibles -->
                <div style="grid-column: 1 / 3;">
                  <h4 style="color: #ffaa00; margin: var(--space-md) 0; font-size: 14px; border-bottom: 2px solid #ffaa0033; padding-bottom: 8px;">
                    üìê ESTRUCTURAS DISPONIBLES
                  </h4>
                  <div id="constructionStructuresContainer" style="max-height: 600px; overflow-y: auto;">
                    <p style="text-align: center; color: var(--gray-text); padding: var(--space-lg);">‚è≥ Cargando estructuras...</p>
                  </div>
                </div>

                <!-- Beneficios del Refugio -->
                <div>
                  <h4 style="color: #44ff44; margin: var(--space-md) 0; font-size: 14px; border-bottom: 2px solid #44ff4433; padding-bottom: 8px;">
                    ‚≠ê BENEFICIOS ACTIVOS
                  </h4>
                  <div id="refugeEffectsContainer" style="max-height: 300px; overflow-y: auto;">
                    <p style="text-align: center; color: var(--gray-text); padding: var(--space-lg);">‚è≥ Cargando...</p>
                  </div>
                </div>
              </div>

              <!-- Proyectos Activos (ancho completo) -->
              <div style="margin-top: var(--space-lg);">
                <h4 style="color: #00aaff; margin: var(--space-md) 0; font-size: 14px; border-bottom: 2px solid #00aaff33; padding-bottom: 8px;">
                  üöß PROYECTOS EN CONSTRUCCI√ìN
                </h4>
                <div id="constructionProjectsContainer" style="max-height: 400px; overflow-y: auto;">
                  <p style="text-align: center; color: var(--gray-text); padding: var(--space-lg);">‚è≥ Cargando proyectos...</p>
                </div>
              </div>
            </div>

            <!-- FASE 11: Misiones Din√°micas NUEVAS + Feed Mundo -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg); margin-bottom: var(--space-lg);">
              
              <!-- Misiones Din√°micas (FASE 11) -->
              <div class="card">
                <h3 style="color: var(--purple-rare); margin-bottom: var(--space-sm);">
                  üéØ MISIONES DIN√ÅMICAS <span style="font-size: 11px; color: var(--orange-warn);">(FASE 11)</span>
                </h3>
                <p style="color: var(--gray-text); font-size: 12px; margin-bottom: var(--space-md);">
                  Misiones generadas por relaciones y eventos del mundo
                </p>
                <button onclick="requestDynamicQuests()" style="padding: 8px 16px; margin-bottom: var(--space-sm);">üîÑ Refrescar</button>
                <div id="dynamicQuestsContainer" style="max-height: 500px; overflow-y: auto; font-size: 12px;">
                  <p style="text-align: center; color: var(--gray-text); padding: var(--space-lg);">‚è≥ Cargando misiones din√°micas...</p>
                </div>
              </div>

              <!-- Misiones Legacy (Mundo Original) -->
              <div class="card">
                <h3 style="color: var(--orange-warn); margin-bottom: var(--space-sm);">
                  ‚ö° MISIONES (LEGACY) <span id="questCountBadge" style="font-size: 12px; color: var(--green-safe);"></span>
                </h3>
                <p style="color: var(--gray-text); font-size: 12px; margin-bottom: var(--space-md);">
                  Sistema original de misiones
                </p>
                <button onclick="refreshQuests()" style="padding: 8px 16px; margin-bottom: var(--space-sm);">üîÑ Refrescar</button>
                <div id="questsList" style="max-height: 400px; overflow-y: auto; font-size: 12px;">
                  <p style="text-align: center; color: var(--gray-text); padding: var(--space-lg);">‚è≥ Cargando misiones...</p>
                </div>
              </div>
            </div>

            <!-- Feed del Mundo -->
            <div class="card" style="margin-bottom: var(--space-lg);">
              <h3 style="color: var(--blue-info); margin-bottom: var(--space-sm);">üì∞ FEED DEL MUNDO</h3>
              <p style="color: var(--gray-text); font-size: 12px; margin-bottom: var(--space-md);">
                Los NPCs viven sus propias vidas...
              </p>
              <button onclick="refreshWorldEvents()" style="padding: 8px 16px; margin-bottom: var(--space-sm);">üîÑ Refrescar</button>
              <div id="worldEventsFeed" style="max-height: 400px; overflow-y: auto; font-size: 11px;">
                <p style="text-align: center; color: var(--gray-text); padding: var(--space-lg);">‚è≥ Cargando eventos...</p>
              </div>
            </div>

            <!-- Misiones Din√°micas & Feed Mundo -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg); margin-bottom: var(--space-lg); display: none;">
              
              <!-- Misiones Din√°micas -->
              <div class="card">
                <h3 style="color: var(--orange-warn); margin-bottom: var(--space-sm);">
                  ‚ö° MISIONES DIN√ÅMICAS <span id="questCountBadge" style="font-size: 12px; color: var(--green-safe);"></span>
                </h3>
                <p style="color: var(--gray-text); font-size: 12px; margin-bottom: var(--space-md);">
                  Misiones generadas por eventos del mundo
                </p>
                <button onclick="refreshQuests()" style="padding: 8px 16px; margin-bottom: var(--space-sm);">üîÑ Refrescar</button>
                <div id="questsList" style="max-height: 400px; overflow-y: auto; font-size: 12px;">
                  <p style="text-align: center; color: var(--gray-text); padding: var(--space-lg);">‚è≥ Cargando misiones...</p>
                </div>
              </div>

              <!-- Feed del Mundo -->
              <div class="card">
                <h3 style="color: var(--blue-info); margin-bottom: var(--space-sm);">üì∞ FEED DEL MUNDO</h3>
                <p style="color: var(--gray-text); font-size: 12px; margin-bottom: var(--space-md);">
                  Los NPCs viven sus propias vidas...
                </p>
                <button onclick="refreshWorldEvents()" style="padding: 8px 16px; margin-bottom: var(--space-sm);">üîÑ Refrescar</button>
                <div id="worldEventsFeed" style="max-height: 400px; overflow-y: auto; font-size: 11px;">
                  <p style="text-align: center; color: var(--gray-text); padding: var(--space-lg);">‚è≥ Cargando eventos...</p>
                </div>
              </div>
            </div>

            <!-- Relaciones & Estado del Mundo -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg); margin-bottom: var(--space-lg);">
              
              <!-- Relaciones Dram√°ticas -->
              <div class="card">
                <h3 style="color: var(--purple-rare); margin-bottom: var(--space-sm);">üíï RELACIONES DRAM√ÅTICAS</h3>
                <p style="color: var(--gray-text); font-size: 12px; margin-bottom: var(--space-md);">
                  Amores, odios, rivalidades entre NPCs
                </p>
                <div id="intenseRelationships" style="max-height: 300px; overflow-y: auto; font-size: 12px;">
                  <p style="color: var(--gray-text);">Sin relaciones dram√°ticas...</p>
                </div>
              </div>

              <!-- Estado del Mundo -->
              <div class="card">
                <h3 style="color: var(--green-medium); margin-bottom: var(--space-sm);">üåç ESTADO DEL MUNDO</h3>
                <div id="worldStats" style="font-size: 12px; line-height: 1.8;">
                  <p style="color: var(--gray-text);">Cargando estad√≠sticas...</p>
                </div>
              </div>
            </div>

            <!-- Acciones Aut√≥nomas NPCs -->
            <div class="card">
              <h3 style="color: var(--yellow-legend); margin-bottom: var(--space-sm);">ü§ñ ACCIONES AUT√ìNOMAS DE NPCs</h3>
              <p style="color: var(--gray-text); font-size: 12px; margin-bottom: var(--space-md);">
                Los NPCs toman decisiones por s√≠ mismos basadas en su personalidad, relaciones y memoria
              </p>
              <div id="npcActionsLog" style="max-height: 350px; overflow-y: auto; font-size: 12px; padding: var(--space-sm); background: var(--gray-bg); border-radius: 4px;">
                <p style="text-align: center; color: var(--gray-text);">Sin acciones registradas...</p>
              </div>
            </div>

          </div>
        </div>

        <!-- PESTA√ëA PROGRESI√ìN -->
        <div id="tab-progression" class="tab-content">
          <div style="grid-column: 1 / -1; max-width: 1200px; margin: 0 auto; padding: var(--space-lg);">
            
            <!-- Logros & Skills -->
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-lg); margin-bottom: var(--space-lg);">
              
              <!-- Logros -->
              <div class="card">
                <h3 style="color: var(--yellow-legend); margin-bottom: var(--space-sm);">
                  üèÜ LOGROS <span id="achievementCount" style="font-size: 13px; color: var(--orange-warn);"></span>
                </h3>
                <div id="achievements" style="font-size: 12px; max-height: 400px; overflow-y: auto;">
                  <em style="color: var(--gray-text);">Sin logros desbloqueados</em>
                </div>
              </div>

              <!-- Stats & Skills -->
              <div class="card">
                <h3 style="color: var(--blue-info); margin-bottom: var(--space-sm);">üìä ESTAD√çSTICAS</h3>
                <div id="playerStats2" style="font-size: 13px; line-height: 1.8; margin-bottom: var(--space-md);">
                  <div>üßü Zombies: 0</div>
                  <div>üî® Crafteos: 0</div>
                  <div>üó∫Ô∏è Locaciones: 1</div>
                  <div>üì¶ Recursos: 0</div>
                </div>

                <h3 style="color: var(--green-safe); margin-bottom: var(--space-sm);">üìà SKILLS</h3>
                <div id="skills" style="font-size: 12px;"></div>
              </div>
            </div>

            <!-- Mascotas & Facciones -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg); margin-bottom: var(--space-lg);">
              
              <!-- Mascotas -->
              <div class="card">
                <h3 style="color: var(--purple-rare); margin-bottom: var(--space-sm);">üêæ MASCOTA</h3>
                <div id="petPanel" style="font-size: 12px;">
                  <p style="color: var(--gray-text); margin-bottom: var(--space-md);">No tienes mascota</p>
                  <div style="display: grid; gap: var(--space-xs);">
                    <button onclick="adoptPet('perro')" style="width: 100%; padding: 10px; font-size: 12px;">üêï Adoptar Perro</button>
                    <button onclick="adoptPet('lobo')" style="width: 100%; padding: 10px; font-size: 12px;">üê∫ Adoptar Lobo</button>
                    <button onclick="adoptPet('cuervo')" style="width: 100%; padding: 10px; font-size: 12px;">ü¶Ö Adoptar Cuervo</button>
                  </div>
                </div>

                <h3 style="color: var(--orange-warn); margin: var(--space-md) 0 var(--space-sm) 0;">‚ö° HABILIDADES ESPECIALES</h3>
                <div id="abilitiesPanel" style="font-size: 12px;">
                  <em style="color: var(--gray-text);">Desbloquea con tu clase</em>
                </div>
              </div>

              <!-- Facciones -->
              <div class="card">
                <h3 style="color: var(--red-danger); margin-bottom: var(--space-sm);">
                  ‚öîÔ∏è FACCI√ìN <span id="factionRank" style="font-size: 13px; color: var(--orange-warn);"></span>
                </h3>
                <div id="factionPanel">
                  <p style="color: var(--gray-text); font-size: 12px; margin-bottom: var(--space-md);">√önete a una facci√≥n para recompensas</p>
                  <div style="display: grid; gap: var(--space-xs);">
                    <button onclick="joinFaction('refugio')" style="width: 100%; padding: 10px; font-size: 12px;">üè† Los Refugiados</button>
                    <button onclick="joinFaction('nomadas')" style="width: 100%; padding: 10px; font-size: 12px;">üö∂ N√≥madas</button>
                    <button onclick="joinFaction('cientificos')" style="width: 100%; padding: 10px; font-size: 12px;">üî¨ Cient√≠ficos</button>
                    <button onclick="joinFaction('saqueadores')" style="width: 100%; padding: 10px; font-size: 12px;">üíÄ Saqueadores</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Veh√≠culos & PvP -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg); margin-bottom: var(--space-lg);">
              
              <!-- Veh√≠culos -->
              <div class="card">
                <h3 style="color: var(--blue-info); margin-bottom: var(--space-sm);">üöó VEH√çCULOS</h3>
                <p style="color: var(--gray-text); font-size: 12px; margin-bottom: var(--space-md);">
                  Mu√©vete m√°s r√°pido y con m√°s seguridad
                </p>
                <div id="vehiclePanel">
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-sm);">
                    <button onclick="craftVehicle('bicicleta')" style="padding: 10px; font-size: 11px;">üö≤ Bicicleta<br><small>(10 mat, 5 arm)</small></button>
                    <button onclick="craftVehicle('moto')" style="padding: 10px; font-size: 11px;">üèçÔ∏è Moto<br><small>(30 mat, 20 arm)</small></button>
                    <button onclick="craftVehicle('auto')" style="padding: 10px; font-size: 11px;">üöó Auto<br><small>(50 mat, 30 arm)</small></button>
                    <button onclick="craftVehicle('blindado')" style="padding: 10px; font-size: 11px;">üöê Blindado<br><small>(100 mat, 60 arm)</small></button>
                  </div>
                </div>
              </div>

              <!-- Arena PvP -->
              <div class="card">
                <h3 style="color: var(--red-danger); margin-bottom: var(--space-sm);">
                  ‚öîÔ∏è ARENA PvP <span id="pvpQueue" style="font-size: 12px;"></span>
                </h3>
                <div id="pvpPanel">
                  <p style="color: var(--gray-text); font-size: 12px; margin-bottom: var(--space-md);">
                    Combate PvP (Requiere 50+ salud)
                  </p>
                  <button onclick="enterPvPArena()" style="padding: 12px 24px; font-size: 14px; width: 100%;">üõ°Ô∏è Entrar a Arena</button>
                  
                  <div id="pvpMatch" style="margin-top: var(--space-md); display: none; background: var(--gray-darker); padding: var(--space-md); border-radius: 4px;">
                    <h4 id="pvpMatchTitle" style="margin-bottom: var(--space-sm);">COMBATE EN CURSO</h4>
                    <div style="display: flex; justify-content: space-between; gap: var(--space-md); margin: var(--space-md) 0;">
                      <div style="flex: 1;">
                        <h5 id="pvpPlayer1" style="margin-bottom: var(--space-xs);">Jugador 1</h5>
                        <div class="stat-bar" style="width: 100%; height: 20px;">
                          <div id="pvpPlayer1HP" class="stat-fill salud" style="width: 100%;"></div>
                        </div>
                      </div>
                      <div style="align-self: center; font-size: 24px;">‚öîÔ∏è</div>
                      <div style="flex: 1; text-align: right;">
                        <h5 id="pvpPlayer2" style="margin-bottom: var(--space-xs);">Jugador 2</h5>
                        <div class="stat-bar" style="width: 100%; height: 20px;">
                          <div id="pvpPlayer2HP" class="stat-fill salud" style="width: 100%;"></div>
                        </div>
                      </div>
                    </div>
                    <button id="pvpAttackBtn" onclick="attackInPvP()" style="width: 100%; padding: 12px; font-size: 16px; background: var(--red-danger);">‚öîÔ∏è ATACAR</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Leaderboard -->
            <div class="card">
              <h3 style="color: var(--yellow-legend); margin-bottom: var(--space-sm);">üèÜ TABLA DE L√çDERES</h3>
              <div class="craft-tabs" style="margin-bottom: var(--space-md);">
                <button class="craft-tab active" onclick="switchLeaderboard('zombies')">üßü ZOMBIES</button>
                <button class="craft-tab" onclick="switchLeaderboard('nivel')">üìä NIVEL</button>
                <button class="craft-tab" onclick="switchLeaderboard('dias')">üìÖ D√çAS</button>
                <button class="craft-tab" onclick="switchLeaderboard('prestigio')">üëë PRESTIGIO</button>
              </div>
              <div id="leaderboardContent" style="font-size: 12px; max-height: 350px; overflow-y: auto;">
                <em style="color: var(--gray-text);">Cargando rankings...</em>
              </div>
            </div>

          </div>
        </div>


      </div>
      
      </div> <!-- fin central-content -->
      
      <!-- üìú SIDEBAR DERECHA - LOGS PERSISTENTES -->
      <div id="right-sidebar-logs">
        <div class="logs-header">üìú LOGS PERSISTENTES</div>
        
        <!-- Log Personal -->
        <div class="log-section" id="personal-log-section">
          <h4>üü¢ LOG PERSONAL</h4>
          <div id="personalLogEntries">
            <div class="log-entry">
              <span class="timestamp">[00:00:00]</span>
              <span>Bienvenido a Z-Survival</span>
            </div>
          </div>
        </div>
        
        <!-- Log del Mundo -->
        <div class="log-section" id="world-log-section">
          <h4>üåç LOG DEL MUNDO</h4>
          <div id="worldLogEntries">
            <div class="log-entry system">
              <span class="timestamp">[00:00:00]</span>
              <span>Servidor inicializado</span>
            </div>
          </div>
        </div>
        
        <!-- Filtros -->
        <div class="log-filters">
          <label class="log-filter-label">
            <input type="checkbox" id="filter-combat" checked onchange="filterLogs()">
            <span>‚öîÔ∏è Combate</span>
          </label>
          <label class="log-filter-label">
            <input type="checkbox" id="filter-social" checked onchange="filterLogs()">
            <span>üí¨ Social</span>
          </label>
          <label class="log-filter-label">
            <input type="checkbox" id="filter-system" onchange="filterLogs()">
            <span>‚öôÔ∏è Sistema</span>
          </label>
        </div>
      </div>
      
    </div> <!-- fin main-layout -->

    </div> <!-- fin gameScreen -->
  
  <!-- Modal de perfil de jugador -->
  <div id="profileBackdrop" class="profile-backdrop" style="display: none;" onclick="closeProfile()"></div>
  <div id="profileModal" class="profile-modal" style="display: none;">
    <div style="text-align: right; margin-bottom: 10px;">
      <button onclick="closeProfile()" style="padding: 5px 10px; background: #aa0000;">‚úñ Cerrar</button>
    </div>
    <div id="profileContent"></div>
  </div>

  <!-- Modal personalizado gen√©rico -->
  <div id="custom-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);">
    <div style="background-color: #2a2a2a; margin: 5% auto; padding: 20px; border: 2px solid #ffaa00; border-radius: 10px; width: 80%; max-width: 600px; color: white;">
      <div style="text-align: right; margin-bottom: 10px;">
        <button onclick="closeModal()" style="padding: 5px 10px; background: #aa0000; color: white; border: none; cursor: pointer; border-radius: 5px;">‚úñ Cerrar</button>
      </div>
      <div id="modal-content" style="text-align: left;"></div>
    </div>
  </div>
  
  <button id="soundToggle" onclick="toggleSound()" title="Activar/Desactivar sonidos">üîá</button>

  <script>
    let ws = null;
    let player = null;
    let world = null;
    let worldLogMessages = []; // Log de eventos del mundo
    let personalLogMessages = []; // Log personal del jugador
    let pingInterval = null;
    let reconnectTimeout = null;
    let activeDialogue = null; // Di√°logo activo con NPC
    let dialogueHistory = []; // Historial de conversaci√≥n
    let soundEnabled = false; // Sonido desactivado por defecto
    let audioContext = null;
    let directMessages = {}; // Almacenar DMs por jugador {playerId: [{from, to, message, timestamp}]}
    let tabsLoaded = {}; // Lazy loading de pesta√±as
    let maxLogEntries = 50; // M√°ximo de entradas en logs
    
    // ====================================
    // ÔøΩ FUNCIONES DE LOGIN (Deben estar al inicio para onclick)
    // ====================================
    
    async function createPlayer() {
      const nombre = document.getElementById('playerName').value.trim();
      
      if (!nombre || nombre.length < 3) {
        alert('Nombre muy corto (m√≠nimo 3 caracteres)');
        return;
      }
      
      try {
        const response = await fetch('/api/player/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nombre })
        });
        
        const data = await response.json();
        
        if (data.success) {
          player = data.player;
          
          // ‚úÖ GUARDAR playerId en localStorage para persistencia
          localStorage.setItem('playerId', player.id);
          console.log('‚úÖ Jugador guardado:', player.id);
          
          showGameScreen();
          
          // Inicializar historia destacada con mensaje inicial
          setTimeout(() => {
            if (world && player && typeof updateFeaturedStory === 'function') {
              updateFeaturedStory();
            }
          }, 1000);
          
          connectWebSocket();
        } else {
          alert(data.error || 'Error al crear jugador');
        }
      } catch (error) {
        console.error('Error al crear jugador:', error);
        alert('Error de conexi√≥n. ¬øEst√° el servidor activo?');
      }
    }
    
    function resetPlayerData() {
      if (!confirm('‚ö†Ô∏è Esto eliminar√° tu cuenta actual y tendr√°s que crear una nueva. ¬øContinuar?')) {
        return;
      }
      
      // Limpiar localStorage
      localStorage.removeItem('playerId');
      console.log('üóëÔ∏è Datos del jugador eliminados');
      
      // Recargar p√°gina
      window.location.reload();
    }
    
    // ====================================
    // ÔøΩüÜï FUNCIONES DE NUEVO LAYOUT
    // ====================================
    
    // Actualizar barra superior persistente
    function updatePersistentHeader() {
      if (!player) return;
      
      const hp = player.salud || 0;
      const maxHp = player.saludMax || 100;
      const hunger = player.hambre || 0;
      const stamina = player.stamina || 100;
      const location = player.locacion || 'Desconocido';
      const threats = world?.locations?.[location]?.zombies || 0;
      
      // Actualizar textos (verificar que existan)
      const hpText = document.getElementById('header-hp-text');
      const hungerText = document.getElementById('header-hunger-text');
      const staminaText = document.getElementById('header-stamina-text');
      const locationText = document.getElementById('header-location-text');
      const threatsText = document.getElementById('header-threats-text');
      const timeText = document.getElementById('header-time-text');
      
      if (hpText) hpText.textContent = `HP: ${hp}/${maxHp}`;
      if (hungerText) hungerText.textContent = `Hambre: ${hunger}`;
      if (staminaText) staminaText.textContent = `Stamina: ${stamina}`;
      if (locationText) locationText.textContent = location;
      if (threatsText) threatsText.textContent = `x${threats}`;
      
      //Format time (day/night cycle simulation)
      if (timeText) {
        const gameTime = Date.now();
        const hour = Math.floor((gameTime / 1000 / 60) % 24);
        const minute = Math.floor((gameTime / 1000) % 60);
        const timeIcon = (hour >= 6 && hour < 18) ? '‚òÄÔ∏è' : 'üåô';
        timeText.textContent = `${timeIcon} ${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
      }
      
      // Marcar como cr√≠tico si HP bajo
      const hpStat = document.getElementById('header-hp');
      if (hpStat) {
        if (hp < maxHp * 0.3) {
          hpStat.classList.add('critical');
        } else {
          hpStat.classList.remove('critical');
        }
      }
    }
    
    // Actualizar sidebar izquierda
    function updateLeftSidebar() {
      if (!player) return;
      
      // Avatar y nombre
      const playerName = document.getElementById('player-name-main');
      const playerLevel = document.getElementById('player-level-display');
      if (playerName) playerName.textContent = player.nombre || 'Jugador';
      if (playerLevel) playerLevel.textContent = `Nivel ${player.nivel || 1}`;
      
      // Barras de stats
      const hp = player.salud || 0;
      const maxHp = player.saludMax || 100;
      const hunger = player.hambre || 0;
      const stamina = player.stamina || 100;
      
      const hpValue = document.getElementById('hp-value');
      const hpBar = document.getElementById('hp-bar');
      const hungerValue = document.getElementById('hunger-value');
      const hungerBar = document.getElementById('hunger-bar');
      const staminaValue = document.getElementById('stamina-value');
      const staminaBar = document.getElementById('stamina-bar');
      
      if (hpValue) hpValue.textContent = `${hp}/${maxHp}`;
      if (hpBar) hpBar.style.width = `${(hp / maxHp) * 100}%`;
      if (hungerValue) hungerValue.textContent = `${hunger}/100`;
      if (hungerBar) hungerBar.style.width = `${hunger}%`;
      if (staminaValue) staminaValue.textContent = `${stamina}/100`;
      if (staminaBar) staminaBar.style.width = `${stamina}%`;
      
      // Inventario r√°pido
      const inv = player.inventario || {};
      const quickFood = document.getElementById('quick-food');
      const quickMeds = document.getElementById('quick-meds');
      const quickMats = document.getElementById('quick-mats');
      const quickWeapons = document.getElementById('quick-weapons');
      
      if (quickFood) quickFood.textContent = inv.comida || 0;
      if (quickMeds) quickMeds.textContent = inv.medicinas || 0;
      if (quickMats) quickMats.textContent = inv.materiales || 0;
      if (quickWeapons) quickWeapons.textContent = inv.armas || 0;
      
      // Refugio r√°pido
      if (world?.locations?.refugio) {
        const quickDefense = document.getElementById('quick-defense');
        const quickNpcs = document.getElementById('quick-npcs');
        if (quickDefense) quickDefense.textContent = world.locations.refugio.defensas || 0;
        if (quickNpcs) quickNpcs.textContent = Object.keys(world.npcs || {}).length;
      }
      
      const quickSublocation = document.getElementById('quick-sublocation');
      if (quickSublocation) quickSublocation.textContent = player.currentSubLocation || 'Plaza';
    }
    
    // Toggle secciones colapsables
    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        const isHidden = section.style.display === 'none' || !section.style.display;
        section.style.display = isHidden ? 'block' : 'none';
      }
    }
    
    // Acciones r√°pidas
    function quickAction(action) {
      switch(action) {
        case 'buscar':
          // Llamar a funci√≥n de scavenge existente
          if (typeof scavenge === 'function') scavenge();
          break;
        case 'atacar':
          // Iniciar combate cuerpo a cuerpo
          if (typeof attack === 'function') attack('melee');
          break;
        case 'comer':
          addToPersonalLog('‚ö†Ô∏è Funci√≥n de comer en desarrollo');
          break;
        case 'dormir':
          addToPersonalLog('‚ö†Ô∏è Funci√≥n de dormir en desarrollo');
          break;
        case 'craftear':
          switchTab('main'); // Ir a tab principal donde est√° crafteo
          break;
        case 'socializar':
          switchTab('social');
          break;
        case 'viajar':
          switchTab('mundo');
          break;
      }
    }
    
    // A√±adir entrada al log personal
    function addToPersonalLog(message, type = 'normal') {
      const timestamp = new Date().toLocaleTimeString('es-ES');
      const entry = { timestamp, message, type };
      personalLogMessages.push(entry);
      
      // Limitar tama√±o del log
      if (personalLogMessages.length > maxLogEntries) {
        personalLogMessages.shift();
      }
      
      renderPersonalLog();
    }
    
    // A√±adir entrada al log del mundo
    function addToWorldLog(message, type = 'normal') {
      const timestamp = new Date().toLocaleTimeString('es-ES');
      const entry = { timestamp, message, type };
      worldLogMessages.push(entry);
      
      // Limitar tama√±o del log
      if (worldLogMessages.length > maxLogEntries) {
        worldLogMessages.shift();
      }
      
      renderWorldLog();
    }
    
    // Renderizar log personal
    function renderPersonalLog() {
      const container = document.getElementById('personalLogEntries');
      if (!container) return;
      
      const filters = {
        combat: document.getElementById('filter-combat')?.checked ?? true,
        social: document.getElementById('filter-social')?.checked ?? true,
        system: document.getElementById('filter-system')?.checked ?? true
      };
      
      const filtered = personalLogMessages.filter(entry => {
        if (entry.type === 'combat' && !filters.combat) return false;
        if (entry.type === 'social' && !filters.social) return false;
        if (entry.type === 'system' && !filters.system) return false;
        return true;
      });
      
      container.innerHTML = filtered.map(entry => `
        <div class="log-entry ${entry.type}">
          <span class="timestamp">[${entry.timestamp}]</span>
          <span>${entry.message}</span>
        </div>
      `).join('');
      
      // Auto-scroll al final
      const section = document.getElementById('personal-log-section');
      if (section) section.scrollTop = section.scrollHeight;
    }
    
    // Renderizar log del mundo
    function renderWorldLog() {
      const container = document.getElementById('worldLogEntries');
      if (!container) return;
      
      const filters = {
        combat: document.getElementById('filter-combat')?.checked ?? true,
        social: document.getElementById('filter-social')?.checked ?? true,
        system: document.getElementById('filter-system')?.checked ?? true
      };
      
      const filtered = worldLogMessages.filter(entry => {
        if (entry.type === 'combat' && !filters.combat) return false;
        if (entry.type === 'social' && !filters.social) return false;
        if (entry.type === 'system' && !filters.system) return false;
        return true;
      });
      
      container.innerHTML = filtered.map(entry => `
        <div class="log-entry ${entry.type}">
          <span class="timestamp">[${entry.timestamp}]</span>
          <span>${entry.message}</span>
        </div>
      `).join('');
      
      // Auto-scroll al final
      const section = document.getElementById('world-log-section');
      if (section) section.scrollTop = section.scrollHeight;
    }
    
    // Filtrar logs seg√∫n checkboxes
    function filterLogs() {
      renderPersonalLog();
      renderWorldLog();
    }
    
    // Activar header al mostrar gameScreen
    function showGameScreen() {
      try {
        document.getElementById('login').style.display = 'none';
        document.getElementById('gameScreen').style.display = 'flex';
        
        // Esperar a que el DOM est√© listo antes de activar header
        setTimeout(() => {
          try {
            const header = document.getElementById('persistent-header');
            if (header) header.classList.add('active');
            
            // Inicializar logs solo si los contenedores existen
            const personalLogContainer = document.getElementById('personalLogEntries');
            const worldLogContainer = document.getElementById('worldLogEntries');
            
            if (personalLogContainer && worldLogContainer) {
              addToPersonalLog('‚ú® Bienvenido al apocalipsis zombie', 'system');
              addToWorldLog('üåç Servidor activo y funcionando', 'system');
            }
            
            // Primera actualizaci√≥n (solo si player est√° cargado)
            if (player && player.nombre) {
              updatePersistentHeader();
              updateLeftSidebar();
            }
          } catch (err) {
            console.error('Error al inicializar header/logs:', err);
          }
        }, 100);
        
        // Actualizar cada 5 segundos
        setInterval(() => {
          try {
            if (player && player.nombre && world) {
              updatePersistentHeader();
              updateLeftSidebar();
            }
          } catch (err) {
            console.error('Error al actualizar UI:', err);
          }
        }, 5000);
        
        // üé≠ Iniciar motor de movimiento de NPCs
        startNPCMovementEngine();
        
      } catch (err) {
        console.error('Error al mostrar gameScreen:', err);
        // Fallback: al menos mostrar el juego sin nuevo layout
        document.getElementById('login').style.display = 'none';
        document.getElementById('gameScreen').style.display = 'block';
      }
    }
    let unreadDMs = 0; // Contador de DMs no le√≠dos
    let currentDMTarget = null; // Jugador actual en vista de DM
    let allPlayers = {}; // Cach√© de todos jugadores online
    let currentLeaderboard = 'zombies'; // Leaderboard actual
    let pendingActions = new Set(); // Prevenir acciones duplicadas
    let renderCache = {}; // Cach√© de renders para evitar actualizaciones innecesarias
    let connections = new Map(); // Simulaci√≥n de conexiones para contar jugadores
    let worldEvents = []; // Cach√© de eventos del mundo
    let intenseRelationships = []; // Cach√© de relaciones intensas
    let worldStats = null; // Cach√© de estad√≠sticas del mundo
    let gameStartTime = Date.now(); // Tiempo de inicio de la sesi√≥n
    let totalPlayTime = 0; // Tiempo total jugado en milisegundos
    let attackCooldown = 0; // Timestamp cuando se puede atacar nuevamente
    let cooldownInterval = null; // Intervalo para actualizar UI de cooldown
    let messageQueue = []; // Cola de mensajes cuando est√° desconectado
    
    // üé≠ SISTEMA DE NPCs ANIMADOS
    let npcMovementInterval = null;
    let npcAnimationFrame = 0;

    // Helper para hash simple de objetos
    function simpleHash(obj) {
      return JSON.stringify(obj);
    }
    
    // ==================================== 
    // MOTOR DE MOVIMIENTO DE NPCs
    // ====================================
    function startNPCMovementEngine() {
      if (npcMovementInterval) return; // Ya est√° corriendo
      
      // Actualizar cada 3 segundos
      npcMovementInterval = setInterval(() => {
        if (!world || !world.npcs) return;
        
        npcAnimationFrame++;
        
        // Mover NPCs aleatoriamente entre ubicaciones cercanas
        Object.values(world.npcs).forEach(npc => {
          // Solo mover algunos NPCs (no todos al mismo tiempo)
          if (Math.random() > 0.3) return;
          
          // Solo mover NPCs que no est√©n en misiones cr√≠ticas
          if (npc.enMision) return;
          
          // Definir ubicaciones seg√∫n el rol del NPC
          let posiblesLugares = [];
          
          switch(npc.rol) {
            case 'agricultor':
              posiblesLugares = ['granja', 'plaza', 'almacen'];
              break;
            case 'guardia':
              posiblesLugares = ['torre', 'puerta', 'plaza', 'muralla'];
              break;
            case 'comerciante':
              posiblesLugares = ['taberna', 'plaza', 'almacen'];
              break;
            case 'medico':
              posiblesLugares = ['hospital', 'plaza'];
              break;
            case 'ingeniero':
              posiblesLugares = ['taller', 'torre', 'plaza'];
              break;
            default:
              posiblesLugares = ['plaza', 'viviendas', 'taberna'];
          }
          
          // Elegir una ubicaci√≥n aleatoria
          const nuevaUbicacion = posiblesLugares[Math.floor(Math.random() * posiblesLugares.length)];
          
          // Solo mover si la ubicaci√≥n existe y es diferente
          if (world.locations[nuevaUbicacion] && npc.ubicacion !== nuevaUbicacion) {
            npc.ubicacion = nuevaUbicacion;
          }
        });
        
        // Re-renderizar el mapa para mostrar nuevas posiciones
        render2DWorldMap();
        
      }, 3000); // Cada 3 segundos
    }
    
    function stopNPCMovementEngine() {
      if (npcMovementInterval) {
        clearInterval(npcMovementInterval);
        npcMovementInterval = null;
      }
    }

    // Render con cach√© - solo actualiza si cambi√≥ el contenido
    function cachedRender(key, renderFn, dependencies) {
      const hash = simpleHash(dependencies);
      if (renderCache[key] !== hash) {
        try {
          renderFn();
          renderCache[key] = hash;
        } catch (error) {
          console.warn(`‚ö†Ô∏è Error en render cached '${key}':`, error.message);
        }
      }
    }

    // Helper para fetch con manejo de errores robusto
    async function safeFetch(url, options = {}) {
      try {
        const response = await fetch(url, options);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.success && data.error) {
          log(`‚ùå ${data.error}`, 'warning');
          playSound('error');
          return { success: false, error: data.error };
        }
        
        return data;
      } catch (error) {
        console.error('Error en fetch:', error);
        log(`‚ùå Error de conexi√≥n: ${error.message}`, 'warning');
        playSound('error');
        return { success: false, error: error.message };
      }
    }

    // Al cargar, verificar si hay un personaje seleccionado
    window.addEventListener('DOMContentLoaded', () => {
      const playerId = localStorage.getItem('playerId');
      
      if (!playerId) {
        // Sin personaje, redirigir al login
        window.location.href = '/index.html';
        return;
      }
      
      // Tenemos playerId, ocultar login y mostrar juego
      player = { id: playerId };
      showGameScreen();
      connectWebSocket();
    });

    function log(message, type = '') {
      // Determinar √≠cono seg√∫n tipo
      let icon = '‚ÑπÔ∏è';
      if (type === 'success') icon = '‚úÖ';
      else if (type === 'warning') icon = '‚ö†Ô∏è';
      else if (type === 'combat') icon = '‚öîÔ∏è';
      else if (type === 'death') icon = 'üíÄ';
      
      // Reproducir sonido
      if (type === 'success') playSound('success');
      else if (type === 'warning') playSound('warning');
      else if (type === 'combat') playSound('combat');
      else if (type === 'death') playSound('death');
      
      // üÜï DISTRIBUIR ENTRE LOGS PERSONALES Y DEL MUNDO
      const formattedMessage = `${icon} ${message}`;
      
      // Mensajes personales (acciones del jugador)
      if (type === 'combat' || type === 'death' || type === 'warning' || type === 'success') {
        addToPersonalLog(formattedMessage, type || 'normal');
      }
      
      // Mensajes del mundo (eventos globales, NPCs, otros jugadores)
      // Para mantener compatibilidad, tambi√©n agregar algunos al world log
      if (type === 'combat' || type === 'death') {
        addToWorldLog(formattedMessage, type);
      } else if (!type || type === 'system') {
        addToWorldLog(formattedMessage, 'system');
      }
      
      // Log principal (mantener para compatibilidad con c√≥digo antiguo)
      const logDiv = document.getElementById('log');
      if (logDiv) {
        const entry = document.createElement('div');
        entry.className = `log-entry log-${type}`;
        entry.textContent = `${icon} [${new Date().toLocaleTimeString()}] ${message}`;
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
        
        // Limitar a 50 entradas
        while (logDiv.children.length > 50) {
          logDiv.removeChild(logDiv.firstChild);
        }
      }
      
      // Tambi√©n agregar al log2 (mantener para compatibilidad)
      const logDiv2 = document.getElementById('log2');
      if (logDiv2) {
        const entry2 = document.createElement('div');
        entry2.className = `log-entry log-${type}`;
        entry2.textContent = `${icon} [${new Date().toLocaleTimeString()}] ${message}`;
        logDiv2.appendChild(entry2);
        logDiv2.scrollTop = logDiv2.scrollHeight;
        
        while (logDiv2.children.length > 50) {
          logDiv2.removeChild(logDiv2.firstChild);
        }
      }
    }
    
    // Funci√≥n auxiliar para enviar mensajes de forma segura
    function safeSend(data, options = {}) {
      const { queueIfDisconnected = true, showWarning = true } = options;
      
      // Si el WebSocket est√° conectado, enviar inmediatamente
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(data));
        return true;
      }
      
      // Si est√° desconectado y se permite encolar
      if (queueIfDisconnected) {
        messageQueue.push(data);
        if (showWarning) {
          log('Mensaje encolado. Se enviar√° al reconectar...', 'warning');
        }
        return false;
      }
      
      // No se pudo enviar y no se permite encolar
      if (showWarning) {
        log('No conectado al servidor', 'warning');
      }
      return false;
    }
    
    // Procesar cola de mensajes pendientes
    function processMessageQueue() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      
      while (messageQueue.length > 0) {
        const data = messageQueue.shift();
        try {
          ws.send(JSON.stringify(data));
          console.log('Mensaje de cola enviado:', data.type);
        } catch (error) {
          console.error('Error enviando mensaje de cola:', error);
          messageQueue.unshift(data); // Volver a poner en la cola
          break;
        }
      }
    }
    
    function worldLog(message, category = '') {
      // √çconos por categor√≠a
      const icons = {
        player: 'üßç',
        zombie: 'üßü',
        npc: 'üë§',
        event: 'üé≠',
        horde: 'üö®',
        trade: 'üí±',
        faction: '‚öîÔ∏è',
        pet: 'üêæ',
        vehicle: 'üöó',
        pvp: '‚öîÔ∏è',
        special: '‚≠ê'
      };
      const icon = icons[category] || 'üåç';
      
      // üÜï MAPEAR A NUEVO SISTEMA DE TIPOS
      let logType = 'system';
      if (category === 'zombie' || category === 'horde' || category === 'pvp' || category === 'faction') {
        logType = 'combat';
      } else if (category === 'player' || category === 'npc' || category === 'trade') {
        logType = 'social';
      }
      
      // üÜï USAR NUEVO SISTEMA DE LOG DEL MUNDO
      addToWorldLog(`${icon} ${message}`, logType);
      
      // Mantener compatibilidad con log antiguo
      const logDiv = document.getElementById('worldLog');
      if (logDiv) {
        const entry = document.createElement('div');
        entry.className = `log-entry log-${category}`;
        entry.textContent = `${icon} [${new Date().toLocaleTimeString()}] ${message}`;
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
        
        // Mantener solo √∫ltimos 20 mensajes
        while (logDiv.children.length > 20) {
          logDiv.removeChild(logDiv.firstChild);
        }
      }
    }

    // ====================================
    // SISTEMA DE SONIDO
    // ====================================
    function toggleSound() {
      soundEnabled = !soundEnabled;
      const btn = document.getElementById('soundToggle');
      btn.textContent = soundEnabled ? 'üîä' : 'üîá';
      btn.title = soundEnabled ? 'Desactivar sonidos' : 'Activar sonidos';
      
      if (soundEnabled && !audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      
      if (soundEnabled) {
        playSound('success');
        startAmbientMusic();
      } else {
        stopAmbientMusic();
      }
    }
    
    // Sistema de audio para sonidos reales
    const audioFiles = {};
    let audioVolume = 0.95;
    
    // üéµ M√∫sica de fondo ambiente
    let ambientMusic = null;
    let ambientGain = null;

    function loadAudioFile(name, path) {
      const audio = new Audio(path);
      audio.volume = audioVolume;
      audioFiles[name] = audio;
    }

    // Cargar archivos de sonido
    loadAudioFile('npc_saludo', '/sounds/SaludoinicialNpcMale.m4a');
    loadAudioFile('npc_charla', '/sounds/CharlamediaNpcMale.m4a');
    loadAudioFile('npc_despedida', '/sounds/DespedidaNpcMale.m4a');
    loadAudioFile('ataque_melee', '/sounds/AtacoMele.m4a');
    loadAudioFile('recibo_dano', '/sounds/ReciboDa√±o.m4a');
    
    // Iniciar m√∫sica ambiente 8-bit tranquila
    function startAmbientMusic() {
      if (!soundEnabled || !audioContext || ambientMusic) return;
      
      ambientGain = audioContext.createGain();
      ambientGain.gain.value = 0.05; // Muy suave
      ambientGain.connect(audioContext.destination);
      
      // Secuencia de notas estilo 8-bit (C mayor relajante)
      const notes = [
        { freq: 261.63, duration: 0.4 }, // C
        { freq: 329.63, duration: 0.4 }, // E
        { freq: 392.00, duration: 0.4 }, // G
        { freq: 523.25, duration: 0.4 }, // C alto
        { freq: 392.00, duration: 0.4 }, // G
        { freq: 329.63, duration: 0.4 }, // E
        { freq: 293.66, duration: 0.4 }, // D
        { freq: 261.63, duration: 0.8 }  // C (m√°s larga)
      ];
      
      let noteIndex = 0;
      let currentOsc = null;
      
      function playNextNote() {
        if (!ambientMusic) return;
        
        const note = notes[noteIndex];
        
        // Crear nuevo oscilador para cada nota
        currentOsc = audioContext.createOscillator();
        currentOsc.type = 'square'; // Sonido 8-bit
        currentOsc.frequency.value = note.freq;
        
        const noteGain = audioContext.createGain();
        noteGain.gain.setValueAtTime(0, audioContext.currentTime);
        noteGain.gain.linearRampToValueAtTime(1, audioContext.currentTime + 0.02); // Attack
        noteGain.gain.setValueAtTime(1, audioContext.currentTime + note.duration - 0.05);
        noteGain.gain.linearRampToValueAtTime(0, audioContext.currentTime + note.duration); // Release
        
        currentOsc.connect(noteGain);
        noteGain.connect(ambientGain);
        
        currentOsc.start(audioContext.currentTime);
        currentOsc.stop(audioContext.currentTime + note.duration);
        
        noteIndex = (noteIndex + 1) % notes.length;
        setTimeout(playNextNote, note.duration * 1000);
      }
      
      playNextNote();
      ambientMusic = { playing: true };
    }
    
    function stopAmbientMusic() {
      if (ambientMusic) {
        ambientMusic.playing = false;
        ambientMusic = null;
      }
    }

    function playSound(type) {
      if (!soundEnabled) return;
      
      // Iniciar m√∫sica ambiente si no est√° corriendo
      if (!ambientMusic && audioContext) {
        startAmbientMusic();
      }
      
      // Intentar reproducir archivo de audio real primero
      if (audioFiles[type]) {
        const audio = audioFiles[type].cloneNode();
        audio.volume = audioVolume;
        audio.play().catch(err => console.log('Error reproduciendo sonido:', err));
        return;
      }

      // Fallback a tonos sintetizados
      if (!audioContext) return;
      
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      // Diferentes tonos seg√∫n tipo
      switch(type) {
        case 'success':
          oscillator.frequency.value = 800;
          oscillator.type = 'sine';
          gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
          break;
        case 'error':
          oscillator.frequency.value = 200;
          oscillator.type = 'sawtooth';
          gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
          break;
        case 'warning':
          oscillator.frequency.value = 400;
          oscillator.type = 'triangle';
          gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
          break;
        case 'combat':
          oscillator.frequency.value = 150;
          oscillator.type = 'square';
          gainNode.gain.setValueAtTime(0.12, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
          break;
        case 'levelup':
          // Sonido ascendente √©pico mejorado
          const osc1 = audioContext.createOscillator();
          const osc2 = audioContext.createOscillator();
          const osc3 = audioContext.createOscillator();
          const levelGain = audioContext.createGain();
          
          osc1.type = 'sine';
          osc2.type = 'sine';
          osc3.type = 'triangle';
          
          // Armon√≠a ascendente
          osc1.frequency.setValueAtTime(400, audioContext.currentTime);
          osc1.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.5);
          
          osc2.frequency.setValueAtTime(500, audioContext.currentTime + 0.1);
          osc2.frequency.exponentialRampToValueAtTime(1400, audioContext.currentTime + 0.5);
          
          osc3.frequency.setValueAtTime(600, audioContext.currentTime + 0.2);
          osc3.frequency.exponentialRampToValueAtTime(1600, audioContext.currentTime + 0.5);
          
          levelGain.gain.setValueAtTime(0.2, audioContext.currentTime);
          levelGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
          levelGain.connect(audioContext.destination);
          
          osc1.connect(levelGain);
          osc2.connect(levelGain);
          osc3.connect(levelGain);
          
          osc1.start(audioContext.currentTime);
          osc2.start(audioContext.currentTime + 0.1);
          osc3.start(audioContext.currentTime + 0.2);
          
          osc1.stop(audioContext.currentTime + 0.5);
          osc2.stop(audioContext.currentTime + 0.5);
          osc3.stop(audioContext.currentTime + 0.5);
          return;
        case 'loot':
          // Sonido de pickup
          oscillator.frequency.value = 1000;
          oscillator.type = 'sine';
          gainNode.gain.setValueAtTime(0.08, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.08);
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.08);
          return;
        case 'craft':
          // Sonido de martillo
          oscillator.frequency.value = 300;
          oscillator.type = 'square';
          gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.05);
          return;
        case 'move':
          // Sonido sutil de paso
          oscillator.frequency.value = 250;
          oscillator.type = 'sine';
          gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.06);
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.06);
          return;
        case 'notification':
          // Ping suave
          oscillator.frequency.value = 600;
          oscillator.type = 'sine';
          gainNode.gain.setValueAtTime(0.08, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.12);
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.12);
          return;
        case 'death':
          // Sonido grave de muerte
          oscillator.frequency.setValueAtTime(300, audioContext.currentTime);
          oscillator.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime + 0.4);
          oscillator.type = 'sawtooth';
          gainNode.gain.setValueAtTime(0.18, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.4);
          return;
        case 'achievement':
          // Fanfarria corta
          oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
          oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.08);
          oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.16);
          oscillator.type = 'sine';
          gainNode.gain.setValueAtTime(0.12, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.25);
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.25);
          return;
        case 'click':
          // Click UI
          oscillator.frequency.value = 500;
          oscillator.type = 'sine';
          gainNode.gain.setValueAtTime(0.06, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.03);
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.03);
          return;
      }
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.2);
    }
    
    // ====================================
    // TABS DE CRAFTEO
    // ====================================
    function switchCraftTab(tabName) {
      // Desactivar todos los tabs
      document.querySelectorAll('.craft-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.craft-section').forEach(section => section.classList.remove('active'));
      
      // Activar el seleccionado
      event.target.classList.add('active');
      document.getElementById(`craft-${tabName}`).classList.add('active');
      
      playSound('success');
    }
    
    // ====================================
    // MAPA 2D VISUAL DEL MUNDO
    // ====================================
    function render2DWorldMap() {
      const mapEl = document.getElementById('world-map-2d');
      if (!mapEl || !world || !world.locations || !player) return;
      
      // Definir estructura del mapa (representaci√≥n ASCII)
      const map = `
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                    üèòÔ∏è REFUGIO CENTRAL                         ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë                                                                ‚ïë
‚ïë    üåæ GRANJA          üêÑ CORRAL          üîß TALLER             ‚ïë
‚ïë    [[loc:granja]]     [[loc:corral]]    [[loc:taller]]        ‚ïë
‚ïë                                                                ‚ïë
‚ïë          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                   ‚ïë
‚ïë          ‚îÇ         PLAZA CENTRAL          ‚îÇ                   ‚ïë
‚ïë          ‚îÇ         [[loc:plaza]]          ‚îÇ                   ‚ïë
‚ïë          ‚îÇ         [[npcs:plaza]]         ‚îÇ                   ‚ïë
‚ïë          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                   ‚ïë
‚ïë                                                                ‚ïë
‚ïë    üç∫ TABERNA       üè• HOSPITAL        üõ°Ô∏è TORRE               ‚ïë
‚ïë    [[loc:taberna]]  [[loc:hospital]]   [[loc:torre]]          ‚ïë
‚ïë                                                                ‚ïë
‚ïë    üì¶ ALMAC√âN       üõèÔ∏è VIVIENDAS      üö™ PUERTA              ‚ïë
‚ïë    [[loc:almacen]]  [[loc:viviendas]]  [[loc:puerta]]         ‚ïë
‚ïë                                                                ‚ïë
‚ïë    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïë
‚ïë              ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà MURALLA NIV.${world.refugio?.nivel || 1} ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà              ‚ïë
‚ïë    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïë
‚ïë                                                                ‚ïë
‚ïë    ZONAS EXTERIORES:                                          ‚ïë
‚ïë    üèöÔ∏è Supermercado [[loc:supermercado]]                       ‚ïë
‚ïë    üè• Farmacia [[loc:farmacia]]                                ‚ïë
‚ïë    üè≠ Almac√©n Industrial [[loc:almacen_abandonado]]            ‚ïë
‚ïë    üè™ Tienda [[loc:tienda]]                                    ‚ïë
‚ïë                                                                ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
`;
      
      // Reemplazar marcadores con estado actual
      let processedMap = map;
      
      // Procesar cada ubicaci√≥n
      Object.keys(world.locations).forEach(locId => {
        const loc = world.locations[locId];
        const marker = `[[loc:${locId}]]`;
        
        if (processedMap.includes(marker)) {
          let status = '';
          
          // Indicador de jugador en esta ubicaci√≥n (CON PULSO)
          if (player.locacion === locId) {
            status += '<span style="color: #00ff00; font-weight: bold; display: inline-block; animation: pulse 2s ease-in-out infinite;">üìçT√ö</span>';
          }
          
          // Indicador de zombies (CON TEMBLOR)
          if (loc.zombies > 0) {
            status += ` <span style="color: #ff0000; display: inline-block; animation: zombieShake 0.5s ease-in-out infinite;">üßü√ó${loc.zombies}</span>`;
          }
          
          // Indicador de recursos disponibles (CON BRILLO)
          if (loc.tipo === 'loot' && !loc.looted) {
            status += ' <span style="color: #ffaa00; display: inline-block; animation: resourceGlow 2s ease-in-out infinite;">üì¶</span>';
          }
          
          // Indicador de NPCs en ubicaci√≥n (CON CAMINATA)
          const npcsHere = world.npcs ? Object.values(world.npcs).filter(npc => npc.ubicacion === locId) : [];
          if (npcsHere.length > 0) {
            status += ` <span style="color: #88ff88; display: inline-block; animation: npcWalk 1s ease-in-out infinite;">üë§√ó${npcsHere.length}</span>`;
          }
          
          // Hacer ubicaci√≥n clickeable
          const clickable = `<span style="cursor: pointer; text-decoration: underline; color: #00aaff;" onclick="moveTo('${locId}')" title="${loc.nombre}">${status || '¬∑'}</span>`;
          
          processedMap = processedMap.replace(marker, clickable);
        }
      });
      
      // Procesar NPCs en plaza (NPCs movi√©ndose con animaci√≥n)
      const plazaNPCs = world.npcs ? Object.values(world.npcs).filter(npc => npc.ubicacion === 'plaza') : [];
      const npcMarker = '[[npcs:plaza]]';
      if (processedMap.includes(npcMarker)) {
        const npcIcons = plazaNPCs.slice(0, 5).map(npc => 
          `<span style="color: #88ff88; display: inline-block; animation: npcWalk 1s ease-in-out infinite;" title="${npc.nombre}">üë§</span>`
        ).join(' ');
        processedMap = processedMap.replace(npcMarker, npcIcons || '');
      }
      
      // Limpiar marcadores no procesados
      processedMap = processedMap.replace(/\[\[.*?\]\]/g, '');
      
      mapEl.innerHTML = processedMap;
    }

    // ====================================
    // REFUGIO VISUAL DIN√ÅMICO
    // ====================================
    function renderRefugioVisual() {
      if (!world || !world.locations || !world.locations.refugio) return;
      
      const refugio = world.locations.refugio;
      const defensas = refugio.defensas || 0;
      const mejoras = refugio.mejoras || {};
      
      let visual = 'üèòÔ∏è'; // Base: edificio b√°sico
      
      // A√±adir elementos seg√∫n mejoras
      if (mejoras.torre_vigilancia && mejoras.torre_vigilancia.nivel > 0) {
        visual = 'üèØ' + visual; // Torre
      }
      if (mejoras.enfermeria && mejoras.enfermeria.nivel > 0) {
        visual += '‚öïÔ∏è'; // Cruz m√©dica
      }
      if (mejoras.taller && mejoras.taller.nivel > 0) {
        visual += 'üîß'; // Herramientas
      }
      if (mejoras.armeria && mejoras.armeria.nivel > 0) {
        visual += 'üõ°Ô∏è'; // Escudo
      }
      if (mejoras.huerto && mejoras.huerto.nivel > 0) {
        visual += 'üåø'; // Planta
      }
      
      // Estado seg√∫n defensas
      let estadoText = '';
      let color = '#00ff00';
      if (defensas < 20) {
        estadoText = '‚ö†Ô∏è VULNERABLE';
        color = '#ff0000';
      } else if (defensas < 50) {
        estadoText = '‚öôÔ∏è FORTIFICADO';
        color = '#ffaa00';
      } else if (defensas < 100) {
        estadoText = 'üõ°Ô∏è PROTEGIDO';
        color = '#00ff00';
      } else {
        estadoText = 'üèØ FORTALEZA';
        color = '#00ffff';
      }
      
      const html = `
        <div style="text-align: center;">
          <div style="font-size: 48px; margin: 10px 0;">${visual}</div>
          <div style="font-size: 12px; color: ${color}; font-weight: bold;">${estadoText}</div>
        </div>
      `;
      
      const container = document.getElementById('refugioVisual');
      if (container) {
        container.innerHTML = html;
      }
    }
    
    // ====================================
    // SISTEMA DE PESTA√ëAS
    // ====================================
    function switchTab(tabName) {
      // Ocultar todos los contenidos
      const contents = document.querySelectorAll('.tab-content');
      contents.forEach(content => content.classList.remove('active'));
      
      // Desactivar todos los botones
      const buttons = document.querySelectorAll('.tab-button');
      buttons.forEach(btn => btn.classList.remove('active'));
      
      // Activar la pesta√±a seleccionada
      document.getElementById(`tab-${tabName}`).classList.add('active');
      document.querySelector(`button[onclick="switchTab('${tabName}')"]`).classList.add('active');
      
      // Sonido de click
      playSound('click');
      
      // Limpiar badge cuando se abre la pesta√±a
      if (tabName === 'events') {
        hideBadge('events');
      } else if (tabName === 'social') {
        hideBadge('social');
        checkSocialAccess(); // Verificar acceso cada vez que se abre
      } else if (tabName === 'missions') {
        hideBadge('missions');
        loadNarrativeMissions(); // Cargar misiones narrativas
      } else if (tabName === 'mundo') {
        hideBadge('mundo');
        refreshQuests(); // Refrescar misiones legacy
        requestDynamicQuests(); // FASE 11: Misiones din√°micas
        requestActiveEvents(); // FASE 11: Eventos globales
      }
      
      // Lazy loading: cargar contenido solo la primera vez
      if (!tabsLoaded[tabName]) {
        tabsLoaded[tabName] = true;
        switch(tabName) {
          case 'missions':
            loadNarrativeMissions();
            break;
          case 'crafting':
            renderCrafting();
            break;
          case 'quests':
            renderQuests();
            break;
          case 'social':
            renderOnlinePlayers([]);
            renderChat();
            checkSocialAccess(); // Cargar fogata y juegos
            break;
          case 'mundo':
            refreshQuests();
            refreshWorldEvents();
            loadIntenseRelationships();
            loadWorldStats();
            requestDynamicQuests(); // FASE 11
            requestActiveEvents(); // FASE 11
            break;
          case 'progression':
            loadDefaultLeaderboard();
            renderAchievements();
            break;
          case 'events':
            renderWorldEvents();
            renderNarrativeHistory();
            break;
        }
      } else if (tabName === 'progression') {
        // Siempre actualizar leaderboard y logros al abrir
        loadDefaultLeaderboard();
        renderAchievements();
      } else if (tabName === 'mundo') {
        // Siempre refrescar datos del mundo al abrir
        refreshWorldEvents();
        requestDynamicQuests(); // FASE 11
        requestActiveEvents(); // FASE 11
        loadIntenseRelationships();
        loadWorldStats();
      }
    }

    function showBadge(tab) {
      const badge = document.getElementById(`badge-${tab}`);
      if (badge) {
        badge.style.display = 'flex';
      }
    }

    function hideBadge(tab) {
      const badge = document.getElementById(`badge-${tab}`);
      if (badge) {
        badge.style.display = 'none';
      }
    }

    // Acciones r√°pidas desde la pesta√±a principal
    function quickAction(action) {
      switch(action) {
        case 'scavenge':
          showActionFeedback('üîç Buscando recursos...');
          scavenge();
          break;
        case 'attack':
          showActionFeedback('‚öîÔ∏è Iniciando combate...', 'danger');
          startCombat();
          break;
        case 'rest':
          rest();
          break;
        case 'eat':
          eat();
          break;
      }
    }
    
    function showActionFeedback(text, type = 'success') {
      let feedbackEl = document.getElementById('actionFeedback');
      if (!feedbackEl) {
        feedbackEl = document.createElement('div');
        feedbackEl.id = 'actionFeedback';
        document.body.appendChild(feedbackEl);
      }
      
      feedbackEl.textContent = text;
      feedbackEl.style.background = type === 'danger' ? 'rgba(255, 0, 0, 0.95)' : 'rgba(0, 255, 0, 0.95)';
      feedbackEl.style.color = type === 'danger' ? '#fff' : '#000';
      feedbackEl.style.display = 'block';
      
      setTimeout(() => {
        feedbackEl.style.display = 'none';
      }, 800);
    }

    // ====================================
    // SISTEMA DE M√âTRICAS DE RENDIMIENTO
    // ====================================
    function requestMetrics() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        showNotification('No hay conexi√≥n con el servidor', 'warning');
        return;
      }
      
      ws.send(JSON.stringify({ type: 'admin:getMetrics' }));
    }

    function showMetricsModal(metrics, totalHandlers) {
      // Crear modal de m√©tricas
      const modalHtml = `
        <div id="metricsModal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                 background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); 
                 border: 2px solid #4CAF50; border-radius: 12px; padding: 25px; 
                 z-index: 10000; max-width: 800px; max-height: 80vh; overflow-y: auto;
                 box-shadow: 0 10px 50px rgba(0, 0, 0, 0.8);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; color: #4CAF50; font-size: 24px;">üìä M√©tricas de Servidor</h2>
            <button onclick="document.getElementById('metricsModal').remove(); document.getElementById('metricsOverlay').remove();" 
                    style="background: #f44336; color: white; border: none; border-radius: 5px; padding: 8px 15px; cursor: pointer; font-size: 16px;">‚úñ</button>
          </div>
          
          <div style="background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <p style="margin: 5px 0; color: #eee;"><strong>Total Handlers:</strong> ${totalHandlers}</p>
            <p style="margin: 5px 0; color: #eee;"><strong>Tiempo de muestreo:</strong> Desde inicio del servidor</p>
          </div>
          
          <table style="width: 100%; border-collapse: collapse; color: #eee;">
            <thead>
              <tr style="background: rgba(76, 175, 80, 0.2); text-align: left;">
                <th style="padding: 10px; border: 1px solid #555;">Handler</th>
                <th style="padding: 10px; border: 1px solid #555;">Llamadas</th>
                <th style="padding: 10px; border: 1px solid #555;">Errores</th>
                <th style="padding: 10px; border: 1px solid #555;">Error %</th>
                <th style="padding: 10px; border: 1px solid #555;">Tiempo Avg</th>
              </tr>
            </thead>
            <tbody>
              ${metrics.slice(0, 20).map((m, idx) => {
                const errorColor = m.errorRate > 10 ? '#f44336' : m.errorRate > 0 ? '#ff9800' : '#4CAF50';
                const timeColor = m.avgTime > 100 ? '#ff9800' : m.avgTime > 500 ? '#f44336' : '#4CAF50';
                const rowBg = idx % 2 === 0 ? 'rgba(255, 255, 255, 0.05)' : 'transparent';
                
                return `
                  <tr style="background: ${rowBg};">
                    <td style="padding: 8px; border: 1px solid #555;"><code>${m.handler}</code></td>
                    <td style="padding: 8px; border: 1px solid #555; text-align: center;">${m.calls}</td>
                    <td style="padding: 8px; border: 1px solid #555; text-align: center; color: ${errorColor};">${m.errors}</td>
                    <td style="padding: 8px; border: 1px solid #555; text-align: center; color: ${errorColor};">
                      ${m.errorRate.toFixed(1)}%
                    </td>
                    <td style="padding: 8px; border: 1px solid #555; text-align: center; color: ${timeColor};">
                      ${m.avgTime.toFixed(2)}ms
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
          
          ${metrics.length > 20 ? `<p style="color: #999; text-align: center; margin-top: 10px; font-style: italic;">Mostrando top 20 de ${metrics.length} handlers</p>` : ''}
          
          <div style="margin-top: 20px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; border-left: 4px solid #4CAF50;">
            <h3 style="margin: 0 0 10px 0; color: #4CAF50;">‚ÑπÔ∏è Informaci√≥n</h3>
            <p style="margin: 5px 0; color: #ccc; font-size: 14px;">‚Ä¢ <strong>Error %:</strong> Porcentaje de llamadas que resultaron en error</p>
            <p style="margin: 5px 0; color: #ccc; font-size: 14px;">‚Ä¢ <strong>Tiempo Avg:</strong> Tiempo promedio de ejecuci√≥n del handler</p>
            <p style="margin: 5px 0; color: #ccc; font-size: 14px;">‚Ä¢ üü¢ <strong>Verde:</strong> Rendimiento √≥ptimo | üü† <strong>Naranja:</strong> Atenci√≥n | üî¥ <strong>Rojo:</strong> Revisar</p>
          </div>
        </div>
        
        <div id="metricsOverlay" onclick="this.remove(); document.getElementById('metricsModal').remove();" 
             style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0, 0, 0, 0.8); z-index: 9999;"></div>
      `;
      
      // Remover modal anterior si existe
      const oldModal = document.getElementById('metricsModal');
      const oldOverlay = document.getElementById('metricsOverlay');
      if (oldModal) oldModal.remove();
      if (oldOverlay) oldOverlay.remove();
      
      // Agregar nuevo modal
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      log('üìä M√©tricas del servidor actualizadas', 'success');
    }

    function rest() {
      if (!player) return;
      
      const oldSalud = player.salud;
      const oldHambre = player.hambre;
      
      player.salud = Math.min(100, player.salud + 10);
      player.hambre = Math.max(0, player.hambre - 5);
      
      // Mostrar consecuencias
      if (player.salud > oldSalud) showStatChange('salud', player.salud - oldSalud);
      if (player.hambre < oldHambre) showStatChange('hambre', player.hambre - oldHambre);
      
      showActionFeedback('üí§ Descansando...', 'success');
      renderGame();
    }

    // ====================================
    // SISTEMA DE DONACI√ìN AL REFUGIO
    // ====================================
    function showDonateMenu() {
      const items = Object.entries(player.inventario)
        .filter(([item, cant]) => cant > 0)
        .map(([item, cant]) => `<option value="${item}">${item} (tienes: ${cant})</option>`)
        .join('');
      
      if (!items) {
        showNotification('No tienes nada que donar', 'warning');
        return;
      }
      
      const item = prompt(`¬øQu√© quieres donar al refugio?\n\nOpciones: ${Object.keys(player.inventario).filter(k => player.inventario[k] > 0).join(', ')}`);
      
      if (!item || !player.inventario[item]) {
        return;
      }
      
      const cantidad = parseInt(prompt(`¬øCu√°nto ${item} quieres donar? (tienes: ${player.inventario[item]})`));
      
      if (!cantidad || cantidad <= 0 || cantidad > player.inventario[item]) {
        showNotification('Cantidad inv√°lida', 'warning');
        return;
      }
      
      donateToRefugio(item, cantidad);
    }

    function donateToRefugio(item, cantidad) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No conectado al servidor', 'warning');
        return;
      }
      
      ws.send(JSON.stringify({
        type: 'donate',
        item,
        cantidad
      }));
    }

    // ====================================
    // SISTEMA DE MUNDO VIVO
    // ====================================
    
    function refreshWorldEvents() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No conectado al servidor', 'warning');
        return;
      }
      
      ws.send(JSON.stringify({
        type: 'getWorldEvents',
        limit: 50
      }));
    }

    function loadIntenseRelationships() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      
      ws.send(JSON.stringify({
        type: 'getIntenseRelationships',
        minIntensity: 5
      }));
    }

    function loadWorldStats() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      
      ws.send(JSON.stringify({
        type: 'getWorldState'
      }));
    }

    function renderWorldEvents(events) {
      // Si no se pasan eventos, usar la cach√©
      if (!events && worldEvents.length > 0) {
        events = worldEvents;
      }
      
      const feed = document.getElementById('worldEventsFeed');
      if (!feed) return;
      
      if (!events || events.length === 0) {
        feed.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">No hay eventos recientes...</p>';
        return;
      }
      
      // Actualizar cach√© si se recibieron eventos nuevos
      if (events && events.length > 0) {
        worldEvents = events;
      }

      // Agrupar eventos por tipo para mejor visualizaci√≥n
      const groupedEvents = {
        romance: [],
        conflicto: [],
        drama: [],
        actividad: [],
        otros: []
      };

      events.forEach(event => {
        const tipo = event.tipo;
        if (tipo.includes('romance') || tipo.includes('coqueteo') || tipo.includes('amor') || tipo.includes('tension')) {
          groupedEvents.romance.push(event);
        } else if (tipo.includes('pelea') || tipo.includes('conflicto') || tipo.includes('enemigo') || tipo.includes('rival')) {
          groupedEvents.conflicto.push(event);
        } else if (tipo.includes('drama') || tipo.includes('chisme') || tipo.includes('celos') || tipo.includes('triangulo')) {
          groupedEvents.drama.push(event);
        } else if (tipo.includes('colaboracion') || tipo.includes('charla') || tipo.includes('ayuda') || tipo.includes('amistad')) {
          groupedEvents.actividad.push(event);
        } else {
          groupedEvents.otros.push(event);
        }
      });

      let html = '';

      // Mostrar todos los eventos en orden cronol√≥gico
      events.forEach(event => {
        const timeAgo = getTimeAgo(event.timestamp);
        const icon = getEventIcon(event.tipo);
        const color = getEventColor(event.tipo);
        
        html += `
          <div style="background: #1a1a1a; border-left: 3px solid ${color}; padding: 10px; margin: 8px 0; border-radius: 3px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
              <span style="color: ${color};">${icon} ${event.tipo.toUpperCase()}</span>
              <span style="color: #666; font-size: 10px;">${timeAgo}</span>
            </div>
            <p style="margin: 0; color: #ddd; line-height: 1.4;">
              ${event.descripcion}
            </p>
          </div>
        `;
      });

      feed.innerHTML = html;
    }

    function renderIntenseRelationships(relationships) {
      // Si no se pasan relaciones, usar la cach√©
      if (!relationships && intenseRelationships.length > 0) {
        relationships = intenseRelationships;
      }
      
      const container = document.getElementById('intenseRelationships');
      if (!container) return;

      if (!relationships || relationships.length === 0) {
        container.innerHTML = '<p style="color: #888;">Sin relaciones dram√°ticas...</p>';
        return;
      }
      
      // Actualizar cach√©
      if (relationships && relationships.length > 0) {
        intenseRelationships = relationships;
      }

      let html = '';

      relationships.forEach(rel => {
        const estadoIcon = getRelationshipIcon(rel.estado);
        const color = getRelationshipColor(rel.estado);
        
        html += `
          <div style="background: #1a2a1a; border: 1px solid ${color}; padding: 8px; margin: 5px 0; border-radius: 3px;">
            <div style="color: ${color}; font-weight: bold; margin-bottom: 3px;">
              ${estadoIcon} ${rel.npc_a_id} ‚Üî ${rel.npc_b_id}
            </div>
            <div style="font-size: 10px; color: #aaa;">
              Estado: <span style="color: ${color};">${rel.estado}</span> | 
              Intensidad: ${'üî•'.repeat(Math.min(rel.intensidad, 10))}
            </div>
            <div style="font-size: 9px; color: #888; margin-top: 3px;">
              Amistad: ${rel.amistad} | Atracci√≥n: ${rel.atraccion} | 
              Rivalidad: ${rel.rivalidad} | Celos: ${rel.celos}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function renderWorldStats(stats) {
      // Si no se pasan stats, usar la cach√©
      if (!stats && worldStats) {
        stats = worldStats;
      }
      
      const container = document.getElementById('worldStats');
      if (!container) return;
      
      if (!stats) {
        container.innerHTML = '<p style="color: #888;">Cargando...</p>';
        return;
      }
      
      // Actualizar cach√©
      worldStats = stats;

      const narrativeStats = stats.narrativeStats || {};
      const aiStats = stats.aiStats || {};
      
      const html = `
        <div style="background: #1a1a2a; padding: 10px; border-radius: 3px; margin: 5px 0;">
          <div style="margin: 5px 0;">‚è±Ô∏è <strong>Tick:</strong> #${stats.tick || 0}</div>
          <div style="margin: 5px 0;">üë• <strong>NPCs Activos:</strong> ${stats.npcCount || 0}</div>
          <div style="margin: 5px 0;">‚ö° <strong>Eventos Activos:</strong> ${stats.activeEvents || 0}</div>
        </div>
        
        <div style="background: #2a1a1a; padding: 10px; border-radius: 3px; margin: 10px 0;">
          <div style="font-weight: bold; margin-bottom: 5px; color: #ff88aa;">üìä Estad√≠sticas Narrativas</div>
          <div style="margin: 3px 0;">üíï Romances: ${narrativeStats.romances || 0}</div>
          <div style="margin: 3px 0;">‚öîÔ∏è Conflictos: ${narrativeStats.conflictos || 0}</div>
          <div style="margin: 3px 0;">üé≠ Dramas: ${narrativeStats.dramas || 0}</div>
          <div style="margin: 3px 0;">ü§ù Actividades: ${narrativeStats.actividades || 0}</div>
        </div>
        
        <div style="background: #1a2a1a; padding: 10px; border-radius: 3px; margin: 10px 0;">
          <div style="font-weight: bold; margin-bottom: 5px; color: #44ff88;">ü§ñ Sistema de IA</div>
          <div style="margin: 3px 0;">üß† NPCs con memoria: ${aiStats.npcsWithMemories || 0}</div>
          <div style="margin: 3px 0;">üí≠ Recuerdos totales: ${aiStats.totalMemories || 0}</div>
          <div style="margin: 3px 0;">üéØ Objetivos activos: ${aiStats.activeGoals || 0}</div>
        </div>
      `;

      container.innerHTML = html;
    }

    // Helpers para iconos y colores
    function getEventIcon(tipo) {
      if (tipo.includes('romance') || tipo.includes('amor')) return 'üíï';
      if (tipo.includes('pelea') || tipo.includes('conflicto')) return '‚öîÔ∏è';
      if (tipo.includes('drama') || tipo.includes('chisme')) return 'üé≠';
      if (tipo.includes('amistad') || tipo.includes('ayuda')) return 'ü§ù';
      if (tipo.includes('coqueteo')) return 'üòä';
      if (tipo.includes('tension')) return 'üî•';
      if (tipo.includes('celos')) return 'üòí';
      return 'üì∞';
    }

    function getEventColor(tipo) {
      if (tipo.includes('romance') || tipo.includes('amor')) return '#ff88aa';
      if (tipo.includes('pelea') || tipo.includes('conflicto')) return '#ff4444';
      if (tipo.includes('drama') || tipo.includes('chisme')) return '#ff8800';
      if (tipo.includes('amistad') || tipo.includes('ayuda')) return '#44ff44';
      if (tipo.includes('coqueteo')) return '#ffaa88';
      if (tipo.includes('tension')) return '#ffaa00';
      if (tipo.includes('celos')) return '#aa00aa';
      return '#888888';
    }

    function getRelationshipIcon(estado) {
      switch(estado) {
        case 'amantes': return 'üíë';
        case 'tension_sexual': return 'üî•';
        case 'enemigos': return '‚öîÔ∏è';
        case 'rivales': return 'ü•ä';
        case 'amigos': return 'ü§ù';
        case 'celoso': return 'üòí';
        case 'complejo': return 'üé≠';
        default: return 'üë•';
      }
    }

    function getRelationshipColor(estado) {
      switch(estado) {
        case 'amantes': return '#ff4488';
        case 'tension_sexual': return '#ff8800';
        case 'enemigos': return '#ff0000';
        case 'rivales': return '#ffaa00';
        case 'amigos': return '#44ff44';
        case 'celoso': return '#aa00aa';
        case 'complejo': return '#8888ff';
        default: return '#888888';
      }
    }

    // Renderizar historial narrativo
    function renderNarrativeHistory() {
      const container = document.getElementById('narrative-events');
      if (!container) return;

      // Obtener eventos narrativos del mundo o jugador
      let narrativeEvents = [];
      
      // Combinar eventos del mundo y del jugador
      if (world && world.narrativeEvents && Array.isArray(world.narrativeEvents)) {
        narrativeEvents = [...world.narrativeEvents];
      }
      if (player && player.narrativeHistory && Array.isArray(player.narrativeHistory)) {
        narrativeEvents = [...narrativeEvents, ...player.narrativeHistory];
      }

      if (!narrativeEvents || narrativeEvents.length === 0) {
        container.innerHTML = '<div class="empty-message">No hay eventos narrativos registrados a√∫n...</div>';
        return;
      }

      // Ordenar por timestamp (m√°s reciente primero)
      narrativeEvents.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

      // Agrupar por tipo
      const grouped = {};
      narrativeEvents.forEach(event => {
        const tipo = event.type || 'general';
        if (!grouped[tipo]) grouped[tipo] = [];
        grouped[tipo].push(event);
      });

      let html = '';
      
      // Renderizar cada grupo
      Object.keys(grouped).forEach(tipo => {
        const events = grouped[tipo];
        const icon = getEventIcon(tipo);
        const color = getEventColor(tipo);
        
        html += `
          <div class="event-group">
            <div class="event-group-header" style="color: ${color};">
              ${icon} ${tipo.toUpperCase().replace('_', ' ')} (${events.length})
            </div>
        `;
        
        events.forEach(event => {
          const timeAgo = event.timestamp ? getTimeAgo(event.timestamp) : 'hace un momento';
          const description = event.description || event.texto || 'Evento sin descripci√≥n';
          
          html += `
            <div class="event-item" style="border-left: 3px solid ${color};">
              <span class="event-time">${timeAgo}</span>
              <span class="event-icon">${icon}</span>
              <span class="event-text">${description}</span>
            </div>
          `;
        });
        
        html += `</div>`;
      });

      container.innerHTML = html;
    }

    function getTimeAgo(timestamp) {
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      if (seconds < 60) return `hace ${seconds}s`;
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `hace ${minutes}m`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `hace ${hours}h`;
      const days = Math.floor(hours / 24);
      return `hace ${days}d`;
    }

    // Renderizar acciones aut√≥nomas de NPCs
    function renderNpcActions(actions) {
      const container = document.getElementById('npcActionsLog');
      
      if (!actions || actions.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #888;">Sin acciones registradas...</p>';
        return;
      }

      const actionsHTML = actions.map(action => {
        const icon = getActionIcon(action.action);
        const color = getActionColor(action.action);
        
        return `
          <div style="
            background: rgba(0,0,0,0.4);
            border-left: 3px solid ${color};
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
          ">
            <div style="color: ${color}; font-weight: bold; margin-bottom: 4px;">
              ${icon} ${action.action.toUpperCase().replace('_', ' ')}
            </div>
            <div style="color: #ccc;">
              ${action.description}
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = actionsHTML;
    }

    function getActionIcon(actionType) {
      const icons = {
        'move': 'üö∂',
        'interact': 'üí¨',
        'seek_romance': 'üíï',
        'avoid_enemy': 'üèÉ',
        'seek_friend': 'ü§ù',
        'confront': '‚öîÔ∏è',
        'rest': 'üò¥'
      };
      return icons[actionType] || 'üéØ';
    }

    function getActionColor(actionType) {
      const colors = {
        'move': '#4488ff',
        'interact': '#44ff44',
        'seek_romance': '#ff4488',
        'avoid_enemy': '#ffaa00',
        'seek_friend': '#44ff88',
        'confront': '#ff4444',
        'rest': '#8888ff'
      };
      return colors[actionType] || '#888888';
    }

    // ====================================
    // SISTEMA DE MISIONES DIN√ÅMICAS
    // ====================================
    
    function refreshQuests() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ 
        type: 'getQuests', 
        playerId: player.id 
      }));
    }
    
    function renderQuests(quests) {
      const list = document.getElementById('questsList');
      const badge = document.getElementById('questCountBadge');
      
      if (!quests || quests.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">No hay misiones disponibles.</p>';
        badge.textContent = '';
        return;
      }
      
      badge.textContent = `(${quests.length})`;
      
      const questsHTML = quests.map(quest => {
        const timeLeft = quest.expiresAt - Date.now();
        const minutesLeft = Math.floor(timeLeft / 60000);
        const isExpiringSoon = minutesLeft < 3;
        
        const typeIcons = {
          'romance': 'üíï',
          'matchmaker': 'üíò',
          'mediation': 'üïäÔ∏è',
          'rivalry': '‚öîÔ∏è',
          'jealousy': 'üòí',
          'investigation': 'üîç'
        };
        
        const typeColors = {
          'romance': '#ff4488',
          'matchmaker': '#ff88cc',
          'mediation': '#44ff44',
          'rivalry': '#ffaa00',
          'jealousy': '#aa00aa',
          'investigation': '#4488ff'
        };
        
        const icon = typeIcons[quest.type] || '‚ö°';
        const color = typeColors[quest.type] || '#888';
        const isAccepted = quest.estado === 'aceptada';
        
        return `
          <div class="quest-card" style="
            background: linear-gradient(135deg, rgba(0,0,0,0.8) 0%, rgba(30,30,30,0.9) 100%);
            border: 2px solid ${color};
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            ${isExpiringSoon ? 'animation: pulse 1s infinite;' : ''}
          ">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
              <h3 style="margin: 0; color: ${color}; font-size: 14px;">
                ${icon} ${quest.title}
              </h3>
              <span style="
                background: ${isExpiringSoon ? '#ff0000' : '#333'};
                color: white;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 10px;
                font-weight: bold;
              ">
                ‚è±Ô∏è ${minutesLeft}m
              </span>
            </div>
            
            <p style="font-size: 11px; color: #ccc; margin: 10px 0; line-height: 1.4;">
              ${quest.description}
            </p>
            
            <div style="margin: 10px 0;">
              <strong style="color: ${color}; font-size: 11px;">OBJETIVOS:</strong>
              <ul style="margin: 5px 0; padding-left: 20px; font-size: 10px; color: #aaa;">
                ${quest.objectives.map(obj => `<li>${obj}</li>`).join('')}
              </ul>
            </div>
            
            <div style="margin: 10px 0;">
              <strong style="color: #ffaa00; font-size: 11px;">RECOMPENSAS:</strong>
              <div style="font-size: 10px; color: #ffcc00; margin-top: 5px;">
                ${quest.rewards?.xp ? `‚≠ê +${quest.rewards.xp} XP` : ''}
                ${quest.rewards?.reputacion ? `üìä +${quest.rewards.reputacion} Rep` : ''}
                ${quest.rewards?.oro ? `üí∞ +${quest.rewards.oro} Oro` : ''}
              </div>
            </div>
            
            ${quest.npcsInvolved && quest.npcsInvolved.length > 0 ? `
              <div style="margin: 10px 0; font-size: 10px; color: #888;">
                NPCs: ${quest.npcsInvolved.map(npc => `<span style="color: #fff;">${npc.nombre || npc.name || npc}</span>`).join(', ')}
              </div>
            ` : ''}
            
            ${isAccepted ? `
              <button onclick="completeQuest('${quest.id}', true)" style="
                background: #44ff44;
                color: #000;
                border: none;
                padding: 8px 15px;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
                margin-right: 5px;
              ">‚úÖ COMPLETAR</button>
              <button onclick="completeQuest('${quest.id}', false)" style="
                background: #ff4444;
                color: #fff;
                border: none;
                padding: 8px 15px;
                border-radius: 4px;
                cursor: pointer;
              ">‚ùå FALLAR</button>
            ` : `
              <button onclick="acceptQuest('${quest.id}')" style="
                background: ${color};
                color: #fff;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
                width: 100%;
              ">üéØ ACEPTAR MISI√ìN</button>
            `}
          </div>
        `;
      }).join('');
      
      list.innerHTML = questsHTML;
    }
    
    function acceptQuest(questId) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No hay conexi√≥n con el servidor', 'warning');
        return;
      }
      
      ws.send(JSON.stringify({
        type: 'acceptQuest',
        questId,
        playerId: player.id
      }));
    }
    
    function completeQuest(questId, success) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No hay conexi√≥n con el servidor', 'warning');
        return;
      }
      
      const confirmMsg = success 
        ? '¬øCompletaste los objetivos de la misi√≥n?' 
        : '¬øQuieres marcar la misi√≥n como fallida?';
      
      if (confirm(confirmMsg)) {
        ws.send(JSON.stringify({
          type: 'completeQuest',
          questId,
          playerId: player.id,
          success
        }));
      }
    }

    // ====================================
    // FIN SISTEMA DE MISIONES DIN√ÅMICAS
    // ====================================

    // ====================================
    // FASE 11: EVENTOS GLOBALES
    // ====================================

    function requestActiveEvents() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: 'get_active_events' }));
    }

    function renderGlobalEvents(events) {
      const container = document.getElementById('globalEventsContainer');
      if (!container) return;

      if (!events || events.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">No hay eventos globales activos.</p>';
        return;
      }

      const eventsHTML = events.map(event => {
        const timeLeft = event.endsAt - Date.now();
        const minutesLeft = Math.floor(timeLeft / 60000);
        const secondsLeft = Math.floor((timeLeft % 60000) / 1000);

        const eventIcons = {
          zombie_horde: 'üßü',
          airdrop: 'üì¶',
          traveling_merchant: 'üõí',
          weather: '‚òî'
        };

        const eventColors = {
          zombie_horde: '#ff0000',
          airdrop: '#00ff00',
          traveling_merchant: '#ffaa00',
          weather: '#4488ff'
        };

        const icon = eventIcons[event.type] || 'üåç';
        const color = eventColors[event.type] || '#888';

        let actionButton = '';
        if (event.type === 'airdrop' && event.status === 'active') {
          actionButton = `
            <button onclick="claimAirdrop('${event.id}')" style="
              background: #00ff00;
              color: #000;
              border: none;
              padding: 12px 24px;
              border-radius: 6px;
              cursor: pointer;
              font-weight: bold;
              width: 100%;
              margin-top: 10px;
              font-size: 14px;
            ">üì¶ RECLAMAR AIRDROP</button>
          `;
        } else if (event.type === 'traveling_merchant' && event.status === 'active') {
          actionButton = `
            <button onclick="showMerchantInventory('${event.id}')" style="
              background: #ffaa00;
              color: #000;
              border: none;
              padding: 12px 24px;
              border-radius: 6px;
              cursor: pointer;
              font-weight: bold;
              width: 100%;
              margin-top: 10px;
              font-size: 14px;
            ">üõí VER TIENDA</button>
          `;
        }

        return `
          <div class="event-card" style="
            background: linear-gradient(135deg, rgba(0,0,0,0.9) 0%, rgba(30,30,30,0.95) 100%);
            border: 3px solid ${color};
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 0 20px ${color}50;
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <h3 style="margin: 0; color: ${color}; font-size: 18px; font-weight: bold;">
                ${icon} ${event.title}
              </h3>
              <span style="
                background: ${color};
                color: #000;
                padding: 6px 12px;
                border-radius: 6px;
                font-size: 12px;
                font-weight: bold;
              ">
                ‚è±Ô∏è ${minutesLeft}m ${secondsLeft}s
              </span>
            </div>

            <p style="font-size: 13px; color: #ddd; margin: 12px 0; line-height: 1.5;">
              ${event.description}
            </p>

            ${event.location ? `
              <div style="margin: 10px 0; font-size: 12px; color: #ffaa00;">
                üìç Ubicaci√≥n: ${event.location}
              </div>
            ` : ''}

            ${event.effects ? `
              <div style="margin: 10px 0; font-size: 11px; color: #ff6666;">
                ‚ö†Ô∏è Efectos: ${JSON.stringify(event.effects)}
              </div>
            ` : ''}

            ${actionButton}
          </div>
        `;
      }).join('');

      container.innerHTML = eventsHTML;
    }

    function claimAirdrop(eventId) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        showNotification('No hay conexi√≥n con el servidor', 'warning');
        return;
      }

      ws.send(JSON.stringify({
        type: 'claim_airdrop',
        eventId,
        playerId: player.id
      }));
    }

    function showMerchantInventory(eventId) {
      // Solicitar inventario del comerciante
      requestActiveEvents();
      
      // Buscar el evento del comerciante
      // Esto se implementar√° despu√©s con un modal
      showNotification('üõí Sistema de tienda en desarrollo', 'info');
    }

    function buyFromMerchant(eventId, itemId) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        showNotification('No hay conexi√≥n con el servidor', 'warning');
        return;
      }

      ws.send(JSON.stringify({
        type: 'buy_from_merchant',
        eventId,
        itemId,
        playerId: player.id
      }));
    }

    // ====================================
    // FASE 11: MISIONES DIN√ÅMICAS
    // ====================================

    function requestDynamicQuests() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ 
        type: 'get_dynamic_quests', 
        playerId: player.id 
      }));
    }

    function renderDynamicQuests(available, accepted) {
      const container = document.getElementById('dynamicQuestsContainer');
      if (!container) return;

      if ((!available || available.length === 0) && (!accepted || accepted.length === 0)) {
        container.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">No hay misiones din√°micas disponibles.</p>';
        return;
      }

      let html = '';

      if (accepted && accepted.length > 0) {
        html += '<h3 style="color: #ffaa00; margin-bottom: 15px;">üéØ Misiones Aceptadas</h3>';
        html += accepted.map(quest => renderDynamicQuestCard(quest, true)).join('');
      }

      if (available && available.length > 0) {
        html += '<h3 style="color: #4488ff; margin: 20px 0 15px 0;">‚ú® Misiones Disponibles</h3>';
        html += available.map(quest => renderDynamicQuestCard(quest, false)).join('');
      }

      container.innerHTML = html;
    }

    function renderDynamicQuestCard(quest, isAccepted) {
      const typeIcons = {
        romance: 'üíï',
        matchmaker: 'üíò',
        mediation: 'üïäÔ∏è',
        rivalry: '‚öîÔ∏è',
        jealousy: 'üòí',
        investigation: 'üîç'
      };

      const typeColors = {
        romance: '#ff4488',
        matchmaker: '#ff88cc',
        mediation: '#44ff44',
        rivalry: '#ffaa00',
        jealousy: '#aa00aa',
        investigation: '#4488ff'
      };

      const icon = typeIcons[quest.type] || '‚ö°';
      const color = typeColors[quest.type] || '#888';
      
      const timeLeft = quest.expiresAt - Date.now();
      const minutesLeft = Math.floor(timeLeft / 60000);
      const isExpiringSoon = minutesLeft < 3;

      return `
        <div class="quest-card-dynamic" style="
          background: linear-gradient(135deg, rgba(0,0,0,0.9) 0%, rgba(30,30,30,0.95) 100%);
          border: 2px solid ${color};
          border-radius: 10px;
          padding: 18px;
          margin-bottom: 18px;
          ${isExpiringSoon ? 'animation: pulse 1s infinite;' : ''}
        ">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
            <h4 style="margin: 0; color: ${color}; font-size: 16px;">
              ${icon} ${quest.title}
            </h4>
            <span style="
              background: ${isExpiringSoon ? '#ff0000' : '#333'};
              color: white;
              padding: 5px 10px;
              border-radius: 5px;
              font-size: 11px;
              font-weight: bold;
            ">
              ‚è±Ô∏è ${minutesLeft}min
            </span>
          </div>

          <p style="font-size: 12px; color: #ccc; margin: 12px 0; line-height: 1.5;">
            ${quest.description}
          </p>

          <div style="margin: 12px 0;">
            <strong style="color: ${color}; font-size: 12px;">OBJETIVOS:</strong>
            <ul style="margin: 5px 0; padding-left: 20px; font-size: 11px; color: #aaa;">
              ${quest.objectives.map(obj => {
                let objText = obj.type || obj;
                if (obj.item) objText += `: ${obj.item} x${obj.required || 1}`;
                if (obj.npc) objText += `: ${obj.npc}`;
                return `<li>${objText}</li>`;
              }).join('')}
            </ul>
          </div>

          ${quest.rewards ? `
            <div style="margin: 12px 0;">
              <strong style="color: #ffaa00; font-size: 12px;">RECOMPENSAS:</strong>
              <div style="font-size: 11px; color: #ffcc00; margin-top: 5px;">
                ${quest.rewards.xp ? `‚≠ê +${quest.rewards.xp} XP` : ''}
                ${quest.rewards.reputacion ? ` | üìä +${quest.rewards.reputacion} Rep` : ''}
                ${quest.rewards.oro ? ` | üí∞ +${quest.rewards.oro} Oro` : ''}
              </div>
            </div>
          ` : ''}

          ${isAccepted ? `
            <button onclick="completeDynamicQuest('${quest.id}', true)" style="
              background: #44ff44;
              color: #000;
              border: none;
              padding: 10px 15px;
              border-radius: 5px;
              cursor: pointer;
              font-weight: bold;
              margin-right: 8px;
              font-size: 13px;
            ">‚úÖ COMPLETAR</button>
            <button onclick="completeDynamicQuest('${quest.id}', false)" style="
              background: #ff4444;
              color: #fff;
              border: none;
              padding: 10px 15px;
              border-radius: 5px;
              cursor: pointer;
              font-size: 13px;
            ">‚ùå FALLAR</button>
          ` : `
            <button onclick="acceptDynamicQuest('${quest.id}')" style="
              background: ${color};
              color: #fff;
              border: none;
              padding: 12px 24px;
              border-radius: 6px;
              cursor: pointer;
              font-weight: bold;
              width: 100%;
              font-size: 14px;
            ">üéØ ACEPTAR MISI√ìN</button>
          `}
        </div>
      `;
    }

    function acceptDynamicQuest(questId) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        showNotification('No hay conexi√≥n con el servidor', 'warning');
        return;
      }

      ws.send(JSON.stringify({
        type: 'accept_dynamic_quest',
        questId,
        playerId: player.id
      }));
    }

    function completeDynamicQuest(questId, success) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        showNotification('No hay conexi√≥n con el servidor', 'warning');
        return;
      }

      const confirmMsg = success 
        ? '¬øCompletaste los objetivos de la misi√≥n din√°mica?' 
        : '¬øQuieres marcar la misi√≥n din√°mica como fallida?';

      if (confirm(confirmMsg)) {
        ws.send(JSON.stringify({
          type: 'complete_dynamic_quest',
          questId,
          playerId: player.id,
          success
        }));
      }
    }

    // Auto-actualizar eventos cada 30 segundos
    setInterval(() => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        requestActiveEvents();
        requestDynamicQuests();
        requestConstructionData(); // FASE 12
      }
    }, 30000);

    // ====================================
    // FIN FASE 11
    // ====================================

    // ====================================
    // FASE 12: SISTEMA DE CONSTRUCCI√ìN
    // ====================================

    function requestConstructionData() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: 'get_structures' }));
      ws.send(JSON.stringify({ type: 'get_construction_projects' }));
      ws.send(JSON.stringify({ type: 'get_refuge_effects' }));
    }

    function renderConstructionStructures(available, completed) {
      const container = document.getElementById('constructionStructuresContainer');
      if (!container) return;

      if (!available || available.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">No hay estructuras disponibles.</p>';
        return;
      }

      const structuresByCategory = {};
      available.forEach(structure => {
        if (!structuresByCategory[structure.category]) {
          structuresByCategory[structure.category] = [];
        }
        structuresByCategory[structure.category].push(structure);
      });

      let html = '';

      const categoryNames = {
        defense: 'üõ°Ô∏è Defensa',
        resource: 'üì¶ Recursos',
        utility: 'üîß Utilidad',
        crafting: 'üõ†Ô∏è Crafteo',
        medical: '‚öïÔ∏è M√©dico',
        storage: 'üè™ Almac√©n',
        communication: 'üì° Comunicaci√≥n',
        training: 'üéØ Entrenamiento'
      };

      for (const [category, structures] of Object.entries(structuresByCategory)) {
        html += `<h4 style="color: #ffaa00; margin: 20px 0 10px 0; border-bottom: 2px solid #ffaa0033; padding-bottom: 8px;">
          ${categoryNames[category] || category.toUpperCase()}
        </h4>`;

        html += structures.map(structure => {
          const costStr = Object.entries(structure.cost)
            .map(([resource, amount]) => `${resource}: ${amount}`)
            .join(' | ');

          const effectsStr = Object.entries(structure.effects)
            .map(([effect, value]) => `${effect}: +${value}`)
            .join(' | ');

          const isMaxLevel = structure.currentLevel >= structure.maxLevel;
          const canBuild = structure.canBuild && !structure.hasActiveProject;

          return `
            <div class="construction-card" style="
              background: linear-gradient(135deg, rgba(0,0,0,0.9) 0%, rgba(30,30,30,0.95) 100%);
              border: 2px solid ${canBuild ? '#44ff44' : (isMaxLevel ? '#ffaa00' : '#888')};
              border-radius: 10px;
              padding: 16px;
              margin-bottom: 16px;
            ">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                <h4 style="margin: 0; color: ${canBuild ? '#44ff44' : '#ffaa00'}; font-size: 15px;">
                  ${structure.icon} ${structure.name}
                  <span style="font-size: 11px; color: #888; margin-left: 8px;">
                    Nivel ${structure.currentLevel}/${structure.maxLevel}
                  </span>
                </h4>
              </div>

              <p style="font-size: 12px; color: #ccc; margin: 10px 0; line-height: 1.4;">
                ${structure.description}
              </p>

              <div style="margin: 10px 0; font-size: 11px;">
                <strong style="color: #ff6666;">COSTO:</strong> ${costStr}
              </div>

              <div style="margin: 10px 0; font-size: 11px;">
                <strong style="color: #66ff66;">EFECTOS:</strong> ${effectsStr}
              </div>

              ${structure.hasActiveProject ? `
                <div style="background: rgba(255,170,0,0.2); padding: 8px; border-radius: 5px; margin-top: 10px; font-size: 11px; color: #ffaa00;">
                  ‚ö†Ô∏è Ya hay un proyecto activo para esta estructura
                </div>
              ` : (isMaxLevel ? `
                <div style="background: rgba(255,215,0,0.2); padding: 8px; border-radius: 5px; margin-top: 10px; font-size: 11px; color: #ffd700;">
                  ‚≠ê Nivel M√°ximo Alcanzado
                </div>
              ` : (canBuild ? `
                <button onclick="startConstruction('${structure.id}')" style="
                  background: #44ff44;
                  color: #000;
                  border: none;
                  padding: 10px 20px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-weight: bold;
                  width: 100%;
                  margin-top: 10px;
                  font-size: 13px;
                ">üèóÔ∏è INICIAR CONSTRUCCI√ìN</button>
              ` : `
                <div style="background: rgba(136,136,136,0.2); padding: 8px; border-radius: 5px; margin-top: 10px; font-size: 11px; color: #888;">
                  ‚ÑπÔ∏è No disponible actualmente
                </div>
              `))}
            </div>
          `;
        }).join('');
      }

      container.innerHTML = html;
    }

    function renderConstructionProjects(projects) {
      const container = document.getElementById('constructionProjectsContainer');
      if (!container) return;

      if (!projects || projects.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">No hay proyectos de construcci√≥n activos.</p>';
        return;
      }

      const html = projects.map(project => {
        const structure = project.structure;
        if (!structure) return '';

        const costStr = Object.entries(structure.cost)
          .map(([resource, amount]) => `${resource}: ${amount}`)
          .join(', ');

        const contributors = Object.keys(project.contributions).length;

        return `
          <div class="project-card" style="
            background: linear-gradient(135deg, rgba(0,100,200,0.1) 0%, rgba(0,50,100,0.2) 100%);
            border: 2px solid #00aaff;
            border-radius: 10px;
            padding: 18px;
            margin-bottom: 18px;
          ">
            <h4 style="color: #00aaff; margin: 0 0 12px 0; font-size: 16px;">
              ${structure.icon} ${structure.name} (Nivel ${project.level})
            </h4>

            <div style="margin: 12px 0;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px;">
                <span style="color: #ccc;">Progreso:</span>
                <span style="color: #00aaff; font-weight: bold;">${project.progress.toFixed(1)}%</span>
              </div>
              <div style="background: #333; height: 20px; border-radius: 10px; overflow: hidden;">
                <div style="
                  background: linear-gradient(90deg, #00aaff 0%, #0088cc 100%);
                  height: 100%;
                  width: ${project.progress}%;
                  transition: width 0.3s ease;
                "></div>
              </div>
            </div>

            <div style="font-size: 11px; color: #aaa; margin: 10px 0;">
              üë• ${contributors} contribuyente(s) | üõ†Ô∏è Costo total: ${costStr}
            </div>

            <button onclick="showContributeModal('${project.id}', '${structure.name}')" style="
              background: #00aaff;
              color: #fff;
              border: none;
              padding: 10px 20px;
              border-radius: 6px;
              cursor: pointer;
              font-weight: bold;
              width: 100%;
              font-size: 13px;
            ">üî® CONTRIBUIR RECURSOS</button>
          </div>
        `;
      }).join('');

      container.innerHTML = html;
    }

    function renderRefugeEffects(effects) {
      const container = document.getElementById('refugeEffectsContainer');
      if (!container) return;

      const effectsList = [
        { key: 'defense', label: 'üõ°Ô∏è Defensa', value: effects.defense, unit: '%' },
        { key: 'foodPerHour', label: 'üçñ Comida/hora', value: effects.foodPerHour, unit: '' },
        { key: 'craftingCostReduction', label: 'üõ†Ô∏è Reducci√≥n crafteo', value: effects.craftingCostReduction, unit: '%' },
        { key: 'hpRegenPerMinute', label: '‚öïÔ∏è Regeneraci√≥n HP', value: effects.hpRegenPerMinute, unit: '/min' },
        { key: 'xpBonus', label: '‚≠ê Bonus XP', value: effects.xpBonus, unit: '%' },
        { key: 'storageCapacity', label: 'üì¶ Capacidad almac√©n', value: effects.storageCapacity, unit: '' }
      ];

      const html = effectsList
        .filter(effect => effect.value > 0)
        .map(effect => `
          <div style="
            background: rgba(68,255,68,0.1);
            border: 1px solid #44ff4444;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
          ">
            <span style="font-size: 13px; color: #ddd;">${effect.label}</span>
            <span style="font-size: 15px; color: #44ff44; font-weight: bold;">
              +${effect.value}${effect.unit}
            </span>
          </div>
        `).join('');

      if (html) {
        container.innerHTML = html;
      } else {
        container.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">No hay beneficios activos a√∫n.</p>';
      }
    }

    function startConstruction(structureId) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        showNotification('No hay conexi√≥n con el servidor', 'warning');
        return;
      }

      if (!confirm('¬øIniciar proyecto de construcci√≥n? Otros jugadores podr√°n contribuir.')) {
        return;
      }

      ws.send(JSON.stringify({
        type: 'start_construction',
        structureId,
        playerId: player.id,
        playerName: player.nombre
      }));
    }

    function showContributeModal(projectId, structureName) {
      const resources = prompt(
        `Contribuir a: ${structureName}\n\n` +
        `Formato: recurso:cantidad, recurso:cantidad\n` +
        `Ejemplo: madera:50, metal:30\n\n` +
        `Recursos disponibles en tu inventario:\n` +
        Object.entries(player.inventario || {})
          .map(([r, q]) => `${r}: ${q}`)
          .join(', ')
      );

      if (!resources) return;

      try {
        const resourcesObj = {};
        resources.split(',').forEach(pair => {
          const [resource, amount] = pair.trim().split(':');
          if (resource && amount) {
            resourcesObj[resource.trim()] = parseInt(amount);
          }
        });

        contributeConstruction(projectId, resourcesObj);
      } catch (error) {
        showNotification('Formato inv√°lido. Usa: recurso:cantidad, recurso:cantidad', 'warning');
      }
    }

    function contributeConstruction(projectId, resources) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        showNotification('No hay conexi√≥n con el servidor', 'warning');
        return;
      }

      ws.send(JSON.stringify({
        type: 'contribute_construction',
        projectId,
        resources,
        playerId: player.id,
        playerName: player.nombre
      }));
    }

    // ====================================
    // FIN FASE 12
    // ====================================

    // ====================================
    // SISTEMA DE MISIONES NARRATIVAS
    // ====================================

    let currentNarrativeMission = null;
    let narrativeTimer = null;
    let narrativeTimeLeft = 0;

    // Cargar misiones disponibles
    function loadNarrativeMissions() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No hay conexi√≥n con el servidor', 'warning');
        return;
      }

      ws.send(JSON.stringify({ type: 'getNarrativeMissions' }));
    }

    // Renderizar lista de misiones
    function renderNarrativeMissions(missions) {
      const container = document.getElementById('narrativeMissionCards');
      
      if (!missions || missions.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #888;">No hay misiones disponibles para tu nivel.</p>';
        return;
      }

      const missionsHTML = missions.map(mission => {
        return `
          <div class="mission-card" style="
            background: linear-gradient(135deg, #1a1a2a 0%, #2a1a2a 100%);
            border: 2px solid #ffaa00;
            border-radius: 8px;
            padding: 15px;
          ">
            <h3 style="color: #ffaa00; margin-bottom: 10px;">${mission.title}</h3>
            <p style="font-size: 11px; color: #ccc; margin-bottom: 10px; line-height: 1.4;">
              ${mission.description}
            </p>
            
            <div style="font-size: 10px; color: #888; margin: 5px 0;">
              üìä Nivel m√≠nimo: ${mission.minLevel}
            </div>
            <div style="font-size: 10px; color: #888; margin: 5px 0;">
              üë• M√°ximo jugadores: ${mission.maxPartySize}
            </div>
            <div style="font-size: 10px; color: #888; margin: 5px 0;">
              ‚è±Ô∏è Duraci√≥n estimada: ${mission.estimatedTime}
            </div>

            <div style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 4px;">
              <div style="font-weight: bold; color: #ffaa00; margin-bottom: 5px;">üéÅ Recompensas</div>
              <div style="font-size: 10px; color: #ffcc00;">
                üë§ Solo: ${mission.rewards.solo.xp} XP + ${Object.entries(mission.rewards.solo.items).map(([k,v]) => `${v} ${k}`).join(', ')}
              </div>
              <div style="font-size: 10px; color: #88ff88;">
                üë• Grupo: ${mission.rewards.group.xp} XP + ${Object.entries(mission.rewards.group.items).map(([k,v]) => `${v} ${k}`).join(', ')}
              </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 15px;">
              <button onclick="startNarrativeMission('${mission.id}', false)" style="
                flex: 1;
                background: #4444ff;
                color: white;
                border: none;
                padding: 10px;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
              ">
                üë§ INICIAR SOLO
              </button>
              <button onclick="startNarrativeMission('${mission.id}', true)" style="
                flex: 1;
                background: #44ff44;
                color: #000;
                border: none;
                padding: 10px;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
              ">
                üë• INICIAR EN GRUPO
              </button>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = missionsHTML;
    }

    // Iniciar misi√≥n narrativa
    function startNarrativeMission(templateId, isGroup) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No hay conexi√≥n con el servidor', 'warning');
        return;
      }

      // Si es grupo, obtener miembros del partido
      let partyMembers = [player.id];
      
      if (isGroup) {
        // TODO: Implementar selector de grupo
        // Por ahora, solo jugador
        if (!confirm('¬øIniciar misi√≥n en modo GRUPO? (Actualmente solo t√∫)')) {
          return;
        }
      }

      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No conectado al servidor', 'warning');
        return;
      }

      ws.send(JSON.stringify({
        type: 'startNarrativeMission',
        templateId,
        isGroup,
        partyMembers
      }));
    }

    // Mostrar misi√≥n en curso
    function showNarrativeMission(mission) {
      currentNarrativeMission = mission;

      // Ocultar lista, mostrar misi√≥n activa
      document.getElementById('narrativeMissionList').style.display = 'none';
      document.getElementById('narrativeMissionActive').style.display = 'block';

      // T√≠tulo
      document.getElementById('narrativeMissionTitle').textContent = `üìñ ${mission.title}`;

      // Modo
      const modeDiv = document.getElementById('narrativeMode');
      if (mission.isGroup) {
        modeDiv.innerHTML = `üë• GRUPO (${mission.partyMembers.length})`;
        modeDiv.style.background = '#44ff44';
        modeDiv.style.color = '#000';
      } else {
        modeDiv.innerHTML = 'üë§ SOLO';
        modeDiv.style.background = '#4444ff';
      }

      // Mostrar paso actual
      if (mission.currentStep) {
        showNarrativeStep(mission.currentStep);
      }
    }

    // Mostrar paso narrativo
    function showNarrativeStep(step) {
      if (!step) {
        console.warn('showNarrativeStep: step is null or undefined. Misi√≥n puede haber finalizado.');
        // Ocultar secci√≥n narrativa si no hay paso
        const narrativeSection = document.getElementById('narrativeMissionPanel');
        if (narrativeSection) {
          narrativeSection.style.display = 'none';
        }
        return;
      }

      // Texto narrativo
      document.getElementById('narrativeStoryText').innerHTML = step.text;

      // Timer
      narrativeTimeLeft = step.timer || 30;
      updateNarrativeTimer();
      
      // Reiniciar timer
      if (narrativeTimer) clearInterval(narrativeTimer);
      narrativeTimer = setInterval(() => {
        narrativeTimeLeft--;
        updateNarrativeTimer();
        
        if (narrativeTimeLeft <= 0) {
          clearInterval(narrativeTimer);
          // Auto-seleccionar opci√≥n aleatoria
          autoSelectNarrativeChoice();
        }
      }, 1000);

      // Estilo del timer seg√∫n urgencia
      const timerDiv = document.getElementById('narrativeTimer');
      if (step.critical) {
        timerDiv.style.background = '#ff0000';
        timerDiv.style.animation = 'pulse 0.5s infinite';
      } else if (step.danger) {
        timerDiv.style.background = '#ff6600';
      } else {
        timerDiv.style.background = '#ff4444';
        timerDiv.style.animation = 'none';
      }

      // Votaci√≥n (si es grupo)
      if (currentNarrativeMission.isGroup) {
        document.getElementById('narrativeVoting').style.display = 'block';
        document.getElementById('voteCount').textContent = `Votos: 0 / ${currentNarrativeMission.partyMembers.length}`;
      } else {
        document.getElementById('narrativeVoting').style.display = 'none';
      }

      // Opciones
      renderNarrativeChoices(step.choices);
    }

    // Actualizar timer
    function updateNarrativeTimer() {
      document.getElementById('narrativeTimer').textContent = `‚è±Ô∏è ${narrativeTimeLeft}s`;
    }

    // Renderizar opciones
    function renderNarrativeChoices(choices) {
      const container = document.getElementById('narrativeChoices');
      
      const choicesHTML = choices.map(choice => {
        return `
          <button onclick="makeNarrativeChoice('${choice.id}')" class="narrative-choice-btn" style="
            background: linear-gradient(135deg, #2a2a4a 0%, #3a2a4a 100%);
            border: 2px solid #ffaa00;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            text-align: left;
            color: white;
            font-size: 13px;
            transition: all 0.3s;
          " onmouseover="this.style.borderColor='#ffff00'; this.style.transform='scale(1.05)'" onmouseout="this.style.borderColor='#ffaa00'; this.style.transform='scale(1)'">
            ${choice.text}
          </button>
        `;
      }).join('');

      container.innerHTML = choicesHTML;
    }

    // Hacer elecci√≥n
    function makeNarrativeChoice(choiceId) {
      if (!currentNarrativeMission) return;

      // Detener timer
      if (narrativeTimer) {
        clearInterval(narrativeTimer);
        narrativeTimer = null;
      }

      // Validar conexi√≥n
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No conectado al servidor', 'warning');
        return;
      }

      // Enviar elecci√≥n
      if (currentNarrativeMission.isGroup) {
        // Votar
        ws.send(JSON.stringify({
          type: 'narrativeVote',
          missionId: currentNarrativeMission.id,
          choiceId
        }));

        log('‚úÖ Voto registrado. Esperando a los dem√°s...', 'info');
      } else {
        // Elecci√≥n directa
        ws.send(JSON.stringify({
          type: 'narrativeChoice',
          missionId: currentNarrativeMission.id,
          choiceId
        }));
      }

      // Deshabilitar botones
      document.querySelectorAll('.narrative-choice-btn').forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
      });
    }

    // Auto-seleccionar si se acaba el tiempo
    function autoSelectNarrativeChoice() {
      if (!currentNarrativeMission) return;
      
      const step = currentNarrativeMission.currentStep;
      if (step && step.choices && step.choices.length > 0) {
        // Elegir la √∫ltima opci√≥n (generalmente la m√°s segura/cobarde)
        const lastChoice = step.choices[step.choices.length - 1];
        log('‚è∞ ¬°Tiempo agotado! Elecci√≥n autom√°tica...', 'warning');
        makeNarrativeChoice(lastChoice.id);
      }
    }

    // Abandonar misi√≥n
    function abandonNarrativeMission() {
      if (!confirm('¬øSeguro que quieres abandonar la misi√≥n?')) return;

      currentNarrativeMission = null;
      if (narrativeTimer) {
        clearInterval(narrativeTimer);
        narrativeTimer = null;
      }

      document.getElementById('narrativeMissionActive').style.display = 'none';
      document.getElementById('narrativeMissionList').style.display = 'block';

      log('Misi√≥n abandonada', 'warning');
    }

    // Mostrar completado
    function showNarrativeMissionCompleted(rewards, summary) {
      if (narrativeTimer) {
        clearInterval(narrativeTimer);
        narrativeTimer = null;
      }

      playSound('achievement');

      // Validar rewards y summary con valores por defecto
      const missionRewards = rewards || { xp: 0, health: 0, items: {} };
      const missionSummary = summary || {};
      const title = missionSummary.title || 'Misi√≥n Narrativa';
      const duration = missionSummary.duration || '0m';
      const mode = missionSummary.mode || 'Solo';
      const kills = missionSummary.kills || 0;

      let summaryHTML = `
        <div style="
          background: linear-gradient(135deg, #1a4a1a 0%, #2a5a2a 100%);
          border: 3px solid #44ff44;
          border-radius: 12px;
          padding: 25px;
          text-align: center;
        ">
          <h2 style="color: #44ff44; font-size: 24px; margin-bottom: 15px;">
            ‚úÖ ¬°MISI√ìN COMPLETADA!
          </h2>
          
          <div style="font-size: 18px; margin: 10px 0;">
            ${title}
          </div>
          
          <div style="display: flex; justify-content: center; gap: 30px; margin: 20px 0; font-size: 14px;">
            <div>‚è±Ô∏è ${duration}</div>
            <div>${mode === 'Grupo' ? 'üë•' : 'üë§'} ${mode}</div>
            <div>üßü ${kills} Kills</div>
          </div>

          <div style="
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
          ">
            <div style="font-size: 16px; color: #ffaa00; margin-bottom: 10px;">üéÅ RECOMPENSAS</div>
            <div style="font-size: 14px;">
              ‚≠ê +${missionRewards.xp} XP<br>
              ‚ù§Ô∏è ${missionRewards.health > 0 ? '+' : ''}${missionRewards.health} Salud<br>
              üéí ${Object.entries(missionRewards.items || {}).map(([k,v]) => `${v} ${k}`).join(', ') || 'Ninguno'}
            </div>
          </div>

          <button onclick="closeNarrativeMissionComplete()" style="
            background: #44ff44;
            color: #000;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            margin-top: 15px;
          ">
            ‚úÖ CONTINUAR
          </button>
        </div>
      `;

      document.getElementById('narrativeStoryText').innerHTML = summaryHTML;
      document.getElementById('narrativeChoices').innerHTML = '';
      document.getElementById('narrativeTimer').style.display = 'none';
    }

    function closeNarrativeMissionComplete() {
      currentNarrativeMission = null;
      document.getElementById('narrativeMissionActive').style.display = 'none';
      document.getElementById('narrativeMissionList').style.display = 'block';
      document.getElementById('narrativeTimer').style.display = 'block';
      
      loadNarrativeMissions();
      renderGame();
    }

    // ====================================
    // FIN SISTEMA DE MISIONES NARRATIVAS
    // ====================================

    // ====================================
    // FIN SISTEMA DE MUNDO VIVO
    // ====================================

    function rest() {
      if (!player) return;
      
      player.salud = Math.min(100, player.salud + 10);
      player.hambre = Math.max(0, player.hambre - 5);
      
      log('üò¥ Descansaste un momento. +10 salud', 'success');
      renderGame();
    }

    function eat() {
      if (!player || !player.inventario.comida || player.inventario.comida <= 0) {
        showNotification('No tienes comida', 'warning');
        return;
      }
      
      player.inventario.comida--;
      player.hambre = Math.min(100, player.hambre + 40);
      player.salud = Math.min(100, player.salud + 5);
      
      log('üçñ Comiste. +40 hambre, +5 salud', 'success');
      renderGame();
    }

    function connectWebSocket() {
      // Limpiar intervalo anterior si existe
      if (pingInterval) clearInterval(pingInterval);
      if (reconnectTimeout) clearTimeout(reconnectTimeout);
      
      // Exponential backoff para reconexi√≥n
      if (!window.reconnectAttempts) window.reconnectAttempts = 0;
      if (!window.maxReconnectAttempts) window.maxReconnectAttempts = 5;
      
      // Detectar si usar ws:// o wss:// seg√∫n el protocolo de la p√°gina
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}`);
      
      ws.onopen = () => {
        log('‚úÖ Conectado al servidor', 'success');
        playSound('success');
        window.reconnectAttempts = 0; // Reset contador
        
        ws.send(JSON.stringify({ type: 'login', playerId: player.id }));
        
        // Solicitar estado completo del mundo
        ws.send(JSON.stringify({ type: 'getWorld' }));
        
        // Solicitar lista de jugadores online
        ws.send(JSON.stringify({ type: 'getPlayers' }));
        
        // Solicitar misiones narrativas en curso (por si fue una reconexi√≥n)
        ws.send(JSON.stringify({ type: 'getNarrativeMissions' }));
        
        // Procesar cola de mensajes pendientes
        if (messageQueue.length > 0) {
          log(`üì§ Enviando ${messageQueue.length} mensajes pendientes...`, 'info');
          setTimeout(() => processMessageQueue(), 500);
        }
        
        // Actualizar indicador de conexi√≥n
        const statusEl = document.getElementById('connectionStatus');
        if (statusEl) {
          statusEl.className = 'connection-status connected';
          statusEl.innerHTML = 'üü¢ Conectado';
        }
        
        // Mostrar mensaje de bienvenida con comandos
        setTimeout(() => {
          addSystemMessage('¬°Bienvenido! Escribe /help en el chat para ver comandos disponibles.\nAtajos de teclado: S=Buscar, C=Combate, T=Comerciar, H=Hablar');
        }, 1000);
        
        // Iniciar ping cada 30 segundos para mantener conexi√≥n activa
        pingInterval = setInterval(() => {
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'ping' }));
          }
        }, 30000);
      };
      
      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        handleMessage(msg);
      };
      
      ws.onclose = () => {
        log('Desconectado del servidor', 'warning');
        if (pingInterval) clearInterval(pingInterval);
        
        // Actualizar indicador de conexi√≥n
        const statusEl = document.getElementById('connectionStatus');
        if (statusEl) {
          statusEl.className = 'connection-status disconnected pulse';
          statusEl.innerHTML = 'üî¥ Desconectado';
        }
        
        // Intentar reconectar con exponential backoff
        if (window.reconnectAttempts < window.maxReconnectAttempts) {
          window.reconnectAttempts++;
          const delay = Math.min(1000 * Math.pow(2, window.reconnectAttempts - 1), 16000);
          log(`Reconectando en ${delay/1000}s... (intento ${window.reconnectAttempts}/${window.maxReconnectAttempts})`, 'warning');
          
          reconnectTimeout = setTimeout(() => {
            connectWebSocket();
          }, delay);
        } else {
          log('‚ùå No se pudo reconectar. Recarga la p√°gina.', 'warning');
          if (statusEl) statusEl.innerHTML = 'üî¥ Sin conexi√≥n';
        }
      };
      
      ws.onerror = (error) => {
        log('Error de conexi√≥n', 'warning');
      };
    }

    // ====================================
    // WEBSOCKET HANDLERS (Organizado por tipo)
    // ====================================
    const messageHandlers = {
      'player:data': (msg) => {
        // Recibir datos actualizados del jugador desde el servidor
        if (msg.player) {
          player = msg.player;
          console.log('‚úÖ Datos del jugador actualizados:', player.nombre);
          renderGame();
        }
      },
      
      'world:state': (msg) => {
        world = msg.world;
        console.log('üì¶ Mundo recibido:', world);
        if (world.players && world.players[player.id]) {
          player = world.players[player.id];
        }
        renderGame();
      },
      
      'moved': (msg) => {
        log(`Te moviste a: ${msg.location.nombre}`, 'success');
        player.locacion = msg.location.id;
        playSound('move');
        renderGame();
        checkSocialAccess(); // Verificar acceso a fogata y juegos
      },
      
      'scavenge:result': (msg) => {
        const items = Object.entries(msg.found).map(([k,v]) => `${k}:${v}`).join(', ');
        log(`Encontraste: ${items || 'nada'}`, 'success');
        if (msg.inventario) player.inventario = msg.inventario;
        if (items) playSound('loot');
        renderGame();
      },
      
      'combat': (msg) => {
        log(msg.message, 'combat');
        player.salud = msg.salud;
        renderGame();
      },
      
      // ===== SISTEMA DE COMBATE POR TURNOS =====
      'combat:started': (msg) => {
        player.inCombat = {
          zombieHP: msg.zombie.hp,
          zombieMaxHP: msg.zombie.maxHP,
          turno: msg.turno
        };
        log(msg.message, 'combat');
        renderGame();
      },

      'combat:turn_result': (msg) => {
        const r = msg.resultado;
        
        // Ataque del jugador
        let combatLog = `‚öîÔ∏è Atacaste: ${r.playerAttack.damage} da√±o`;
        if (r.playerAttack.critical) combatLog += ' ¬°CR√çTICO!';
        log(combatLog, 'combat');
        
        // Efectos visuales para ataque del jugador
        showDamageNumber(r.playerAttack.damage, r.playerAttack.critical, false, 'right');
        
        // Ataque del zombie
        if (r.zombieAttack.dodged) {
          log(`‚ú® ¬°Esquivaste el ataque del zombie!`, 'success');
        } else if (r.zombieAttack.damage > 0) {
          log(`üßü Zombie te atac√≥: ${r.zombieAttack.damage} da√±o`, 'warning');
          showDamageNumber(r.zombieAttack.damage, false, false, 'left');
          shakeScreen();
        }
        
        player.inCombat = {
          zombieHP: msg.zombie.hp,
          zombieMaxHP: msg.zombie.maxHP,
          turno: msg.turno
        };
        player.salud = msg.player.hp;
        player.saludMaxima = msg.player.maxHP;
        
        log(msg.message, 'combat');
        renderGame();
      },

      'combat:result': (msg) => {
        const r = msg.resultado;
        
        if (r.combatEnded) {
          if (r.playerWon) {
            log(`üéâ ¬°Victoria! ${msg.message}`, 'success');
            
            const lootItems = Object.entries(r.loot || {});
            if (lootItems.length > 0) {
              log(`üì¶ Loot: ${lootItems.map(([k,v]) => `${k} x${v}`).join(', ')}`, 'success');
            }
            
            player.inventario = msg.player.inventario;
            playSound('achievement');
          } else {
            log(msg.message, 'warning');
            playSound('recibo_dano');
          }
          
          delete player.inCombat;
        }
        
        player.salud = msg.player.hp;
        if (msg.player.maxHP) player.saludMaxima = msg.player.maxHP;
        if (msg.zombiesRemaining !== undefined && world.locations[player.locacion]) {
          world.locations[player.locacion].zombies = msg.zombiesRemaining;
        }
        
        renderGame();
      },

      'combat:fled': (msg) => {
        if (msg.success) {
          log(msg.message, 'success');
        } else {
          log(msg.message, 'warning');
          if (msg.damage) player.salud = msg.player.hp;
        }
        delete player.inCombat;
        renderGame();
      },

      'player:respawn': (msg) => {
        log(msg.message || 'Reapareciste en el refugio', 'warning');
        player.salud = msg.player.salud;
        player.locacion = msg.player.locacion;
        delete player.inCombat;
        renderGame();
      },
      
      // Legacy combat result (para compatibilidad)
      'combat:result_legacy': (msg) => {
        // Reproducir sonido si viene en el mensaje
        if (msg.playSound) playSound(msg.playSound);
        
        let combatMsg = `‚öîÔ∏è Eliminaste ${msg.killed} zombies`;
        if (msg.critico) combatMsg += ' ¬°CR√çTICO!';
        if (msg.falloSigilo) combatMsg = 'üö´ Fallo de sigilo! Te detectaron y te hirieron.';
        const lootItems = Object.entries(msg.loot || {});
        if (lootItems.length > 0) {
          combatMsg += ' | Loot: ' + lootItems.map(([k,v]) => `${k}:${v}`).join(', ');
        }
        const zombieInfo = msg.zombiesMax ? `${msg.remaining}/${msg.zombiesMax}` : msg.remaining;
        log(`${combatMsg}. Quedan: ${zombieInfo}`, 'combat');
        player.inventario = msg.inventario;
        
        // Actualizar info de ubicaci√≥n actual
        if (world && world.locations && world.locations[player.locacion]) {
          world.locations[player.locacion].zombies = msg.remaining;
          if (msg.zombiesMax) world.locations[player.locacion].zombiesInitial = msg.zombiesMax;
        }
        
        renderGame();
      },
      
      'craft:success': (msg) => {
        log(`üî® Crafteaste: ${msg.item}`, 'success');
        if (msg.defensas && world.locations?.refugio) {
          world.locations.refugio.defensas = msg.defensas;
        }
        if (msg.inventario) player.inventario = msg.inventario;
        playSound('craft');
        renderGame();
      },
      
      'level:up': (msg) => {
        player.nivel = msg.nivel;
        player.xpParaSiguienteNivel = msg.xpMax;
        player.xp = 0;
        playSound('levelup');
        showNotification(`üéâ ¬°NIVEL ${msg.nivel}!`, 'success');
        renderGame();
      },
      
      'xp:gained': (msg) => {
        log(`+${msg.amount} XP (${msg.xp}/${msg.xpMax})`, 'success');
        player.xp = msg.xp;
        player.xpParaSiguienteNivel = msg.xpMax;
        renderGame();
      },
      
      'world:event': (msg) => {
        worldLog(msg.message, msg.category);
        const mundoTab = document.getElementById('tab-mundo');
        if (mundoTab && !mundoTab.classList.contains('active')) {
          showBadge('mundo');
        }
      },
      
      'location:update': (msg) => {
        if (world && world.locations && msg.location) {
          const loc = world.locations[msg.location.id];
          if (loc) {
            loc.zombies = msg.location.zombies;
            if (msg.location.zombiesMax) loc.zombiesInitial = msg.location.zombiesMax;
            if (msg.location.nivelRuido !== undefined) loc.nivelRuido = msg.location.nivelRuido;
            renderGame();
          }
        }
      },
      
      'player:joined': (msg) => {
        worldLog(`üë§ ${msg.nombre} se uni√≥`, 'success');
        // Solicitar lista actualizada de jugadores
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'getPlayers' }));
        }
        renderGame();
      },
      
      'player:left': (msg) => {
        worldLog(`üë§ ${msg.nombre} se desconect√≥`, 'warning');
      },
      
      'players:list': (msg) => {
        console.log('üéÆ Lista de jugadores recibida:', msg.players);
        console.log('üéÆ Cantidad de jugadores:', msg.players?.length);
        
        // Actualizar mapa de conexiones (para featured story y otros)
        if (!window.connections) window.connections = new Map();
        window.connections.clear();
        if (msg.players && Array.isArray(msg.players)) {
          msg.players.forEach(p => {
            window.connections.set(p.id, p);
          });
        }
        
        renderOnlinePlayers(msg.players);
        updateTradePlayerSelect(msg.players);
      },
      
      'chat:message': (msg) => {
        addChatMessage(msg);
        if (msg.playerId !== player.id) {
          const socialTab = document.getElementById('tab-social');
          if (socialTab && !socialTab.classList.contains('active')) {
            showBadge('social');
          }
        }
      },
      
      'achievement:unlocked': (msg) => {
        handleAchievementUnlocked(msg.achievement);
        if (!player.achievements) player.achievements = {};
        player.achievements[msg.achievement.id] = { desbloqueado: true, fecha: Date.now() };
        playSound('achievement');
        renderAchievements();
      },
      
      'mission:completed': (msg) => {
        showNotification(`‚úÖ Misi√≥n: ${msg.mission?.descripcion}`, 'success');
        if (msg.inventario) player.inventario = msg.inventario;
        if (world.activeMissions) {
          const mission = world.activeMissions.find(m => m.id === msg.mission?.id);
          if (mission && !mission.completedBy.includes(player.id)) {
            mission.completedBy.push(player.id);
          }
        }
        renderGame();
      },
      
      'dm:received': (msg) => {
        // Agregar a log local
        if (!directMessages[msg.from]) directMessages[msg.from] = [];
        directMessages[msg.from].push({
          from: msg.from,
          to: player.id,
          message: msg.message,
          timestamp: Date.now(),
          sent: false
        });
        
        // Incrementar contador de no le√≠dos
        unreadDMs++;
        updateDMBadge();
        
        // Notificaci√≥n
        playSound('warning');
        log(`üíå Mensaje privado de ${msg.fromName || allPlayers[msg.from] || 'Desconocido'}`, 'warning');
        
        // Si est√° viendo DMs de ese jugador, actualizar
        if (currentDMTarget === msg.from) {
          renderDMs();
          unreadDMs--;
          updateDMBadge();
        }
        
        // Badge en tab social
        const socialTab = document.getElementById('tab-social');
        if (socialTab && !socialTab.classList.contains('active')) {
          showBadge('social');
        }
      },
      
      'dm:sent': (msg) => {
        playSound('success');
      },
      
      'trade:offer_received': (msg) => {
        log(`üì¶ ${msg.fromName} te ofrece: ${msg.offer.item} x${msg.offer.cantidad} por ${msg.offer.request.item} x${msg.offer.request.cantidad}`, 'warning');
        showNotification(`üì¶ Oferta de comercio de ${msg.fromName}`, 'warning');
        playSound('notification');
      },
      
      'trade:success': (msg) => {
        log(msg.message, 'success');
        if (msg.inventario) player.inventario = msg.inventario;
        renderGame();
      },
      
      'donate:success': (msg) => {
        log(`üíù Donaste ${msg.cantidad} ${msg.item} al refugio (+${msg.xpGain} XP)`, 'success');
        player.inventario = msg.inventario;
        player.xp += msg.xpGain;
        playSound('success');
        showNotification(`¬°Gracias por tu donaci√≥n! +${msg.xpGain} XP`, 'success');
        renderGame();
      },
      
      'refugio:recursos': (msg) => {
        if (world.locations && world.locations.refugio) {
          world.locations.refugio.recursos = msg.recursos;
          renderRefugioRecursos();
        }
      },
      
      // ===== MUNDO VIVO =====
      'world:events': (msg) => {
        renderWorldEvents(msg.events);
        // Badge si hay nuevos eventos y no est√° en el tab
        const mundoTab = document.getElementById('tab-mundo');
        if (mundoTab && !mundoTab.classList.contains('active') && msg.events && msg.events.length > 0) {
          showBadge('mundo');
        }
      },
      
      'world:relationships': (msg) => {
        renderIntenseRelationships(msg.relationships);
      },
      
      'world:fullState': (msg) => {
        renderWorldStats(msg.state);
        
        // Renderizar acciones de NPCs si hay
        if (msg.state.recentNpcActions) {
          renderNpcActions(msg.state.recentNpcActions);
        }
      },
      
      'quests:list': (msg) => {
        renderQuests(msg.quests);
      },
      
      'quest:accepted': (msg) => {
        log(`‚úÖ Misi√≥n aceptada: ${msg.quest.title}`, 'success');
        playSound('achievement');
        refreshQuests();
      },
      
      'quest:completed': (msg) => {
        log(msg.result.message, 'success');
        if (msg.result.rewards) {
          const r = msg.result.rewards;
          const rewards = [];
          if (r.xp) rewards.push(`+${r.xp} XP`);
          if (r.reputacion) rewards.push(`+${r.reputacion} Reputaci√≥n`);
          if (r.oro) rewards.push(`+${r.oro} Oro`);
          log(`üéÅ Recompensas: ${rewards.join(', ')}`, 'success');
        }
        player = { ...player, ...msg.player };
        playSound('achievement');
        renderGame();
        refreshQuests();
      },
      
      // ===== MISIONES NARRATIVAS =====
      'narrative:missions': (msg) => {
        renderNarrativeMissions(msg.missions);
      },
      
      'narrative:started': (msg) => {
        log(`üìñ Misi√≥n iniciada: ${msg.mission.title}`, 'success');
        showNarrativeMission(msg.mission);
        playSound('achievement');
      },
      
      'narrative:nextStep': (msg) => {
        if (msg.effects) {
          // Mostrar efectos brevemente
          if (msg.effects.damage) {
            log(`üíî Recibiste da√±o: ${msg.effects.damage}`, 'combat');
          }
          if (msg.effects.loot) {
            log(`üéí Conseguiste items`, 'success');
          }
        }
        
        // Mostrar siguiente paso (solo si hay paso)
        setTimeout(() => {
          if (msg.step) {
            showNarrativeStep(msg.step);
          } else {
            console.log('No hay paso siguiente, probablemente misi√≥n completada');
          }
        }, 500);
      },
      
      'narrative:completed': (msg) => {
        log(`‚úÖ ¬°Misi√≥n completada!`, 'success');
        showNarrativeMissionCompleted(msg.rewards, msg.summary);
        
        // Limpiar evento narrativo del mundo
        if (world) {
          delete world.activeNarrativeEvent;
          renderSpecialEvent(); // Re-renderizar para mostrar eventos regulares
        }
      },
      
      'narrative:voted': (msg) => {
        document.getElementById('voteCount').textContent = `Votos: ${msg.votesCount} / ${msg.totalMembers}`;
        log(`‚úÖ Voto registrado (${msg.votesCount}/${msg.totalMembers})`, 'info');
      },
      
      'narrative:active': (msg) => {
        if (msg.mission) {
          showNarrativeMission(msg.mission);
        }
      },
      
      'pong': (msg) => {
        // Respuesta al ping, mantener conexi√≥n activa
      },
      
      'mission:new': (msg) => {
        const missionDesc = msg.mission?.descripcion || msg.mission?.description || msg.mission?.titulo || msg.mission?.title || 'Misi√≥n disponible';
        log(`üéØ Nueva misi√≥n: ${missionDesc}`, 'info');
        showBadge('missions', 1);
        // Refrescar lista de misiones si est√° en la pesta√±a mundo
        if (document.getElementById('tab-mundo').style.display !== 'none') {
          refreshQuests();
        }
      },
      
      'mission:expired': (msg) => {
        log(`‚è∞ Misi√≥n expirada`, 'warning');
      },
      
      'world:update': (msg) => {
        log(msg.message, 'info');
        worldLog(msg.message, 'info');
      },
      
      'event:bad_outcome': (msg) => {
        log(`‚ö†Ô∏è ${msg.message}`, 'warning');
        playSound('error');
      },
      
      'event:resolved_broadcast': (msg) => {
        log(`‚úÖ Evento resuelto: ${msg.message}`, 'success');
      },

      // ===== MISIONES DE NPCs =====
      'npc:talk': (msg) => {
        log(`${msg.npcName}: "${msg.dialogo}"`, 'info');
        if (msg.playSound) {
          playSound(msg.playSound);
        }
        if (msg.inventario) {
          player.inventario = msg.inventario;
        }
        if (msg.npcState) {
          world.npcs[msg.npcId] = msg.npcState;
        }
        renderGame();
      },

      'npc:mission_accepted': (msg) => {
        player.activeMission = msg.mission;
        log(`üìú Misi√≥n aceptada: ${msg.mission.descripcion}`, 'success');
        showActionFeedback(msg.message, 'success');
        playSound('achievement');
        renderGame();
      },

      'npc:mission_completed': (msg) => {
        delete player.activeMission;
        log(`‚úÖ ${msg.message}`, 'success');
        
        const rewards = [];
        if (msg.recompensas.xp) rewards.push(`+${msg.recompensas.xp} XP`);
        if (msg.recompensas.reputacion) rewards.push(`+${msg.recompensas.reputacion} Reputaci√≥n`);
        Object.keys(msg.recompensas).forEach(key => {
          if (key !== 'xp' && key !== 'reputacion') {
            rewards.push(`+${msg.recompensas[key]} ${key}`);
          }
        });
        
        showActionFeedback(`üéÅ Recompensas: ${rewards.join(', ')}`, 'success');
        playSound('level_up');
        renderGame();
      },

      'npc:resource_given': (msg) => {
        log(`‚úÖ ${msg.message}`, 'success');
        showActionFeedback(msg.message, 'success');
        playSound('item_pickup');
        renderGame();
      },

      // ===== GRUPOS =====
      'group:created': (msg) => {
        currentGroup = msg.group;
        log(`üë• ${msg.message}`, 'success');
        showActionFeedback(msg.message, 'success');
        renderGroupPanel();
        playSound('achievement');
      },

      'group:joined': (msg) => {
        currentGroup = msg.group;
        log(`üë• ${msg.message}`, 'success');
        showActionFeedback(msg.message, 'success');
        renderGroupPanel();
        playSound('achievement');
      },

      'group:left': (msg) => {
        currentGroup = null;
        log(`üö™ ${msg.message}`, 'info');
        showActionFeedback(msg.message, 'info');
        renderGroupPanel();
      },

      'group:member_joined': (msg) => {
        currentGroup = msg.group;
        log(`üë• ${msg.message}`, 'info');
        addGroupChatMessage(`SISTEMA: ${msg.message}`);
        renderGroupPanel();
      },

      'group:member_left': (msg) => {
        currentGroup = msg.group;
        log(`üö™ ${msg.message}`, 'info');
        addGroupChatMessage(`SISTEMA: ${msg.message}`);
        renderGroupPanel();
      },

      'group:chat_message': (msg) => {
        addGroupChatMessage(`${msg.message.jugador}: ${msg.message.mensaje}`);
      },

      'group:list_response': (msg) => {
        renderAvailableGroups(msg.groups);
      },

      // ===== MISIONES DIN√ÅMICAS =====
      'quests': (msg) => {
        // Normalizar formato de misiones (espa√±ol -> ingl√©s)
        const normalizeQuest = (q) => ({
          id: q.id,
          title: q.title || q.titulo,
          description: q.description || q.descripcion,
          type: q.type || q.tipo,
          objectives: q.objectives || q.objetivos || [],
          rewards: q.rewards || q.recompensas || {},
          estado: q.estado || q.status,
          expiresAt: q.expiresAt || q.expira_en || (Date.now() + 600000), // 10 min default
          npcsInvolved: q.npcsInvolved || q.npcs || [],
          isDynamic: q.isDynamic || false
        });

        // Combinar misiones disponibles y activas
        const allQuests = [
          ...(msg.disponibles || []).map(normalizeQuest), 
          ...(msg.activas || []).map(normalizeQuest)
        ];
        
        console.log('üìã Misiones recibidas:', allQuests);
        renderQuests(allQuests);
      },

      'quest_aceptada': (msg) => {
        log(`‚úÖ ${msg.mensaje}`, 'success');
        playSound('achievement');
        showActionFeedback(msg.mensaje, 'success');
        // Refrescar lista de misiones
        refreshQuests();
      },
      
      // ===== SISTEMA SOCIAL: FOGATA =====
      'fogata:list': (msg) => {
        renderFogata(msg.posts);
      },
      
      'fogata:created': (msg) => {
        showNotification('¬°Post publicado!', 'success');
        loadFogata(); // Recargar feed
      },
      
      'fogata:new_post': (msg) => {
        // Broadcast: alguien m√°s cre√≥ un post
        const author = msg.post?.authorName || msg.author || 'Alguien';
        addLiveActivity('fogata', `${author} public√≥ en la fogata`, 'üî•');
        loadFogata(); // Recargar feed para mostrar el nuevo post
      },
      
      'fogata:like_update': (msg) => {
        // Actualizar likes del post en tiempo real
        if (msg.liker && msg.liker !== player.nombre) {
          addLiveActivity('fogata', `${msg.liker} dio like a un post`, '‚ù§Ô∏è');
        }
        updatePostLikes(msg.postId, msg.likes);
      },
      
      'fogata:comment_added': (msg) => {
        // Broadcast: nuevo comentario agregado
        // Reducir notificaciones solo si no es del usuario actual
        if (msg.comment && msg.comment.authorId !== player.id) {
          const commenter = msg.comment.authorName || 'Alguien';
          const isNPC = msg.comment.isNPC;
          if (isNPC) {
            addLiveActivity('fogata', `ü§ñ ${commenter} respondi√≥ en la fogata`, 'üí¨');
          }
        }
        
        // Si el div de comentarios est√° abierto, recargarlos
        const commentsDiv = document.getElementById(`comments-${msg.postId}`);
        if (commentsDiv && commentsDiv.style.display !== 'none') {
          ws.send(JSON.stringify({ type: 'fogata:loadComments', postId: msg.postId }));
        }
        // Actualizar contador de comentarios
        updatePostCommentCount(msg.postId, msg.commentCount);
      },
      
      'fogata:comment_success': (msg) => {
        // Confirmaci√≥n de comentario enviado por el usuario
        showNotification('‚úÖ Comentario publicado', 'success');
        
        // Si el div de comentarios est√° abierto, recargarlos inmediatamente
        const commentsDiv = document.getElementById(`comments-${msg.postId}`);
        if (commentsDiv && commentsDiv.style.display !== 'none') {
          setTimeout(() => {
            ws.send(JSON.stringify({ type: 'fogata:loadComments', postId: msg.postId }));
          }, 100);
        }
      },
      
      'fogata:comments': (msg) => {
        renderComments(msg.postId, msg.comments);
      },
      
      // ===== NPCs: DI√ÅLOGOS Y ACCIONES =====
      'npc:talk': (msg) => {
        // Reproducir sonido y agregar di√°logo a la historia
        if (msg.playSound) {
          playSound(msg.playSound);
        }
        
        log(`${msg.npcName}: "${msg.dialogo}"`, 'info');
        
        // A√±adir a di√°logos activos
        if (!activeDialogue || activeDialogue.npcId !== msg.npcId) {
          activeDialogue = {
            npcId: msg.npcId,
            npcName: msg.npcName,
            startedAt: Date.now()
          };
        }
        
        dialogueHistory.push({
          speaker: msg.npcName,
          text: msg.dialogo,
          timestamp: Date.now()
        });
        
        renderInteractiveDialogue();
        showBadge('events');
        
        // Actualizar estado del NPC si viene
        if (msg.npcState) {
          world.npcs[msg.npcId] = msg.npcState;
          renderGame();
        }
        
        // Actualizar inventario si viene
        if (msg.inventario) {
          player.inventario = msg.inventario;
          renderGame();
        }
      },
      
      'npc:resource_given': (msg) => {
        showNotification(`¬°Le diste ${msg.cantidad} ${msg.resource} a ${msg.npcName}!`, 'success');
        
        // Actualizar inventario
        if (msg.inventario) {
          player.inventario = msg.inventario;
        }
        
        // Actualizar NPC
        if (msg.npcState) {
          world.npcs[msg.npcId] = msg.npcState;
        }
        
        // Actualizar reputaci√≥n si viene
        if (msg.reputation !== undefined) {
          log(`Reputaci√≥n con ${msg.npcName}: ${msg.reputation}`, 'success');
        }
        
        renderGame();
      },
      
      'npc:reputation_info': (msg) => {
        // Mostrar informaci√≥n de reputaci√≥n en un modal
        const content = `
          <div style="text-align: center;">
            <h2 style="color: var(--green-bright); margin-bottom: 10px;">${msg.npcName}</h2>
            <div style="background: #1a2a1a; padding: 20px; border-radius: 8px; border: 2px solid #00ff00;">
              <div style="font-size: 48px; margin-bottom: 10px;">üíï</div>
              <div style="font-size: 24px; color: #00ff00; margin-bottom: 5px;">${msg.status}</div>
              <div style="font-size: 14px; color: #888;">Reputaci√≥n: ${msg.reputation}/100</div>
              <div style="width: 100%; height: 20px; background: #222; border-radius: 10px; margin-top: 15px; overflow: hidden;">
                <div style="width: ${Math.max(0, Math.min(100, msg.reputation))}%; height: 100%; background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00); transition: width 0.5s;"></div>
              </div>
            </div>
            <button onclick="closeModal()" style="width: 100%; padding: 10px; margin-top: 20px; background: #004400; border: 1px solid #00ff00; color: #00ff00; cursor: pointer; font-size: 12px; border-radius: 3px;">
              CERRAR
            </button>
          </div>
        `;
        
        const modalContent = document.getElementById('modal-content');
        const customModal = document.getElementById('custom-modal');
        
        if (modalContent && customModal) {
          modalContent.innerHTML = content;
          customModal.style.display = 'flex';
        }
      },
      
      // ===== SISTEMA DE JUEGOS =====
      'game:joined': (msg) => {
        console.log('game:joined recibido:', msg);
        
        if (msg.success && msg.game) {
          currentGame = msg.game;
          showNotification(`Te uniste a ${msg.game.name}`, 'success');
          
          // Abrir modal y mostrar sala de espera
          openGameModal(msg.game.type);
          
          // Actualizar sala de espera con jugadores actuales
          setTimeout(() => {
            updateWaitingRoom(msg.game);
          }, 100);
        }
        
        loadActiveGames();
      },
      
      'game:list': (msg) => {
        renderActiveGames(msg.games);
      },
      
      'game:updated': (msg) => {
        // Broadcast: juego actualizado (nuevo jugador se uni√≥ o NPC cre√≥ juego)
        console.log('game:updated recibido:', msg);
        
        if (msg.action === 'created') {
          const creator = msg.creator || 'Alguien';
          const gameType = msg.game.type === 'poker' ? 'Poker' : msg.game.type === 'dice' ? 'Dados' : msg.game.type === 'roulette' ? 'Ruleta' : 'Blackjack';
          addLiveActivity('game', `${creator} cre√≥ una partida de ${gameType}`, 'üé≤');
        } else if (msg.action === 'joined') {
          const joiner = msg.joiner || 'Alguien';
          const gameType = msg.game.type === 'poker' ? 'Poker' : msg.game.type === 'dice' ? 'Dados' : msg.game.type === 'roulette' ? 'Ruleta' : 'Blackjack';
          addLiveActivity('game', `${joiner} se uni√≥ a ${gameType}`, 'üéÆ');
          
          // Actualizar sala de espera si el jugador est√° en ese juego
          if (currentGame && currentGame.type === msg.game.type) {
            currentGame = msg.game;
            console.log('Actualizando sala de espera con:', msg.game);
            updateWaitingRoom(msg.game);
          }
        }
        loadActiveGames(); // Recargar lista de juegos
        showNotification(`Juego actualizado: ${msg.game.type}`, 'info');
      },
      
      'game:player_ready': (msg) => {
        // Actualizar estado de ready en la sala de espera
        console.log('game:player_ready recibido:', msg);
        
        if (currentGame && msg.game) {
          currentGame = msg.game;
          updateWaitingRoom(msg.game);
          
          // Validar que players existe y es un array antes de usar every
          if (msg.game.players && Array.isArray(msg.game.players)) {
            const allReady = msg.game.players.every(p => p.ready);
            if (allReady) {
              showNotification('¬°Todos listos! El juego comenzar√° pronto...', 'success');
            } else {
              showNotification(`${msg.playerName} est√° listo`, 'info');
            }
          }
        }
      },
      
      'game:dice_rolled': (msg) => {
        // Mostrar tirada de dado en tiempo real
        if (currentGame) {
          const gameArea = document.getElementById('gameArea');
          if (gameArea) {
            // Actualizar el dado del jugador que tir√≥ con animaci√≥n
            const playerSeats = gameArea.querySelectorAll('.player-seat');
            playerSeats.forEach(seat => {
              const playerId = seat.getAttribute('data-player-id');
              if (playerId === msg.playerId) {
                const diceDiv = seat.querySelector('.dice-animated');
                if (diceDiv) {
                  // Animar dado
                  diceDiv.style.animation = 'diceRoll 1s';
                  setTimeout(() => {
                    const diceEmojis = ['‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'];
                    diceDiv.textContent = diceEmojis[msg.roll - 1];
                    diceDiv.style.animation = '';
                    
                    const resultDiv = seat.querySelector('.dice-result');
                    if (resultDiv) {
                      resultDiv.textContent = `Resultado: ${msg.roll}`;
                      resultDiv.style.color = '#00ff00';
                    }
                  }, 1000);
                }
              }
            });
          }
          
          showNotification(`${msg.playerName} tir√≥ un ${msg.roll}!`, 'info');
        }
      },
      
      'game:started': (msg) => {
        const gameType = msg.game.type === 'poker' ? 'Poker' : msg.game.type === 'dice' ? 'Dados' : msg.game.type === 'roulette' ? 'Ruleta' : 'Blackjack';
        addLiveActivity('game', `¬°Partida de ${gameType} iniciada!`, 'üéØ');
        showNotification(`¬°Partida de ${msg.game.name} iniciada!`, 'success');
        playSound('achievement');
        
        // Actualizar juego actual y renderizar mesa
        if (currentGame && currentGame.type === msg.game.type) {
          currentGame = msg.game;
          renderGameTable(msg.game);
        }
        
        loadActiveGames();
      },
      
      'game:state': (msg) => {
        // Actualizar estado del juego en tiempo real
        if (currentGame && msg.game) {
          currentGame = msg.game;
          renderGameTable(msg.game);
        }
      },
      
      'game:finished': (msg) => {
        // Verificar si el jugador es ganador
        const isWinner = msg.winners && msg.winners.some(w => w.id === player.id);
        const winnersText = msg.winners && msg.winners.length > 0 ? msg.winners.map(w => w.nombre).join(', ') : 'La casa';
        
        if (isWinner) {
          showNotification(`¬°Ganaste! üéâ`, 'success');
          playSound('levelup');
        } else {
          showNotification(`Ganador(es): ${winnersText}`, 'info');
        }
        
        // Mostrar resultados en la mesa si est√° abierta
        if (currentGame && msg.game) {
          currentGame = msg.game;
          currentGame.winners = msg.winners;
          renderGameResults(msg.game, msg.winners);
        }
        
        // Recargar estado del juego y lista
        renderGame();
        loadActiveGames();
        
        // Cerrar modal despu√©s de 10 segundos
        setTimeout(() => {
          if (document.getElementById('gameModal').classList.contains('active')) {
            closeGameModal();
          }
        }, 10000);
      },
      
      // üèòÔ∏è CAMBIO DE SUB-UBICACI√ìN
      'sublocation:changed': (msg) => {
        player.currentSubLocation = msg.subLocation;
        log(`üìç ${msg.message}`, 'success');
        renderSubLocationNav();
        renderNPCs();
        renderAvailableGames(); // üéÆ Actualizar juegos disponibles
        playSound('move');
        showActionFeedback(`Ahora est√°s en: ${msg.subLocationData.nombre}`, 'success');
      },
      
      'error': (msg) => {
        log(`‚ö†Ô∏è ERROR: ${msg.error || msg.mensaje}`, 'warning');
      },

      'admin:metrics': (msg) => {
        console.log('üìä M√©tricas recibidas:', msg.metrics);
        showMetricsModal(msg.metrics, msg.totalHandlers);
      },

      // ===== FASE 11: EVENTOS GLOBALES =====
      'active_events': (msg) => {
        console.log('üåç Eventos globales recibidos:', msg.events);
        renderGlobalEvents(msg.events);
      },

      'global_event:start': (msg) => {
        const event = msg.event;
        log(`üåç ¬°EVENTO GLOBAL! ${event.title}: ${event.description}`, 'evento');
        showNotification(`${event.title}\n${event.description}`, 'warning');
        playSound('loot'); // Sonido de alerta
        
        // Actualizar lista de eventos
        requestActiveEvents();
      },

      'global_event:update': (msg) => {
        log(`üì¢ ${msg.event.message}`, 'evento');
        showNotification(msg.event.message, 'info');
      },

      'global_event:end': (msg) => {
        const event = msg.event;
        log(`‚úÖ Evento terminado: ${event.message || event.type}`, 'success');
        
        // Actualizar lista de eventos
        requestActiveEvents();
      },

      'airdrop_claimed': (msg) => {
        const lootStr = Object.entries(msg.loot).map(([k,v]) => `${k}:${v}`).join(', ');
        log(`üì¶ ${msg.message} Recibiste: ${lootStr}`, 'success');
        showNotification(`¬°Airdrop reclamado!\n${lootStr}`, 'success');
        playSound('loot');
        renderGame();
      },

      'merchant_purchase_success': (msg) => {
        log(`üõí ${msg.message}`, 'success');
        showNotification(`Compraste: ${msg.item.name}\nOro restante: ${msg.newOro}`, 'success');
        player.oro = msg.newOro;
        renderGame();
      },

      // ===== FASE 11: MISIONES DIN√ÅMICAS =====
      'dynamic_quests': (msg) => {
        console.log('üéØ Misiones din√°micas recibidas:', msg);
        renderDynamicQuests(msg.available, msg.accepted);
      },

      'quest_accepted': (msg) => {
        log(`‚úÖ ${msg.message}`, 'success');
        showNotification(`Misi√≥n aceptada:\n${msg.quest.title}`, 'success');
        requestDynamicQuests();
      },

      'quest_completed': (msg) => {
        const rewardsStr = msg.rewards ? 
          Object.entries(msg.rewards).map(([k,v]) => `${k}:${v}`).join(', ') : 
          'Sin recompensas';
        log(`‚úÖ ${msg.message} | Recompensas: ${rewardsStr}`, 'success');
        showNotification(`¬°Misi√≥n completada!\n${rewardsStr}`, 'success');
        playSound('achievement');
        requestDynamicQuests();
        renderGame();
      },

      'mission:new': (msg) => {
        // Nueva misi√≥n din√°mica generada
        log(`üéØ Nueva misi√≥n disponible: ${msg.mission.title}`, 'evento');
        showNotification(`Nueva misi√≥n:\n${msg.mission.title}`, 'info');
        requestDynamicQuests();
      },

      // ===== FASE 12: SISTEMA DE CONSTRUCCI√ìN =====
      'structures': (msg) => {
        console.log('üèóÔ∏è Estructuras recibidas:', msg);
        renderConstructionStructures(msg.available, msg.completed);
      },

      'construction_projects': (msg) => {
        console.log('üèóÔ∏è Proyectos recibidos:', msg.projects);
        renderConstructionProjects(msg.projects);
      },

      'construction:started': (msg) => {
        log(`üèóÔ∏è ${msg.message}`, 'success');
        showNotification(`Construcci√≥n iniciada:\n${msg.project.structure.name}`, 'success');
        requestConstructionData();
      },

      'construction:progress': (msg) => {
        log(`üî® ${msg.message}`, 'info');
        requestConstructionData();
      },

      'construction:completed': (msg) => {
        log(`üéâ ${msg.message}`, 'success');
        showNotification(`¬°Construcci√≥n completada!\n${msg.structure.name}\nBeneficios activos`, 'success');
        playSound('achievement');
        requestConstructionData();
        renderGame();
      },

      'construction_started': (msg) => {
        log(`‚úÖ ${msg.message}`, 'success');
        showNotification(`Construcci√≥n iniciada:\n${msg.structure.name}`, 'success');
        requestConstructionData();
      },

      'construction_contributed': (msg) => {
        log(`‚úÖ ${msg.message}`, 'success');
        if (msg.newInventory) {
          player.inventario = msg.newInventory;
        }
        requestConstructionData();
        renderGame();
      },

      'construction_completed': (msg) => {
        log(`üéâ ${msg.message}`, 'success');
        showNotification(`¬°Construcci√≥n completada!\n${msg.structure.definition?.name || 'Estructura'}`, 'success');
        playSound('achievement');
        requestConstructionData();
        renderGame();
      },

      'refuge_effects': (msg) => {
        console.log('üè† Efectos del refugio:', msg.effects);
        renderRefugeEffects(msg.effects);
      },

      'error': (msg) => {
        log(`‚ö†Ô∏è ERROR: ${msg.error || msg.mensaje}`, 'warning');
      },

      'admin:metrics': (msg) => {
        console.log('üìä M√©tricas recibidas:', msg.metrics);
        showMetricsModal(msg.metrics, msg.totalHandlers);
      }
    };

    let currentGroup = null;
    
    // ‚ö° FEED DE ACTIVIDAD EN VIVO
    const MAX_ACTIVITIES = 30;
    
    function addLiveActivity(type, message, icon = 'üì¢') {
      const feed = document.getElementById('liveActivityFeed');
      if (!feed) return;
      
      const activityItem = document.createElement('div');
      activityItem.className = `activity-item activity-${type}`;
      
      const timestamp = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
      activityItem.innerHTML = `<span style="opacity: 0.6; margin-right: 8px;">${timestamp}</span>${icon} ${message}`;
      
      // Insertar al principio (m√°s reciente arriba)
      if (feed.firstChild) {
        feed.insertBefore(activityItem, feed.firstChild);
      } else {
        feed.appendChild(activityItem);
      }
      
      // Limitar cantidad de actividades
      while (feed.children.length > MAX_ACTIVITIES) {
        feed.removeChild(feed.lastChild);
      }
      
      // Hacer parpadear el t√≠tulo de la pesta√±a si no est√° en Mundo
      const mundoTab = document.getElementById('tab-mundo');
      if (mundoTab && !mundoTab.classList.contains('active')) {
        showBadge('mundo');
      }
    }

    function handleMessage(msg) {
      // Normalizar tipo de mensaje (soportar 'type' y 'tipo')
      const messageType = msg.type || msg.tipo;
      const handler = messageHandlers[messageType];
      if (handler) {
        handler(msg);
      } else {
        // Fallback para mensajes no migrados a√∫n
        handleMessageLegacy(msg);
      }
    }

    function handleMessageLegacy(msg) {
      switch(msg.type) {
        case 'world:state':
          world = msg.world;
          console.log('üì¶ Mundo recibido:', world);
          if (world.players && world.players[player.id]) {
            player = world.players[player.id];
          }
          updateFeaturedStory(); // Actualizar historia destacada
          renderGame();
          break;
        
        case 'mission:completed':
          log(`‚úÖ Misi√≥n completada! Recompensa: ${Object.entries(msg.recompensa).map(([k,v]) => `${k}:${v}`).join(', ')}`, 'success');
          if (msg.inventario) {
            player.inventario = msg.inventario;
          }
          // Actualizar el mundo local para reflejar la misi√≥n completada
          if (world.activeMissions) {
            const mission = world.activeMissions.find(m => m.id === msg.mission.id);
            if (mission && !mission.completedBy.includes(player.id)) {
              mission.completedBy.push(player.id);
            }
          }
          renderGame();
          break;
          
        case 'moved':
          log(`Te moviste a: ${msg.location.nombre}`, 'success');
          player.locacion = msg.location.id;
          playSound('move');
          renderGame();
          break;
          
        case 'scavenge:result':
          const items = Object.entries(msg.found).map(([k,v]) => `${k}:${v}`).join(', ');
          log(`Encontraste: ${items || 'nada'}`, 'success');
          
          // Mostrar pop-ups de consecuencias
          for (const [item, cantidad] of Object.entries(msg.found)) {
            if (cantidad > 0) {
              showStatChange(item, cantidad);
            }
          }
          
          if (msg.inventario) {
            player.inventario = msg.inventario;
          }
          if (items) playSound('loot');
          renderGame();
          break;
          
        case 'combat':
          log(msg.message, 'combat');
          const oldHealth = player.salud;
          player.salud = msg.salud;
          
          // Mostrar cambio de salud
          if (player.salud !== oldHealth) {
            showStatChange('salud', player.salud - oldHealth);
          }
          
          renderGame();
          break;
          
        case 'give:success':
          log(`Le diste ${msg.cantidad} ${msg.item} a ${msg.npc}`, 'success');
          if (msg.inventario) {
            player.inventario = msg.inventario;
          }
          world.npcs[msg.npcState.id] = msg.npcState;
          renderGame();
          break;
          
        case 'dialogue':
          // Reproducir sonido de saludo inicial o de charla
          if (msg.playSound) {
            playSound(msg.playSound);
          }
          
          log(`${msg.npc}: "${msg.text}"`, '');
          
          // Actualizar panel de di√°logo interactivo
          activeDialogue = {
            npcId: msg.npcId,
            npcName: msg.npc,
            text: msg.text,
            options: msg.options || []
          };
          
          dialogueHistory.push({
            speaker: msg.npc,
            text: msg.text,
            timestamp: Date.now()
          });
          
          renderInteractiveDialogue();
          showBadge('events');
          break;
          
        case 'npc:died':
          log(`üíÄ ${msg.nombre} ha muerto`, 'death');
          if (world.npcs[msg.npcId]) {
            world.npcs[msg.npcId].vivo = false;
          }
          renderGame();
          break;
          
        case 'npc:updated':
          world.npcs[msg.npcId] = msg.npc;
          renderGame();
          break;
          
        case 'horde:warning':
          log(msg.message, 'warning');
          document.getElementById('hordeWarning').style.display = 'block';
          break;
          
        case 'horde:attacked':
          log(msg.message, 'combat');
          document.getElementById('hordeWarning').style.display = 'none';
          renderGame();
          break;
          
        case 'horde:npc_killed':
          log(`üíÄ ${msg.npcNombre} muri√≥ en el ataque de la horda`, 'death');
          break;
          
        case 'quest:new':
          log(`üìã Nueva quest: ${msg.quest.descripcion}`, 'success');
          if (!world.activeQuests) world.activeQuests = [];
          world.activeQuests.push(msg.quest);
          renderGame();
          break;
          
        case 'craft:success':
          log(`üî® Crafteaste: ${msg.item}`, 'success');
          if (msg.defensas) {
            log(`üõ°Ô∏è Defensas del refugio: ${msg.defensas}`, 'success');
            if (world.locations && world.locations.refugio) {
              world.locations.refugio.defensas = msg.defensas;
            }
          }
          if (msg.inventario) {
            player.inventario = msg.inventario;
          }
          playSound('craft');
          renderGame();
          break;
          
        case 'combat:result':
          let combatMsg = `‚öîÔ∏è Eliminaste ${msg.killed} zombies`;
          if (msg.critico) combatMsg += ' ¬°CR√çTICO!';
          if (msg.falloSigilo) combatMsg = 'üö´ Fallo de sigilo! Te detectaron y te hirieron.';
          
          const lootItems = Object.entries(msg.loot || {});
          if (lootItems.length > 0) {
            combatMsg += ' | Loot: ' + lootItems.map(([k,v]) => `${k}:${v}`).join(', ');
          }
          
          log(`${combatMsg}. Quedan: ${msg.remaining}`, 'combat');
          player.inventario = msg.inventario;
          renderGame();
          break;
          
        case 'shoot:result':
          log(`üî´ Mataste ${msg.killed} zombies. Quedan: ${msg.remaining}`, 'combat');
          log(msg.warning, 'warning');
          renderGame();
          break;
          
        case 'event:special':
          log(`üé≠ EVENTO: ${msg.event.nombre}`, 'success');
          world.activeEvents = [msg.event];
          renderGame();
          break;
          
        case 'event:resolved':
          log(msg.resultado, 'success');
          player.inventario = msg.inventario;
          world.activeEvents = [];
          renderGame();
          break;
          
        case 'event:expired':
          log('El evento expir√≥', 'warning');
          world.activeEvents = [];
          renderGame();
          break;
          
        case 'world:event':
          worldLog(msg.message, msg.category);
          
          // Mostrar badge en pesta√±a de mundo si no est√° activa
          const mundoTab = document.getElementById('tab-mundo');
          if (mundoTab && !mundoTab.classList.contains('active')) {
            showBadge('mundo');
          }
          break;
          
        case 'player:joined':
          worldLog(`üë§ ${msg.nombre} se uni√≥`, 'success');
          renderGame();
          break;
          
        case 'player:left':
          worldLog(`üë§ ${msg.nombre} se desconect√≥`, 'warning');
          break;

        case 'players:list':
          // Actualizar mapa de conexiones para featured story
          connections.clear();
          if (msg.players && Array.isArray(msg.players)) {
            msg.players.forEach(p => {
              connections.set(p.id, p);
            });
          }
          renderOnlinePlayers(msg.players);
          break;
          
        case 'player:moved':
          renderGame();
          break;
          
        case 'trade:success':
          log(msg.message, 'success');
          player.inventario = msg.inventario;
          renderGame();
          break;
          
        case 'xp:gained':
          log(`+${msg.amount} XP (${msg.xp}/${msg.xpMax})`, 'success');
          player.xp = msg.xp;
          player.xpParaSiguienteNivel = msg.xpMax;
          renderGame();
          break;
          
        case 'level:up':
          log(`‚≠ê ¬°SUBISTE A NIVEL ${msg.nivel}!`, 'success');
          player.nivel = msg.nivel;
          player.xpParaSiguienteNivel = msg.xpMax;
          player.xp = 0;
          playSound('levelup');
          showNotification(`üéâ ¬°NIVEL ${msg.nivel}!`, 'success');
          renderGame();
          break;
          
        case 'refugio:recursos':
          if (world.locations && world.locations.refugio) {
            world.locations.refugio.recursos = msg.recursos;
          }
          renderGame();
          break;
          
        case 'quest:cooperativa':
          renderQuestCooperativa(msg.quest);
          worldLog(`ü§ù QUEST COOPERATIVA: ${msg.quest.nombre}`, 'special');
          break;
          
        case 'quest:votes_update':
          updateVotosQuest(msg.votos);
          break;
          
        case 'quest:resultado':
          worldLog(`‚úÖ Quest resuelta: ${msg.opcionGanadora}`, 'success');
          document.getElementById('questCooperativa').innerHTML = '<em style="color: #888;">Sin quest activa</em>';
          break;
          
        case 'quest:voted':
          log(msg.message, 'success');
          break;
          
        case 'error':
          log(`ERROR: ${msg.error}`, 'warning');
          break;
          
        case 'chat:message':
          addChatMessage(msg);
          
          // Mostrar badge en pesta√±a social si no est√° activa y no es tu mensaje
          if (msg.playerId !== player.id) {
            const socialTab = document.getElementById('tab-social');
            if (socialTab && !socialTab.classList.contains('active')) {
              showBadge('social');
            }
          }
          break;
          
        case 'chat:system':
          addSystemMessage(msg.mensaje);
          break;
        
        // ====================================
        // MENSAJES PRIVADOS
        // ====================================
        case 'dm:received':
          // Agregar a log local
          if (!directMessages[msg.from]) directMessages[msg.from] = [];
          directMessages[msg.from].push({
            from: msg.from,
            to: player.id,
            message: msg.message,
            timestamp: Date.now(),
            sent: false
          });
          
          // Incrementar contador de no le√≠dos
          unreadDMs++;
          updateDMBadge();
          
          // Notificaci√≥n
          playSound('warning');
          log(`üíå Mensaje privado de ${allPlayers[msg.from] || 'Desconocido'}`, 'warning');
          
          // Si est√° viendo DMs de ese jugador, actualizar
          if (currentDMTarget === msg.from) {
            renderDMs();
            unreadDMs--;
            updateDMBadge();
          }
          
          // Badge en tab social
          const socialTab = document.getElementById('tab-social');
          if (socialTab && !socialTab.classList.contains('active')) {
            showBadge('social');
          }
          break;
        
        case 'dm:sent':
          playSound('success');
          break;
          
        case 'achievement:unlocked':
          handleAchievementUnlocked(msg.achievement);
          if (!player.achievements) player.achievements = {};
          player.achievements[msg.achievement.id] = { desbloqueado: true, fecha: Date.now() };
          playSound('achievement');
          renderAchievements();
          break;
          
        case 'players:list':
          renderOnlinePlayers(msg.players);
          updateTradePlayerSelect(msg.players);
          break;
          
        case 'mission:completed':
          showNotification(`‚úÖ Misi√≥n completada: ${msg.mission.descripcion}`, 'success');
          player.inventario = msg.inventario;
          renderGame();
          break;
          
        case 'pet:updated':
          player.mascota = msg.mascota;
          player.inventario = msg.inventario;
          renderPet();
          break;
        
        case 'pet:adopted':
          player.mascota = msg.mascota;
          showNotification(`üêæ Adoptaste ${msg.mascota.nombre}!`, 'success');
          renderPet();
          break;
        
        case 'faction:joined':
          player.faccion = msg.faccion;
          player.factionRep = msg.reputation;
          showNotification(`‚öîÔ∏è Te uniste a ${msg.faccion.nombre}!`, 'success');
          renderFaction();
          break;
        
        case 'faction:reputation':
          player.factionRep = msg.reputation;
          renderFaction();
          break;
        
        case 'vehicle:created':
          player.vehiculo = msg.vehiculo;
          player.inventario = msg.inventario;
          showNotification(`üöó Construiste ${msg.vehiculo.nombre}!`, 'success');
          renderVehicle();
          break;
          
        case 'ability:result':
          if (msg.success) {
            showNotification(`‚ö° ${msg.ability.nombre} activada!`, 'success');
            renderGame();
          } else {
            showNotification(msg.error, 'warning');
          }
          break;
          
        case 'reputation:updated':
          showNotification(`Reputaci√≥n con NPC: ${msg.level.nombre}`, 'info');
          break;
          
        case 'pvp:match:start':
          currentPvPMatch = msg.matchId;
          document.getElementById('pvpMatch').style.display = 'block';
          document.getElementById('pvpPlayer1').textContent = msg.player1.nombre;
          document.getElementById('pvpPlayer2').textContent = msg.player2.nombre;
          document.getElementById('pvpPlayer1HP').style.width = '100%';
          document.getElementById('pvpPlayer2HP').style.width = '100%';
          showNotification(`‚öîÔ∏è Combate PvP iniciado!`, 'info');
          break;
          
        case 'pvp:attack':
          const isP1 = msg.attacker === player.nombre;
          const targetHP = msg.defenderSalud;
          const maxHP = 100;
          const hpPercent = (targetHP / maxHP) * 100;
          
          if (isP1) {
            document.getElementById('pvpPlayer2HP').style.width = hpPercent + '%';
          } else {
            document.getElementById('pvpPlayer1HP').style.width = hpPercent + '%';
          }
          
          log(`‚öîÔ∏è ${msg.attacker} atac√≥ a ${msg.defender} por ${msg.damage} de da√±o`, 'combat');
          break;
          
        case 'pvp:match:end':
          const won = msg.winner === player.nombre;
          showNotification(won ? 'üèÜ ¬°VICTORIA!' : 'üíÄ Derrota', won ? 'success' : 'warning');
          document.getElementById('pvpMatch').style.display = 'none';
          currentPvPMatch = null;
          renderGame();
          break;
        
        // ====================================
        // EVENTOS NARRATIVOS
        // ====================================
        case 'narrative:event':
          world.activeNarrativeEvent = msg.event;
          log(`üìñ ${msg.event.nombre} (Parte ${msg.event.parte})`, 'warning');
          playSound('notification');
          showBadge('events'); // Notificar en tab EVENTOS
          renderGame();
          break;
        
        case 'narrative:completed':
          log(msg.resultado, 'success');
          player.inventario = msg.inventario;
          if (msg.defensas) {
            world.locations.refugio.defensas = msg.defensas;
          }
          renderGame();
          break;
        
        case 'narrative:failed':
          log(msg.message, 'warning');
          playSound('error');
          break;
      }
    }

    function addChatMessage(msg) {
      const chatLog = document.getElementById('chatLog');
      const entry = document.createElement('div');
      entry.style.cssText = 'margin: 5px 0; padding: 5px; background: #2a2a2a; border-radius: 3px;';
      
      const time = new Date(msg.timestamp).toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
      const isMe = msg.playerId === player.id;
      const nameColor = isMe ? '#00ff00' : msg.color || '#00ffff';
      
      entry.innerHTML = `
        <div style="font-size: 10px; color: #888;">${time}</div>
        <div><span style="color: ${nameColor}; font-weight: bold;">${msg.avatar} ${msg.nombre}:</span> ${msg.mensaje}</div>
      `;
      
      chatLog.appendChild(entry);
      chatLog.scrollTop = chatLog.scrollHeight;
      
      // Mantener solo √∫ltimos 30 mensajes
      while (chatLog.children.length > 30) {
        chatLog.removeChild(chatLog.firstChild);
      }
    }

    function renderChat() {
      // Esta funci√≥n se llama al cambiar a la pesta√±a social
      // El chat se renderiza din√°micamente con addChatMessage cuando llegan mensajes
      // Aqu√≠ solo aseguramos que el scroll est√© al final
      const chatLog = document.getElementById('chatLog');
      if (chatLog) {
        chatLog.scrollTop = chatLog.scrollHeight;
      }
      const dmLog = document.getElementById('dmLog');
      if (dmLog) {
        dmLog.scrollTop = dmLog.scrollHeight;
      }
    }

    function addSystemMessage(mensaje) {
      const chatLog = document.getElementById('chatLog');
      const entry = document.createElement('div');
      entry.style.cssText = 'margin: 5px 0; padding: 8px; background: #1a3a1a; border-left: 3px solid #00ff00; border-radius: 3px; white-space: pre-line;';
      
      entry.innerHTML = `<span style="color: #00ff00; font-weight: bold;">üñ•Ô∏è SISTEMA:</span> ${mensaje}`;
      
      chatLog.appendChild(entry);
      chatLog.scrollTop = chatLog.scrollHeight;
      
      // Mantener solo √∫ltimos 30 mensajes
      while (chatLog.children.length > 30) {
        chatLog.removeChild(chatLog.firstChild);
      }
    }

    function sendChat() {
      const input = document.getElementById('chatInput');
      const mensaje = input.value.trim();
      
      if (!mensaje) return;
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No conectado al servidor', 'warning');
        return;
      }
      
      ws.send(JSON.stringify({
        type: 'chat',
        mensaje: mensaje
      }));
      
      input.value = '';
    }
    
    // ====================================
    // MENSAJES PRIVADOS (DMs)
    // ====================================
    function sendDM() {
      const input = document.getElementById('dmInput');
      const targetSelect = document.getElementById('dmTargetSelect');
      const mensaje = input.value.trim();
      const targetId = targetSelect.value;
      
      if (!mensaje || !targetId) {
        showActionFeedback('Selecciona un jugador y escribe un mensaje', 'danger');
        return;
      }
      
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No conectado al servidor', 'warning');
        return;
      }
      
      ws.send(JSON.stringify({
        type: 'dm',
        targetId,
        mensaje
      }));
      
      // Agregar a log local
      if (!directMessages[targetId]) directMessages[targetId] = [];
      directMessages[targetId].push({
        from: player.id,
        to: targetId,
        message: mensaje,
        timestamp: Date.now(),
        sent: true
      });
      
      currentDMTarget = targetId;
      renderDMs();
      input.value = '';
      playSound('success');
    }
    
    function renderDMs() {
      const dmLog = document.getElementById('dmLog');
      if (!currentDMTarget || !directMessages[currentDMTarget]) {
        dmLog.innerHTML = '<em style="color: #888;">No hay mensajes con este jugador</em>';
        return;
      }
      
      const messages = directMessages[currentDMTarget];
      const html = messages.map(dm => {
        const isSent = dm.from === player.id;
        const time = new Date(dm.timestamp).toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
        const senderName = isSent ? 'T√∫' : (allPlayers[dm.from] || 'Desconocido');
        
        return `
          <div class="dm-message ${isSent ? 'dm-sent' : 'dm-received'}">
            <div style="font-weight: bold; color: ${isSent ? '#00ff00' : '#ff8800'}; margin-bottom: 3px;">
              ${senderName} <span style="font-size: 9px; color: #888; font-weight: normal;">${time}</span>
            </div>
            <div>${dm.message}</div>
          </div>
        `;
      }).join('');
      
      dmLog.innerHTML = html;
      dmLog.scrollTop = dmLog.scrollHeight;
    }
    
    function switchChatTab(tab) {
      // Cambiar tabs
      document.querySelectorAll('.craft-tab').forEach(t => {
        if (t.onclick && t.onclick.toString().includes('switchChatTab')) {
          t.classList.remove('active');
        }
      });
      
      event.target.classList.add('active');
      
      // Cambiar secciones
      document.getElementById('chat-global').classList.remove('active');
      document.getElementById('chat-dms').classList.remove('active');
      
      if (tab === 'global') {
        document.getElementById('chat-global').classList.add('active');
      } else if (tab === 'dms') {
        document.getElementById('chat-dms').classList.add('active');
        unreadDMs = 0;
        updateDMBadge();
      }
      
      playSound('success');
    }
    
    function updateDMBadge() {
      const badge = document.getElementById('dmBadge');
      if (unreadDMs > 0) {
        badge.style.display = 'block';
        badge.textContent = unreadDMs;
      } else {
        badge.style.display = 'none';
      }
    }
    
    // ====================================
    // INSPECCIONAR JUGADOR
    // ====================================
    function inspectPlayer(playerId) {
      // Pedir datos completos del jugador al servidor
      fetch(`/api/player/${playerId}`)
        .then(r => r.json())
        .then(data => {
          if (data.error) {
            showActionFeedback(data.error, 'danger');
            return;
          }
          showPlayerProfile(data.player);
        })
        .catch(err => {
          console.error('Error al inspeccionar:', err);
          showActionFeedback('Error al cargar perfil', 'danger');
        });
      
      playSound('success');
    }
    
    function showPlayerProfile(target) {
      const modal = document.getElementById('profileModal');
      const backdrop = document.getElementById('profileBackdrop');
      const content = document.getElementById('profileContent');
      
      // Calcular t√≠tulo/rango
      let rankBadge = '';
      let titleBadge = '';
      
      const stats = target.stats || {};
      const zombies = stats.zombies_matados || 0;
      const dias = stats.dias_sobrevividos || 0;
      
      if (zombies > 100) rankBadge = 'üíÄ';
      else if (zombies > 50) rankBadge = '‚öîÔ∏è';
      else if (zombies > 20) rankBadge = 'üî™';
      
      if (dias > 30) titleBadge = '<span class="title-badge">üèÜ VETERANO</span>';
      else if (dias > 15) titleBadge = '<span class="title-badge">‚≠ê SUPERVIVIENTE</span>';
      else if (dias > 7) titleBadge = '<span class="title-badge">üéñÔ∏è RESISTENTE</span>';
      
      // Calcular "prestigio" (score combinado)
      const prestigio = (zombies * 10) + (dias * 100) + (target.nivel * 50) + (stats.items_crafteados || 0);
      
      // Comparaci√≥n con tus stats
      const myZombies = player.stats?.zombies_matados || 0;
      const myNivel = player.nivel || 1;
      const myDias = player.stats?.dias_sobrevividos || 0;
      
      const html = `
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 48px; margin: 10px 0;">${rankBadge || 'üë§'}</div>
          <h2 style="color: #00ff00; margin: 5px 0;">${target.nombre}</h2>
          ${titleBadge}
          <div style="font-size: 12px; color: #888; margin-top: 5px;">Prestigio: ${prestigio.toLocaleString()}</div>
        </div>
        
        <div style="border-top: 2px solid #00ff00; padding-top: 15px; margin-top: 15px;">
          <h3 style="margin-bottom: 10px;">üìä ESTAD√çSTICAS</h3>
          
          <div class="stat-comparison">
            <span>Nivel:</span>
            <span class="${target.nivel > myNivel ? 'stat-better' : target.nivel < myNivel ? 'stat-worse' : ''}">${target.nivel}</span>
          </div>
          
          <div class="stat-comparison">
            <span>üßü Zombies eliminados:</span>
            <span class="${zombies > myZombies ? 'stat-better' : zombies < myZombies ? 'stat-worse' : ''}">${zombies}</span>
          </div>
          
          <div class="stat-comparison">
            <span>üìÖ D√≠as sobrevividos:</span>
            <span class="${dias > myDias ? 'stat-better' : dias < myDias ? 'stat-worse' : ''}">${dias}</span>
          </div>
          
          <div class="stat-comparison">
            <span>üî® Items crafteados:</span>
            <span>${stats.items_crafteados || 0}</span>
          </div>
          
          <div class="stat-comparison">
            <span>üó∫Ô∏è Locaciones visitadas:</span>
            <span>${stats.locaciones_visitadas || 1}</span>
          </div>
        </div>
        
        <div style="border-top: 2px solid #00ff00; padding-top: 15px; margin-top: 15px;">
          <h3 style="margin-bottom: 10px;">üéí INVENTARIO</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; font-size: 11px;">
            <div>üçñ Comida: ${target.inventario?.comida || 0}</div>
            <div>üíä Medicinas: ${target.inventario?.medicinas || 0}</div>
            <div>üî© Materiales: ${target.inventario?.materiales || 0}</div>
            <div>üî´ Armas: ${target.inventario?.armas || 0}</div>
          </div>
        </div>
        
        ${target.mascota ? `
        <div style="border-top: 2px solid #00ff00; padding-top: 15px; margin-top: 15px;">
          <h3 style="margin-bottom: 10px;">üêæ MASCOTA</h3>
          <div style="text-align: center;">
            <div style="font-size: 32px;">${target.mascota.icono || 'üêï'}</div>
            <div style="color: #00ff00;">${target.mascota.nombre}</div>
            <div style="font-size: 11px; color: #888;">Nivel ${target.mascota.nivel || 1}</div>
          </div>
        </div>
        ` : ''}
        
        <div style="margin-top: 20px; display: flex; gap: 10px;">
          <button onclick="sendDMTo('${target.id}', '${target.nombre}')" style="flex: 1; padding: 10px;">üíå Mensaje Privado</button>
          <button onclick="closeProfile()" style="padding: 10px;">Cerrar</button>
        </div>
      `;
      
      content.innerHTML = html;
      modal.style.display = 'block';
      backdrop.style.display = 'block';
    }
    
    function closeProfile() {
      document.getElementById('profileModal').style.display = 'none';
      document.getElementById('profileBackdrop').style.display = 'none';
    }
    
    function closeModal() {
      const modal = document.getElementById('custom-modal');
      if (modal) {
        modal.style.display = 'none';
      }
    }
    
    function sendDMTo(playerId, playerName) {
      closeProfile();
      switchTab('social');
      switchChatTab('dms');
      
      // Seleccionar jugador en el dropdown
      const select = document.getElementById('dmTargetSelect');
      select.value = playerId;
      currentDMTarget = playerId;
      renderDMs();
      
      // Focus en input
      document.getElementById('dmInput').focus();
    }
    
    // ====================================
    // LEADERBOARD
    // ====================================
    function switchLeaderboard(category) {
      currentLeaderboard = category;
      
      // Cambiar tabs
      document.querySelectorAll('.craft-tab').forEach(t => {
        if (t.onclick && t.onclick.toString().includes('switchLeaderboard')) {
          t.classList.remove('active');
        }
      });
      
      event.target.classList.add('active');
      
      // Pedir datos al servidor
      fetch(`/api/leaderboard/${category}`)
        .then(r => r.json())
        .then(data => {
          renderLeaderboard(data.rankings, category);
        })
        .catch(err => {
          console.error('Error al cargar leaderboard:', err);
          document.getElementById('leaderboardContent').innerHTML = '<em style="color: #ff8888;">Error al cargar rankings</em>';
        });
      
      playSound('success');
    }
    
    function renderLeaderboard(rankings, category) {
      const container = document.getElementById('leaderboardContent');
      
      if (!rankings || rankings.length === 0) {
        container.innerHTML = '<em style="color: #888;">No hay datos disponibles</em>';
        return;
      }
      
      let categoryLabel = '';
      let valueKey = '';
      
      switch(category) {
        case 'zombies':
          categoryLabel = 'üßü Zombies';
          valueKey = 'zombies_matados';
          break;
        case 'nivel':
          categoryLabel = 'üìä Nivel';
          valueKey = 'nivel';
          break;
        case 'dias':
          categoryLabel = 'üìÖ D√≠as';
          valueKey = 'dias_sobrevividos';
          break;
        case 'prestigio':
          categoryLabel = 'üëë Prestigio';
          valueKey = 'prestigio';
          break;
      }
      
      const html = rankings.map((entry, idx) => {
        const rank = idx + 1;
        const rankClass = rank <= 3 ? `rank-${rank}` : '';
        const isMe = entry.playerId === player.id;
        const rankEmoji = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;
        
        return `
          <div class="leaderboard-entry ${rankClass}" style="${isMe ? 'border: 2px solid #00ffff;' : ''}">
            <div>
              <span style="font-weight: bold; font-size: 14px; margin-right: 10px;">${rankEmoji}</span>
              <span style="color: ${isMe ? '#00ffff' : '#00ff00'}; font-weight: ${isMe ? 'bold' : 'normal'};">
                ${entry.nombre}${isMe ? ' (T√ö)' : ''}
              </span>
            </div>
            <div style="font-weight: bold; color: ${rank === 1 ? '#ffd700' : rank === 2 ? '#c0c0c0' : rank === 3 ? '#cd7f32' : '#fff'};">
              ${entry[valueKey]?.toLocaleString() || 0}
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = html;
    }
    
    // Cargar leaderboard por defecto al abrir tab
    function loadDefaultLeaderboard() {
      if (currentLeaderboard) {
        fetch(`/api/leaderboard/${currentLeaderboard}`)
          .then(r => r.json())
          .then(data => {
            renderLeaderboard(data.rankings, currentLeaderboard);
          })
          .catch(err => console.error('Error al cargar leaderboard:', err));
      }
    }
    
    // Enviar con Enter
    document.addEventListener('DOMContentLoaded', () => {
      const chatInput = document.getElementById('chatInput');
      if (chatInput) {
        chatInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            sendChat();
          }
        });
      }
    });

    function renderGame() {
      if (!player || !world) {
        console.warn('‚ö†Ô∏è No se puede renderizar: player o world es null', {player, world});
        return;
      }
      
      console.log('üé® Renderizando juego...', {player: player.nombre, locacion: player.locacion});
      
      // üÜï ACTUALIZAR NUEVO LAYOUT PERSISTENTE
      safeCall(updatePersistentHeader, 'updatePersistentHeader');
      safeCall(updateLeftSidebar, 'updateLeftSidebar');
      
      // üó∫Ô∏è RENDERIZAR MAPA 2D VISUAL
      safeCall(render2DWorldMap, 'render2DWorldMap');
      
      // Renders cr√≠ticos (siempre se ejecutan)
      safeCall(renderPlayerStats, 'renderPlayerStats');
      safeCall(renderLocation, 'renderLocation');
      safeCall(renderWorldTime, 'renderWorldTime');
      safeCall(renderSurvivalTime, 'renderSurvivalTime');
      
      // Renders con cach√© (solo si cambi√≥ el contenido)
      cachedRender('inventory', renderInventory, player.inventario);
      cachedRender('skills', renderSkills, player.skills);
      cachedRender('npcs', renderNPCs, world.npcs);
      cachedRender('quests', renderQuests, world.quests);
      cachedRender('defensas', renderDefensas, player.defensas);
      cachedRender('refugio', renderRefugioRecursos, world.refugio);
      
      // Renders condicionales
      safeCall(renderLocations, 'renderLocations');
      safeCall(renderSpecialEvent, 'renderSpecialEvent');
      safeCall(renderNarrativeEvent, 'renderNarrativeEvent');
      safeCall(renderPlayersHere, 'renderPlayersHere');
      safeCall(renderInteractiveDialogue, 'renderInteractiveDialogue');
      safeCall(renderMissions, 'renderMissions');
      safeCall(renderPet, 'renderPet');
      safeCall(renderAbilities, 'renderAbilities');
      safeCall(renderFaction, 'renderFaction');
      safeCall(renderVehicle, 'renderVehicle');
      safeCall(renderAchievements, 'renderAchievements');
      safeCall(renderTimeOfDay, 'renderTimeOfDay');
      safeCall(renderPlayerStats2, 'renderPlayerStats2'); // Stats avanzadas
      safeCall(renderRefugioVisual, 'renderRefugioVisual');
      safeCall(renderSubLocationNav, 'renderSubLocationNav'); // üèòÔ∏è Sistema de sub-ubicaciones
      safeCall(renderAvailableGames, 'renderAvailableGames'); // üéÆ Juegos disponibles por ubicaci√≥n
      safeCall(checkSocialAccess, 'checkSocialAccess'); // Verificar acceso a sistemas sociales
    }

    function renderSurvivalTime() {
      // Calcular tiempo de supervivencia
      const currentSession = Date.now() - gameStartTime;
      const totalMs = totalPlayTime + currentSession;
      
      const hours = Math.floor(totalMs / (1000 * 60 * 60));
      const minutes = Math.floor((totalMs % (1000 * 60 * 60)) / (1000 * 60));
      
      // Actualizar d√≠as (basado en el d√≠a del mundo)
      const daysEl = document.getElementById('daysAlive');
      const totalTimeEl = document.getElementById('totalTime');
      
      if (daysEl && world && world.time) {
        daysEl.textContent = world.time.dia || 1;
      }
      
      if (totalTimeEl) {
        totalTimeEl.textContent = `${hours}h ${minutes}m`;
      }
    }
    
    // ============================================
    // HELPER: Renderizado defensivo
    // ============================================
    function safeRender(elementId, content, method = 'innerHTML') {
      const element = document.getElementById(elementId);
      if (!element) {
        console.warn(`‚ö†Ô∏è Elemento no encontrado: #${elementId}`);
        return false;
      }
      
      if (method === 'innerHTML') {
        element.innerHTML = content;
      } else if (method === 'textContent') {
        element.textContent = content;
      } else if (method === 'value') {
        element.value = content;
      }
      
      return true;
    }
    
    function elementExists(elementId) {
      return document.getElementById(elementId) !== null;
    }
    
    // Ejecuta una funci√≥n de forma segura capturando cualquier error
    function safeCall(fn, context = '') {
      try {
        fn();
      } catch (error) {
        console.warn(`‚ö†Ô∏è Error en ${context || fn.name}:`, error.message);
      }
    }

    function renderPlayerStats() {
      // Actualiza elementos individuales del left sidebar usando renders defensivos
      
      // Avatar
      safeRender('player-avatar-icon', player.avatar || 'üßî');
      
      // Nombre
      safeRender('player-name-main', player.nombre || 'Jugador');
      
      // Nivel
      const nivelTexto = `Nivel ${player.nivel || 1}`;
      safeRender('player-level-display', nivelTexto);
      
      // HP
      const hpTexto = `${player.salud || 100}/100`;
      safeRender('hp-value', hpTexto);
      
      const hpBar = document.getElementById('hp-bar');
      if (hpBar) {
        hpBar.style.width = `${player.salud || 100}%`;
        // Color seg√∫n nivel de salud
        if (player.salud < 30) {
          hpBar.style.background = '#ff0000';
        } else if (player.salud < 50) {
          hpBar.style.background = '#ffaa00';
        } else {
          hpBar.style.background = '#00ff00';
        }
      }
      
      // Hambre
      const hambreTexto = `${player.hambre || 100}/100`;
      safeRender('hunger-value', hambreTexto);
      
      const hungerBar = document.getElementById('hunger-bar');
      if (hungerBar) {
        hungerBar.style.width = `${player.hambre || 100}%`;
        // Color seg√∫n nivel de hambre
        if (player.hambre < 30) {
          hungerBar.style.background = '#ff0000';
        } else if (player.hambre < 50) {
          hungerBar.style.background = '#ffaa00';
        } else {
          hungerBar.style.background = '#88ff88';
        }
      }
      
      // Stamina (si existe)
      const staminaTexto = `${player.stamina || player.energia || 100}/100`;
      safeRender('stamina-value', staminaTexto);
      
      const staminaBar = document.getElementById('stamina-bar');
      if (staminaBar) {
        staminaBar.style.width = `${player.stamina || player.energia || 100}%`;
      }
    }

    function renderInventory() {
      // Actualiza contadores espec√≠ficos del quick-inventory
      
      // Mapeo de categor√≠as de items
      const categoriaItems = {
        comida: ['comida', 'agua', 'carne', 'vegetales', 'conservas'],
        medicinas: ['vendas', 'medicinas', 'antibioticos', 'analgesicos'],
        materiales: ['madera', 'metal', 'tela', 'plastico', 'componentes'],
        armas: ['pistola', 'rifle', 'escopeta', 'cuchillo', 'bate']
      };
      
      // Contar items por categor√≠a
      let countFood = 0;
      let countMeds = 0;
      let countMats = 0;
      let countWeapons = 0;
      
      for (const [item, cantidad] of Object.entries(player.inventario || {})) {
        const itemLower = item.toLowerCase();
        
        if (categoriaItems.comida.some(cat => itemLower.includes(cat))) {
          countFood += cantidad;
        } else if (categoriaItems.medicinas.some(cat => itemLower.includes(cat))) {
          countMeds += cantidad;
        } else if (categoriaItems.materiales.some(cat => itemLower.includes(cat))) {
          countMats += cantidad;
        } else if (categoriaItems.armas.some(cat => itemLower.includes(cat))) {
          countWeapons += cantidad;
        } else {
          // Items sin categor√≠a se cuentan como materiales por defecto
          countMats += cantidad;
        }
      }
      
      // Actualizar elementos con safeRender
      safeRender('quick-food', countFood.toString());
      safeRender('quick-meds', countMeds.toString());
      safeRender('quick-mats', countMats.toString());
      safeRender('quick-weapons', countWeapons.toString());
    }

    function renderLocation() {
      const loc = world.locations[player.locacion];
      safeRender('locationName', `üìç ${loc.nombre}`, 'textContent');
      safeRender('locationDesc', loc.descripcion, 'textContent');
      
      let actionsHtml = '';
      
      // PANEL DE COMBATE ACTIVO
      if (player.inCombat) {
        const combat = player.inCombat;
        const zombieHPPercent = (combat.zombieHP / combat.zombieMaxHP) * 100;
        const playerHPPercent = (player.salud / (player.saludMaxima || 100)) * 100;
        
        actionsHtml += `
          <div style="background: #3a0000; padding: 15px; margin: 10px 0; border: 3px solid #ff0000; border-radius: 8px; animation: pulse 1.5s infinite;">
            <div style="text-align: center; font-size: 20px; margin-bottom: 10px; color: #ff0000; font-weight: bold;">
              ‚öîÔ∏è EN COMBATE
            </div>
            
            <div style="margin: 15px 0; padding: 10px; background: #1a1a1a; border-radius: 5px;">
              <div style="font-weight: bold; color: #00ff00; margin-bottom: 5px;">
                üßü T√ö: ${player.nombre}
              </div>
              <div style="display: flex; align-items: center; gap: 10px;">
                <div style="flex: 1; background: #333; height: 25px; border-radius: 5px; overflow: hidden;">
                  <div style="height: 100%; background: linear-gradient(90deg, #ff0000, #00ff00); width: ${playerHPPercent}%; transition: width 0.3s;"></div>
                </div>
                <div style="color: #00ff00; font-weight: bold; min-width: 60px;">${player.salud}/${player.saludMaxima || 100}</div>
              </div>
            </div>
            
            <div style="margin: 15px 0; padding: 10px; background: #1a1a1a; border-radius: 5px;">
              <div style="font-weight: bold; color: #ff8888; margin-bottom: 5px;">
                üßü ZOMBIE
              </div>
              <div style="display: flex; align-items: center; gap: 10px;">
                <div style="flex: 1; background: #333; height: 25px; border-radius: 5px; overflow: hidden;">
                  <div style="height: 100%; background: linear-gradient(90deg, #ff0000, #ff8800); width: ${zombieHPPercent}%; transition: width 0.3s;"></div>
                </div>
                <div style="color: #ff8888; font-weight: bold; min-width: 60px;">${combat.zombieHP}/${combat.zombieMaxHP}</div>
              </div>
            </div>
            
            ${combat.turno === 'player' ? `
              <div style="margin-top: 15px;">
                <div style="color: #ffff00; font-weight: bold; text-align: center; margin-bottom: 10px;">
                  ‚≠ê TU TURNO - ¬°Elige tu acci√≥n!
                </div>
                ${player.inventario.armas > 0 ? `
                  <button onclick="attack('shoot')" style="width: 100%; padding: 12px; margin: 5px 0; background: #660000; border: 2px solid #ff0000; color: #fff; font-weight: bold; cursor: pointer; border-radius: 5px;">
                    üî´ DISPARAR (armas: ${player.inventario.armas})
                  </button>
                ` : ''}
                <button onclick="attack('melee')" style="width: 100%; padding: 12px; margin: 5px 0; background: #664400; border: 2px solid #ffaa00; color: #fff; font-weight: bold; cursor: pointer; border-radius: 5px;">
                  ü•ä GOLPE CUERPO A CUERPO
                </button>
                <button onclick="fleeCombat()" style="width: 100%; padding: 10px; margin: 5px 0; background: #333; border: 2px solid #888; color: #fff; font-weight: bold; cursor: pointer; border-radius: 5px;">
                  üèÉ HUIR (${Math.floor(50 + player.atributos.agilidad * 2)}% √©xito)
                </button>
              </div>
            ` : `
              <div style="color: #ff8888; font-weight: bold; text-align: center; margin-top: 15px; padding: 10px; background: #1a0000; border-radius: 5px;">
                üßü TURNO DEL ZOMBIE...
              </div>
            `}
          </div>
        `;
      }
      // ACCIONES NORMALES (fuera de combate)
      else if (loc.tipo === 'loot') {
        actionsHtml += `
          <button onclick="scavenge()" style="width: 100%; padding: 15px; font-size: 16px; margin: 10px 0; background: #00aa00; cursor: pointer; border: 2px solid #00ff00;">
            üîç BUSCAR RECURSOS (+XP)
          </button>
          ${loc.zombies > 0 ? `
            <div style="background: #2a1a1a; padding: 10px; margin: 10px 0; border: 2px solid #ff0000;">
              <div style="margin-bottom: 5px; font-weight: bold; color: #ff8888;">‚ö†Ô∏è ${loc.zombies} zombies aqu√≠</div>
              ${player.inventario.armas > 0 ? `
                <button onclick="attack('shoot')" style="width: 100%; padding: 10px; margin: 3px 0; background: #660000; border: 1px solid #ff0000;">
                  üî´ DISPARAR (armas: ${player.inventario.armas}) - Alto da√±o, mucho ruido
                </button>
              ` : ''}
              <button onclick="attack('melee')" style="width: 100%; padding: 10px; margin: 3px 0; background: #664400; border: 1px solid #ffaa00;">
                ü•ä MELEE - Da√±o medio, poco ruido
              </button>
            </div>
          ` : ''}
          ${loc.nivelRuido > 30 ? `<span style="color: #ff8800;"> üîä RUIDOSO (${loc.nivelRuido})</span>` : ''}
        `;
      } else if (loc.id === 'refugio') {
        actionsHtml += `<p style="color: #00ff00; padding: 10px; background: #1a3a1a;">‚úÖ Est√°s a salvo aqu√≠</p>`;
      }
      
      document.getElementById('locationActions').innerHTML = actionsHtml;
      
      // Actualizar contador de zombies en bot√≥n principal
      const zombieCounter = document.getElementById('zombieCount');
      if (zombieCounter) {
        const zombies = loc.zombies || 0;
        if (zombies > 0) {
          zombieCounter.textContent = `${zombies} zombie${zombies > 1 ? 's' : ''} aqu√≠`;
          zombieCounter.style.color = '#ff6666';
        } else {
          zombieCounter.textContent = 'Sin zombies';
          zombieCounter.style.color = '#666666';
        }
      }
      
      // Actualizar NPCs en ubicaci√≥n actual
      renderNPCsInLocation();
      
      // Actualizar info de locaci√≥n en panel derecho
      renderLocationInfo();
    }
    
    function renderNPCsInLocation() {
      const npcsHereEl = document.getElementById('npcsHere');
      if (!npcsHereEl || !world || !world.npcs || !player) return;
      
      const npcsInLocation = Object.values(world.npcs).filter(npc => 
        npc.ubicacion === player.locacion || npc.locacion === player.locacion
      );
      
      if (npcsInLocation.length === 0) {
        npcsHereEl.innerHTML = '<div style="opacity: 0.5; font-style: italic;">No hay nadie aqu√≠</div>';
        return;
      }
      
      const html = npcsInLocation.map(npc => {
        const relationColor = npc.relacion >= 70 ? '#00ff00' : npc.relacion >= 40 ? '#ffaa00' : '#ff0000';
        const relationIcon = npc.relacion >= 70 ? 'üòä' : npc.relacion >= 40 ? 'üòê' : 'üò†';
        
        return `
          <div style="padding: 8px; background: #1a1a1a; border-left: 3px solid ${relationColor}; margin-bottom: 6px; border-radius: 3px; cursor: pointer;" onclick="hablarCon('${npc.id}')">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong style="color: #00aaff;">${npc.nombre}</strong>
                <span style="opacity: 0.7; font-size: 10px; margin-left: 6px;">${npc.rol || 'Sobreviviente'}</span>
              </div>
              <div style="font-size: 16px;" title="Relaci√≥n: ${npc.relacion}/100">${relationIcon}</div>
            </div>
          </div>
        `;
      }).join('');
      
      npcsHereEl.innerHTML = html;
    }

    function renderLocationInfo() {
      if (!world || !world.locations || !player) return;
      
      const loc = world.locations[player.locacion];
      if (!loc) return;
      
      const zombieDisplay = loc.zombiesInitial ? `${loc.zombies || 0}/${loc.zombiesInitial}` : (loc.zombies || 0);
      const ruidoLevel = loc.nivelRuido || 0;
      const ruidoColor = ruidoLevel > 60 ? '#ff0000' : ruidoLevel > 30 ? '#ffaa00' : '#00ff00';
      const ruidoWidth = Math.min(100, (ruidoLevel / 100) * 100);
      
      const html = `
        <div>üßü Zombies: <span style="color: ${loc.zombies > 0 ? '#ff6666' : '#00ff00'};">${zombieDisplay}</span></div>
        <div>
          üîä Ruido: <span style="color: ${ruidoColor};">${ruidoLevel}/100</span>
          <div class="stat-bar" style="margin-top: 3px;">
            <div class="stat-fill" style="width: ${ruidoWidth}%; background: ${ruidoColor};"></div>
          </div>
          ${ruidoLevel > 60 ? '<div style="color: #ff0000; font-size: 10px; margin-top: 2px;">‚ö†Ô∏è ¬°MUY RUIDOSO! Puede atraer zombies</div>' : ''}
        </div>
        <div>üõ°Ô∏è Defensas: ${loc.defensas || 0}</div>
      `;
      
      const locationInfoEl = document.getElementById('locationInfo');
      if (locationInfoEl) {
        locationInfoEl.innerHTML = html;
      }
    }

    function renderSkills() {
      if (!player.skills) return;
      const html = Object.entries(player.skills)
        .map(([skill, nivel]) => {
          const barWidth = (nivel / 10) * 100;
          return `
            <div style="margin: 5px 0;">
              <strong>${skill}:</strong> ${nivel.toFixed(1)}/10
              <div class="stat-bar">
                <div class="stat-fill" style="width: ${barWidth}%; background: #00ffff;"></div>
              </div>
            </div>
          `;
        }).join('');
      safeRender('skills', html);
    }

    function renderDefensas() {
      const refugio = world.locations.refugio;
      if (refugio) {
        safeRender('defensas', `üõ°Ô∏è ${refugio.defensas || 0}`, 'textContent');
        // Tambi√©n actualizar en quick-defense del sidebar si existe
        safeRender('quick-defense', `${refugio.defensas || 0}`);
      }
    }

    function renderQuests() {
      if (!world.activeQuests || world.activeQuests.length === 0) {
        safeRender('quests', '<em>Sin quests activas</em>');
        return;
      }
      
      const html = world.activeQuests.map(q => `
        <div style="background: #1a1a1a; padding: 5px; margin: 5px 0; border-left: 2px solid #ffff00;">
          ${q.descripcion}
        </div>
      `).join('');
      safeRender('quests', html);
    }

    function craft(item) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No conectado al servidor', 'warning');
        return;
      }
      ws.send(JSON.stringify({ type: 'craft', item }));
    }
    
    function iniciarCombate() {
      // Verificar si hay zombies en la ubicaci√≥n
      if (!world || !world.locations || !player) {
        log('‚ö†Ô∏è Error al cargar datos del mundo', 'warning');
        return;
      }
      
      const loc = world.locations[player.locacion];
      if (!loc || !loc.zombies || loc.zombies === 0) {
        log('‚ö†Ô∏è No hay zombies aqu√≠ para atacar', 'warning');
        playSound('error');
        return;
      }
      
      // Cambiar al tab de combate
      switchTab('combate');
      
      // Dar tiempo a que cargue el tab y luego atacar
      setTimeout(() => {
        attack('melee');
      }, 100);
    }

    function attack(tipo) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No conectado al servidor', 'warning');
        return;
      }

      // Si ya estamos en combate, atacar directamente
      if (player.inCombat) {
        ws.send(JSON.stringify({ type: 'combat:attack', attackType: tipo }));
        return;
      }

      // Iniciar nuevo combate
      let confirmMsg = '';
      if (tipo === 'shoot') confirmMsg = '¬øIniciar combate con disparo? (consume arma)';
      else if (tipo === 'melee') confirmMsg = '¬øIniciar combate cuerpo a cuerpo?';
      else if (tipo === 'stealth') confirmMsg = '¬øAtaque sigiloso? Puede fallar.';
      
      if (confirm(confirmMsg)) {
        // Iniciar combate y hacer primer ataque
        ws.send(JSON.stringify({ type: 'attack', attackType: tipo }));
      }
    }

    function fleeCombat() {
      if (!player.inCombat) {
        log('No est√°s en combate', 'warning');
        return;
      }
      ws.send(JSON.stringify({ type: 'combat:flee' }));
    }

    function startCooldownDisplay() {
      // Actualizar botones cada 100ms durante el cooldown
      if (cooldownInterval) clearInterval(cooldownInterval);
      
      cooldownInterval = setInterval(() => {
        const remaining = attackCooldown - Date.now();
        if (remaining <= 0) {
          clearInterval(cooldownInterval);
          cooldownInterval = null;
          renderGame(); // Refrescar para habilitar botones
        } else {
          updateAttackButtonsState(remaining);
        }
      }, 100);
    }

    function updateAttackButtonsState(remainingMs) {
      const segundos = Math.ceil(remainingMs / 1000);
      const buttons = document.querySelectorAll('[onclick^="attack("]');
      buttons.forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
        const originalText = btn.textContent.split('‚è≥')[0].trim();
        btn.textContent = `${originalText} ‚è≥${segundos}s`;
      });
    }

    function renderLocations() {
      const current = world.locations[player.locacion];
      const html = current.conectado_a.map(locId => {
        const loc = world.locations[locId];
        const isDanger = loc.zombies > 2;
        return `
          <div class="location ${isDanger ? 'danger' : ''}" onclick="moveTo('${locId}')">
            <strong>${loc.nombre}</strong>
            ${loc.zombies > 0 ? `<span class="zombie-count">(üßü ${loc.zombies})</span>` : ''}
          </div>
        `;
      }).join('');
      document.getElementById('locations').innerHTML = html;
    }

    function renderNPCs() {
      // Filtrar NPCs por sub-ubicaci√≥n actual (si est√° en refugio)
      let filteredNPCs = Object.values(world.npcs).filter(npc => npc.locacion === 'refugio');
      
      // Si hay sub-ubicaci√≥n definida, filtrar tambi√©n por ella
      if (player.currentSubLocation) {
        filteredNPCs = filteredNPCs.filter(npc => npc.subLocation === player.currentSubLocation);
      }
      
      const html = filteredNPCs.map(npc => {
          const hasMissions = npc.misionesDisponibles && npc.misionesDisponibles.length > 0;
          
          // Mostrar nivel de relaci√≥n si el NPC es romanceable
          const relationshipBar = npc.romanceable ? `
            <div style="margin: 5px 0; font-size: 10px;">
              üíï Relaci√≥n: ${npc.relationshipLevel || 0}/100
              <div style="width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden;">
                <div style="width: ${npc.relationshipLevel || 0}%; height: 100%; background: linear-gradient(90deg, #ff4444 0%, #ff00ff 50%, #ff0088 100%);"></div>
              </div>
            </div>` : '';
          
          return `
          <div class="npc ${!npc.vivo ? 'dead' : ''}">
            <div class="npc-name">${npc.avatar || ''} ${npc.nombre} ${!npc.vivo ? 'üíÄ' : ''}</div>
            ${npc.vivo ? `
              <div style="font-size: 11px; margin: 5px 0;">
                ‚ù§Ô∏è ${npc.salud} | üçñ ${npc.hambre} | üòä ${npc.moral}
              </div>
              ${relationshipBar}
              <div style="display: flex; gap: 3px; flex-wrap: wrap;">
                <button onclick="openNPCInteractionMenu('${npc.id}')" style="flex: 1; min-width: 60px; padding: 5px; font-size: 11px; background: #004400; border-color: #00ff00;">üí¨ HABLAR</button>
                ${hasMissions ? `<button onclick="showNPCMissions('${npc.id}')" style="flex: 1; min-width: 40px; padding: 5px; font-size: 11px; background: #003366; border-color: #00aaff; color: #00aaff;" title="Misiones">üìú</button>` : ''}
              </div>
            ` : '<em>Muerto</em>'}
          </div>
        `;
        }).join('');
      document.getElementById('npcs').innerHTML = html || '<em style="color: #888;">No hay NPCs en esta ubicaci√≥n</em>';
    }

    // üèòÔ∏è RENDERIZAR NAVEGACI√ìN DE SUB-UBICACIONES
    function renderSubLocationNav() {
      if (!player || player.locacion !== 'refugio') {
        document.getElementById('subLocationNav').innerHTML = '<em style="color: #888; grid-column: span 3;">Solo disponible en el Refugio</em>';
        return;
      }
      
      const refugio = world.locations.refugio;
      if (!refugio || !refugio.subLocations) return;
      
      const currentSub = player.currentSubLocation || 'plaza';
      
      const html = Object.entries(refugio.subLocations).map(([id, sub]) => {
        const isActive = id === currentSub;
        return `
          <button 
            onclick="changeSubLocation('${id}')" 
            style="
              padding: 10px 8px;
              font-size: 11px;
              background: ${isActive ? '#003366' : '#1a2a1a'};
              border: 2px solid ${isActive ? '#00ffff' : '#444'};
              color: ${isActive ? '#00ffff' : '#aaa'};
              cursor: ${isActive ? 'default' : 'pointer'};
              border-radius: 5px;
              font-weight: ${isActive ? 'bold' : 'normal'};
            "
            ${isActive ? 'disabled' : ''}
          >
            ${sub.nombre}
          </button>
        `;
      }).join('');
      
      document.getElementById('subLocationNav').innerHTML = html;
      
      // Actualizar info de ubicaci√≥n actual
      const currentSubData = refugio.subLocations[currentSub];
      if (currentSubData) {
        document.getElementById('currentSubLocationName').textContent = currentSubData.nombre;
        document.getElementById('currentSubLocationDesc').textContent = currentSubData.descripcion;
      }
    }

    // üö∂ CAMBIAR DE SUB-UBICACI√ìN
    function changeSubLocation(subLocationId) {
      console.log('Cambiando a sub-ubicaci√≥n:', subLocationId);
      ws.send(JSON.stringify({
        type: 'sublocation:change',
        subLocationId
      }));
    }

    // üéÆ RENDERIZAR JUEGOS DISPONIBLES POR SUB-UBICACI√ìN
    function renderAvailableGames() {
      const container = document.getElementById('availableGames');
      if (!container) return;

      const currentSubLocation = player?.currentSubLocation || 'plaza';

      // Definir juegos por ubicaci√≥n
      const gamesByLocation = {
        taberna: [
          { type: 'poker', icon: 'üÉè', name: 'POKER', desc: 'Apuesta recursos', color: '#ff0000', bg: '#2a1a1a' },
          { type: 'blackjack', icon: 'üé¥', name: 'BLACKJACK', desc: '21 cl√°sico', color: '#0088ff', bg: '#1a2a1a' }
        ],
        callejon: [
          { type: 'dice', icon: 'üé≤', name: 'DADOS', desc: 'Juego r√°pido', color: '#00ff00', bg: '#1a1a2a' },
          { type: 'roulette', icon: 'üé∞', name: 'RULETA', desc: 'Suerte pura', color: '#ffaa00', bg: '#2a2a1a' }
        ],
        plaza: [],
        enfermeria: [],
        taller: [],
        dormitorios: []
      };

      const availableGames = gamesByLocation[currentSubLocation] || [];

      if (availableGames.length === 0) {
        container.innerHTML = `
          <div style="grid-column: span 2; text-align: center; padding: 30px; color: #888;">
            <div style="font-size: 32px; margin-bottom: 10px;">üéØ</div>
            <p>No hay juegos disponibles en esta ubicaci√≥n.</p>
            <p style="font-size: 11px; margin-top: 8px;">
              Ve a la <strong style="color: #ff6600;">üç∫ Taberna</strong> o al <strong style="color: #00ff00;">üé≤ Callej√≥n</strong> para jugar.
            </p>
          </div>
        `;
        return;
      }

      container.innerHTML = availableGames.map(game => `
        <button 
          onclick="joinGame('${game.type}')" 
          style="
            padding: 15px; 
            background: ${game.bg}; 
            border: 2px solid ${game.color}; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: all 0.3s;
          "
          onmouseover="this.style.transform='translateY(-3px)'; this.style.borderWidth='3px';"
          onmouseout="this.style.transform='translateY(0)'; this.style.borderWidth='2px';"
        >
          <div style="font-size: 24px; margin-bottom: 5px;">${game.icon}</div>
          <div style="font-weight: bold; margin-bottom: 3px;">${game.name}</div>
          <div style="font-size: 10px; color: #888;">${game.desc}</div>
          <div id="${game.type}Players" style="font-size: 11px; color: #00ff00; margin-top: 5px;">0 jugadores</div>
        </button>
      `).join('');
    }

    function renderWorldTime() {
      document.getElementById('worldTime').textContent = `D√≠a ${Math.floor(world.simulationTime / 144)}, ${(world.simulationTime % 144) * 10} min`;
    }

    function moveTo(locId) {
      ws.send(JSON.stringify({ type: 'move', targetId: locId }));
    }

    function scavenge() {
      ws.send(JSON.stringify({ type: 'scavenge' }));
    }

    function talkTo(npcId) {
      ws.send(JSON.stringify({ type: 'talk', npcId }));
    }

    function giveItem(npcId, item) {
      ws.send(JSON.stringify({ type: 'give', npcId, item, cantidad: 1 }));
    }
    
    function renderInteractiveDialogue() {
      try {
        const container = document.getElementById('interactiveDialogue');
        if (!container) {
          console.warn('Contenedor interactiveDialogue no encontrado');
          return;
        }
        
        if (!activeDialogue && dialogueHistory.length === 0) {
          container.innerHTML = '<em style="color: #888;">Sin conversaciones activas</em>';
          return;
        }
        
        let html = '<div style="max-height: 250px; overflow-y: auto; margin-bottom: 10px;">';
        
        // Mostrar historial de conversaci√≥n
        if (dialogueHistory && dialogueHistory.length > 0) {
          dialogueHistory.slice(-5).forEach(entry => {
            const time = new Date(entry.timestamp).toLocaleTimeString();
            html += `
              <div style="margin: 5px 0; padding: 8px; background: #1a2a2a; border-left: 3px solid #00ffff; border-radius: 3px;">
                <strong style="color: #00ffff;">${entry.speaker || 'Desconocido'}</strong> <span style="color: #666; font-size: 9px;">${time}</span>
                <div style="color: #ccc; margin-top: 3px; font-size: 12px;">${entry.text || ''}</div>
              </div>
            `;
          });
        }
        
        html += '</div>';
        
        // Mostrar opciones de respuesta si hay di√°logo activo
        if (activeDialogue) {
          html += '<div style="background: #2a3a2a; padding: 10px; border-radius: 5px;">';
          html += `<strong style="color: #ffaa00;">Responder a ${activeDialogue.npcName || 'NPC'}:</strong>`;
          
          if (activeDialogue.options && activeDialogue.options.length > 0) {
            html += '<div style="margin-top: 8px;">';
            activeDialogue.options.forEach((option, idx) => {
              html += `
                <button onclick="respondToDialogue(${idx})" style="display: block; width: 100%; margin: 5px 0; padding: 8px; font-size: 11px; text-align: left; background: #3a4a3a; border: 1px solid #00ff00;">
                  ${option.texto || 'Opci√≥n ' + (idx + 1)}
                </button>
              `;
            });
            html += '</div>';
          } else {
            html += '<button onclick="clearDialogue()" style="width: 100%; margin-top: 8px; padding: 8px;">Continuar</button>';
          }
          
          html += '</div>';
        } else if (dialogueHistory.length > 0) {
          html += '<button onclick="clearDialogue()" style="width: 100%; padding: 8px;">üóëÔ∏è Limpiar historial</button>';
        }
        
        container.innerHTML = html;
      } catch (error) {
        console.error('Error en renderInteractiveDialogue:', error);
        const container = document.getElementById('interactiveDialogue');
        if (container) {
          container.innerHTML = '<em style="color: #ff0000;">Error al mostrar di√°logo</em>';
        }
      }
    }
    
    function respondToDialogue(optionIndex) {
      try {
        if (!activeDialogue) {
          console.warn('No hay di√°logo activo');
          return;
        }
        
        if (!activeDialogue.options || !activeDialogue.options[optionIndex]) {
          console.error('Opci√≥n de di√°logo inv√°lida:', optionIndex);
          return;
        }
        
        const option = activeDialogue.options[optionIndex];
        
        // Agregar respuesta del jugador al historial
        dialogueHistory.push({
          speaker: player.nombre || 'Jugador',
          text: option.texto,
          timestamp: Date.now()
        });
        
        // Enviar respuesta al servidor
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({
            type: 'dialogue:respond',
            npcId: activeDialogue.npcId,
            optionIndex
          }));
        }
        
        // Limpiar di√°logo activo
        activeDialogue = null;
        renderInteractiveDialogue();
      } catch (error) {
        console.error('Error en respondToDialogue:', error);
        activeDialogue = null;
        renderInteractiveDialogue();
      }
    }
    
    function clearDialogue() {
      try {
        console.log('Limpiando di√°logo...');
        activeDialogue = null;
        dialogueHistory = [];
        renderInteractiveDialogue();
      } catch (error) {
        console.error('Error en clearDialogue:', error);
        activeDialogue = null;
        dialogueHistory = [];
        const container = document.getElementById('interactiveDialogue');
        if (container) {
          container.innerHTML = '<em style="color: #888;">Sin conversaciones activas</em>';
        }
      }
    }
    
    function renderSpecialEvent() {
      if (!world.activeEvents || world.activeEvents.length === 0) {
        document.getElementById('specialEvent').innerHTML = '<em style="color: #888;">Sin eventos</em>';
        return;
      }
      
      const evento = world.activeEvents[0];
      const html = `
        <div style="background: #3a2a1a; padding: 10px; border: 2px solid #ff8800; border-radius: 5px;">
          <strong style="color: #ffaa00;">${evento.nombre}</strong>
          <p style="margin: 8px 0; font-size: 11px; color: #ddd;">${evento.descripcion}</p>
          ${evento.opciones.map((op, idx) => {
            const costoStr = Object.entries(op.costo).map(([k,v]) => `${k}:${v}`).join(', ');
            return `<button onclick="respondEvent('${evento.id}', ${idx})" style="display: block; width: 100%; margin: 5px 0; padding: 5px; font-size: 11px;">
              ${op.texto} ${costoStr ? `(Costo: ${costoStr})` : ''}
            </button>`;
          }).join('')}
          <div style="margin-top: 8px; font-size: 10px; color: #ff5555;">
            Expira en ${evento.expiresIn - (world.simulationTime - evento.timestamp)} ticks
          </div>
        </div>
      `;
      document.getElementById('specialEvent').innerHTML = html;
    }
    
    function respondEvent(eventId, opcionIndex) {
      ws.send(JSON.stringify({ type: 'event:respond', eventId, opcionIndex }));
    }
    
    // ====================================
    // RENDERIZAR EVENTO NARRATIVO
    // ====================================
    function renderNarrativeEvent() {
      const container = document.getElementById('specialEvent');
      if (!world.activeNarrativeEvent) {
        return; // No sobrescribir si hay eventos regulares
      }
      
      const evento = world.activeNarrativeEvent;
      const html = `
        <div style="background: #1a1a2a; padding: 15px; border: 3px solid #8800ff; border-radius: 8px; box-shadow: 0 0 20px rgba(136, 0, 255, 0.5);">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <div style="font-size: 32px;">üìñ</div>
            <div>
              <strong style="color: #aa88ff; font-size: 14px;">${evento.nombre}</strong>
              <div style="font-size: 9px; color: #888;">Parte ${evento.parte} - Historia Encadenada</div>
            </div>
          </div>
          <p style="margin: 10px 0; font-size: 12px; color: #ccc; line-height: 1.4;">
            ${evento.descripcion}
          </p>
          <div style="margin-top: 15px;">
            ${evento.opciones.map((op, idx) => {
              let costoStr = '';
              let riesgoStr = '';
              let recompensaStr = '';
              
              if (op.costo && Object.keys(op.costo).length > 0) {
                costoStr = '<br><small style="color: #ff8888;">üí∞ ' + Object.entries(op.costo).map(([k,v]) => `${k}:${v}`).join(', ') + '</small>';
              }
              
              if (op.riesgo && op.riesgo > 0) {
                riesgoStr = `<br><small style="color: #ffaa00;">‚ö†Ô∏è Riesgo: ${(op.riesgo * 100).toFixed(0)}%</small>`;
              }
              
              if (op.recompensa && Object.keys(op.recompensa).length > 0) {
                const recompensaTexto = Object.entries(op.recompensa)
                  .map(([k,v]) => {
                    if (k === 'moral') return `moral ${v > 0 ? '+' : ''}${v}`;
                    if (k === 'defensas') return `defensas +${v}`;
                    if (k === 'npc_nuevo') return `NPC: ${v}`;
                    return `${k}:${v}`;
                  })
                  .join(', ');
                recompensaStr = `<br><small style="color: #88ff88;">‚úì ${recompensaTexto}</small>`;
              }
              
              return `
                <button onclick="respondNarrativeEvent(${idx})" 
                        style="display: block; width: 100%; margin: 8px 0; padding: 12px; font-size: 12px; 
                               background: #2a1a3a; border: 2px solid #aa88ff; color: #fff; cursor: pointer;
                               transition: all 0.3s; text-align: left;">
                  <strong>${idx + 1}. ${op.texto}</strong>
                  ${costoStr}${riesgoStr}${recompensaStr}
                </button>
              `;
            }).join('')}
          </div>
        </div>
      `;
      container.innerHTML = html;
    }
    
    function respondNarrativeEvent(opcionIndex) {
      playSound('success');
      ws.send(JSON.stringify({ type: 'narrative:respond', opcionIndex }));
    }
    
    // ‚ö†Ô∏è FUNCIONES DUPLICADAS ELIMINADAS - Las versiones actualizadas con safeRender est√°n arriba
    // renderDefensas(), renderQuests(), renderSkills() ahora usan safeRender (ver l√≠neas ~7023-7020)
    
    function renderPlayersHere() {
      if (!world || !world.players) {
        document.getElementById('playersHere').innerHTML = '<em style="color: #888;">Solo t√∫</em>';
        return;
      }
      
      const playersInLocation = Object.values(world.players)
        .filter(p => p.locacion === player.locacion && p.id !== player.id);
      
      if (playersInLocation.length === 0) {
        document.getElementById('playersHere').innerHTML = '<em style="color: #888;">Solo t√∫</em>';
        return;
      }
      
      const html = playersInLocation.map(p => `
        <div style="margin: 5px 0; padding: 5px; background: #1a3a1a; border-left: 2px solid #00ff00;">
          <strong>${p.nombre}</strong>
          <div style="font-size: 10px; color: #aaa;">
            ‚ù§Ô∏è ${p.salud} | üéí ${Object.values(p.inventario || {}).reduce((a,b) => a+b, 0)} items
          </div>
        </div>
      `).join('');
      
      document.getElementById('playersHere').innerHTML = html;
    }
    
    function renderRefugioRecursos() {
      if (!world || !world.locations || !world.locations.refugio) return;
      
      const refugio = world.locations.refugio;
      const recursos = refugio.recursos || {};
      
      // Actualizar defensas
      const defensasEl = document.getElementById('defensas');
      if (defensasEl) {
        defensasEl.textContent = `üõ°Ô∏è Defensas: ${refugio.defensas || 0}`;
      }
      
      // Actualizar recursos
      const html = Object.entries(recursos).map(([item, cant]) => {
        let color = '#00ff00';
        if (cant < 5) color = '#ff0000';
        else if (cant < 10) color = '#ffaa00';
        
        return `<div style="margin: 3px 0; color: ${color};">${item}: ${cant}</div>`;
      }).join('');
      
      const refugioEl = document.getElementById('refugioRecursos');
      if (refugioEl) {
        refugioEl.innerHTML = html || '<em style="color: #888;">Sin recursos</em>';
      }
    }

    function renderOnlinePlayers(players) {
      const onlineCount = document.getElementById('onlineCount');
      const onlinePlayers = document.getElementById('onlinePlayers');
      
      // Validar que los elementos existan
      if (!onlineCount || !onlinePlayers) return;
      
      if (!players || players.length === 0) {
        onlineCount.textContent = '0';
        onlinePlayers.innerHTML = '<em style="color: #888;">Sin jugadores conectados</em>';
        // Limpiar select de DMs
        const dmSelect = document.getElementById('dmTargetSelect');
        if (dmSelect) dmSelect.innerHTML = '<option value="">Sin jugadores online</option>';
        return;
      }
      
      onlineCount.textContent = players.length;
      
      // Actualizar cach√© de jugadores
      players.forEach(p => {
        allPlayers[p.id] = p.nombre;
      });
      
      // Actualizar select de DMs
      const dmSelect = document.getElementById('dmTargetSelect');
      if (dmSelect) {
        dmSelect.innerHTML = '<option value="">Selecciona jugador...</option>' + 
          players
            .filter(p => p.id !== player.id)
            .map(p => `<option value="${p.id}">${p.nombre}</option>`)
            .join('');
      }
      
      const html = players.map(p => {
        const isMe = p.id === player.id;
        const locationName = world.locations && world.locations[p.locacion] 
          ? world.locations[p.locacion].nombre 
          : p.locacion;
        
        const stats = p.stats || {};
        const zombies = stats.zombies_matados || 0;
        let rankBadge = '';
        if (zombies > 100) rankBadge = 'üíÄ';
        else if (zombies > 50) rankBadge = '‚öîÔ∏è';
        else if (zombies > 20) rankBadge = 'üî™';
        
        return `
          <div class="player-card-inspect" onclick="${isMe ? '' : `inspectPlayer('${p.id}')`}" style="${isMe ? 'background: #2a4a2a; border-left-color: #ffff00; cursor: default;' : ''}">
            ${rankBadge ? `<div class="rank-badge">${rankBadge}</div>` : ''}
            <div style="font-weight: bold; color: ${isMe ? '#ffff00' : '#00ff00'}; font-size: 14px;">
              ${isMe ? '‚≠ê ' : ''}${p.nombre}${isMe ? ' (T√∫)' : ''}
            </div>
            <div style="font-size: 11px; color: #888; margin-top: 5px;">
              üìç ${locationName} | Nv.${p.nivel || 1} | ‚ù§Ô∏è ${p.salud || 100}
            </div>
            ${!isMe ? '<div style="font-size: 10px; color: #00ff00; margin-top: 5px;">üëÅÔ∏è Click para inspeccionar</div>' : ''}
          </div>
        `;
      }).join('');
      
      onlinePlayers.innerHTML = html;
    }

    function renderQuestCooperativa(quest) {
      const html = `
        <div style="background: #2a4a2a; padding: 10px; border-radius: 5px; border: 2px solid #ffff00;">
          <strong style="color: #ffff00; font-size: 14px;">${quest.nombre}</strong>
          <p style="margin: 10px 0; color: #ccc;">${quest.descripcion}</p>
          <div style="margin-top: 10px;">
            ${quest.opciones.map(opt => `
              <button onclick="votarQuest('${opt}')" style="width: 100%; padding: 8px; margin: 3px 0;">
                ${opt} <span id="votos-${opt.replace(/\s/g, '')}" style="color: #ffaa00;"></span>
              </button>
            `).join('')}
          </div>
        </div>
      `;
      document.getElementById('questCooperativa').innerHTML = html;
    }

    function updateVotosQuest(votos) {
      Object.keys(votos).forEach(opcion => {
        const el = document.getElementById(`votos-${opcion.replace(/\s/g, '')}`);
        if (el) {
          el.textContent = `(${votos[opcion].length} votos)`;
        }
      });
    }

    function votarQuest(opcion) {
      ws.send(JSON.stringify({
        type: 'quest:vote',
        opcion: opcion
      }));
    }

    // Sistema de notificaciones
    function showNotification(message, type = 'success') {
      const notif = document.createElement('div');
      notif.className = `notification ${type}`;
      notif.textContent = message;
      document.body.appendChild(notif);
      
      setTimeout(() => {
        notif.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => notif.remove(), 300);
      }, 3000);
    }
    
    // üí• Sistema de feedback de consecuencias
    function showConsequence(text, type = 'neutral') {
      const container = document.getElementById('consequenceFeedback');
      if (!container) return;
      
      const popup = document.createElement('div');
      popup.className = `consequence-popup ${type}`;
      popup.textContent = text;
      
      container.appendChild(popup);
      
      // Auto-remover despu√©s de 3 segundos
      setTimeout(() => {
        popup.remove();
      }, 3000);
    }
    
    // Helper para mostrar cambios de stats
    function showStatChange(stat, amount) {
      let icon = '';
      let type = 'neutral';
      
      switch(stat) {
        case 'salud':
        case 'health':
          icon = '‚ù§Ô∏è';
          type = amount > 0 ? 'positive' : 'negative';
          break;
        case 'hambre':
        case 'hunger':
          icon = 'üçñ';
          type = amount < 0 ? 'positive' : 'negative'; // Menos hambre es bueno
          break;
        case 'energia':
        case 'energy':
          icon = '‚ö°';
          type = amount > 0 ? 'positive' : 'negative';
          break;
        case 'moral':
        case 'morale':
          icon = 'üòä';
          type = amount > 0 ? 'positive' : 'negative';
          break;
        case 'comida':
        case 'food':
          icon = 'ü•´';
          type = amount > 0 ? 'positive' : 'negative';
          break;
        case 'agua':
        case 'water':
          icon = 'üíß';
          type = amount > 0 ? 'positive' : 'negative';
          break;
        case 'materiales':
        case 'materials':
          icon = 'üîß';
          type = amount > 0 ? 'positive' : 'negative';
          break;
        case 'medicina':
        case 'medicine':
          icon = 'üíä';
          type = amount > 0 ? 'positive' : 'negative';
          break;
        case 'armas':
        case 'weapons':
          icon = 'üî´';
          type = amount > 0 ? 'positive' : 'negative';
          break;
        default:
          icon = 'üìä';
      }
      
      const sign = amount > 0 ? '+' : '';
      showConsequence(`${icon} ${sign}${amount} ${stat}`, type);
    }

    // ‚ö†Ô∏è DESHABILITADO: Extensi√≥n de handleMessage (las notificaciones ya se manejan dentro de cada handler)
    // const originalHandleMessage = handleMessage;
    // handleMessage = function(msg) {
    //   // Notificaciones especiales
    //   if (msg.type === 'player:joined' && msg.playerId !== player.id) {
    //     showNotification(`${msg.nombre} se uni√≥ al juego`, 'success');
    //   }
    //   if (msg.type === 'level:up') {
    //     showNotification(`¬°NIVEL ${msg.nivel}!`, 'success');
    //   }
    //   if (msg.type === 'horde:warning') {
    //     showNotification('‚ö†Ô∏è HORDA ACERC√ÅNDOSE', 'danger');
    //   }
    //   
    //   // Llamar a la funci√≥n original
    //   originalHandleMessage(msg);
    // };

    // Atajos de teclado
    document.addEventListener('keydown', (e) => {
      // Si est√° escribiendo en el chat, ignorar
      if (document.activeElement.id === 'chatInput' || 
          document.activeElement.id === 'playerName') {
        return;
      }
      
      // S = Scavenge
      if (e.key === 's' || e.key === 'S') {
        scavenge();
      }
      // C = Combat (deshabilitado, usar botones de combate)
      // if (e.key === 'c' || e.key === 'C') {
      //   combat();
      // }
      // T = Trade
      if (e.key === 't' || e.key === 'T') {
        tradeWithNPC('comerciante');
      }
      // H = Hablar con Dr. G√≥mez
      if (e.key === 'h' || e.key === 'H') {
        talkToNPC('dr_gomez');
      }
    });

    // Auto-guardar el estado peri√≥dicamente
    setInterval(() => {
      if (player && player.id) {
        // El servidor ya guarda autom√°ticamente, solo actualizar UI
        if (world && world.locations) {
          renderGame();
        }
      }
    }, 10000); // Cada 10 segundos

    // ====================================
    // NUEVAS FUNCIONES - SISTEMAS AVANZADOS
    // ====================================

    // Crear grupo
    async function createGroup() {
      const groupName = prompt('Nombre del grupo:');
      if (!groupName) return;
      
      const data = await safeFetch('/api/group/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id, groupName })
      });
      
      if (data.success) {
        showNotification('Grupo creado!', 'success');
        renderGroupPanel(data.group);
      }
    }

    // Invitar a jugador al grupo
    async function inviteToGroup(targetId) {
      const response = await fetch('/api/group/invite', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id, targetId })
      });
      
      const data = await response.json();
      if (data.success) {
        showNotification('Jugador invitado!', 'success');
        renderGroupPanel(data.group);
      } else {
        showNotification(data.error, 'warning');
      }
    }

    // Salir del grupo
    async function leaveGroup() {
      if (!confirm('¬øSalir del grupo?')) return;
      
      const response = await fetch('/api/group/leave', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id })
      });
      
      const data = await response.json();
      if (data.success) {
        showNotification('Saliste del grupo', 'success');
        document.getElementById('groupPanel').innerHTML = '<button onclick="createGroup()" style="width: 100%; padding: 10px; margin: 5px 0;">‚ûï Crear Grupo</button>';
      }
    }

    // Mejorar refugio
    async function upgradeRefugio(upgradeType) {
      const response = await fetch('/api/refugio/upgrade', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id, upgradeType })
      });
      
      const data = await response.json();
      if (data.success) {
        showNotification(`${upgradeType} mejorado!`, 'success');
        player.inventario = data.inventario;
        renderGame();
      } else {
        showNotification(data.error, 'warning');
      }
    }

    // Abrir di√°logo de comercio
    function openTradeDialog() {
      const targetId = document.getElementById('tradeTargetSelect').value;
      if (!targetId || targetId === 'none') {
        showNotification('Selecciona un jugador', 'warning');
        return;
      }
      
      // Crear di√°logo simple para definir la oferta
      const offering = prompt('¬øQu√© ofreces? (formato: comida:5,materiales:3)');
      const requesting = prompt('¬øQu√© solicitas? (formato: medicinas:2,armas:1)');
      
      if (!offering || !requesting) return;
      
      const parseItems = (str) => {
        const items = {};
        str.split(',').forEach(pair => {
          const [item, amount] = pair.trim().split(':');
          items[item] = parseInt(amount);
        });
        return items;
      };
      
      createTradeOffer(targetId, parseItems(offering), parseItems(requesting));
    }

    // Crear oferta de comercio
    async function createTradeOffer(targetId, offering, requesting) {
      const response = await fetch('/api/trade/offer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id, targetId, offering, requesting })
      });
      
      const data = await response.json();
      if (data.success) {
        showNotification('Oferta enviada!', 'success');
      } else {
        showNotification(data.error, 'warning');
      }
    }

    // Responder a oferta de comercio
    async function respondToTrade(offerId, accept) {
      const response = await fetch('/api/trade/respond', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id, offerId, accept })
      });
      
      const data = await response.json();
      showNotification(data.message || data.error, data.success ? 'success' : 'warning');
      if (data.success) renderGame();
    }

    // Renderizar panel de grupo
    function renderGroupPanel(group) {
      if (!group) {
        document.getElementById('groupPanel').innerHTML = '<button onclick="createGroup()" style="width: 100%; padding: 10px; margin: 5px 0;">‚ûï Crear Grupo</button>';
        document.getElementById('groupMemberCount').textContent = '';
        return;
      }
      
      const membersHTML = group.members.map(mid => {
        const member = world.players && world.players[mid];
        return member ? `<div style="margin: 5px 0;">${member.nombre} ${member.id === player.id ? '(T√∫)' : ''}</div>` : '';
      }).join('');
      
      document.getElementById('groupPanel').innerHTML = `
        <div style="padding: 10px; background: #1a3a1a; border-radius: 5px;">
          <strong style="color: #ffff00;">${group.name}</strong>
          <div style="margin-top: 10px;">${membersHTML}</div>
          <button onclick="leaveGroup()" style="width: 100%; margin-top: 10px; padding: 8px; background: #4a1a1a;">üö™ Salir del Grupo</button>
        </div>
      `;
      
      document.getElementById('groupMemberCount').textContent = `(${group.members.length}/4)`;
    }

    // ====================================
    // SISTEMA SOCIAL: FOGATA Y JUEGOS
    // ====================================

    // Verificar acceso a caracter√≠sticas sociales (solo refugio)
    function checkSocialAccess() {
      const inRefugio = player && player.locacion === 'refugio';
      
      // Fogata
      const fogataLocked = document.getElementById('fogataLocked');
      const fogataUnlocked = document.getElementById('fogataUnlocked');
      if (fogataLocked && fogataUnlocked) {
        if (inRefugio) {
          fogataLocked.style.display = 'none';
          fogataUnlocked.style.display = 'block';
          loadFogata();
        } else {
          fogataLocked.style.display = 'block';
          fogataUnlocked.style.display = 'none';
        }
      }
      
      // Juegos
      const gamesLocked = document.getElementById('gamesLocked');
      const gamesUnlocked = document.getElementById('gamesUnlocked');
      if (gamesLocked && gamesUnlocked) {
        if (inRefugio) {
          gamesLocked.style.display = 'none';
          gamesUnlocked.style.display = 'block';
          loadActiveGames();
        } else {
          gamesLocked.style.display = 'block';
          gamesUnlocked.style.display = 'none';
        }
      }
    }

    // Crear post en la fogata
    async function createPost() {
      const title = document.getElementById('postTitle').value.trim();
      const content = document.getElementById('postContent').value.trim();
      const category = document.getElementById('postCategory').value;
      
      if (!title || !content) {
        showNotification('Completa t√≠tulo y contenido', 'warning');
        return;
      }
      
      if (player.locacion !== 'refugio') {
        showNotification('Debes estar en el refugio', 'warning');
        return;
      }
      
      ws.send(JSON.stringify({
        type: 'fogata:create',
        title,
        content,
        category
      }));
      
      // Limpiar campos
      document.getElementById('postTitle').value = '';
      document.getElementById('postContent').value = '';
    }

    // Variables de estado de fogata
    let currentSortBy = 'recent';
    
    // Cambiar ordenamiento
    function changeSortBy(sortBy) {
      currentSortBy = sortBy;
      
      // Actualizar estilos de botones
      ['recent', 'likes', 'comments'].forEach(type => {
        const btn = document.getElementById(`sort-${type}`);
        if (btn) {
          if (type === sortBy) {
            btn.style.background = '#ff8800';
            btn.style.color = '#000';
            btn.style.border = 'none';
            btn.style.fontWeight = 'bold';
          } else {
            btn.style.background = '#1a1a1a';
            btn.style.color = '#888';
            btn.style.border = '1px solid #333';
            btn.style.fontWeight = 'normal';
          }
        }
      });
      
      loadFogata();
    }
    
    // Cargar posts de la fogata
    function loadFogata() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ 
        type: 'fogata:load',
        sortBy: currentSortBy,
        limit: 20,
        page: 0
      }));
    }

    // Dar like a post
    function likePost(postId) {
      ws.send(JSON.stringify({ type: 'fogata:like', postId }));
    }

    // Comentar post
    function commentPost(postId) {
      const commentText = prompt('Escribe tu comentario (m√°x 200 caracteres):');
      if (!commentText || !commentText.trim()) {
        return;
      }
      
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        showNotification('‚ùå No conectado al servidor', 'warning');
        return;
      }
      
      ws.send(JSON.stringify({
        type: 'fogata:comment',
        postId,
        content: commentText.trim().substring(0, 200)
      }));
    }

    // Ver comentarios de un post
    function toggleComments(postId) {
      const commentsDiv = document.getElementById(`comments-${postId}`);
      if (!commentsDiv) return;
      
      if (commentsDiv.style.display === 'none') {
        commentsDiv.style.display = 'block';
        ws.send(JSON.stringify({ type: 'fogata:loadComments', postId }));
      } else {
        commentsDiv.style.display = 'none';
      }
    }

    // Renderizar feed de la fogata
    function renderFogata(posts) {
      const feed = document.getElementById('fogataFeed');
      if (!feed) return;
      
      if (!posts || posts.length === 0) {
        feed.innerHTML = '<div style="text-align: center; padding: 30px; color: #888;"><div style="font-size: 48px; margin-bottom: 10px;">üî•</div><p>A√∫n no hay posts. ¬°S√© el primero en compartir!</p></div>';
        return;
      }
      
      const categoryIcons = {
        historia: 'üìñ',
        consejo: 'üí°',
        pregunta: '‚ùì',
        busco_grupo: 'üë•',
        comercio: 'üí∞',
        general: 'üí¨'
      };
      
      let html = posts.map(post => {
        const icon = categoryIcons[post.category] || 'üí¨';
        const timeAgo = getTimeAgo(post.timestamp);
        
        return `
          <div style="background: #1a2a1a; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ff8800;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
              <div style="flex: 1;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                  <span style="font-size: 20px;">${icon}</span>
                  <strong style="font-size: 14px; color: #ffaa00;">${escapeHtml(post.title)}</strong>
                </div>
                <div style="font-size: 10px; color: #888;">
                  Por <strong style="color: #00ff00;">${escapeHtml(post.authorName)}</strong> ‚Ä¢ ${timeAgo}
                </div>
              </div>
            </div>
            
            <p style="font-size: 12px; color: #ddd; line-height: 1.5; margin-bottom: 10px; white-space: pre-wrap;">
              ${escapeHtml(post.content)}
            </p>
            
            <div style="display: flex; gap: 15px; align-items: center; padding-top: 10px; border-top: 1px solid #333; font-size: 11px;">
              <button onclick="likePost('${post.id}')" style="background: none; border: none; color: ${(post.likes && post.likes.includes(player.id)) ? '#ff0000' : '#888'}; cursor: pointer; display: flex; align-items: center; gap: 5px; padding: 5px 10px;">
                ‚ù§Ô∏è <span id="likes-${post.id}">${(post.likes || []).length}</span>
              </button>
              <button onclick="toggleComments('${post.id}')" style="background: none; border: none; color: #888; cursor: pointer; display: flex; align-items: center; gap: 5px; padding: 5px 10px;">
                üí¨ <span id="commentCount-${post.id}">${post.commentCount || 0}</span>
              </button>
              <button onclick="commentPost('${post.id}')" style="background: none; border: none; color: #00ff00; cursor: pointer; padding: 5px 10px;">
                ‚úçÔ∏è Comentar
              </button>
            </div>
            
            <div id="comments-${post.id}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #333;">
              <div style="text-align: center; padding: 20px; color: #888;">Cargando comentarios...</div>
            </div>
          </div>
        `;
      }).join('');
      
      feed.innerHTML = html;
    }

    // Actualizar likes de un post en tiempo real
    function updatePostLikes(postId, likes) {
      const likesElement = document.getElementById(`likes-${postId}`);
      if (likesElement) {
        likesElement.textContent = likes.length;
      }
      // No recargar toda la fogata, solo actualizar el contador
    }

    // Actualizar contador de comentarios en tiempo real
    function updatePostCommentCount(postId, count) {
      const countElement = document.getElementById(`commentCount-${postId}`);
      if (countElement) {
        countElement.textContent = count;
      }
    }

    // Renderizar comentarios de un post
    function renderComments(postId, comments) {
      const commentsDiv = document.getElementById(`comments-${postId}`);
      if (!commentsDiv) return;
      
      if (!comments || comments.length === 0) {
        commentsDiv.innerHTML = '<div style="text-align: center; padding: 10px; color: #888; font-size: 11px;">No hay comentarios a√∫n</div>';
        return;
      }
      
      let html = comments.map(comment => {
        const timeAgo = getTimeAgo(comment.timestamp);
        const isNPC = comment.isNPC || false;
        const bgColor = isNPC ? '#1a1a2a' : '#0a1a0a';
        const borderColor = isNPC ? '#8888ff' : 'transparent';
        const npcBadge = isNPC ? '<span style="background: #4a4aff; color: #fff; font-size: 8px; padding: 2px 4px; border-radius: 3px; margin-left: 5px;">NPC</span>' : '';
        
        return `
          <div style="background: ${bgColor}; padding: 10px; border-radius: 5px; margin-bottom: 8px; border-left: 2px solid ${borderColor};">
            <div style="font-size: 10px; color: #888; margin-bottom: 5px;">
              <strong style="color: ${comment.authorColor || '#00ff00'};">${escapeHtml(comment.authorName)}</strong>${npcBadge} ‚Ä¢ ${timeAgo}
            </div>
            <div style="font-size: 11px; color: #ddd;">
              ${escapeHtml(comment.content)}
            </div>
          </div>
        `;
      }).join('');
      
      commentsDiv.innerHTML = html;
    }

    // Unirse a juego de mesa
    let currentGame = null;
    
    function joinGame(gameType) {
      if (player.locacion !== 'refugio') {
        showNotification('Debes estar en el refugio', 'warning');
        return;
      }

      // üèòÔ∏è VALIDAR SUB-UBICACI√ìN PARA JUEGOS
      const gameLocations = {
        poker: 'taberna',
        blackjack: 'taberna',
        dice: 'callejon',
        roulette: 'callejon'
      };

      const requiredLocation = gameLocations[gameType];
      const currentSubLocation = player.currentSubLocation || 'plaza';

      if (requiredLocation && currentSubLocation !== requiredLocation) {
        const locationNames = {
          taberna: 'üç∫ Taberna',
          callejon: 'üé≤ Callej√≥n'
        };
        showNotification(`Debes estar en ${locationNames[requiredLocation]} para jugar`, 'warning');
        return;
      }
      
      // Guardar tipo de juego actual
      currentGame = { type: gameType, players: [] };
      
      ws.send(JSON.stringify({
        type: 'game:join',
        gameType
      }));
      
      // Abrir modal de juego
      openGameModal(gameType);
    }

    // Cargar juegos activos
    function loadActiveGames() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: 'game:list' }));
    }

    // Renderizar juegos activos
    function renderActiveGames(games) {
      const container = document.getElementById('activeGames');
      if (!container) return;
      
      if (!games || games.length === 0) {
        container.innerHTML = '<em style="color: #888;">No hay partidas activas</em>';
        return;
      }
      
      const gameIcons = {
        poker: 'üÉè',
        dice: 'üé≤',
        roulette: 'üé∞',
        blackjack: 'üé¥'
      };
      
      let html = games.map(game => {
        const icon = gameIcons[game.type] || 'üéÆ';
        const potComida = game.pot?.comida || 0;
        
        return `
          <div style="background: #1a1a2a; padding: 10px; border-radius: 5px; margin-bottom: 8px; border-left: 3px solid #ffaa00;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong>${icon} ${game.name || game.type.toUpperCase()}</strong>
                <div style="font-size: 10px; color: #888; margin-top: 3px;">
                  ${game.players} jugadores
                </div>
                <div style="font-size: 10px; color: #ffaa00; margin-top: 2px;">
                  Pozo: ${potComida} comida
                </div>
              </div>
              ${game.status === 'waiting' ? `<button onclick="joinGame('${game.type}')" style="padding: 5px 10px; font-size: 10px;">Unirse</button>` : `<span style="color: #888; font-size: 10px;">En juego...</span>`}
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = html;
      
      // Actualizar contadores de jugadores en los botones
      const gameCounts = {
        poker: 0,
        dados: 0,
        ruleta: 0,
        blackjack: 0
      };
      
      games.forEach(game => {
        if (gameCounts[game.type] !== undefined) {
          gameCounts[game.type] += game.players.length;
        }
      });
      
      Object.keys(gameCounts).forEach(type => {
        const el = document.getElementById(`${type}Players`);
        if (el) el.textContent = `${gameCounts[type]} jugadores`;
      });
    }

    // Funciones auxiliares
    function getTimeAgo(timestamp) {
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      if (seconds < 60) return 'ahora';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `hace ${minutes}m`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `hace ${hours}h`;
      const days = Math.floor(hours / 24);
      return `hace ${days}d`;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function sendGroupChat() {
      const input = document.getElementById('groupChatInput');
      if (!input || !input.value.trim()) return;
      
      ws.send(JSON.stringify({
        type: 'groupChat',
        message: input.value.trim()
      }));
      
      input.value = '';
    }

    // ====================================
    // FIN SISTEMA SOCIAL
    // ====================================

    // Renderizar logros
    function renderAchievements() {
      const achievementsDiv = document.getElementById('achievements');
      const countSpan = document.getElementById('achievementCount');
      
      if (!window.achievementSystem) {
        achievementsDiv.innerHTML = '<em style="color: #888;">Cargando sistema de logros...</em>';
        return;
      }

      const progress = window.achievementSystem.getProgress();
      countSpan.textContent = `(${progress.unlocked}/${progress.total}) - ${progress.percentage}%`;

      // Renderizar todos los logros (desbloqueados y bloqueados)
      const allAchievements = window.achievementSystem.achievements;
      const unlockedIds = window.achievementSystem.unlockedAchievements;

      // Agrupar por categor√≠a
      const categories = {
        'Exploraci√≥n': [],
        'Combate': [],
        'Supervivencia': [],
        'Recursos': [],
        'Social': [],
        'Crafteo': []
      };

      Object.values(allAchievements).forEach(achievement => {
        categories[achievement.category].push(achievement);
      });

      let html = '';
      
      Object.entries(categories).forEach(([category, achievements]) => {
        if (achievements.length === 0) return;
        
        html += `
          <div style="margin-bottom: var(--space-md);">
            <h4 style="color: var(--blue-info); font-size: 13px; margin-bottom: var(--space-sm); border-bottom: 1px solid #333; padding-bottom: 4px;">
              üìÅ ${category}
            </h4>
        `;
        
        achievements.forEach(achievement => {
          const isUnlocked = unlockedIds.includes(achievement.id);
          const rarityColors = {
            'common': '#9ca3af',
            'uncommon': '#10b981',
            'rare': '#3b82f6',
            'epic': '#a855f7',
            'legendary': '#f59e0b'
          };
          const borderColor = rarityColors[achievement.rarity] || '#888';
          
          html += `
            <div style="
              margin: var(--space-xs) 0; 
              padding: var(--space-sm); 
              background: ${isUnlocked ? 'linear-gradient(135deg, #1a3a1a 0%, #0d2a0d 100%)' : '#1a1a1a'}; 
              border-left: 3px solid ${borderColor}; 
              border-radius: 5px;
              ${!isUnlocked ? 'opacity: 0.5;' : ''}
              transition: all 0.2s ease-out;
            " ${isUnlocked ? 'onmouseover="this.style.transform=\'scale(1.02)\'" onmouseout="this.style.transform=\'scale(1)\'"' : ''}>
              <div style="display: flex; align-items: center; gap: var(--space-sm);">
                <div style="font-size: 32px; ${!isUnlocked ? 'filter: grayscale(1) opacity(0.3);' : ''}">
                  ${isUnlocked ? achievement.icon : 'üîí'}
                </div>
                <div style="flex: 1;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <strong style="color: ${isUnlocked ? borderColor : '#666'}; font-size: 13px;">
                      ${achievement.name}
                    </strong>
                    <span style="
                      font-size: 9px; 
                      padding: 2px 6px; 
                      background: ${borderColor}; 
                      color: #000; 
                      border-radius: 10px; 
                      font-weight: bold;
                      text-transform: uppercase;
                    ">
                      ${achievement.rarity}
                    </span>
                  </div>
                  <div style="font-size: 11px; color: ${isUnlocked ? '#aaa' : '#555'}; margin-top: 4px;">
                    ${isUnlocked ? achievement.description : '???'}
                  </div>
                </div>
              </div>
            </div>
          `;
        });
        
        html += '</div>';
      });

      achievementsDiv.innerHTML = html;
    }

    // Renderizar tiempo d√≠a/noche
    function renderTimeOfDay() {
      if (!world.timeOfDay && world.timeOfDay !== 0) return;
      
      const hour = world.timeOfDay;
      const day = world.dayCount || 1;
      const timeStr = `${String(hour).padStart(2, '0')}:00`;
      
      let icon = '‚òÄÔ∏è';
      let color = '#ffff00';
      if (hour >= 20 || hour <= 6) {
        icon = 'üåô';
        color = '#4444ff';
      } else if (hour >= 18 || hour <= 8) {
        icon = 'üåÖ';
        color = '#ffaa00';
      }
      
      safeRender('timeDisplay', `<span style="color: ${color};">${icon} D√≠a ${day} - ${timeStr}</span>`);
    }

    // Renderizar estad√≠sticas del jugador (stats avanzadas)
    function renderPlayerStats2() {
      if (!player.stats) return;
      
      const html = `
        <div>üßü Zombies: ${player.stats.zombies_matados || 0}</div>
        <div>üî® Crafteos: ${player.stats.items_crafteados || 0}</div>
        <div>üó∫Ô∏è Locaciones: ${player.stats.locaciones_visitadas || 1}</div>
        <div>üì¶ Recursos: ${player.stats.recursos_totales || 0}</div>
        <div>ü§ù Comercios: ${player.stats.comercios_completados || 0}</div>
        <div>üí™ Tanques: ${player.stats.tanques_matados || 0}</div>
      `;
      
      safeRender('playerStats2', html);
    }

    // Actualizar selector de jugadores para comercio
    function updateTradePlayerSelect(players) {
      const select = document.getElementById('tradeTargetSelect');
      if (!select) return;
      
      const options = players
        .filter(p => p.id !== player.id)
        .map(p => `<option value="${p.id}">${p.nombre} (Nv.${p.nivel})</option>`)
        .join('');
      
      select.innerHTML = options || '<option value="none">Sin jugadores disponibles</option>';
    }

    // ‚ö†Ô∏è DESHABILITADO: Extensi√≥n de renderGame que causaba recursi√≥n
    // Las funciones renderAchievements, renderTimeOfDay, renderPlayerStats2 
    // ahora se llaman desde renderGame() principal con safeCall
    // const originalRenderGame = renderGame;
    // renderGame = function() {
    //   originalRenderGame();
    //   renderAchievements();
    //   renderTimeOfDay();
    //   renderPlayerStats2();
    // };

    // Handler para logros desbloqueados
    function handleAchievementUnlocked(achievement) {
      showNotification(`üèÜ Logro desbloqueado: ${achievement.nombre}!`, 'success');
      log(`üèÜ Desbloqueaste: ${achievement.nombre} - ${achievement.descripcion}`, 'success');
    }

    // ====================================
    // FUNCIONES PARA NUEVOS SISTEMAS
    // ====================================

    // MISIONES
    function renderMissions() {
      if (!world.activeMissions || world.activeMissions.length === 0) {
        document.getElementById('missionsPanel').innerHTML = '<em style="color: #888;">Sin misiones disponibles</em>';
        document.getElementById('missionCount').textContent = '';
        return;
      }

      const availableMissions = world.activeMissions.filter(m => !m.completedBy.includes(player.id));
      
      const html = availableMissions.map(mission => {
        return `
          <div style="margin: 8px 0; padding: 8px; background: #2a2a1a; border-left: 3px solid #ffaa00; border-radius: 3px;">
            <strong style="color: #ffaa00;">${mission.descripcion}</strong>
            <div style="font-size: 10px; color: #aaa; margin: 4px 0;">Tipo: ${mission.tipo} | Cantidad: ${mission.cantidad}</div>
            <div style="font-size: 10px; color: #0f0;">Recompensa: ${Object.entries(mission.recompensa).map(([k,v]) => `${k}:${v}`).join(', ')}</div>
            <button onclick="completeDailyMission('${mission.id}')" style="width: 100%; margin-top: 5px; padding: 5px; font-size: 10px;">‚úÖ Completar</button>
          </div>
        `;
      }).join('');

      document.getElementById('missionsPanel').innerHTML = html || '<em style="color: #888;">Todas completadas</em>';
      document.getElementById('missionCount').textContent = `(${availableMissions.length})`;
    }

    async function completeDailyMission(missionId) {
      // Prevenir clicks m√∫ltiples
      if (pendingActions.has(`mission-${missionId}`)) return;
      pendingActions.add(`mission-${missionId}`);
      
      const data = await safeFetch('/api/mission/complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id, missionId })
      });
      
      pendingActions.delete(`mission-${missionId}`);
      if (data.success) {
        showNotification('‚úÖ Misi√≥n completada!', 'success');
        renderGame();
      } else {
        showNotification(data.error, 'warning');
      }
    }

    // MASCOTAS
    function renderPet() {
      if (!player.mascota) {
        document.getElementById('petPanel').innerHTML = `
          <p style="color: #888; margin-bottom: 10px;">No tienes mascota</p>
          <button onclick="adoptPet('perro')" style="width: 100%; padding: 8px; margin: 3px 0; font-size: 11px;">üêï Adoptar Perro</button>
          <button onclick="adoptPet('lobo')" style="width: 100%; padding: 8px; margin: 3px 0; font-size: 11px;">üê∫ Adoptar Lobo</button>
          <button onclick="adoptPet('cuervo')" style="width: 100%; padding: 8px; margin: 3px 0; font-size: 11px;">ü¶Ö Adoptar Cuervo</button>
        `;
        return;
      }

      const pet = player.mascota;
      document.getElementById('petPanel').innerHTML = `
        <div style="padding: 10px; background: #1a2a2a; border-radius: 5px;">
          <strong style="color: #00ffff; font-size: 14px;">${pet.nombre} Nv.${pet.nivel}</strong>
          <div style="margin: 8px 0;">
            <div style="font-size: 10px;">Hambre:</div>
            <div class="stat-bar" style="height: 10px; width: 100%;">
              <div class="stat-fill hambre" style="width: ${pet.hambre}%;"></div>
            </div>
          </div>
          <div style="margin: 8px 0;">
            <div style="font-size: 10px;">Moral:</div>
            <div class="stat-bar" style="height: 10px; width: 100%;">
              <div class="stat-fill moral" style="width: ${pet.moral}%;"></div>
            </div>
          </div>
          <div style="font-size: 10px; color: #888; margin: 5px 0;">${pet.habilidad}</div>
          <button onclick="feedPet('comida')" style="width: 100%; padding: 6px; margin: 3px 0; font-size: 10px;">üçñ Alimentar (comida)</button>
          <button onclick="feedPet('carne')" style="width: 100%; padding: 6px; margin: 3px 0; font-size: 10px;">ü•© Alimentar (carne)</button>
        </div>
      `;
    }

    async function adoptPet(petType) {
      if (pendingActions.has('adoptPet')) return;
      pendingActions.add('adoptPet');
      
      const data = await safeFetch('/api/pet/adopt', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id, petType })
      });
      
      pendingActions.delete('adoptPet');
      
      if (data.success) {
        player.mascota = data.mascota;
        showNotification(`üêæ Adoptaste ${data.mascota.nombre}!`, 'success');
        renderPet();
      }
    }

    async function feedPet(item) {
      if (pendingActions.has('feedPet')) return;
      pendingActions.add('feedPet');
      
      const data = await safeFetch('/api/pet/feed', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id, item })
      });
      
      pendingActions.delete('feedPet');
      
      if (data.success) {
        player.mascota = data.mascota;
        player.inventario = data.inventario;
        showNotification('üçñ Mascota alimentada!', 'success');
        renderGame();
      }
    }

    // HABILIDADES ESPECIALES
    function renderAbilities() {
      if (!player.clase) {
        document.getElementById('abilitiesPanel').innerHTML = '<em style="color: #888;">Necesitas una clase</em>';
        return;
      }

      const classAbilities = {
        'soldado': ['curacion_rapida', 'rafaga_mortal'],
        'explorador': ['sigilo_perfecto', 'visi√≥n_extendida'],
        'ingeniero': ['crafteo_instantaneo', 'reparacion_rapida'],
        'medico': ['curacion_rapida', 'inmunidad_temporal'],
        'lider': ['escudo_grupal', 'moral_boost']
      };

      const abilities = classAbilities[player.clase] || [];
      
      const html = abilities.map(abilityId => {
        const ability = world.specialAbilities && world.specialAbilities[abilityId];
        if (!ability) return '';
        
        const onCooldown = player.abilityCooldowns && player.abilityCooldowns[abilityId] && Date.now() < player.abilityCooldowns[abilityId];
        const cooldownText = onCooldown ? ` (${Math.ceil((player.abilityCooldowns[abilityId] - Date.now()) / 1000)}s)` : '';
        
        return `
          <button onclick="useAbility('${abilityId}')" ${onCooldown ? 'disabled' : ''} style="width: 100%; padding: 8px; margin: 3px 0; font-size: 10px;">
            ‚ö° ${ability.nombre}${cooldownText}
          </button>
        `;
      }).join('');

      document.getElementById('abilitiesPanel').innerHTML = html || '<em style="color: #888;">Sin habilidades disponibles</em>';
    }

    async function useAbility(abilityId) {
      if (pendingActions.has(`ability-${abilityId}`)) return;
      pendingActions.add(`ability-${abilityId}`);
      
      const data = await safeFetch('/api/ability/use', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id, abilityId })
      });
      
      pendingActions.delete(`ability-${abilityId}`);
      
      if (data.success) {
        showNotification(`‚ö° Usaste: ${data.ability.nombre}!`, 'success');
        renderGame();
      }
    }

    // FACCIONES
    function renderFaction() {
      if (!player.faccion) {
        document.getElementById('factionPanel').innerHTML = `
          <p style="color: #888; margin-bottom: 10px;">√önete a una facci√≥n para desbloquear recompensas</p>
          <button onclick="joinFaction('refugio')" style="width: 100%; padding: 8px; margin: 3px 0; font-size: 10px;">üè† Los Refugiados</button>
          <button onclick="joinFaction('nomadas')" style="width: 100%; padding: 8px; margin: 3px 0; font-size: 10px;">üö∂ N√≥madas</button>
          <button onclick="joinFaction('cientificos')" style="width: 100%; padding: 8px; margin: 3px 0; font-size: 10px;">üî¨ Los Cient√≠ficos</button>
          <button onclick="joinFaction('saqueadores')" style="width: 100%; padding: 8px; margin: 3px 0; font-size: 10px;">üíÄ Saqueadores</button>
        `;
        document.getElementById('factionRank').textContent = '';
        return;
      }

      const faction = world.factions && world.factions.find(f => f.id === player.faccion);
      if (!faction) return;

      document.getElementById('factionPanel').innerHTML = `
        <div style="padding: 10px; background: #2a1a1a; border-radius: 5px;">
          <strong style="color: #ff8800; font-size: 14px;">${faction.nombre}</strong>
          <div style="font-size: 10px; color: #aaa; margin: 5px 0;">${faction.descripcion}</div>
          <div style="margin: 8px 0; font-size: 11px;">Puntos: ${player.faccionPuntos || 0}</div>
        </div>
      `;
      
      document.getElementById('factionRank').textContent = `Rango ${player.faccionRango || 1}`;
    }

    async function joinFaction(factionId) {
      const response = await fetch('/api/faction/join', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id, factionId })
      });
      
      const data = await response.json();
      if (data.success) {
        player.faccion = factionId;
        showNotification(`‚öîÔ∏è Te uniste a: ${data.faction.nombre}!`, 'success');
        renderFaction();
      } else {
        showNotification(data.error, 'warning');
      }
    }

    // VEH√çCULOS
    function renderVehicle() {
      if (!player.vehiculo) return;

      const vehicle = player.vehiculo;
      document.getElementById('vehiclePanel').innerHTML = `
        <div style="padding: 10px; background: #1a1a2a; border-radius: 5px;">
          <strong style="color: #00ff00; font-size: 14px;">${vehicle.nombre}</strong>
          <div style="margin: 8px 0;">
            <div style="font-size: 10px;">Combustible:</div>
            <div class="stat-bar" style="height: 10px; width: 100%;">
              <div class="stat-fill hambre" style="width: ${vehicle.combustible}%;"></div>
            </div>
          </div>
          <div style="margin: 8px 0;">
            <div style="font-size: 10px;">Durabilidad:</div>
            <div class="stat-bar" style="height: 10px; width: 100%;">
              <div class="stat-fill salud" style="width: ${vehicle.durabilidad}%;"></div>
            </div>
          </div>
          <div style="font-size: 10px; color: #888; margin: 5px 0;">Velocidad: +${vehicle.velocidad} | Protecci√≥n: ${vehicle.proteccion}%</div>
        </div>
      `;
    }

    async function craftVehicle(vehicleType) {
      const response = await fetch('/api/vehicle/craft', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id, vehicleType })
      });
      
      const data = await response.json();
      if (data.success) {
        player.vehiculo = data.vehiculo;
        player.inventario = data.inventario;
        showNotification(`üöó Construiste: ${data.vehiculo.nombre}!`, 'success');
        renderGame();
      } else {
        showNotification(data.error, 'warning');
      }
    }

    // PVP ARENA
    let currentPvPMatch = null;

    async function enterPvPArena() {
      if (player.salud < 50) {
        showNotification('Necesitas al menos 50 de salud', 'warning');
        return;
      }

      const response = await fetch('/api/pvp/enter', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id })
      });
      
      const data = await response.json();
      if (data.success) {
        showNotification(`‚öîÔ∏è En cola PvP (Posici√≥n: ${data.queuePosition})`, 'success');
        document.getElementById('pvpQueue').textContent = `Cola: ${data.queuePosition}`;
      } else {
        showNotification(data.error, 'warning');
      }
    }

    async function attackInPvP() {
      if (!currentPvPMatch) return;

      const response = await fetch('/api/pvp/attack', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: player.id, matchId: currentPvPMatch })
      });
      
      const data = await response.json();
      if (data.success) {
        if (data.victory) {
          showNotification('üèÜ ¬°VICTORIA! +100 XP', 'success');
          document.getElementById('pvpMatch').style.display = 'none';
          currentPvPMatch = null;
        }
      } else {
        showNotification(data.error, 'warning');
      }
    }

    // Actualizar funci√≥n renderGame para incluir nuevos sistemas
    const _originalRenderGame = renderGame;
    renderGame = function() {
      _originalRenderGame();
      renderMissions();
      renderPet();
      renderAbilities();
      renderFaction();
      renderVehicle();
      updateFeaturedStory();
    };
    
    // üåü SISTEMA DE HISTORIA DESTACADA
    let featuredStoryData = {
      text: 'El refugio se mantiene en calma...',
      target: null,
      type: 'neutral'
    };
    
    function updateFeaturedStory() {
      if (!world || !player) return;
      
      const stories = [];
      
      // Verificar eventos especiales activos
      if (world.evento_especial) {
        stories.push({
          text: `‚ö†Ô∏è ${world.evento_especial.descripcion}`,
          target: 'events',
          type: 'danger',
          priority: 100
        });
      }
      
      // Relaciones dram√°ticas entre NPCs
      const npcs = Object.values(world.npcs || {});
      for (const npc of npcs) {
        if (npc.relaciones) {
          const relations = Object.values(npc.relaciones);
          const romance = relations.find(r => r.estado === 'amantes');
          const rivalry = relations.find(r => r.estado === 'enemigos' || r.estado === 'rivales');
          
          if (romance) {
            stories.push({
              text: `üíï Una relaci√≥n rom√°ntica est√° floreciendo en el refugio`,
              target: 'mundo',
              type: 'positive',
              priority: 80
            });
            break;
          }
          
          if (rivalry) {
            stories.push({
              text: `‚öîÔ∏è Tensi√≥n creciente entre sobrevivientes del refugio`,
              target: 'mundo',
              type: 'warning',
              priority: 85
            });
            break;
          }
        }
      }
      
      // Misiones narrativas disponibles
      if (player.misionesNarrativasDisponibles && player.misionesNarrativasDisponibles.length > 0) {
        stories.push({
          text: `üìñ Nueva misi√≥n narrativa disponible`,
          target: 'missions',
          type: 'highlight',
          priority: 70
        });
      }
      
      // Recursos del refugio cr√≠ticos
      if (world.refugio && world.refugio.recursos) {
        const lowResources = Object.entries(world.refugio.recursos).filter(([k, v]) => v < 10);
        if (lowResources.length > 0) {
          const resource = lowResources[0][0];
          stories.push({
            text: `üè† Refugio necesita urgente: ${resource}`,
            target: 'main',
            type: 'warning',
            priority: 90
          });
        }
      }
      
      // Jugadores en l√≠nea
      const onlinePlayers = connections?.size || 0;
      if (onlinePlayers > 1) {
        stories.push({
          text: `üë• ${onlinePlayers} supervivientes conectados ahora`,
          target: 'social',
          type: 'highlight',
          priority: 60
        });
      }
      
      // Estado del jugador cr√≠tico
      if (player.salud < 30) {
        stories.push({
          text: `üíî Tu salud est√° cr√≠tica. Descansa pronto`,
          target: 'main',
          type: 'danger',
          priority: 95
        });
      }
      
      // Seleccionar historia de mayor prioridad
      if (stories.length > 0) {
        stories.sort((a, b) => b.priority - a.priority);
        featuredStoryData = stories[0];
      } else {
        featuredStoryData = {
          text: 'Todo tranquilo en el apocalipsis... por ahora',
          target: null,
          type: 'neutral',
          priority: 0
        };
      }
      
      // Actualizar UI
      const textEl = document.getElementById('featuredStoryText');
      const containerEl = document.getElementById('featuredStory');
      if (textEl) {
        textEl.textContent = featuredStoryData.text;
      }
      
      // Actualizar color del borde seg√∫n tipo
      if (containerEl) {
        let borderColor = 'var(--green-bright)';
        switch(featuredStoryData.type) {
          case 'danger':
            borderColor = '#ff0000';
            break;
          case 'warning':
            borderColor = '#ffff00';
            break;
          case 'positive':
            borderColor = '#00ffff';
            break;
          case 'highlight':
            borderColor = 'var(--green-bright)';
            break;
        }
        containerEl.style.borderColor = borderColor;
        containerEl.style.boxShadow = `0 0 15px ${borderColor}40`;
      }
    }
    
    function handleFeaturedStoryClick() {
      if (featuredStoryData.target) {
        switchTab(featuredStoryData.target);
        showConsequence('üìå Navegando a ' + featuredStoryData.target.toUpperCase(), 'neutral');
      }
    }

    // ====================================
    // SISTEMA DE GRUPOS
    // ====================================
    function showCreateGroupForm() {
      const groupName = prompt('Nombre del grupo (m√≠nimo 3 caracteres):');
      if (!groupName || groupName.trim().length < 3) {
        showActionFeedback('El nombre debe tener al menos 3 caracteres', 'danger');
        return;
      }

      const usePassword = confirm('¬øQuieres proteger el grupo con contrase√±a?');
      let password = null;
      
      if (usePassword) {
        password = prompt('Contrase√±a del grupo:');
        if (!password) {
          showActionFeedback('Contrase√±a requerida', 'danger');
          return;
        }
      }

      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No conectado al servidor', 'warning');
        return;
      }

      ws.send(JSON.stringify({
        type: 'group:create',
        groupName: groupName.trim(),
        password: password
      }));
    }

    function refreshGroupsList() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No conectado al servidor', 'warning');
        return;
      }

      ws.send(JSON.stringify({ type: 'group:list' }));
      showActionFeedback('Actualizando lista de grupos...', 'info');
    }

    function joinGroup(groupId, hasPassword) {
      let password = null;
      
      if (hasPassword) {
        password = prompt('Contrase√±a del grupo:');
        if (!password) return;
      }

      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No conectado al servidor', 'warning');
        return;
      }

      ws.send(JSON.stringify({
        type: 'group:join',
        groupId: groupId,
        password: password
      }));
    }

    function leaveGroup() {
      if (!confirm('¬øSeguro que quieres abandonar el grupo?')) return;

      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No conectado al servidor', 'warning');
        return;
      }

      ws.send(JSON.stringify({ type: 'group:leave' }));
    }

    function sendGroupChat() {
      const input = document.getElementById('groupChatInput');
      const mensaje = input.value.trim();
      
      if (!mensaje) return;
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No conectado al servidor', 'warning');
        return;
      }

      ws.send(JSON.stringify({
        type: 'group:chat',
        mensaje: mensaje
      }));
      
      input.value = '';
    }

    function renderGroupPanel() {
      const currentGroupDiv = document.getElementById('currentGroup');
      const membersSection = document.getElementById('groupMembersSection');
      const chatSection = document.getElementById('groupChatSection');

      if (!currentGroup) {
        currentGroupDiv.innerHTML = `
          <p style="color: #888; font-style: italic;">No perteneces a ning√∫n grupo</p>
          <button onclick="showCreateGroupForm()" style="width: 100%; padding: 10px; margin-top: 10px; background: #006600; border: 1px solid #00ff00; color: #00ff00; cursor: pointer; font-size: 12px;">
            ‚ûï CREAR GRUPO
          </button>
        `;
        membersSection.style.display = 'none';
        chatSection.style.display = 'none';
        return;
      }

      const isLeader = currentGroup.lider === player.id;
      
      currentGroupDiv.innerHTML = `
        <div style="background: #003300; border: 1px solid #00ff00; padding: 15px; border-radius: 5px;">
          <h3 style="margin-top: 0; color: var(--green-bright);">${currentGroup.nombre}</h3>
          <p style="font-size: 11px; color: #888; margin: 5px 0;">
            ${isLeader ? 'üëë Eres el l√≠der' : 'üë§ Miembro'}
          </p>
          <p style="font-size: 11px; color: #888;">
            üë• ${currentGroup.miembros.length} miembro(s)
          </p>
        </div>
      `;

      // Renderizar miembros
      const membersDiv = document.getElementById('groupMembers');
      membersDiv.innerHTML = currentGroup.miembros.map(memberId => {
        const memberData = world.players && world.players[memberId];
        const isMe = memberId === player.id;
        const isLider = memberId === currentGroup.lider;
        
        return `
          <div style="padding: 8px; background: ${isMe ? '#003366' : '#222'}; border: 1px solid ${isMe ? '#00aaff' : '#444'}; margin-bottom: 5px; border-radius: 3px;">
            ${isLider ? 'üëë' : 'üë§'} <strong>${memberData?.nombre || memberId}</strong> ${isMe ? '(T√ö)' : ''}
            <div style="font-size: 10px; color: #888;">
              Nv.${memberData?.nivel || '?'} | ${memberData?.clase || 'Sobreviviente'}
            </div>
          </div>
        `;
      }).join('');

      membersSection.style.display = 'block';
      chatSection.style.display = 'block';

      // Auto-scroll chat
      const chatLog = document.getElementById('groupChatLog');
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function renderAvailableGroups(groups) {
      const div = document.getElementById('availableGroups');
      
      if (!groups || groups.length === 0) {
        div.innerHTML = '<em style="color: #888;">No hay grupos disponibles</em>';
        return;
      }

      div.innerHTML = groups.map(g => `
        <div style="padding: 12px; background: #222; border: 1px solid #444; margin-bottom: 10px; border-radius: 5px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <strong style="color: var(--green-bright); font-size: 13px;">${g.nombre}</strong>
            ${g.tienePassword ? '<span style="color: #ffaa00; font-size: 11px;">üîí Privado</span>' : '<span style="color: #888; font-size: 11px;">üîì P√∫blico</span>'}
          </div>
          <div style="font-size: 11px; color: #888; margin-bottom: 8px;">
            üëë L√≠der: ${g.lider} | üë• Miembros: ${g.miembros}
          </div>
          <button onclick="joinGroup('${g.id}', ${g.tienePassword})" style="width: 100%; padding: 6px; background: #006600; border: 1px solid #00ff00; color: #00ff00; cursor: pointer; font-size: 11px;">
            ‚û°Ô∏è UNIRSE
          </button>
        </div>
      `).join('');
    }

    function addGroupChatMessage(message) {
      const chatLog = document.getElementById('groupChatLog');
      if (!chatLog) return;

      const msgDiv = document.createElement('div');
      msgDiv.style.marginBottom = '5px';
      msgDiv.style.color = message.startsWith('SISTEMA:') ? '#ffaa00' : '#00ff00';
      msgDiv.textContent = message;
      
      chatLog.appendChild(msgDiv);
      chatLog.scrollTop = chatLog.scrollHeight;

      // Limitar mensajes
      while (chatLog.children.length > 50) {
        chatLog.removeChild(chatLog.firstChild);
      }
    }

    // ====================================
    // SISTEMA DE MISIONES DE NPCs
    // ====================================
    function acceptNPCMission(npcId, missionType) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No conectado al servidor', 'warning');
        return;
      }

      ws.send(JSON.stringify({
        type: 'npc:accept_mission',
        npcId: npcId,
        missionType: missionType
      }));
    }

    function completeMission() {
      if (!player.activeMission) {
        showNotification('‚ùå No tienes ninguna misi√≥n activa', 'warning');
        log('No tienes ninguna misi√≥n activa de NPCs', 'warning');
        return;
      }

      if (!ws || ws.readyState !== WebSocket.OPEN) {
        showNotification('‚ùå No conectado al servidor', 'warning');
        return;
      }

      log('Completando misi√≥n...', 'info');
      ws.send(JSON.stringify({ type: 'npc:complete_mission' }));
    }

    function giveResourceToNPC(npcId, resource, cantidad = 1) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('No conectado al servidor', 'warning');
        return;
      }

      ws.send(JSON.stringify({
        type: 'npc:give_resource',
        npcId: npcId,
        resource: resource,
        cantidad: cantidad
      }));
      
      // Cerrar modal
      closeModal();
      
      // Log temporal
      log(`Diste ${cantidad} ${resource} a un NPC`, 'info');
    }

    // NUEVO: Men√∫ de interacci√≥n completo con NPCs
    function openNPCInteractionMenu(npcId) {
      const npc = world.npcs[npcId];
      if (!npc || !npc.vivo) {
        log('NPC no disponible', 'error');
        return;
      }

      const content = `
        <div style="text-align: left; max-width: 500px;">
          <h2 style="color: var(--green-bright); margin-bottom: 5px;">${npc.nombre}</h2>
          <div style="font-size: 12px; color: #888; margin-bottom: 20px;">
            ‚ù§Ô∏è Salud: ${npc.salud} | üçñ Hambre: ${npc.hambre} | üòä Moral: ${npc.moral}
          </div>
          
          <div style="background: #1a2a1a; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid #00ff00;">
            <div style="font-size: 13px; color: #ccc; font-style: italic;">
              "${npc.dialogo || 'Hola... ¬øen qu√© puedo ayudarte?'}"
            </div>
          </div>

          <div style="display: grid; gap: 10px;">
            <button onclick="npcAction_talk('${npcId}')" style="width: 100%; padding: 12px; background: #004400; border: 1px solid #00ff00; color: #00ff00; cursor: pointer; font-size: 13px; border-radius: 5px; text-align: left;">
              üí¨ <strong>Conversar</strong><br>
              <span style="font-size: 10px; color: #888;">Hablar y conocer m√°s sobre esta persona</span>
            </button>
            
            <button onclick="npcAction_giveResources('${npcId}')" style="width: 100%; padding: 12px; background: #442200; border: 1px solid #ff8800; color: #ff8800; cursor: pointer; font-size: 13px; border-radius: 5px; text-align: left;">
              üéÅ <strong>Dar Recursos</strong><br>
              <span style="font-size: 10px; color: #888;">Compartir comida, medicinas o materiales</span>
            </button>
            
            <button onclick="npcAction_trade('${npcId}')" style="width: 100%; padding: 12px; background: #223344; border: 1px solid #4488ff; color: #4488ff; cursor: pointer; font-size: 13px; border-radius: 5px; text-align: left;">
              üí± <strong>Comerciar</strong><br>
              <span style="font-size: 10px; color: #888;">Intercambiar recursos o items</span>
            </button>
            
            <button onclick="npcAction_relationship('${npcId}')" style="width: 100%; padding: 12px; background: #440044; border: 1px solid #ff44ff; color: #ff44ff; cursor: pointer; font-size: 13px; border-radius: 5px; text-align: left;">
              üíï <strong>Relaci√≥n</strong><br>
              <span style="font-size: 10px; color: #888;">Ver reputaci√≥n y estado de relaci√≥n</span>
            </button>
            
            <button onclick="closeModal()" style="width: 100%; padding: 10px; margin-top: 10px; background: #660000; border: 1px solid #ff0000; color: #ff0000; cursor: pointer; font-size: 12px; border-radius: 3px;">
              ‚ùå CANCELAR
            </button>
          </div>
        </div>
      `;

      const modalContent = document.getElementById('modal-content');
      const customModal = document.getElementById('custom-modal');
      
      if (!modalContent || !customModal) {
        console.error('Modal elements not found');
        return;
      }

      modalContent.innerHTML = content;
      customModal.style.display = 'flex';
      
      // A√±adir a di√°logos activos
      if (!activeDialogue || activeDialogue.npcId !== npcId) {
        activeDialogue = {
          npcId: npcId,
          npcName: npc.nombre,
          startedAt: Date.now()
        };
        dialogueHistory.push({
          speaker: npc.nombre,
          text: npc.dialogo || 'Hola...',
          timestamp: Date.now()
        });
        renderInteractiveDialogue();
      }
    }

    // Acciones de NPC
    function npcAction_talk(npcId) {
      closeModal();
      ws.send(JSON.stringify({ type: 'talk', npcId: npcId }));
    }

    function npcAction_giveResources(npcId) {
      closeModal();
      setTimeout(() => showGiveResourceMenu(npcId), 100);
    }

    function npcAction_trade(npcId) {
      closeModal();
      log('Sistema de comercio en desarrollo', 'info');
      // TODO: Implementar sistema de intercambio
    }

    function npcAction_relationship(npcId) {
      const npc = world.npcs[npcId];
      if (!npc) return;
      
      closeModal();
      
      // Solicitar info de reputaci√≥n al servidor
      ws.send(JSON.stringify({ type: 'npc:check_reputation', npcId: npcId }));
      
      // Mostrar info b√°sica mientras tanto
      log(`Relaci√≥n con ${npc.nombre}: Revisando...`, 'info');
    }

    function showNPCMissions(npcId) {
      const npc = world.npcs[npcId];
      if (!npc || !npc.misionesDisponibles || npc.misionesDisponibles.length === 0) {
        showActionFeedback('Este NPC no tiene misiones disponibles', 'info');
        return;
      }

      const missionNames = {
        espiar_refugio_central: 'üîç Espiar Refugio Central',
        informar_movimientos: 'üì° Informar Movimientos',
        conseguir_componentes: 'üîß Conseguir Componentes',
        investigar_radios: 'üìª Investigar Radios',
        espiar_comerciante: 'üëÅÔ∏è Espiar al Comerciante',
        revelar_secretos: 'üîì Revelar Secretos',
        seguir_npc: 'üïµÔ∏è Seguir a un NPC'
      };

      const missionButtons = npc.misionesDisponibles.map(mission => 
        `<button onclick="acceptNPCMission('${npcId}', '${mission}')" style="width: 100%; padding: 10px; margin: 5px 0; background: #003366; border: 1px solid #00aaff; color: #00aaff; cursor: pointer; font-size: 12px; border-radius: 3px;">
          ${missionNames[mission] || mission}
        </button>`
      ).join('');

      const content = `
        <div style="text-align: center;">
          <h3 style="color: var(--green-bright);">Misiones de ${npc.nombre}</h3>
          <p style="font-size: 12px; color: #888; margin: 15px 0;">
            ${npc.dialogo}
          </p>
          ${missionButtons}
        </div>
      `;

      const modalContent = document.getElementById('modal-content');
      const customModal = document.getElementById('custom-modal');
      
      if (!modalContent || !customModal) {
        console.error('Modal elements not found');
        return;
      }

      modalContent.innerHTML = content;
      customModal.style.display = 'flex';
    }

    function showGiveResourceMenu(npcId) {
      const npc = world.npcs[npcId];
      if (!npc) return;

      const resources = ['comida', 'medicinas', 'materiales', 'armas'];
      const resourceButtons = resources.map(resource => {
        const cantidad = player.inventario[resource] || 0;
        const disabled = cantidad === 0;
        
        return `<button 
          onclick="giveResourceToNPC('${npcId}', '${resource}', 1)" 
          ${disabled ? 'disabled' : ''}
          style="width: 100%; padding: 10px; margin: 5px 0; background: ${disabled ? '#222' : '#006600'}; border: 1px solid ${disabled ? '#444' : '#00ff00'}; color: ${disabled ? '#666' : '#00ff00'}; cursor: ${disabled ? 'not-allowed' : 'pointer'}; font-size: 12px; border-radius: 3px;">
          ${resource.toUpperCase()} (Tienes: ${cantidad})
        </button>`;
      }).join('');

      const content = `
        <div style="text-align: center;">
          <h3 style="color: var(--green-bright);">Dar Recursos a ${npc.nombre}</h3>
          <p style="font-size: 12px; color: #888; margin: 15px 0;">
            Dar recursos mejora tu reputaci√≥n con este NPC
          </p>
          ${resourceButtons}
          <button onclick="closeModal()" style="width: 100%; padding: 10px; margin-top: 15px; background: #660000; border: 1px solid #ff0000; color: #ff0000; cursor: pointer; font-size: 12px; border-radius: 3px;">
            CANCELAR
          </button>
        </div>
      `;

      const modalContent = document.getElementById('modal-content');
      const customModal = document.getElementById('custom-modal');
      
      if (!modalContent || !customModal) {
        console.error('Modal elements not found');
        return;
      }

      modalContent.innerHTML = content;
      customModal.style.display = 'flex';
    }

    // Actualizar al cambiar a pesta√±a de grupos
    const originalSwitchTab = switchTab;
    switchTab = function(tabName) {
      originalSwitchTab(tabName);
      
      if (tabName === 'grupos') {
        renderGroupPanel();
        refreshGroupsList();
      }
    };
    
    // ====================================
    // SISTEMA DE CASINO INTERACTIVO
    // ====================================
    
    function openGameModal(gameType) {
      const modal = document.getElementById('gameModal');
      const titles = {
        poker: 'üÉè MESA DE POKER',
        dice: 'üé≤ MESA DE DADOS',
        roulette: 'üé∞ RULETA',
        blackjack: 'üé¥ BLACKJACK'
      };
      
      document.getElementById('gameTitle').textContent = titles[gameType] || 'üéÆ MESA DE JUEGO';
      modal.classList.add('active');
      
      // Mostrar sala de espera inicial
      document.getElementById('gameArea').innerHTML = `
        <div style="text-align: center; padding: 30px;">
          <div style="font-size: 64px; margin-bottom: 20px; animation: pulse 2s infinite;">‚è≥</div>
          <h3 style="color: #ff8800;">Sala de Espera</h3>
          <p style="color: #888; margin-top: 10px;">Esperando que todos est√©n listos...</p>
          <div style="margin-top: 30px;" id="waitingPlayers"></div>
          
          <div style="margin-top: 40px;">
            <button id="btnReady" onclick="markPlayerReady()" class="game-btn primary" style="font-size: 20px; padding: 20px 40px;">
              ‚úÖ ¬°ESTOY LISTO!
            </button>
          </div>
        </div>
      `;
    }
    
    function markPlayerReady() {
      const btn = document.getElementById('btnReady');
      if (btn) {
        btn.disabled = true;
        btn.textContent = '‚úÖ ESPERANDO...';
        btn.style.opacity = '0.5';
      }
      
      ws.send(JSON.stringify({
        type: 'game:ready'
      }));
    }
    
    function updateWaitingRoom(game) {
      const waitingDiv = document.getElementById('waitingPlayers');
      if (!waitingDiv || game.status !== 'waiting') return;
      if (!game.players || !Array.isArray(game.players)) {
        console.warn('game.players no es un array:', game);
        return;
      }
      
      let html = '<div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">';
      
      game.players.forEach(p => {
        const isMe = p.id === player.id;
        const readyStatus = p.ready ? '‚úÖ LISTO' : '‚è≥ Esperando...';
        const readyColor = p.ready ? '#00ff00' : '#ff8800';
        
        html += `
          <div style="background: ${p.ready ? 'rgba(0,255,0,0.1)' : 'rgba(0,0,0,0.3)'}; 
                      padding: 15px; 
                      border-radius: 8px; 
                      border: 2px solid ${p.ready ? '#00ff00' : '#444'};
                      min-width: 120px;
                      ${isMe ? 'box-shadow: 0 0 15px rgba(255,136,0,0.5);' : ''}">
            <div style="font-size: 32px; margin-bottom: 5px;">${p.avatar || 'üë§'}</div>
            <div style="font-size: 14px; color: ${p.color || '#fff'}; font-weight: bold; margin-bottom: 5px;">
              ${escapeHtml(p.nombre)}${isMe ? ' (T√ö)' : ''}
            </div>
            <div style="font-size: 12px; color: ${readyColor}; font-weight: bold;">
              ${readyStatus}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      waitingDiv.innerHTML = html;
      
      // Si el jugador ya est√° listo, deshabilitar bot√≥n
      const myPlayer = game.players.find(p => p.id === player.id);
      if (myPlayer && myPlayer.ready) {
        const btn = document.getElementById('btnReady');
        if (btn) {
          btn.disabled = true;
          btn.textContent = '‚úÖ ESPERANDO...';
          btn.style.opacity = '0.5';
        }
      }
    }
    
    function closeGameModal() {
      document.getElementById('gameModal').classList.remove('active');
      currentGame = null;
    }
    
    function renderGameTable(game) {
      if (!game) return;
      
      const gameArea = document.getElementById('gameArea');
      if (!gameArea) return;
      
      // Renderizar seg√∫n el tipo de juego
      switch(game.type) {
        case 'dice':
          renderDiceGame(game);
          break;
        case 'poker':
          renderPokerGame(game);
          break;
        case 'roulette':
          renderRouletteGame(game);
          break;
        case 'blackjack':
          renderBlackjackGame(game);
          break;
      }
    }
    
    function renderDiceGame(game) {
      const gameArea = document.getElementById('gameArea');
      const pot = game.pot?.comida || 0;
      
      let html = `
        <div style="text-align: center; margin-bottom: 30px;">
          <h3 style="color: #ffaa00;">üí∞ Pozo: ${pot} comida</h3>
          <p style="color: #00ff00; font-size: 14px; margin-top: 5px;">¬°Lanzando dados uno por uno!</p>
        </div>
        
        <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 30px;">
      `;
      
      game.players.forEach(p => {
        const isMe = p.id === player.id;
        const roll = p.roll || '?';
        const diceEmoji = roll === '?' ? 'üé≤' : ['‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'][roll - 1] || 'üé≤';
        
        html += `
          <div class="player-seat ${isMe ? 'active' : ''}" data-player-id="${p.id}" style="min-width: 150px;">
            <div style="font-size: 32px; margin-bottom: 10px;">${p.avatar || 'üë§'}</div>
            <div style="font-weight: bold; color: ${p.color || '#fff'}; margin-bottom: 5px;">${escapeHtml(p.nombre)}</div>
            <div class="dice-animated" style="font-size: 48px; margin: 15px 0;">${diceEmoji}</div>
            <div class="dice-result">${roll !== '?' ? `<span style="color: #00ff00; font-weight: bold;">Resultado: ${roll}</span>` : '<span style="color: #888;">Esperando...</span>'}</div>
          </div>
        `;
      });
      
      html += '</div>';
      
      gameArea.innerHTML = html;
    }
    
    function renderPokerGame(game) {
      const gameArea = document.getElementById('gameArea');
      const pot = game.pot?.comida || 0;
      
      let html = `
        <div style="text-align: center; margin-bottom: 30px;">
          <h3 style="color: #ffaa00;">üí∞ Pozo: ${pot} comida</h3>
        </div>
        
        <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 30px;">
      `;
      
      game.players.forEach(p => {
        const isMe = p.id === player.id;
        const hand = p.hand || 0;
        const hasHand = hand > 0;
        
        html += `
          <div class="player-seat ${isMe ? 'active' : ''}" style="min-width: 150px;">
            <div style="font-size: 32px; margin-bottom: 10px;">${p.avatar || 'üë§'}</div>
            <div style="font-weight: bold; color: ${p.color || '#fff'}; margin-bottom: 5px;">${escapeHtml(p.nombre)}</div>
            <div style="margin: 15px 0;">
              ${hasHand ? 'üÇ† üÇ° üÇ¢ üÇ£ üÇ§' : 'üÇ† üÇ† üÇ† üÇ† üÇ†'}
            </div>
            ${hasHand ? `<div style="color: #00ff00; font-weight: bold;">Mano: ${hand}/100</div>` : '<div style="color: #888;">Esperando...</div>'}
          </div>
        `;
      });
      
      html += `
        </div>
        
        ${game.status === 'playing' ? '<div style="text-align: center; color: #ff8800; font-size: 18px; font-weight: bold; animation: pulse 2s infinite;">üÉè Repartiendo cartas...</div>' : ''}
      `;
      
      gameArea.innerHTML = html;
    }
    
    function renderRouletteGame(game) {
      const gameArea = document.getElementById('gameArea');
      const pot = game.pot?.comida || 0;
      const winningNumber = game.winningNumber !== undefined ? game.winningNumber : null;
      
      let html = `
        <div style="text-align: center; margin-bottom: 30px;">
          <h3 style="color: #ffaa00;">üí∞ Pozo: ${pot} comida</h3>
        </div>
        
        <div style="text-align: center; margin: 30px 0;">
          <div class="${game.status === 'playing' ? 'roulette-spin' : ''}" style="display: inline-block; font-size: 120px;">üé∞</div>
          ${winningNumber !== null ? `<div style="font-size: 48px; color: #ffd700; font-weight: bold; margin-top: 20px;">N√∫mero ganador: ${winningNumber}</div>` : ''}
        </div>
        
        <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-top: 30px;">
      `;
      
      game.players.forEach(p => {
        const isMe = p.id === player.id;
        const betNumber = p.bet_number !== undefined ? p.bet_number : '?';
        const won = winningNumber !== null && betNumber === winningNumber;
        
        html += `
          <div class="player-seat ${isMe ? 'active' : ''} ${won ? 'winner' : ''}" style="min-width: 150px;">
            <div style="font-size: 32px; margin-bottom: 10px;">${p.avatar || 'üë§'}</div>
            <div style="font-weight: bold; color: ${p.color || '#fff'}; margin-bottom: 5px;">${escapeHtml(p.nombre)}</div>
            <div style="font-size: 36px; color: #ff8800; margin: 15px 0; font-weight: bold;">${betNumber}</div>
            ${won ? '<div style="color: #ffd700; font-weight: bold;">¬°GANADOR!</div>' : winningNumber !== null ? '<div style="color: #888;">Perdi√≥</div>' : '<div style="color: #888;">Apostando...</div>'}
          </div>
        `;
      });
      
      html += '</div>';
      gameArea.innerHTML = html;
    }
    
    function renderBlackjackGame(game) {
      const gameArea = document.getElementById('gameArea');
      const pot = game.pot?.comida || 0;
      
      let html = `
        <div style="text-align: center; margin-bottom: 30px;">
          <h3 style="color: #ffaa00;">üí∞ Pozo: ${pot} comida</h3>
        </div>
        
        <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 30px;">
      `;
      
      game.players.forEach(p => {
        const isMe = p.id === player.id;
        const score = p.score || 0;
        const hasScore = score > 0;
        const busted = score > 21;
        
        html += `
          <div class="player-seat ${isMe ? 'active' : ''}" style="min-width: 150px;">
            <div style="font-size: 32px; margin-bottom: 10px;">${p.avatar || 'üë§'}</div>
            <div style="font-weight: bold; color: ${p.color || '#fff'}; margin-bottom: 5px;">${escapeHtml(p.nombre)}</div>
            <div style="margin: 15px 0;">
              üé¥ üé¥ üé¥
            </div>
            ${hasScore ? `<div style="color: ${busted ? '#ff0000' : '#00ff00'}; font-weight: bold; font-size: 24px;">${score}</div>` : '<div style="color: #888;">Esperando...</div>'}
            ${busted ? '<div style="color: #ff0000; font-size: 12px;">¬°TE PASASTE!</div>' : ''}
          </div>
        `;
      });
      
      html += `
        </div>
        
        ${game.status === 'playing' ? '<div style="text-align: center; color: #ff8800; font-size: 18px; font-weight: bold; animation: pulse 2s infinite;">üé¥ Repartiendo cartas...</div>' : ''}
      `;
      
      gameArea.innerHTML = html;
    }
    
    function renderGameResults(game, winners) {
      const gameArea = document.getElementById('gameArea');
      if (!gameArea) return;
      
      const hasWinners = winners && winners.length > 0;
      const winnersText = hasWinners ? winners.map(w => w.nombre).join(', ') : 'La casa';
      const prize = game.pot?.comida || 0;
      
      let html = `
        <div style="text-align: center; padding: 50px;">
          <div style="font-size: 80px; margin-bottom: 20px; animation: pulse 2s infinite;">
            ${hasWinners ? 'üéâ' : 'üè†'}
          </div>
          <h2 style="color: #ffd700; margin-bottom: 20px;">
            ${hasWinners ? '¬°GANADORES!' : 'La casa gana'}
          </h2>
          <div style="font-size: 24px; color: #fff; margin-bottom: 30px;">
            ${winnersText}
          </div>
          ${hasWinners ? `<div style="color: #00ff00; font-size: 20px;">Premio: ${Math.floor(prize / winners.length)} comida c/u</div>` : ''}
          
          <div style="margin-top: 40px;">
            <button onclick="closeGameModal()" class="game-btn primary">
              Cerrar Mesa
            </button>
          </div>
        </div>
      `;
      
      // Render resultados por jugador seg√∫n el tipo de juego
      html += '<div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-top: 30px;">';
      
      game.players.forEach(p => {
        const isWinner = winners && winners.some(w => w.id === p.id);
        
        html += `
          <div class="player-seat ${isWinner ? 'winner' : ''}" style="min-width: 150px;">
            <div style="font-size: 32px; margin-bottom: 10px;">${p.avatar || 'üë§'}</div>
            <div style="font-weight: bold; color: ${p.color || '#fff'};">${escapeHtml(p.nombre)}</div>
            <div style="margin-top: 10px; font-size: 18px;">
              ${game.type === 'dice' ? `üé≤ ${p.roll || 0}` : ''}
              ${game.type === 'poker' ? `üÉè ${p.hand || 0}` : ''}
              ${game.type === 'roulette' ? `üé∞ ${p.bet_number !== undefined ? p.bet_number : 0}` : ''}
              ${game.type === 'blackjack' ? `üé¥ ${p.score || 0}` : ''}
            </div>
            ${isWinner ? '<div style="color: #ffd700; font-weight: bold; margin-top: 10px;">üèÜ GANADOR</div>' : ''}
          </div>
        `;
      });
      
      html += '</div>';
      gameArea.innerHTML = html;
    }

    // ===== EFECTOS VISUALES =====
    
    /**
     * Muestra un n√∫mero de da√±o flotante en la pantalla
     * @param {number} damage - Cantidad de da√±o
     * @param {boolean} isCritical - Si es cr√≠tico
     * @param {boolean} isHealing - Si es curaci√≥n
     * @param {string} position - 'left' o 'right' para posicionamiento
     */
    function showDamageNumber(damage, isCritical = false, isHealing = false, position = 'center') {
      const damageNum = document.createElement('div');
      damageNum.className = 'damage-number' + (isCritical ? ' critical' : '');
      damageNum.textContent = isHealing ? `+${damage}` : `-${damage}`;
      damageNum.style.position = 'fixed';
      damageNum.style.fontSize = isCritical ? '48px' : '32px';
      damageNum.style.fontWeight = 'bold';
      damageNum.style.textShadow = '2px 2px 4px rgba(0,0,0,0.8)';
      damageNum.style.pointerEvents = 'none';
      damageNum.style.zIndex = '10005';
      
      // Color seg√∫n tipo
      if (isHealing) {
        damageNum.style.color = '#00ff00';
      } else if (isCritical) {
        damageNum.style.color = '#fbbf24';
      } else {
        damageNum.style.color = '#ff0000';
      }
      
      // Posicionamiento
      const centerX = window.innerWidth / 2;
      const centerY = window.innerHeight / 2;
      if (position === 'left') {
        damageNum.style.left = `${centerX - 200}px`;
      } else if (position === 'right') {
        damageNum.style.left = `${centerX + 100}px`;
      } else {
        damageNum.style.left = `${centerX - 50}px`;
      }
      damageNum.style.top = `${centerY - 100}px`;
      
      document.body.appendChild(damageNum);
      
      // Remover despu√©s de la animaci√≥n
      setTimeout(() => damageNum.remove(), 1500);
    }

    /**
     * Sacude la pantalla brevemente
     */
    function shakeScreen() {
      document.body.classList.add('screen-shake');
      setTimeout(() => document.body.classList.remove('screen-shake'), 500);
    }

    /**
     * Mostrar banner de subida de nivel
     */
    function showLevelUpBanner(level) {
      const banner = document.createElement('div');
      banner.className = 'level-up-banner';
      banner.innerHTML = `
        <div class="level-text">¬°NIVEL ALCANZADO!</div>
        <div class="level-number">${level}</div>
      `;
      
      document.body.appendChild(banner);
      
      // Efecto de part√≠culas
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const x = window.innerWidth / 2 + (Math.random() - 0.5) * 400;
          const y = window.innerHeight / 2 + (Math.random() - 0.5) * 300;
          createParticle(x, y, '#fbbf24');
        }, i * 20);
      }
      
      // Remover despu√©s de 3 segundos
      setTimeout(() => banner.remove(), 3000);
      
      // Sonido
      if (window.playSound) {
        window.playSound('achievement');
      }
    }

    /**
     * Crear una part√≠cula individual
     */
    function createParticle(x, y, color) {
      const particle = document.createElement('div');
      particle.className = 'particle';
      particle.style.position = 'fixed';
      particle.style.left = `${x}px`;
      particle.style.top = `${y}px`;
      particle.style.width = '10px';
      particle.style.height = '10px';
      particle.style.borderRadius = '50%';
      particle.style.background = color;
      particle.style.pointerEvents = 'none';
      particle.style.zIndex = '10006';
      
      document.body.appendChild(particle);
      
      // Animaci√≥n de part√≠cula
      const angle = Math.random() * Math.PI * 2;
      const velocity = 2 + Math.random() * 3;
      const vx = Math.cos(angle) * velocity;
      const vy = Math.sin(angle) * velocity;
      
      let px = x;
      let py = y;
      let opacity = 1;
      let gravity = 0.1;
      let velY = vy;
      
      const animateParticle = () => {
        px += vx;
        py += velY;
        velY += gravity;
        opacity -= 0.02;
        
        particle.style.left = `${px}px`;
        particle.style.top = `${py}px`;
        particle.style.opacity = opacity;
        
        if (opacity > 0 && py < window.innerHeight + 100) {
          requestAnimationFrame(animateParticle);
        } else {
          particle.remove();
        }
      };
      
      animateParticle();
    }

    // ===== SISTEMA DE LOGROS =====
    class AchievementSystem {
      constructor() {
        this.achievements = {
          first_move: {
            id: 'first_move',
            name: 'Primer Paso',
            description: 'Moverte a otra ubicaci√≥n por primera vez',
            icon: 'üë£',
            category: 'Exploraci√≥n',
            rarity: 'common'
          },
          explorer: {
            id: 'explorer',
            name: 'Explorador',
            description: 'Visitar 5 locaciones diferentes',
            icon: 'üó∫Ô∏è',
            category: 'Exploraci√≥n',
            rarity: 'uncommon'
          },
          first_blood: {
            id: 'first_blood',
            name: 'Primera Sangre',
            description: 'Matar tu primer zombie',
            icon: 'ü©∏',
            category: 'Combate',
            rarity: 'uncommon'
          },
          zombie_slayer: {
            id: 'zombie_slayer',
            name: 'Cazador de Zombies',
            description: 'Eliminar 25 zombies',
            icon: '‚öîÔ∏è',
            category: 'Combate',
            rarity: 'rare'
          },
          zombie_legend: {
            id: 'zombie_legend',
            name: 'Leyenda de los No-Muertos',
            description: 'Eliminar 100 zombies',
            icon: 'üëë',
            category: 'Combate',
            rarity: 'epic'
          },
          survivor: {
            id: 'survivor',
            name: 'Superviviente',
            description: 'Llegar a nivel 10',
            icon: 'üõ°Ô∏è',
            category: 'Supervivencia',
            rarity: 'rare'
          },
          near_death: {
            id: 'near_death',
            name: 'Al Borde de la Muerte',
            description: 'Sobrevivir con menos de 10 HP',
            icon: 'üíÄ',
            category: 'Supervivencia',
            rarity: 'uncommon'
          },
          scavenger: {
            id: 'scavenger',
            name: 'Carro√±ero',
            description: 'Recolectar 100 recursos',
            icon: 'üì¶',
            category: 'Recursos',
            rarity: 'uncommon'
          },
          hoarder: {
            id: 'hoarder',
            name: 'Acumulador',
            description: 'Tener 50 o m√°s recursos en inventario',
            icon: 'üéí',
            category: 'Recursos',
            rarity: 'rare'
          },
          friendly: {
            id: 'friendly',
            name: 'Amistoso',
            description: 'Alcanzar 80 de relaci√≥n con un NPC',
            icon: 'ü§ù',
            category: 'Social',
            rarity: 'uncommon'
          },
          trader: {
            id: 'trader',
            name: 'Comerciante',
            description: 'Completar 20 intercambios comerciales',
            icon: 'üí∞',
            category: 'Social',
            rarity: 'rare'
          },
          first_craft: {
            id: 'first_craft',
            name: 'Artesano Novato',
            description: 'Craftear tu primer objeto',
            icon: 'üî®',
            category: 'Crafteo',
            rarity: 'common'
          }
        };

        this.unlockedAchievements = this.loadUnlocked();
        this.container = this.createContainer();
      }

      createContainer() {
        let container = document.getElementById('achievement-popup-container');
        if (!container) {
          container = document.createElement('div');
          container.id = 'achievement-popup-container';
          container.className = 'achievement-popup';
          document.body.appendChild(container);
        }
        return container;
      }

      loadUnlocked() {
        try {
          const saved = localStorage.getItem('achievements');
          return saved ? JSON.parse(saved) : [];
        } catch (error) {
          console.error('Error cargando logros:', error);
          return [];
        }
      }

      saveUnlocked() {
        try {
          localStorage.setItem('achievements', JSON.stringify(this.unlockedAchievements));
        } catch (error) {
          console.error('Error guardando logros:', error);
        }
      }

      unlock(achievementId) {
        if (this.unlockedAchievements.includes(achievementId)) {
          return false;
        }

        const achievement = this.achievements[achievementId];
        if (!achievement) {
          console.warn(`Logro desconocido: ${achievementId}`);
          return false;
        }

        this.unlockedAchievements.push(achievementId);
        this.saveUnlocked();
        this.showAchievementPopup(achievement);
        
        // Sonido de logro
        if (window.playSound) {
          window.playSound('achievement');
        }

        return true;
      }

      showAchievementPopup(achievement) {
        const card = document.createElement('div');
        card.className = `achievement-card rarity-${achievement.rarity}`;
        card.innerHTML = `
          <div class="achievement-icon">${achievement.icon}</div>
          <div class="achievement-content">
            <div class="achievement-header">üéä ¬°LOGRO DESBLOQUEADO!</div>
            <div class="achievement-title">${achievement.name}</div>
            <div class="achievement-desc">${achievement.description}</div>
          </div>
        `;

        this.container.appendChild(card);

        // Animaci√≥n de entrada
        setTimeout(() => card.classList.add('show'), 10);

        // Auto-remover despu√©s de 5 segundos
        setTimeout(() => {
          card.classList.remove('show');
          setTimeout(() => card.remove(), 500);
        }, 5000);
      }

      check(player) {
        if (!player) return;

        // Exploraci√≥n
        if (player.locaciones_visitadas >= 1) {
          this.unlock('first_move');
        }
        if (player.locaciones_visitadas >= 5) {
          this.unlock('explorer');
        }

        // Combate
        if (player.zombies_matados >= 1) {
          this.unlock('first_blood');
        }
        if (player.zombies_matados >= 25) {
          this.unlock('zombie_slayer');
        }
        if (player.zombies_matados >= 100) {
          this.unlock('zombie_legend');
        }

        // Supervivencia
        if (player.nivel >= 10) {
          this.unlock('survivor');
        }
        if (player.salud <= 10 && player.salud > 0) {
          this.unlock('near_death');
        }

        // Recursos
        if (player.recursos_recolectados >= 100) {
          this.unlock('scavenger');
        }
        
        const totalRecursos = (player.comida || 0) + (player.agua || 0) + 
                             (player.madera || 0) + (player.metal || 0);
        if (totalRecursos >= 50) {
          this.unlock('hoarder');
        }

        // Social
        if (player.relaciones) {
          const maxRelacion = Math.max(...Object.values(player.relaciones));
          if (maxRelacion >= 80) {
            this.unlock('friendly');
          }
        }
        if (player.trades_completados >= 20) {
          this.unlock('trader');
        }

        // Crafteo
        if (player.items_crafteados >= 1) {
          this.unlock('first_craft');
        }
      }

      getProgress() {
        const total = Object.keys(this.achievements).length;
        const unlocked = this.unlockedAchievements.length;
        return {
          unlocked,
          total,
          percentage: Math.floor((unlocked / total) * 100)
        };
      }
    }

    // ===== RENDERIZADOR ANIMADO DE STATS =====
    class AnimatedStatsRenderer {
      constructor() {
        this.previousStats = {};
      }

      renderWithAnimations(player) {
        if (!player) return;

        // Detectar cambios en stats
        const changes = this.detectChanges(player);
        
        // Animar cada cambio
        changes.forEach(change => {
          this.animateStat(change.statName, change.oldValue, change.newValue, change.element);
        });

        // Actualizar stats previos
        this.previousStats = { ...player };
      }

      detectChanges(player) {
        const changes = [];
        const stats = ['salud', 'hambre', 'nivel', 'xp', 'comida', 'agua', 'madera', 'metal'];

        stats.forEach(stat => {
          const oldValue = this.previousStats[stat] || 0;
          const newValue = player[stat] || 0;

          if (oldValue !== newValue) {
            const element = this.findStatElement(stat);
            if (element) {
              changes.push({ statName: stat, oldValue, newValue, element });
            }
          }
        });

        return changes;
      }

      findStatElement(statName) {
        // Mapeo de stats a elementos
        const mapping = {
          'salud': 'hp-value',
          'hambre': 'hunger-value',
          'nivel': 'player-level-display',
          'xp': 'xp-value',
          'comida': 'resource-comida',
          'agua': 'resource-agua',
          'madera': 'resource-madera',
          'metal': 'resource-metal'
        };

        const elementId = mapping[statName];
        return elementId ? document.getElementById(elementId) : null;
      }

      animateStat(statName, oldValue, newValue, element) {
        if (!element) return;

        const diff = newValue - oldValue;
        if (diff === 0) return;

        // Crear indicador flotante
        const indicator = document.createElement('div');
        indicator.className = 'stat-change-indicator';
        indicator.textContent = diff > 0 ? `+${diff}` : `${diff}`;
        indicator.style.position = 'fixed';
        indicator.style.color = diff > 0 ? '#00ff00' : '#ff0000';
        indicator.style.fontWeight = 'bold';
        indicator.style.fontSize = '24px';
        indicator.style.textShadow = '2px 2px 4px rgba(0,0,0,0.8)';
        indicator.style.pointerEvents = 'none';
        indicator.style.zIndex = '10006';

        // Posicionar cerca del elemento
        const rect = element.getBoundingClientRect();
        indicator.style.left = `${rect.right + 10}px`;
        indicator.style.top = `${rect.top}px`;

        document.body.appendChild(indicator);

        // Animar elemento con shake
        element.classList.add('stat-shake');
        setTimeout(() => element.classList.remove('stat-shake'), 500);

        // Remover indicador despu√©s de la animaci√≥n
        setTimeout(() => indicator.remove(), 1000);

        // Part√≠culas para cambios importantes
        if (Math.abs(diff) >= 10 || statName === 'nivel') {
          this.createParticleEffect(rect.right, rect.top, diff > 0 ? 'positive' : 'negative');
        }
      }

      createParticleEffect(x, y, type) {
        const colors = {
          'positive': '#00ff00',
          'negative': '#ff0000',
          'level': '#ffd700'
        };

        const color = colors[type] || colors.positive;

        for (let i = 0; i < 10; i++) {
          const particle = document.createElement('div');
          particle.className = 'particle';
          particle.style.position = 'fixed';
          particle.style.left = `${x}px`;
          particle.style.top = `${y}px`;
          particle.style.width = '8px';
          particle.style.height = '8px';
          particle.style.borderRadius = '50%';
          particle.style.background = color;
          particle.style.pointerEvents = 'none';
          particle.style.zIndex = '10006';

          document.body.appendChild(particle);

          // Animaci√≥n de part√≠cula
          const angle = (Math.PI * 2 * i) / 10;
          const velocity = 2 + Math.random() * 2;
          const vx = Math.cos(angle) * velocity;
          const vy = Math.sin(angle) * velocity;

          let px = x;
          let py = y;
          let opacity = 1;

          const animateParticle = () => {
            px += vx;
            py += vy;
            opacity -= 0.02;

            particle.style.left = `${px}px`;
            particle.style.top = `${py}px`;
            particle.style.opacity = opacity;

            if (opacity > 0) {
              requestAnimationFrame(animateParticle);
            } else {
              particle.remove();
            }
          };

          animateParticle();
        }
      }
    }

    // Inicializar sistemas globalmente
    window.achievementSystem = new AchievementSystem();
    window.statsRenderer = new AnimatedStatsRenderer();

    // Variable para rastrear nivel anterior
    let previousLevel = 0;

    // Hook para chequear logros cuando cambia el player
    const originalHandleMessage = handleMessage;
    window.handleMessage = handleMessage = function(msg) {
      // Capturar nivel anterior
      const oldLevel = window.player ? window.player.nivel : 0;
      
      originalHandleMessage(msg);
      
      // Detectar level up
      if (window.player && window.player.nivel > oldLevel && oldLevel > 0) {
        showLevelUpBanner(window.player.nivel);
      }
      
      // Chequear logros despu√©s de actualizar el player
      if (window.player && window.achievementSystem) {
        window.achievementSystem.check(window.player);
      }
      
      // Animar cambios de stats
      if (window.player && window.statsRenderer) {
        window.statsRenderer.renderWithAnimations(window.player);
      }
    };

    console.log('üèÜ Sistema de logros inicializado');
    console.log('üßü Survival Zombie MVP cargado. Usa teclas r√°pidas: S=Scavenge, C=Combat, T=Trade, H=Hablar');
  </script>
  
  <!-- MODAL DE JUEGOS DE CASINO -->
  <div id="gameModal">
    <div class="game-table">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 id="gameTitle" style="color: #ff8800; margin: 0;">üé≤ MESA DE JUEGO</h2>
        <button onclick="closeGameModal()" style="background: #ff0000; color: #fff; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-weight: bold;">‚úï CERRAR</button>
      </div>
      
      <div id="gameArea">
        <!-- El contenido del juego se renderizar√° aqu√≠ din√°micamente -->
      </div>
    </div>
  </div>
</body>
</html>
